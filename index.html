<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQM 品質管理系統 (本地版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0?external=react",
            "recharts": "https://esm.sh/recharts@2.10.3?external=react,react-dom"
        }
    }
    </script>
    <style>
        body { background-color: #f8fafc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
import ReactDOM from 'react-dom/client';
import React, { useState, useEffect, useMemo } from 'react';
import { 
  LayoutDashboard, 
  PlusCircle, 
  List, 
  BarChart3, 
  Download, 
  Trash2, 
  CheckCircle2, 
  AlertCircle, 
  Search,
  Filter,
  Image as ImageIcon,
  X,
  Upload,
  Edit,
  Save,
  Import,
  LogOut,
  Users,
  Shield,
  User,
  Lock,
  Database,
  FileJson,
  FileText, 
  TrendingUp, 
  Menu, 
  ChevronRight, 
  Target, 
  RefreshCw, 
  Calendar,
  LineChart as LineChartIcon,
  ListTodo, 
  UserCircle, 
  Settings, 
  AlertTriangle, 
  Clock, 
  ArrowRight, 
  ArrowLeft,
  Briefcase, 
  MessageSquare, 
  Activity, 
  MoreVertical, 
  XCircle, 
  Plus,
  Send,
  Paperclip,
  PieChart as PieChartIcon
} from 'lucide-react';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  Tooltip as RechartsTooltip,
  Legend, 
  ResponsiveContainer, 
  PieChart, 
  Pie, 
  Cell,
  LineChart,
  Line
} from 'recharts';

// --- Configuration ---
// 如果要使用伺服器模式，請將 USE_SERVER 改為 true，並設定 SERVER_URL
const CONFIG = {
  USE_SERVER: true, // 改為 true 以啟用伺服器模式 (多人共用)
  SERVER_URL: window.location.origin.includes('localhost') || window.location.protocol === 'file:' 
    ? "http://localhost:3002" 
    : window.location.origin // 如果是從伺服器開啟，自動使用當前網址
};

console.log('伺服器連線設定:', CONFIG.SERVER_URL);


// --- Remote Database Implementation (Server Mode) ---
class RemoteDB {
  constructor() {
    this.listeners = {};
    this.baseUrl = CONFIG.SERVER_URL + '/api';
    this.pollingInterval = null;
    this.cache = {}; // 簡單的前端快取，避免畫面閃爍
  }

  init() {
    console.log("正在連接伺服器:", this.baseUrl);
    // 每 2 秒向伺服器檢查一次最新資料 (輪詢)
    this.pollingInterval = setInterval(() => {
      Object.keys(this.listeners).forEach(collection => {
        this._fetchAndNotify(collection);
      });
    }, 2000);
  }

  async _fetchAndNotify(collection) {
    try {
      const res = await fetch(`${this.baseUrl}/${collection}`);
      if (res.ok) {
        const data = await res.json();
        // 只有當資料真的有變動時才通知 React 更新 (簡單比對)
        if (JSON.stringify(this.cache[collection]) !== JSON.stringify(data)) {
            this.cache[collection] = data;
            if (this.listeners[collection]) {
                this.listeners[collection].forEach(cb => cb(data));
            }
        }
      } else {
          console.warn(`無法取得 ${collection} 資料, status: ${res.status}`);
      }
    } catch (e) {
      console.error("伺服器連線錯誤:", e);
    }
  }

  subscribe(collection, callback) {
    if (!this.listeners[collection]) this.listeners[collection] = [];
    this.listeners[collection].push(callback);
    
    // 訂閱時立即抓取一次
    this._fetchAndNotify(collection);
    
    return () => {
      this.listeners[collection] = this.listeners[collection].filter(cb => cb !== callback);
    };
  }

  async addDoc(collectionName, data) {
    // 確保有 ID
    const docToAdd = { ...data, id: data.id || ('doc_' + Date.now() + Math.random().toString(36).substr(2, 9)) };
    
    const res = await fetch(`${this.baseUrl}/${collectionName}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(docToAdd)
    });
    
    if (!res.ok) throw new Error('Server Error: ' + res.statusText);
    
    const newDoc = await res.json();
    this._fetchAndNotify(collectionName); // 立即更新畫面
    return newDoc;
  }

  async updateDoc(collectionName, id, data) {
    const res = await fetch(`${this.baseUrl}/${collectionName}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    if (!res.ok) throw new Error('Server Error: ' + res.statusText);
    this._fetchAndNotify(collectionName); // 立即更新畫面
  }

  async deleteDoc(collectionName, id) {
    const res = await fetch(`${this.baseUrl}/${collectionName}/${id}`, {
      method: 'DELETE'
    });
    
    if (!res.ok) throw new Error('Server Error: ' + res.statusText);
    this._fetchAndNotify(collectionName); // 立即更新畫面
  }

  async getDocs(collectionName, queryFn) {
    try {
      const res = await fetch(`${this.baseUrl}/${collectionName}`);
      let list = await res.json();
      if (queryFn) {
        list = list.filter(queryFn);
      }
      return list;
    } catch (e) {
      console.error("GetDocs Error:", e);
      return [];
    }
  }

  // 伺服器模式下的匯出 (從伺服器抓所有資料)
  async exportData() {
    const collections = ['tqm_users', 'tqm_records', 'rd_projects', 'rd_tasks', 'rd_changes', 'rd_history', 'rd_messages', 'rd_machines'];
    const exportObj = { version: '2.0', exportedAt: new Date().toISOString() };
    
    for (const col of collections) {
        exportObj[col] = await this.getDocs(col);
    }
    return exportObj;
  }

  async importData(data) {
    if (!confirm("警告：匯入資料將會新增至現有伺服器資料庫中。\n若有重複 ID 的資料可能會失敗。\n確定要繼續嗎？")) return;

    const collections = ['tqm_users', 'tqm_records', 'rd_machines', 'rd_projects', 'rd_tasks', 'rd_changes', 'rd_history', 'rd_messages'];
    let successCount = 0;
    let failCount = 0;

    for (const col of collections) {
        if (data[col] && Array.isArray(data[col])) {
            for (const item of data[col]) {
                try {
                    // 嘗試新增
                    await this.addDoc(col, item);
                    successCount++;
                } catch (e) {
                    console.warn(`Import failed for ${col} item ${item.id}:`, e);
                    // 如果失敗(例如ID重複)，嘗試用 updateDoc 覆蓋
                    try {
                        if (item.id) {
                            await this.updateDoc(col, item.id, item);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (updateErr) {
                        failCount++;
                    }
                }
            }
        }
    }
    alert(`匯入完成！\n成功: ${successCount} 筆\n失敗/重複: ${failCount} 筆`);
    window.location.reload();
  }
}

// --- Mock Data for Machines ---
const MACHINES = [
    { id: 'M001', name: 'High-Speed Mounter A1', code: 'HSM-A1', status: 'Active', progress: 85, image: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&w=300&q=80', members: '' },
    { id: 'M002', name: 'Inspection Unit X5', code: 'AOI-X5', status: 'Warning', progress: 60, image: 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?auto=format&fit=crop&w=300&q=80', members: '' },
    { id: 'M003', name: 'Reflow Oven R3', code: 'RO-R3', status: 'Active', progress: 92, image: 'https://images.unsplash.com/photo-1581092335397-9583eb92d232?auto=format&fit=crop&w=300&q=80', members: '' },
    { id: 'M004', name: 'Solder Paste Printer P2', code: 'SPP-P2', status: 'Active', progress: 78, image: 'https://images.unsplash.com/photo-1531297461136-82lw9f2125?auto=format&fit=crop&w=300&q=80', members: '' },
];

// --- Mock Data ---
const PROJECTS = [
  { id: 1, machineId: 'M001', name: 'AI 視覺辨識模組 V2', owner: '陳建宏', department: '軟體部', stage: '驗證', progress: 85, status: 'normal', deadline: '2025-11-15', category: '新產品', specs: '1. 支援 4K 60fps 影像輸入\n2. 辨識準確率 > 99.5%\n3. 延遲 < 50ms' },
  { id: 2, machineId: 'M001', name: '高頻通訊晶片散熱座', owner: '林怡君', department: '機構部', stage: '試產', progress: 60, status: 'risk', deadline: '2025-10-20', category: '改款', specs: '1. 散熱功率 15W\n2. 噪音 < 30dB' },
  { id: 3, machineId: 'M001', name: '車用抬頭顯示器 (HUD)', owner: '張志偉', department: '電子部', stage: '設計', progress: 30, status: 'delay', deadline: '2025-09-30', category: '客製案', specs: '' },
  { id: 4, machineId: 'M002', name: '企業內部 ERP 整合', owner: '王大明', department: '軟體部', stage: '規劃', progress: 10, status: 'normal', deadline: '2025-12-01', category: '內部案', specs: '' },
  { id: 5, machineId: 'M002', name: '輕量化無人機機身', owner: '劉雅婷', department: '機構部', stage: '量產', progress: 98, status: 'normal', deadline: '2025-08-15', category: '新產品', specs: '' },
];

const TASKS = [
  { id: 101, projectId: 1, title: '散熱模擬測試報告', status: 'Doing', owner: '林怡君', priority: 'P1', risk: true },
  { id: 102, projectId: 1, title: 'PCB 佈線優化', status: 'To Do', owner: '張志偉', priority: 'P2', risk: false },
  { id: 103, projectId: 1, title: 'AI 模型訓練 (Dataset B)', status: 'Done', owner: '陳建宏', priority: 'P1', risk: false },
  { id: 104, projectId: 1, title: '客戶需求變更確認', status: 'Review', owner: '王小美', priority: 'P3', risk: true },
];

const CHANGES = [
  { id: 1, projectId: 1, date: '2025-08-10', type: '設計改善', desc: '優化散熱鰭片結構', owner: '林怡君', impact: 'Low' },
  { id: 2, projectId: 1, date: '2025-08-12', type: '客戶修改', desc: '新增 HDMI 介面需求', owner: '張志偉', impact: 'High' },
  { id: 3, projectId: 1, date: '2025-08-15', type: '設計疏失', desc: '干涉檢查未通過', owner: '劉雅婷', impact: 'Medium' },
];

const HISTORY = [
  { id: 1, projectId: 1, version: 'V1.0', date: '2025-05-01', author: '林怡君', action: '初始設計建立', desc: '建立初步架構，包含主要散熱模組與 PCB 堆疊定義。', status: 'Approved' },
  { id: 2, projectId: 1, version: 'V1.1', date: '2025-06-15', author: '張志偉', action: '規格變更', desc: '因應客戶需求增加 HDMI 2.1 支援，修改 I/O 板設計。', status: 'Approved' },
  { id: 3, projectId: 1, version: 'V1.2', date: '2025-07-20', author: '陳建宏', action: '設計優化', desc: '優化散熱鰭片密度，降低整體重量 15%。', status: 'Pending' },
];

const LOAD_DATA = [
  { name: '機構部', load: 120, capacity: 100 },
  { name: '電子部', load: 85, capacity: 100 },
  { name: '軟體部', load: 95, capacity: 100 },
  { name: '美工部', load: 40, capacity: 100 },
];

const TREND_DATA = [
  { month: '5月', onTime: 92, delay: 8 },
  { month: '6月', onTime: 88, delay: 12 },
  { month: '7月', onTime: 85, delay: 15 },
  { month: '8月', onTime: 78, delay: 22 },
];

const CHANGE_TYPE_DATA = [
  { name: '設計改善', value: 45 },
  { name: '設計疏失', value: 20 },
  { name: '客戶修改', value: 25 },
  { name: '料件問題', value: 10 },
];

// --- Local Database Implementation ---
class LocalDB {
  constructor() {
    this.listeners = {};
    this.init();
  }

  init() {
    const initData = (key, data) => {
        const val = localStorage.getItem(key);
        if (!val || val === "undefined" || val === "null") {
            localStorage.setItem(key, JSON.stringify(data));
        }
    };

    initData('tqm_users', [{
        id: 'admin_001',
        username: 'admin',
        password: 'admin123',
        displayName: '系統管理員',
        department: '工程中心',
        role: 'admin',
        createdAt: new Date().toISOString()
    }]);
    
    initData('tqm_records', []);
    
    // Initialize R&D Nexus Collections with Mock Data
    initData('rd_machines', MACHINES);
    initData('rd_projects', PROJECTS);
    initData('rd_tasks', TASKS);
    initData('rd_changes', CHANGES);
    initData('rd_history', HISTORY);
    initData('rd_messages', []);
  }

  _getData(collection) {
    const val = localStorage.getItem(collection);
    if (!val || val === "undefined" || val === "null") return [];
    try {
        return JSON.parse(val);
    } catch (e) {
        console.error(`Error parsing ${collection}:`, e);
        return [];
    }
  }

  _saveData(collection, data) {
    localStorage.setItem(collection, JSON.stringify(data));
    this._notify(collection);
  }

  _notify(collection) {
    if (this.listeners[collection]) {
      const data = this._getData(collection);
      this.listeners[collection].forEach(cb => cb(data));
    }
  }

  subscribe(collection, callback) {
    if (!this.listeners[collection]) this.listeners[collection] = [];
    this.listeners[collection].push(callback);
    // Initial call
    callback(this._getData(collection));
    return () => {
      this.listeners[collection] = this.listeners[collection].filter(cb => cb !== callback);
    };
  }

  async addDoc(collectionName, data) {
    const list = this._getData(collectionName);
    const newDoc = { ...data, id: 'doc_' + Date.now() + Math.random().toString(36).substr(2, 9) };
    list.push(newDoc);
    this._saveData(collectionName, list);
    return newDoc;
  }

  async updateDoc(collectionName, id, data) {
    const list = this._getData(collectionName);
    const index = list.findIndex(item => item.id === id);
    if (index !== -1) {
      list[index] = { ...list[index], ...data };
      this._saveData(collectionName, list);
    }
  }

  async deleteDoc(collectionName, id) {
    const list = this._getData(collectionName);
    const newList = list.filter(item => item.id !== id);
    this._saveData(collectionName, newList);
  }

  async getDocs(collectionName, queryFn) {
    let list = this._getData(collectionName);
    if (queryFn) {
      list = list.filter(queryFn);
    }
    return list;
  }

  // --- New Methods for File Import/Export ---
  exportData() {
    return {
      users: this._getData('tqm_users'),
      records: this._getData('tqm_records'),
      exportedAt: new Date().toISOString(),
      version: '1.0'
    };
  }

  importData(data) {
    if (data.users) this._saveData('tqm_users', data.users);
    if (data.records) this._saveData('tqm_records', data.records);
  }
}

const db = CONFIG.USE_SERVER ? new RemoteDB() : new LocalDB();
if (CONFIG.USE_SERVER && db.init) db.init();

// --- Constants ---
const DEPARTMENTS = ["機構設計", "多媒體設計", "電子設計", "工程中心", "研發部", "軟體部", "製造部", "機構部", "電子部", "美工部", "業務部", "品保部", "管理部"];
const ISSUE_TYPES = [
  "設計疏失", "資料疏失", "公差問題", "組裝異常", 
  "程式異常", "配線異常", "供應商來料", "客戶因素", "其他"
];
const MONTHS = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658', '#8dd1e1', '#a4de6c'];



// --- Helper Functions ---
const parseCSV = (text) => {
  const result = [];
  let row = [];
  let inQuote = false;
  let currentToken = '';
  
  // Auto-detect delimiter (Comma or Tab)
  const firstLine = text.substring(0, 1000).split('\n')[0];
  const delimiter = firstLine.includes('\t') ? '\t' : ',';
  
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const nextChar = text[i + 1];

    if (char === '"') {
      if (inQuote && nextChar === '"') {
        currentToken += '"';
        i++;
      } else {
        inQuote = !inQuote;
      }
    } else if (char === delimiter && !inQuote) {
      row.push(currentToken.trim());
      currentToken = '';
    } else if ((char === '\r' || char === '\n') && !inQuote) {
      if (currentToken || row.length > 0) row.push(currentToken.trim());
      if (row.length > 0) result.push(row);
      row = [];
      currentToken = '';
      if (char === '\r' && nextChar === '\n') i++;
    } else {
      currentToken += char;
    }
  }
  if (currentToken || row.length > 0) row.push(currentToken.trim());
  if (row.length > 0) result.push(row);
  return result;
};

// --- Helper Components ---

const StatCard = ({ title, value, subtext, icon: Icon, colorClass }) => (
  <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
    <div className={`p-4 rounded-full ${colorClass} bg-opacity-10`}>
      <Icon className={`w-8 h-8 ${colorClass.replace('bg-', 'text-')}`} />
    </div>
    <div>
      <p className="text-gray-500 text-sm font-medium">{title}</p>
      <h3 className="text-2xl font-bold text-gray-800">{value}</h3>
      {subtext && <p className="text-xs text-gray-400 mt-1">{subtext}</p>}
    </div>
  </div>
);

const ImageModal = ({ src, onClose }) => {
  if (!src) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-80 p-4" onClick={onClose}>
      <div className="relative max-w-4xl max-h-[90vh] w-full flex flex-col items-center">
        <button onClick={onClose} className="absolute -top-10 right-0 text-white hover:text-gray-300 transition-colors"><X size={32} /></button>
        <img src={src} alt="Evidence" className="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white" onClick={(e) => e.stopPropagation()} />
      </div>
    </div>
  );
};

const NavButton = ({ active, onClick, icon: Icon, label }) => (
  <button 
    onClick={onClick}
    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
      active ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'
    }`}
  >
    <Icon size={20} />
    <span className="font-medium">{label}</span>
  </button>
);

// --- Login Screen Component (Updated with Import) ---
const LoginScreen = ({ onLogin, loading, onImportDB }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!username || !password) {
      setError('請輸入帳號與密碼');
      return;
    }
    onLogin(username, password, setError);
  };

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl">
        <div className="text-center mb-8">
          <div className="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <CheckCircle2 className="text-white w-8 h-8" />
          </div>
          <h1 className="text-2xl font-bold text-slate-800">TQM 品質管理系統</h1>
          <p className="text-slate-500 mt-2">請登入以繼續操作 ({CONFIG.USE_SERVER ? '伺服器連線版' : '單機本地版'})</p>
          {CONFIG.USE_SERVER && <div className="mt-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded inline-block">已連線至: {CONFIG.SERVER_URL}</div>}
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2">
              <AlertCircle size={16} /> {error}
            </div>
          )}
          
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">帳號</label>
            <div className="relative">
              <User className="absolute left-3 top-2.5 text-gray-400" size={18} />
              <input 
                type="text" 
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                placeholder="請輸入使用者帳號"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">密碼</label>
            <div className="relative">
              <Lock className="absolute left-3 top-2.5 text-gray-400" size={18} />
              <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                placeholder="請輸入密碼"
              />
            </div>
          </div>

          <button 
            type="submit" 
            disabled={loading}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg shadow-md transition-all flex items-center justify-center"
          >
            {loading ? '驗證中...' : '登入系統'}
          </button>
        </form>
        
        <div className="mt-6 pt-6 border-t border-gray-100">
          <label className="flex items-center justify-center gap-2 w-full p-2 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg cursor-pointer transition-colors text-sm border border-dashed border-gray-300">
             <Database size={16} />
             <span>載入資料庫檔案 (Load DB)</span>
             <input type="file" accept=".json" onChange={onImportDB} className="hidden" />
          </label>
          <p className="text-center text-xs text-gray-400 mt-2">
            如果您有備份的資料檔 (.json)，可在此載入
          </p>
        </div>

        <div className="mt-4 text-center text-xs text-gray-400">
          預設管理員帳號: admin / admin123
        </div>
      </div>
    </div>
  );
};

// --- User Management Component ---
const UserManagement = ({ currentUser }) => {
  const [users, setUsers] = useState([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [formData, setFormData] = useState({
    username: '', password: '', displayName: '', department: DEPARTMENTS[0], role: 'user'
  });
  const [editId, setEditId] = useState(null);

  useEffect(() => {
    const unsubscribe = db.subscribe('tqm_users', (data) => {
      setUsers(data);
    });
    return () => unsubscribe();
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      if (editId) {
        const updateData = { ...formData };
        if (!updateData.password) delete updateData.password;
        await db.updateDoc('tqm_users', editId, updateData);
        alert('帳號更新成功');
      } else {
        const existing = users.find(u => u.username === formData.username);
        if (existing) return alert('帳號已存在，請使用其他帳號');
        if (!formData.password) return alert('請設定密碼');
        await db.addDoc('tqm_users', { ...formData, createdAt: new Date().toISOString() });
        alert('帳號建立成功');
      }
      setIsModalOpen(false);
      resetForm();
    } catch (err) {
      console.error(err);
      alert('操作失敗');
    }
  };

  const handleDelete = async (id) => {
    if (!confirm('確定要刪除此帳號嗎？')) return;
    try { await db.deleteDoc('tqm_users', id); } catch (err) { console.error(err); }
  };

  const startEdit = (user) => {
    setEditId(user.id);
    setFormData({ username: user.username, password: '', displayName: user.displayName, department: user.department, role: user.role });
    setIsModalOpen(true);
  };

  const resetForm = () => {
    setEditId(null);
    setFormData({ username: '', password: '', displayName: '', department: DEPARTMENTS[0], role: 'user' });
  };

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Users className="text-blue-600"/> 帳號管理</h2>
        <button onClick={() => { resetForm(); setIsModalOpen(true); }} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors shadow-sm"><PlusCircle size={16} /> 新增帳號</button>
      </div>
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <table className="w-full text-sm text-left text-gray-600">
          <thead className="bg-gray-50 text-gray-700 uppercase text-xs"><tr><th className="px-6 py-3">帳號</th><th className="px-6 py-3">姓名</th><th className="px-6 py-3">部門</th><th className="px-6 py-3">權限角色</th><th className="px-6 py-3 text-center">操作</th></tr></thead>
          <tbody>
            {users.map(u => (
              <tr key={u.id} className="border-b hover:bg-gray-50">
                <td className="px-6 py-4 font-medium">{u.username}</td><td className="px-6 py-4">{u.displayName}</td><td className="px-6 py-4">{u.department}</td>
                <td className="px-6 py-4"><span className={`px-2 py-1 rounded-full text-xs font-semibold ${u.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}`}>{u.role === 'admin' ? '管理員' : '一般使用者'}</span></td>
                <td className="px-6 py-4 text-center"><div className="flex justify-center gap-2"><button onClick={() => startEdit(u)} className="text-blue-500 hover:text-blue-700"><Edit size={16}/></button>{u.username !== 'admin' && (<button onClick={() => handleDelete(u.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={16}/></button>)}</div></td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
             <h3 className="text-xl font-bold mb-4">{editId ? '編輯帳號' : '新增帳號'}</h3>
             <form onSubmit={handleSubmit} className="space-y-4">
                <div><label className="block text-xs font-bold text-gray-500 mb-1">帳號</label><input type="text" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} disabled={!!editId} className="w-full p-2 border rounded text-sm disabled:bg-gray-100" required /></div>
                <div><label className="block text-xs font-bold text-gray-500 mb-1">密碼 {editId && '(不修改請留空)'}</label><input type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full p-2 border rounded text-sm" required={!editId} /></div>
                <div><label className="block text-xs font-bold text-gray-500 mb-1">姓名</label><input type="text" value={formData.displayName} onChange={e => setFormData({...formData, displayName: e.target.value})} className="w-full p-2 border rounded text-sm" required /></div>
                <div><label className="block text-xs font-bold text-gray-500 mb-1">部門</label><select value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})} className="w-full p-2 border rounded text-sm">{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                <div><label className="block text-xs font-bold text-gray-500 mb-1">權限</label><select value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} className="w-full p-2 border rounded text-sm"><option value="user">一般使用者</option><option value="admin">系統管理員</option></select></div>
                <div className="flex justify-end gap-3 pt-4"><button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded text-sm">取消</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">儲存</button></div>
             </form>
          </div>
        </div>
      )}
    </div>
  );
};

// --- Entry Form Component ---
const EntryForm = ({ onSubmit, currentUser }) => {
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0], department: currentUser.department || DEPARTMENTS[0], personName: currentUser.displayName || '',
    issueType: ISSUE_TYPES[0], description: '', isRepeat: false, status: '未改善', improvementMethod: '', note: '', attachment: null 
  });
  const [fileName, setFileName] = useState('');

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 500 * 1024) { alert("圖片過大！建議上傳 500KB 以下的照片。"); e.target.value = null; return; }
      setFileName(file.name);
      const reader = new FileReader();
      reader.onloadend = () => { setFormData(prev => ({ ...prev, attachment: reader.result })); };
      reader.readAsDataURL(file);
    }
  };

  const handleRemoveFile = () => { setFileName(''); setFormData(prev => ({ ...prev, attachment: null })); };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.personName || !formData.description) return alert("請填寫完整資料");
    onSubmit(formData);
    setFormData(prev => ({ ...prev, description: '', isRepeat: false, status: '未改善', improvementMethod: '', note: '', attachment: null }));
    setFileName('');
  };

  return (
    <form onSubmit={handleSubmit} className="bg-white p-8 rounded-xl shadow-sm border border-gray-100 space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label className="block text-sm font-medium text-gray-700 mb-1">發生日期</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
        <div><label className="block text-sm font-medium text-gray-700 mb-1">歸屬部門</label><select name="department" value={formData.department} onChange={handleChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label className="block text-sm font-medium text-gray-700 mb-1">回報人員姓名</label><input type="text" name="personName" value={formData.personName} onChange={handleChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" /></div>
        <div><label className="block text-sm font-medium text-gray-700 mb-1">回報類型</label><select name="issueType" value={formData.issueType} onChange={handleChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">{ISSUE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
      </div>
      <div><label className="block text-sm font-medium text-gray-700 mb-1">問題/異常描述</label><textarea name="description" rows="4" value={formData.description} onChange={handleChange} placeholder="請詳細描述異常情況..." className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea></div>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">佐證照片/附件</label>
        <div className="flex items-center space-x-4">
          <label className="flex items-center gap-2 cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-300"><Upload size={18} /><span>選擇檔案</span><input type="file" accept="image/*" onChange={handleFileChange} className="hidden" /></label>
          {fileName && (<div className="flex items-center gap-2 text-sm text-green-600 bg-green-50 px-3 py-1 rounded-full"><span>{fileName}</span><button type="button" onClick={handleRemoveFile} className="hover:text-red-500"><X size={14}/></button></div>)}
        </div>
        {formData.attachment && <div className="mt-3"><img src={formData.attachment} alt="Preview" className="h-32 w-auto object-cover rounded-md border border-gray-200" /></div>}
      </div>
      <div className="flex items-center space-x-6 p-4 bg-gray-50 rounded-lg">
        <div className="flex items-center"><input type="checkbox" id="isRepeat" name="isRepeat" checked={formData.isRepeat} onChange={handleChange} className="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" /><label htmlFor="isRepeat" className="ml-2 text-sm font-medium text-gray-700">是否為重複發生？</label></div>
        <div className="flex items-center space-x-3"><label className="text-sm font-medium text-gray-700">目前狀態：</label><div className="flex space-x-2">{['未改善', '已改善'].map(status => (<button key={status} type="button" onClick={() => setFormData(prev => ({ ...prev, status }))} className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${formData.status === status ? (status === '已改善' ? 'bg-green-100 text-green-800 ring-2 ring-green-500' : 'bg-red-100 text-red-800 ring-2 ring-red-500') : 'bg-white border border-gray-200 text-gray-500 hover:bg-gray-50'}`}>{status}</button>))}</div></div>
      </div>
      <div className="pt-4 border-t border-gray-100 flex justify-end"><button type="submit" className="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 shadow-md">提交紀錄</button></div>
    </form>
  );
};

// --- Edit Record Modal ---
const EditRecordModal = ({ record, onClose, onUpdate }) => {
  const [formData, setFormData] = useState({ ...record, improvementMethod: record.improvementMethod || '', note: record.note || '' });
  const handleChange = (e) => { const { name, value, type, checked } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value })); };
  const handleSubmit = (e) => { e.preventDefault(); onUpdate(record.id, formData); };

  return (
    <div className="fixed inset-0 z-[50] flex items-center justify-center bg-black bg-opacity-50 p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl"><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Edit size={20} className="text-blue-600"/> 編輯/更新案件紀錄</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button></div>
        <form onSubmit={handleSubmit} className="p-6 space-y-6">
          <div className="bg-blue-50 p-4 rounded-lg space-y-4">
             <h3 className="text-sm font-bold text-blue-800 uppercase tracking-wider mb-2">原始問題資訊</h3>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-xs font-semibold text-gray-500 mb-1">發生日期</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full text-sm p-2 border rounded" /></div>
                <div><label className="block text-xs font-semibold text-gray-500 mb-1">部門</label><select name="department" value={formData.department} onChange={handleChange} className="w-full text-sm p-2 border rounded">{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                <div><label className="block text-xs font-semibold text-gray-500 mb-1">人員</label><input type="text" name="personName" value={formData.personName} onChange={handleChange} className="w-full text-sm p-2 border rounded" /></div>
                <div><label className="block text-xs font-semibold text-gray-500 mb-1">類型</label><select name="issueType" value={formData.issueType} onChange={handleChange} className="w-full text-sm p-2 border rounded">{ISSUE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
             </div>
             <div><label className="block text-xs font-semibold text-gray-500 mb-1">問題描述</label><textarea name="description" rows="2" value={formData.description} onChange={handleChange} className="w-full text-sm p-2 border rounded"></textarea></div>
          </div>
          <div className="bg-green-50 p-4 rounded-lg space-y-4 border border-green-100">
             <h3 className="text-sm font-bold text-green-800 uppercase tracking-wider mb-2 flex items-center gap-2"><CheckCircle2 size={16}/> 改善對策與追蹤</h3>
             <div><label className="block text-sm font-semibold text-gray-700 mb-1">改善對策 (Countermeasure)</label><textarea name="improvementMethod" rows="4" value={formData.improvementMethod} onChange={handleChange} placeholder="請填寫具體的改善方法、預防再發措施..." className="w-full p-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"></textarea></div>
             <div><label className="block text-sm font-semibold text-gray-700 mb-1">備註/訊息</label><input type="text" name="note" value={formData.note} onChange={handleChange} placeholder="例如：已通知相關廠商、待主管確認..." className="w-full p-2 border border-green-200 rounded-lg text-sm" /></div>
             <div className="flex flex-col md:flex-row gap-4 items-start md:items-center pt-2">
                <div className="flex items-center space-x-2"><label className="text-sm font-bold text-gray-700">目前狀態：</label><select name="status" value={formData.status} onChange={handleChange} className={`text-sm font-bold py-1 px-3 rounded-full border-none ring-2 ${formData.status === '已改善' ? 'bg-green-100 text-green-800 ring-green-400' : 'bg-red-100 text-red-800 ring-red-400'}`}><option value="未改善">未改善</option><option value="已改善">已改善</option></select></div>
                <div className="flex items-center"><input type="checkbox" id="editIsRepeat" name="isRepeat" checked={formData.isRepeat} onChange={handleChange} className="w-4 h-4 text-blue-600 rounded border-gray-300" /><label htmlFor="editIsRepeat" className="ml-2 text-sm text-gray-600">標記為重複發生</label></div>
             </div>
          </div>
          <div className="flex justify-end gap-3 pt-4 border-t border-gray-100"><button type="button" onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">取消</button><button type="submit" className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md flex items-center gap-2"><Save size={16} /> 儲存更新</button></div>
        </form>
      </div>
    </div>
  );
};

// --- Record Table ---
const RecordTable = ({ records, onDelete, onViewImage, onEdit, currentUser }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterDept, setFilterDept] = useState('All');
  const filteredRecords = records.filter(r => {
    const matchesSearch = r.description?.toLowerCase().includes(searchTerm.toLowerCase()) || r.personName?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesDept = filterDept === 'All' || r.department === filterDept;
    return matchesSearch && matchesDept;
  });

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div className="p-4 border-b border-gray-100 flex gap-4 bg-gray-50/50">
        <div className="relative flex-1 max-w-sm"><Search className="absolute left-3 top-2.5 text-gray-400" size={18} /><input type="text" placeholder="搜尋..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" /></div>
        <select value={filterDept} onChange={(e) => setFilterDept(e.target.value)} className="px-3 py-2 border rounded-lg text-sm"><option value="All">所有部門</option>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-sm text-left text-gray-600">
          <thead className="text-xs text-gray-700 uppercase bg-gray-100"><tr><th className="px-6 py-3">日期</th><th className="px-6 py-3">部門</th><th className="px-6 py-3">人員</th><th className="px-6 py-3">描述</th><th className="px-6 py-3 text-center">附件</th><th className="px-6 py-3 text-center">狀態</th><th className="px-6 py-3 text-center">操作</th></tr></thead>
          <tbody>
            {filteredRecords.map((r) => (
              <tr key={r.id} className="bg-white border-b hover:bg-gray-50">
                <td className="px-6 py-4 whitespace-nowrap">{r.date}</td><td className="px-6 py-4"><span className="px-2 py-1 bg-slate-100 rounded text-xs">{r.department}</span></td><td className="px-6 py-4">{r.personName}</td><td className="px-6 py-4 max-w-xs truncate">{r.description}</td>
                <td className="px-6 py-4 text-center">{r.attachment ? <button onClick={() => onViewImage(r.attachment)} className="text-blue-500"><ImageIcon size={18}/></button> : '-'}</td>
                <td className="px-6 py-4 text-center"><span className={`px-2 py-1 rounded-full text-xs font-semibold ${r.status === '已改善' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{r.status}</span></td>
                <td className="px-6 py-4 text-center flex justify-center gap-2"><button onClick={() => onEdit(r)} className="text-blue-400 hover:text-blue-600"><Edit size={16} /></button>{currentUser.role === 'admin' && (<button onClick={() => onDelete(r.id)} className="text-gray-400 hover:text-red-600"><Trash2 size={16} /></button>)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// --- KPI System Components ---

const DEPARTMENT_COLORS = {
  '機構設計課': '#3b82f6', // Blue
  '工程中心': '#8b5cf6',   // Purple
  '多媒體設計課': '#ec4899', // Pink
  '電子設計課': '#10b981',   // Green
  '線材設計課': '#f97316',   // Orange (New)
};

const MONTH_ORDER = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

const DEPARTMENT_TEMPLATES = {
  '機構設計課': [
    { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '', status: 'Achieved', note: '' },
    { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '設計周期縮短', target: '10%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '新設計提案', target: '1項', actual: '', status: 'Achieved', note: '' },
  ],
  '線材設計課': [
    { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '', status: 'Achieved', note: '' },
    { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '設計周期縮短', target: '10%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '新設計提案', target: '1項', actual: '', status: 'Achieved', note: '' },
  ],
  '工程中心': [
    { category: '質量', name: 'ERP更新準確率', target: '≥ 99%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '設變單改BOM', target: '≥ 98%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '試作圖處理時間', target: '縮短10%', actual: '', status: 'Achieved', note: '' },
    { category: '準確性', name: '目錄命名規範', target: '100%', actual: '', status: 'Achieved', note: '' },
    { category: '維護性', name: '文件備份', target: '100%', actual: '', status: 'Achieved', note: '' },
  ],
  '多媒體設計課': [
    { category: '質量', name: '客戶滿意度', target: '≥ 100%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '按時交付率', target: '≥ 100%', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '每季新風格', target: '1項', actual: '', status: 'Achieved', note: '' },
  ],
  '電子設計課': [
    { category: '質量', name: '錯誤率', target: '≤ 1.5%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '開發時間縮短', target: '5%以上', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '問題改善案', target: '1項', actual: '', status: 'Achieved', note: '' },
  ]
};

const RAW_DATA_NOV = [
  {
    id: 1, name: '廖原頡', department: '機構設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '2%', status: 'Achieved', note: '錯誤2次/總數100次' },
      { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '98%', status: 'Achieved', note: '98次/100次' },
      { category: '效率', name: '設計周期縮短', target: '10%', actual: '8%', status: 'Warning', note: '未達標 (8% vs 10%)' },
      { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '2次', status: 'Achieved', note: '' },
      { category: '創新', name: '新設計提案', target: '1項', actual: '1項', status: 'Achieved', note: '' },
    ]
  },
  {
    id: 2, name: '劉素華', department: '機構設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '7%', status: 'Missed', note: '錯誤1次/總數14次 (未達成)' },
      { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '93%', status: 'Achieved', note: '13次/14次' },
      { category: '效率', name: '設計周期縮短', target: '10%', actual: '10%', status: 'Achieved', note: '目標達成' },
      { category: '效率', name: '月交付次數', target: '≥ 90%', actual: '100%', status: 'Achieved', note: '' },
      { category: '創新', name: '新設計提案', target: '100%', actual: '100%', status: 'Achieved', note: '' },
    ]
  },
  {
    id: 3, name: '李彥箴', department: '工程中心', month: '11月',
    metrics: [
      { category: '質量', name: 'ERP更新準確率', target: '≥ 99%', actual: '100%', status: 'Achieved', note: '無錯誤' },
      { category: '效率', name: '設變單改BOM', target: '≥ 98%', actual: '100%', status: 'Achieved', note: '7件全完成' },
      { category: '效率', name: '試作圖處理時間', target: '縮短10%', actual: '8%', status: 'Unknown', note: '無法評估 (資料完整度不一)' },
      { category: '準確性', name: '目錄命名規範', target: '100%', actual: '100%', status: 'Achieved', note: '無錯誤' },
      { category: '維護性', name: '文件備份', target: '100%', actual: '100%', status: 'Achieved', note: '歸檔完成' },
    ]
  },
  {
    id: 4, name: '黃佳雯', department: '多媒體設計課', month: '11月',
    metrics: [
      { category: '質量', name: '客戶滿意度', target: '≥ 100%', actual: '100%', status: 'Achieved', note: '滿意8次/總回饋8次' },
      { category: '創新', name: '每季新風格', target: '1項', actual: '1項', status: 'Achieved', note: '第一季風格達成' },
      { category: '效率', name: '按時交付率', target: '≥ 100%', actual: '100%', status: 'Achieved', note: '17次全按時' },
    ]
  },
  {
    id: 5, name: '王世昌', department: '電子設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 1.5%', actual: '1.3%', status: 'Achieved', note: '錯誤86行/總6495行' },
      { category: '效率', name: '開發時間縮短', target: '5%以上', actual: '12%', status: 'Achieved', note: '縮短1天 (12%)' },
      { category: '創新', name: '問題改善案', target: '1項', actual: '1項', status: 'Achieved', note: '馬達雜訊干擾改善' },
    ]
  },
  {
    id: 6, name: '黃泓銘', department: '線材設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '6%', status: 'Missed', note: '設變時遺漏刪除廢料 (96分)' },
      { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '94%', status: 'Achieved', note: '導入 SOLIDWORKS Electrical 模擬' },
      { category: '效率', name: '設計周期縮短', target: '10%', actual: '5%', status: 'Missed', note: '未達標 (48分)，但抓線材長度變快' },
      { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '3次', status: 'Achieved', note: '完成 D1141127-5 等3件' },
      { category: '創新', name: '新設計提案', target: '1項', actual: '1項', status: 'Achieved', note: 'F58B 使用保險絲座' },
    ]
  },
];

const generateHistory = () => {
  const history = [];
  const basePeople = RAW_DATA_NOV;
  basePeople.forEach(person => {
    for (let i = 0; i < 10; i++) { 
      const month = `${i + 1}月`;
      const mockMetrics = person.metrics.map(m => ({
        ...m,
        status: Math.random() > 0.8 ? 'Warning' : Math.random() > 0.9 ? 'Missed' : 'Achieved',
        actual: '模擬數據'
      }));
      history.push({
        id: Math.random(),
        name: person.name,
        department: person.department,
        month: month,
        metrics: mockMetrics
      });
    }
  });
  return [...history, ...RAW_DATA_NOV];
};

const StatusBadge = ({ status }) => {
  const styles = {
    Achieved: 'bg-green-100 text-green-800 border-green-200',
    Missed: 'bg-red-100 text-red-800 border-red-200',
    Warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    Unknown: 'bg-gray-100 text-gray-800 border-gray-200',
  };
  const labels = { Achieved: '達成', Missed: '未達成', Warning: '部分達成', Unknown: '無法評估' };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${styles[status] || styles.Unknown}`}>
      {labels[status] || status}
    </span>
  );
};

const KpiCard = ({ title, value, subtext, icon: Icon, trend }) => (
  <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
    <div className="flex justify-between items-start">
      <div>
        <p className="text-sm font-medium text-slate-500">{title}</p>
        <h3 className="text-2xl font-bold text-slate-900 mt-2">{value}</h3>
      </div>
      <div className={`p-2 rounded-lg ${trend === 'up' ? 'bg-green-50' : trend === 'down' ? 'bg-red-50' : 'bg-slate-50'}`}>
        <Icon className={`w-6 h-6 ${trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-slate-600'}`} />
      </div>
    </div>
    <div className="mt-4 flex items-center text-sm">
      <span className={trend === 'up' ? 'text-green-600 font-medium' : 'text-slate-600'}>
        {subtext}
      </span>
    </div>
  </div>
);

const KPIApp = ({ onBackToMenu }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [data, setData] = useState([]);
  const [selectedPerson, setSelectedPerson] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [dashboardMonth, setDashboardMonth] = useState('11月');
  const [analysisPerson, setAnalysisPerson] = useState('黃泓銘');
  const [formData, setFormData] = useState({ name: '', department: '', month: '12月', metrics: [] });

  useEffect(() => { setData(generateHistory()); }, []);

  const calculateRate = (metrics) => {
    if (!metrics || metrics.length === 0) return 0;
    const achieved = metrics.filter(m => m.status === 'Achieved').length;
    return Math.round((achieved / metrics.length) * 100);
  };

  const dashboardData = useMemo(() => data.filter(d => d.month === dashboardMonth), [data, dashboardMonth]);
  const totalMetrics = dashboardData.reduce((acc, curr) => acc + curr.metrics.length, 0);
  const achievedMetrics = dashboardData.reduce((acc, curr) => acc + curr.metrics.filter(m => m.status === 'Achieved').length, 0);
  const overallRate = totalMetrics > 0 ? Math.round((achievedMetrics / totalMetrics) * 100) : 0;
  const missedMetrics = dashboardData.flatMap(p => p.metrics.filter(m => m.status === 'Missed').map(m => ({ ...m, person: p.name, dept: p.department })));

  const departmentPerformance = useMemo(() => {
    const depts = {};
    dashboardData.forEach(person => {
      if (!depts[person.department]) depts[person.department] = { name: person.department, total: 0, achieved: 0, count: 0 };
      person.metrics.forEach(m => {
        depts[person.department].total += 1;
        if (m.status === 'Achieved') depts[person.department].achieved += 1;
      });
      depts[person.department].count += 1;
    });
    return Object.values(depts).map(d => ({ name: d.name, rate: d.total > 0 ? Math.round((d.achieved / d.total) * 100) : 0, headcount: d.count }));
  }, [dashboardData]);

  const analysisChartData = useMemo(() => {
    const personRecords = data.filter(d => d.name === analysisPerson);
    return MONTH_ORDER.map(month => {
      const record = personRecords.find(r => r.month === month);
      return { month, score: record ? calculateRate(record.metrics) : null };
    });
  }, [data, analysisPerson]);

  const analysisStats = useMemo(() => {
    const validScores = analysisChartData.filter(d => d.score !== null).map(d => d.score);
    if (validScores.length === 0) return { avg: 0, max: 0, min: 0 };
    return { avg: Math.round(validScores.reduce((a, b) => a + b, 0) / validScores.length), max: Math.max(...validScores), min: Math.min(...validScores) };
  }, [analysisChartData]);

  const uniquePeople = useMemo(() => [...new Set(data.map(d => d.name))], [data]);

  const handleFormChange = (e) => {
    const { name, value } = e.target;
    if (name === 'department') {
      const template = DEPARTMENT_TEMPLATES[value] || [];
      setFormData({ ...formData, [name]: value, metrics: JSON.parse(JSON.stringify(template)) });
    } else { setFormData({ ...formData, [name]: value }); }
  };

  const handleMetricChange = (index, field, value) => {
    const newMetrics = [...formData.metrics];
    newMetrics[index][field] = value;
    setFormData({ ...formData, metrics: newMetrics });
  };

  const addMetricRow = () => setFormData({ ...formData, metrics: [...formData.metrics, { category: '質量', name: '', target: '', actual: '', status: 'Achieved', note: '' }] });
  const removeMetricRow = (index) => setFormData({ ...formData, metrics: formData.metrics.filter((_, i) => i !== index) });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.name || !formData.department) return alert('請填寫完整資訊');
    setData([...data, { id: Date.now(), ...formData }]);
    alert(`已儲存 ${formData.name} 的資料！`);
    setFormData({ name: '', department: '', month: '12月', metrics: [] });
    setActiveTab('list');
  };

  const filteredData = data.filter(p => (p.name.includes(searchTerm) || p.department.includes(searchTerm)) && (dashboardMonth === 'All' ? true : p.month === dashboardMonth));

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      <nav className="bg-slate-900 text-white shadow-lg sticky top-0 z-30">
        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center space-x-3"><div className="p-2 bg-blue-600 rounded-lg"><Target className="w-6 h-6 text-white"/></div><span className="font-bold text-xl">KPI 績效系統</span></div>
          <div className="flex space-x-4">
            <button onClick={() => setActiveTab('dashboard')} className={`px-3 py-2 rounded-md text-sm font-medium flex items-center ${activeTab === 'dashboard' ? 'bg-slate-800 text-white' : 'text-slate-300 hover:text-white'}`}><LayoutDashboard className="w-4 h-4 mr-2"/>儀表板</button>
            <button onClick={() => setActiveTab('analysis')} className={`px-3 py-2 rounded-md text-sm font-medium flex items-center ${activeTab === 'analysis' ? 'bg-slate-800 text-white' : 'text-slate-300 hover:text-white'}`}><LineChartIcon className="w-4 h-4 mr-2"/>個人分析</button>
            <button onClick={() => setActiveTab('list')} className={`px-3 py-2 rounded-md text-sm font-medium flex items-center ${activeTab === 'list' ? 'bg-slate-800 text-white' : 'text-slate-300 hover:text-white'}`}><FileText className="w-4 h-4 mr-2"/>報表</button>
            <button onClick={() => setActiveTab('entry')} className={`px-3 py-2 rounded-md text-sm font-medium flex items-center ${activeTab === 'entry' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:text-white'}`}><PlusCircle className="w-4 h-4 mr-2"/>新增</button>
            <button onClick={onBackToMenu} className="px-3 py-2 rounded-md text-sm font-medium flex items-center bg-red-600 text-white hover:bg-red-700 ml-4"><LogOut className="w-4 h-4 mr-2"/>返回選單</button>
          </div>
        </div>
      </nav>
      <main className="max-w-7xl mx-auto px-4 py-8">
        <div className="mb-8"><h1 className="text-2xl font-bold">{activeTab === 'dashboard' ? '績效儀表板' : activeTab === 'analysis' ? '年度個人分析' : activeTab === 'list' ? '詳細報表' : '資料填寫'}</h1></div>
        {activeTab === 'dashboard' && (
          <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100">
              <div className="flex items-center space-x-2"><Calendar className="w-5 h-5 text-blue-600" /><span className="font-bold text-slate-700">數據月份：</span><select value={dashboardMonth} onChange={(e) => setDashboardMonth(e.target.value)} className="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg p-2 outline-none font-medium">{MONTH_ORDER.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
              <div className="text-sm text-slate-500">顯示 {dashboardData.length} 筆資料</div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <KpiCard title="該月總達成率" value={`${overallRate}%`} subtext="KPI 指標平均" icon={TrendingUp} trend="up" />
              <KpiCard title="評核人數" value={dashboardData.length.toString()} subtext={`${dashboardMonth} 份數`} icon={Users} trend="neutral" />
              <KpiCard title="待改善項目" value={missedMetrics.length.toString()} subtext="未達標總數" icon={AlertCircle} trend="down" />
              <KpiCard title="完美達成" value={dashboardData.filter(p => calculateRate(p.metrics) === 100).length.toString()} subtext="達成率 100%" icon={CheckCircle2} trend="up" />
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-2"><h3 className="text-lg font-bold text-slate-800 mb-4">{dashboardMonth} - 部門績效總覽</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><BarChart data={departmentPerformance} layout="vertical" margin={{ left: 40 }}><CartesianGrid strokeDasharray="3 3" horizontal={false} /><XAxis type="number" domain={[0, 100]} unit="%" /><YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} /><RechartsTooltip cursor={{fill: '#f8fafc'}} /><Bar dataKey="rate" name="達成率" radius={[0, 4, 4, 0]}>{departmentPerformance.map((entry, index) => (<Cell key={`cell-${index}`} fill={DEPARTMENT_COLORS[entry.name] || '#cbd5e1'} />))}</Bar></BarChart></ResponsiveContainer></div></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center text-red-600"><AlertCircle className="w-5 h-5 mr-2" /> {dashboardMonth} 異常項目</h3><div className="space-y-4 max-h-64 overflow-y-auto pr-2">{missedMetrics.length > 0 ? (missedMetrics.map((item, idx) => (<div key={idx} className="p-3 bg-red-50 rounded-lg border border-red-100"><div className="flex justify-between items-center mb-1"><span className="font-bold text-slate-700">{item.person}</span><span className="text-xs text-slate-500 bg-white px-2 py-0.5 rounded border">{item.dept}</span></div><div className="text-sm text-red-700 font-medium">{item.name}</div><div className="text-xs text-red-600 mt-1">目標: {item.target} | 實際: {item.actual}</div></div>))) : (<div className="text-center py-8 text-slate-400">本月無異常項目，表現優異！</div>)}</div></div>
            </div>
          </div>
        )}
        {activeTab === 'analysis' && (
          <div className="space-y-6 animate-fade-in">
             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
               <div className="flex flex-col md:flex-row justify-between items-center mb-6"><h3 className="text-lg font-bold text-slate-800 flex items-center mb-4 md:mb-0"><LineChartIcon className="w-6 h-6 mr-2 text-purple-600" />個人年度績效趨勢</h3><div className="flex items-center space-x-3"><span className="text-sm font-medium text-slate-600">選擇分析對象：</span><select value={analysisPerson} onChange={(e) => setAnalysisPerson(e.target.value)} className="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg p-2 outline-none font-medium min-w-[150px]">{uniquePeople.map(p => <option key={p} value={p}>{p}</option>)}</select></div></div>
               <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6"><div className="bg-purple-50 p-4 rounded-lg text-center"><p className="text-xs text-purple-600 font-bold uppercase">年度平均分</p><p className="text-3xl font-bold text-purple-900 mt-1">{analysisStats.avg}</p></div><div className="bg-green-50 p-4 rounded-lg text-center"><p className="text-xs text-green-600 font-bold uppercase">歷史最高分</p><p className="text-3xl font-bold text-green-900 mt-1">{analysisStats.max}</p></div><div className="bg-slate-50 p-4 rounded-lg text-center"><p className="text-xs text-slate-500 font-bold uppercase">歷史最低分</p><p className="text-3xl font-bold text-slate-700 mt-1">{analysisStats.min}</p></div><div className="bg-blue-50 p-4 rounded-lg text-center"><p className="text-xs text-blue-600 font-bold uppercase">所屬部門</p><p className="text-lg font-bold text-blue-900 mt-2">{data.find(d => d.name === analysisPerson)?.department || 'N/A'}</p></div></div>
               <div className="h-80 w-full"><ResponsiveContainer width="100%" height="100%"><LineChart data={analysisChartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="month" /><YAxis domain={[0, 100]} /><RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} /><Legend /><Line type="monotone" dataKey="score" name="KPI 達成率" stroke="#8b5cf6" strokeWidth={3} activeDot={{ r: 8 }} connectNulls={true} /></LineChart></ResponsiveContainer></div>
             </div>
          </div>
        )}
        {activeTab === 'list' && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
            <div className="p-4 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4"><h3 className="text-lg font-bold text-slate-800 flex items-center"><span className="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded mr-2">{dashboardMonth}</span>員工列表</h3><div className="relative w-full sm:w-64"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" /><input type="text" placeholder="搜尋姓名或部門..." className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div></div>
            <div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-100"><tr><th className="p-4">姓名</th><th className="p-4">部門</th><th className="p-4">月份</th><th className="p-4 text-center">達成率</th><th className="p-4">狀態</th><th className="p-4">操作</th></tr></thead><tbody className="divide-y divide-slate-100">{filteredData.length > 0 ? filteredData.map((person) => { const rate = calculateRate(person.metrics); return (<tr key={person.id} className="hover:bg-slate-50 transition-colors"><td className="p-4 font-medium text-slate-900">{person.name}</td><td className="p-4"><span className="px-2 py-1 bg-slate-100 rounded text-slate-600 text-xs">{person.department}</span></td><td className="p-4 text-slate-500">{person.month}</td><td className="p-4 text-center"><div className="flex items-center justify-center space-x-2"><div className="w-16 bg-slate-200 rounded-full h-1.5"><div className={`h-1.5 rounded-full ${rate === 100 ? 'bg-green-500' : rate >= 80 ? 'bg-yellow-500' : 'bg-red-500'}`} style={{ width: `${rate}%` }}></div></div><span className="text-xs">{rate}%</span></div></td><td className="p-4">{rate === 100 ? <span className="text-green-600 flex items-center text-xs font-bold"><CheckCircle2 className="w-3 h-3 mr-1"/> 優異</span> : rate < 80 ? <span className="text-red-600 flex items-center text-xs font-bold"><AlertCircle className="w-3 h-3 mr-1"/> 需改善</span> : <span className="text-yellow-600 flex items-center text-xs font-bold"><TrendingUp className="w-3 h-3 mr-1"/> 良好</span>}</td><td className="p-4"><button onClick={() => setSelectedPerson(person)} className="text-blue-600 hover:text-blue-800 font-medium text-xs flex items-center">查看 <ChevronRight className="w-3 h-3 ml-1" /></button></td></tr>); }) : (<tr><td colSpan="6" className="p-8 text-center text-slate-400">沒有找到 {dashboardMonth} 符合條件的資料</td></tr>)}</tbody></table></div>
          </div>
        )}
        {activeTab === 'entry' && (
          <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-slate-100 p-6">
             <div className="border-b border-slate-100 pb-4 mb-6"><h3 className="text-lg font-bold text-slate-800 flex items-center"><PlusCircle className="w-5 h-5 mr-2 text-blue-600" /> 新增資料</h3><p className="text-slate-500 text-sm mt-1">選部門自動帶入指標</p></div>
             <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label className="block text-sm font-medium mb-1">姓名</label><input type="text" name="name" value={formData.name} onChange={handleFormChange} className="w-full p-2 border rounded focus:border-blue-500 outline-none" required /></div><div><label className="block text-sm font-medium mb-1">部門</label><select name="department" value={formData.department} onChange={handleFormChange} className="w-full p-2 border rounded focus:border-blue-500 outline-none" required><option value="" disabled>請選擇</option>{Object.keys(DEPARTMENT_COLORS).map(dept => <option key={dept} value={dept}>{dept}</option>)}</select></div><div><label className="block text-sm font-medium mb-1">月份</label><select name="month" value={formData.month} onChange={handleFormChange} className="w-full p-2 border rounded focus:border-blue-500 outline-none">{MONTH_ORDER.map(m => <option key={m} value={m}>{m}</option>)}</select></div></div>
                <div><div className="flex justify-between items-center mb-2"><label className="font-bold">指標明細</label><div className="space-x-2"><button type="button" onClick={() => {if(formData.department) setFormData({...formData, metrics: JSON.parse(JSON.stringify(DEPARTMENT_TEMPLATES[formData.department]))})}} className="text-xs bg-slate-100 px-3 py-1 rounded hover:bg-slate-200"><RefreshCw className="w-3 h-3 inline mr-1"/>重置</button><button type="button" onClick={addMetricRow} className="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100"><PlusCircle className="w-3 h-3 inline mr-1"/>新增</button></div></div>{formData.metrics.length === 0 ? <p className="text-center py-8 bg-slate-50 text-slate-400 rounded">請先選擇部門</p> : <div className="space-y-3">{formData.metrics.map((m, i) => (<div key={i} className="flex flex-col md:flex-row gap-2 p-3 bg-slate-50 rounded border border-slate-200 items-start md:items-center"><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">類別</span><input value={m.category} onChange={e => handleMetricChange(i, 'category', e.target.value)} className="w-full p-1 text-sm border rounded"/></div><div className="flex-1"><span className="text-xs text-slate-500 block">項目</span><input value={m.name} onChange={e => handleMetricChange(i, 'name', e.target.value)} className="w-full p-1 text-sm border rounded"/></div><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">目標</span><input value={m.target} onChange={e => handleMetricChange(i, 'target', e.target.value)} className="w-full p-1 text-sm border rounded"/></div><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">實際</span><input value={m.actual} onChange={e => handleMetricChange(i, 'actual', e.target.value)} className="w-full p-1 text-sm border rounded bg-white"/></div><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">狀態</span><select value={m.status} onChange={e => handleMetricChange(i, 'status', e.target.value)} className="w-full p-1 text-sm border rounded"><option value="Achieved">達成</option><option value="Missed">未達成</option><option value="Warning">部分</option><option value="Unknown">未知</option></select></div><button type="button" onClick={() => removeMetricRow(i)} className="text-red-400 hover:text-red-600 p-2"><Trash2 className="w-4 h-4"/></button></div>))}</div>}</div>
                <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-bold flex justify-center items-center"><Save className="w-5 h-5 mr-2"/>儲存</button>
             </form>
          </div>
        )}
      </main>
      {selectedPerson && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10"><div><h2 className="text-2xl font-bold">{selectedPerson.name}</h2><p className="text-sm text-slate-500">{selectedPerson.department} | {selectedPerson.month}</p></div><button onClick={() => setSelectedPerson(null)}><X className="w-6 h-6 text-slate-400 hover:text-slate-600"/></button></div>
            <div className="p-6"><div className="mb-6"><h4 className="font-bold mb-2">指標明細</h4><div className="border rounded-lg overflow-hidden"><table className="w-full text-sm"><thead className="bg-slate-50 text-slate-600"><tr><th className="p-3 text-left">類別</th><th className="p-3 text-left">項目</th><th className="p-3">目標/實際</th><th className="p-3">狀態</th><th className="p-3">備註</th></tr></thead><tbody className="divide-y">{selectedPerson.metrics.map((m, i) => (<tr key={i}><td className="p-3 text-slate-500">{m.category}</td><td className="p-3 font-medium">{m.name}</td><td className="p-3">{m.target} <span className="text-slate-400">/</span> <span className="font-bold text-blue-600">{m.actual}</span></td><td className="p-3"><StatusBadge status={m.status}/></td><td className="p-3 text-slate-500 text-xs">{m.note}</td></tr>))}</tbody></table></div></div></div>
          </div>
        </div>
      )}
    </div>
  );
};

// --- Main App Component (TQM) ---
const TQMApp = ({ appUser, onLogout, onBackToMenu }) => {
  const [records, setRecords] = useState([]);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [viewImage, setViewImage] = useState(null); 
  const [editingRecord, setEditingRecord] = useState(null);
  const [importEncoding, setImportEncoding] = useState('Big5'); // Default to Big5 for Excel compatibility

  useEffect(() => {
    if (!appUser) return;
    const unsubscribe = db.subscribe('tqm_records', (data) => {
      const sorted = [...data].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      setRecords(sorted);
    });
    return () => unsubscribe();
  }, [appUser]);

  const handleLogout = onLogout;

  const handleAddRecord = async (formData) => {
    try {
      await db.addDoc('tqm_records', { ...formData, createdAt: new Date().toISOString(), userId: appUser.id, createdByUser: appUser.username });
      alert('TQM紀錄已新增！'); setActiveTab('list');
    } catch (e) { console.error("Error adding document: ", e); alert('新增失敗: ' + (e.toString().includes("exceeds") ? "檔案過大" : "請重試")); }
  };

  const handleUpdateRecord = async (id, updatedData) => {
    try { await db.updateDoc('tqm_records', id, { ...updatedData, updatedAt: new Date().toISOString(), updatedByUser: appUser.username }); setEditingRecord(null); } catch (e) { console.error("Error updating document: ", e); alert('更新失敗，請重試。'); }
  };

  const handleDelete = async (id) => { if (!confirm('確定要刪除此筆紀錄嗎？')) return; try { await db.deleteDoc('tqm_records', id); } catch (e) { console.error("Error deleting: ", e); } };

  const handleImportCSV = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        const text = event.target.result;
        const cleanText = text.charCodeAt(0) === 0xFEFF ? text.slice(1) : text;
        const rows = parseCSV(cleanText);
        if (rows.length < 2) return alert("CSV 格式錯誤");
        const header = rows[0].map(h => h.trim());
        const dataRows = rows.slice(1);
        const getColIndex = (names) => header.findIndex(h => names.some(n => h.includes(n)));
        const colMap = {
          date: getColIndex(['日期']), legacyMonth: getColIndex(['月份']), dept: getColIndex(['部門', '課別']),
          person: getColIndex(['人員', '姓名']), type: getColIndex(['回報類型', 'TQM回報類型']), desc: getColIndex(['問題描述', '異常描述', 'TQM回報問題/異常描述']),
          repeat: getColIndex(['重複']), status: getColIndex(['狀態', '改善狀態']), method: getColIndex(['改善對策', '永久改善措施']), note: getColIndex(['備註', '訊息'])
        };
        if (colMap.dept === -1 || colMap.desc === -1) return alert("無法辨識 CSV 格式，請確認標題列是否正確。");
        let count = 0;
        const currentYear = new Date().getFullYear();
        for (const row of dataRows) {
          if (row.length < 2) continue;
          let recordDate = new Date().toISOString().split('T')[0];
          if (colMap.date !== -1 && row[colMap.date]) {
             const dStr = row[colMap.date].trim();
             // Normalize date format YYYY/MM/DD -> YYYY-MM-DD
             const parts = dStr.split(/[\/\-\.]/);
             if (parts.length === 3) {
                recordDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
             } else {
                recordDate = dStr;
             }
          }
          else if (colMap.legacyMonth !== -1 && row[colMap.legacyMonth]) {
            const m = row[colMap.legacyMonth].match(/(\d+)/)?.[1].padStart(2, '0');
            if(m) recordDate = `${currentYear}-${m}-01`;
          }
          const dept = DEPARTMENTS.find(d => (row[colMap.dept]||'').includes(d)) || (row[colMap.dept]||'其他');
          const isRepeat = (colMap.repeat !== -1 ? row[colMap.repeat] : '').includes('是');
          const status = (colMap.status !== -1 ? row[colMap.status] : '').includes('已改善') ? '已改善' : '未改善';
          await db.addDoc('tqm_records', {
            date: recordDate, department: dept, personName: (colMap.person !== -1 ? row[colMap.person] : '匯入資料').trim(),
            issueType: (colMap.type !== -1 ? row[colMap.type] : '其他').trim(), description: (colMap.desc !== -1 ? row[colMap.desc] : '').trim(),
            isRepeat: isRepeat, status: status, improvementMethod: colMap.method !== -1 ? row[colMap.method] : '',
            note: colMap.note !== -1 ? row[colMap.note] : '批量匯入',
            createdAt: new Date().toISOString(), userId: appUser.id, createdByUser: appUser.username
          });
          count++;
        }
        alert(`成功匯入 ${count} 筆資料！`); e.target.value = null;
      } catch (error) { alert("匯入失敗：" + error.message); }
    };
    reader.readAsText(file, importEncoding);
  };

  // --- New DB Import/Export Handlers ---
  const handleImportDB = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (!data.users || !data.records) throw new Error('格式錯誤');
        db.importData(data);
        alert('資料庫載入成功！');
        window.location.reload(); 
      } catch (err) { alert('載入失敗：' + err.message); }
    };
    reader.readAsText(file);
  };

  const handleExportDB = () => {
    const data = db.exportData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TQM_Database_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
  };

  const stats = useMemo(() => {
    const total = records.length;
    const resolved = records.filter(r => r.status === '已改善').length;
    const unresolved = total - resolved;
    const repeats = records.filter(r => r.isRepeat).length;
    return { total, resolved, unresolved, repeats, improvementRate: total > 0 ? ((resolved / total) * 100).toFixed(1) : 0, repeatRate: total > 0 ? ((repeats / total) * 100).toFixed(1) : 0 };
  }, [records]);

  const chartData = useMemo(() => {
    const trendMap = {}; MONTHS.forEach(m => trendMap[m] = { name: m, 案件數: 0, 重複: 0 });
    const deptMap = {}; DEPARTMENTS.forEach(d => deptMap[d] = { name: d, value: 0 });
    const typeMap = {};
    records.forEach(r => {
      const m = MONTHS[new Date(r.date).getMonth()];
      if (trendMap[m]) { trendMap[m].案件數++; if(r.isRepeat) trendMap[m].重複++; }
      if (deptMap[r.department]) deptMap[r.department].value++;
      if (!typeMap[r.issueType]) typeMap[r.issueType] = { name: r.issueType, value: 0 };
      typeMap[r.issueType].value++;
    });
    return { trendData: Object.values(trendMap), deptData: Object.values(deptMap).filter(d => d.value > 0), typeData: Object.values(typeMap) };
  }, [records]);

  const handleExportCSV = () => {
    if (records.length === 0) return alert("無資料可匯出");
    const headers = ["日期", "部門", "人員", "TQM回報類型", "重複發生", "改善狀態", "問題描述", "改善對策", "備註/訊息", "有無附件"];
    const csvString = '\uFEFF' + [headers.join(','), ...records.map(r => [
      r.date, r.department, r.personName, r.issueType, r.isRepeat?"是":"否", r.status,
      `"${(r.description||'').replace(/"/g,'""')}"`, `"${(r.improvementMethod||'').replace(/"/g,'""')}"`,
      `"${(r.note||'').replace(/"/g,'""')}"`, r.attachment?"有":"無"
    ].join(','))].join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csvString], {type:'text/csv'}));
    a.download = `TQM_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  };

  return (
    <div className="min-h-screen bg-slate-50 flex font-sans text-slate-900">
      {viewImage && <ImageModal src={viewImage} onClose={() => setViewImage(null)} />}
      {editingRecord && <EditRecordModal record={editingRecord} onClose={() => setEditingRecord(null)} onUpdate={handleUpdateRecord} />}

      <aside className="w-64 bg-slate-900 text-white flex-shrink-0 hidden md:flex flex-col">
        <div className="p-6 border-b border-slate-700">
          <h1 className="text-xl font-bold flex items-center gap-2"><CheckCircle2 className="text-blue-400" />TQM 管理系統</h1>
          <div className="mt-4 flex items-center gap-3 bg-slate-800 p-3 rounded-lg">
             <div className="bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">{appUser.displayName[0]}</div>
             <div><p className="text-sm font-medium">{appUser.displayName}</p><p className="text-xs text-slate-400 flex items-center gap-1">{appUser.role === 'admin' ? <Shield size={10} className="text-purple-400"/> : <User size={10}/>}{appUser.role === 'admin' ? '系統管理員' : '一般使用者'}</p></div>
          </div>
        </div>
        <nav className="flex-1 p-4 space-y-2">
          <NavButton active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={LayoutDashboard} label="總覽儀表板" />
          <NavButton active={activeTab === 'entry'} onClick={() => setActiveTab('entry')} icon={PlusCircle} label="新增紀錄" />
          <NavButton active={activeTab === 'list'} onClick={() => setActiveTab('list')} icon={List} label="紀錄清單" />
          <NavButton active={activeTab === 'analysis'} onClick={() => setActiveTab('analysis')} icon={BarChart3} label="統計分析" />
          {appUser.role === 'admin' && (<><div className="border-t border-slate-700 my-2 pt-2 text-xs text-slate-500 px-3">管理功能</div><NavButton active={activeTab === 'users'} onClick={() => setActiveTab('users')} icon={Users} label="帳號管理" /></>)}
        </nav>
        <div className="p-4 border-t border-slate-800 space-y-2">
          <button onClick={handleExportDB} className="w-full flex items-center justify-center gap-2 text-green-400 hover:text-green-300 transition-colors py-2 text-sm border border-slate-700 rounded hover:bg-slate-800">
             <FileJson size={16} /> 匯出資料庫 (備份)
          </button>
          <button onClick={onBackToMenu} className="w-full flex items-center justify-center gap-2 text-red-400 hover:text-red-300 transition-colors py-2 text-sm border border-slate-700 rounded hover:bg-slate-800">
             <LogOut size={16} /> 返回選單
          </button>
        </div>
      </aside>

      <div className="md:hidden fixed top-0 w-full bg-slate-900 text-white z-50 p-4 flex justify-between items-center">
        <span className="font-bold">TQM System</span>
        <button onClick={handleLogout}><LogOut size={20} /></button>
      </div>

      <main className="flex-1 p-4 md:p-8 overflow-y-auto mt-12 md:mt-0">
        {activeTab === 'dashboard' && (
          <div className="space-y-6 max-w-7xl mx-auto">
             <header className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-slate-800">年度 TQM 總覽</h2><button onClick={handleExportCSV} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors shadow-sm"><Download size={16} /> 匯出報表</button></header>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <StatCard title="年度總回報件數" value={stats.total} subtext="累積案件" icon={List} colorClass="bg-blue-500 text-blue-600" />
              <StatCard title="改善率" value={`${stats.improvementRate}%`} subtext={`已改善: ${stats.resolved} 件`} icon={CheckCircle2} colorClass="bg-green-500 text-green-600" />
              <StatCard title="重複發生件數" value={stats.repeats} subtext={`重複率: ${stats.repeatRate}%`} icon={AlertCircle} colorClass="bg-red-500 text-red-600" />
              <StatCard title="待處理案件" value={stats.unresolved} subtext="需追蹤進度" icon={Filter} colorClass="bg-orange-500 text-orange-600" />
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
               <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-80"><ResponsiveContainer><LineChart data={chartData.trendData}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name"/><YAxis/><Tooltip/><Legend/><Line type="monotone" dataKey="案件數" stroke="#3b82f6"/><Line type="monotone" dataKey="重複" stroke="#ef4444"/></LineChart></ResponsiveContainer></div>
               <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-80"><ResponsiveContainer><PieChart><Pie data={chartData.typeData} cx="50%" cy="50%" outerRadius={80} fill="#8884d8" dataKey="value" label>{chartData.typeData.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Pie><Tooltip/></PieChart></ResponsiveContainer></div>
            </div>
          </div>
        )}
        {activeTab === 'entry' && (<div className="max-w-2xl mx-auto"><h2 className="text-2xl font-bold text-slate-800 mb-6">新增 TQM 紀錄</h2><EntryForm onSubmit={handleAddRecord} currentUser={appUser} /></div>)}
        {activeTab === 'list' && (
          <div className="max-w-7xl mx-auto space-y-6">
            <div className="flex justify-between items-end"><h2 className="text-2xl font-bold text-slate-800">歷史紀錄清單</h2>
            <div className="flex items-center gap-2">
              <select value={importEncoding} onChange={e=>setImportEncoding(e.target.value)} className="text-sm border border-gray-300 rounded-lg p-2 bg-white">
                <option value="UTF-8">UTF-8</option>
                <option value="Big5">Big5 (Excel)</option>
              </select>
              <label className="flex items-center gap-2 cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm transition-colors border border-blue-200 shadow-sm"><Import size={16} /><span>匯入舊資料 (CSV)</span><input type="file" accept=".csv" onChange={handleImportCSV} className="hidden" /></label>
            </div></div>
            <RecordTable records={records} onDelete={handleDelete} onViewImage={setViewImage} onEdit={setEditingRecord} currentUser={appUser} />
          </div>
        )}
        {activeTab === 'analysis' && (
           <div className="max-w-7xl mx-auto space-y-6">
             <h2 className="text-2xl font-bold text-slate-800 mb-6">進階統計分析</h2>
             <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96"><h3 className="mb-4 font-bold">部門案件統計</h3><ResponsiveContainer><BarChart data={chartData.deptData} layout="vertical"><CartesianGrid horizontal vertical={false}/><XAxis type="number"/><YAxis dataKey="name" type="category" width={80}/><Tooltip/><Bar dataKey="value" fill="#6366f1"/></BarChart></ResponsiveContainer></div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96 overflow-y-auto"><h3 className="mb-4 font-bold">類型排行</h3><table className="w-full text-sm text-left"><thead><tr className="bg-gray-50"><th className="p-2">類型</th><th className="p-2">數量</th></tr></thead><tbody>{chartData.typeData.sort((a,b)=>b.value-a.value).map(d=><tr key={d.name} className="border-b"><td className="p-2">{d.name}</td><td className="p-2">{d.value}</td></tr>)}</tbody></table></div>
             </div>
           </div>
        )}
        {activeTab === 'users' && appUser.role === 'admin' && (<UserManagement currentUser={appUser} />)}
      </main>
    </div>
  );
}

// --- Project Management System (R&D Nexus) ---



// --- Components ---

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
          <h2 className="text-xl font-bold text-slate-800">{title}</h2>
          <button onClick={onClose} className="p-1 hover:bg-slate-100 rounded-full transition-colors">
            <X size={20} className="text-slate-400" />
          </button>
        </div>
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>
  );
};

const TaskForm = ({ onSubmit, initialData, onCancel }) => {
  const [formData, setFormData] = useState(initialData || {
    title: '',
    status: 'To Do',
    owner: '',
    priority: 'P2',
    risk: false
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">任務標題</label>
        <input 
          type="text" 
          required
          className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          value={formData.title}
          onChange={e => setFormData({...formData, title: e.target.value})}
        />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">負責人</label>
          <input 
            type="text" 
            required
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.owner}
            onChange={e => setFormData({...formData, owner: e.target.value})}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">狀態</label>
          <select 
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.status}
            onChange={e => setFormData({...formData, status: e.target.value})}
          >
            <option value="To Do">To Do</option>
            <option value="Doing">Doing</option>
            <option value="Testing">Testing</option>
            <option value="Done">Done</option>
          </select>
        </div>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">優先級</label>
          <select 
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.priority}
            onChange={e => setFormData({...formData, priority: e.target.value})}
          >
            <option value="P1">P1 (High)</option>
            <option value="P2">P2 (Medium)</option>
            <option value="P3">P3 (Low)</option>
          </select>
        </div>
        <div className="flex items-center pt-6">
          <label className="flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              className="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500"
              checked={formData.risk}
              onChange={e => setFormData({...formData, risk: e.target.checked})}
            />
            <span className="ml-2 text-sm text-slate-700">標記為高風險</span>
          </label>
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-4">
        <button type="button" onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium">取消</button>
        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">儲存任務</button>
      </div>
    </form>
  );
};

const ProjectForm = ({ onSubmit, initialData, onCancel }) => {
  const [formData, setFormData] = useState(initialData || {
    name: '',
    owner: '',
    department: '研發部',
    stage: '規劃',
    progress: 0,
    status: 'normal',
    deadline: '',
    category: '新產品'
  });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">專案名稱</label>
        <input 
          type="text" 
          name="name"
          required
          className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          value={formData.name}
          onChange={handleChange}
        />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">負責人</label>
          <input 
            type="text" 
            name="owner"
            required
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.owner}
            onChange={handleChange}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">部門</label>
          <select 
            name="department"
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.department}
            onChange={handleChange}
          >
            <option value="業務部">業務部</option>
            <option value="研發部">研發部</option>
            <option value="線材部">線材部</option>
            <option value="多媒體部">多媒體部</option>
            <option value="工程中心">工程中心</option>
            <option value="製造部">製造部</option>
          </select>
        </div>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">階段</label>
          <input 
            type="text" 
            name="stage"
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.stage}
            onChange={handleChange}
            placeholder="e.g. 規劃, 開發, 測試"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">進度 (%)</label>
          <input 
            type="number" 
            name="progress"
            min="0"
            max="100"
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.progress}
            onChange={handleChange}
          />
        </div>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">狀態</label>
          <select 
            name="status"
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.status}
            onChange={handleChange}
          >
            <option value="normal">正常 (Normal)</option>
            <option value="risk">風險 (Risk)</option>
            <option value="delay">延遲 (Delay)</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">截止日期</label>
          <input 
            type="date" 
            name="deadline"
            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={formData.deadline}
            onChange={handleChange}
          />
        </div>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">類別</label>
        <input 
          type="text" 
          name="category"
          className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          value={formData.category}
          onChange={handleChange}
          placeholder="e.g. 新產品, 改款, 內部案"
        />
      </div>
      <div className="flex justify-end gap-3 pt-4">
        <button type="button" onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium">取消</button>
        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">儲存專案</button>
      </div>
    </form>
  );
};

const ChangeForm = ({ onSubmit, onCancel }) => {
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    type: '設計改善',
    desc: '',
    owner: '',
    impact: 'Low'
  });

  return (
    <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">日期</label>
          <input type="date" required className="w-full px-3 py-2 border border-slate-200 rounded-lg" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">類型</label>
          <select className="w-full px-3 py-2 border border-slate-200 rounded-lg" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}>
            <option>設計改善</option><option>設計疏失</option><option>客戶修改</option><option>料件問題</option>
          </select>
        </div>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">變更描述</label>
        <textarea required className="w-full px-3 py-2 border border-slate-200 rounded-lg" rows="3" value={formData.desc} onChange={e => setFormData({...formData, desc: e.target.value})}></textarea>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">發起人</label>
          <input type="text" required className="w-full px-3 py-2 border border-slate-200 rounded-lg" value={formData.owner} onChange={e => setFormData({...formData, owner: e.target.value})} />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">衝擊度</label>
          <select className="w-full px-3 py-2 border border-slate-200 rounded-lg" value={formData.impact} onChange={e => setFormData({...formData, impact: e.target.value})}>
            <option>Low</option><option>Medium</option><option>High</option>
          </select>
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-4">
        <button type="button" onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium">取消</button>
        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">提交變更</button>
      </div>
    </form>
  );
};

const ProjectStatusBadge = ({ status }) => {
  const styles = {
    normal: 'bg-emerald-100 text-emerald-700 border-emerald-200',
    risk: 'bg-amber-100 text-amber-700 border-amber-200',
    delay: 'bg-rose-100 text-rose-700 border-rose-200',
  };
  
  const labels = {
    normal: '正常',
    risk: '風險',
    delay: '延遲',
  };

  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium border ${styles[status] || styles.normal}`}>
      {labels[status] || status}
    </span>
  );
};

const PriorityBadge = ({ priority }) => {
  const styles = {
    P1: 'bg-red-100 text-red-700',
    P2: 'bg-orange-100 text-orange-700',
    P3: 'bg-blue-100 text-blue-700',
  };
  return <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${styles[priority]}`}>{priority}</span>;
};

// --- Views ---

const MachineForm = ({ initialData, onSubmit, onCancel }) => {
  const [formData, setFormData] = useState(initialData || {
    name: '',
    code: '',
    status: 'Active',
    progress: 0,
    image: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&w=300&q=80',
    members: ''
  });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  return (
    <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">機台名稱 (Machine Name)</label>
        <input name="name" value={formData.name} onChange={handleChange} required className="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">代碼 (Code)</label>
          <input name="code" value={formData.code} onChange={handleChange} required className="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">狀態 (Status)</label>
          <select name="status" value={formData.status} onChange={handleChange} className="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <option value="Active">Active</option>
            <option value="Warning">Warning</option>
            <option value="Maintenance">Maintenance</option>
          </select>
        </div>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">進度 (Progress %)</label>
        <input type="number" name="progress" value={formData.progress} onChange={handleChange} min="0" max="100" className="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">專案成員 (Members)</label>
        <input name="members" value={formData.members} onChange={handleChange} className="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="請輸入成員名稱，多人請用逗號分隔" />
        <p className="text-xs text-slate-500 mt-1">例如：張三, 李四, 王五</p>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">圖片連結 (Image URL)</label>
        <input name="image" value={formData.image} onChange={handleChange} className="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://..." />
        {formData.image && (
            <div className="mt-2 h-32 w-full bg-slate-100 rounded-lg overflow-hidden border border-slate-200">
                <img src={formData.image} alt="Preview" className="w-full h-full object-cover" onError={(e) => e.target.src = 'https://via.placeholder.com/300?text=Image+Error'} />
            </div>
        )}
      </div>
      <div className="flex justify-end gap-2 pt-4 border-t border-slate-100">
        <button type="button" onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">取消</button>
        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">儲存</button>
      </div>
    </form>
  );
};

const MachineSelectionView = ({ machines, onSelect, onBack, onAddMachine, onUpdateMachine }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingMachine, setEditingMachine] = useState(null);

  const handleOpenAdd = () => {
    setEditingMachine(null);
    setIsModalOpen(true);
  };

  const handleOpenEdit = (machine, e) => {
    e.stopPropagation();
    setEditingMachine(machine);
    setIsModalOpen(true);
  };

  const handleSubmit = (data) => {
    if (editingMachine) {
        onUpdateMachine({ ...editingMachine, ...data });
    } else {
        onAddMachine(data);
    }
    setIsModalOpen(false);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-8 animate-fade-in">
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingMachine ? "編輯機台專案" : "新增機台專案"}>
        <MachineForm initialData={editingMachine} onSubmit={handleSubmit} onCancel={() => setIsModalOpen(false)} />
      </Modal>

      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-8">
          <div>
            <button onClick={onBack} className="flex items-center text-slate-500 hover:text-slate-700 mb-2">
              <ArrowRight className="rotate-180 mr-2" size={20} /> 返回系統選單
            </button>
            <h1 className="text-3xl font-bold text-slate-800">產品機台專案選擇分析</h1>
            <p className="text-slate-500 mt-1">請選擇要管理的產品機台專案 (Product Machine Project)</p>
          </div>
          <div className="flex gap-3">
             <div className="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-emerald-500"></div>
                <span className="text-sm font-medium text-slate-600">運作正常: {machines.filter(m => m.status === 'Active').length}</span>
             </div>
             <div className="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-amber-500"></div>
                <span className="text-sm font-medium text-slate-600">需關注: {machines.filter(m => m.status !== 'Active').length}</span>
             </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
           {machines.map(machine => (
             <div 
                key={machine.id} 
                onClick={() => onSelect(machine)}
                className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group relative"
             >
                <div className="absolute top-3 right-3 z-10 flex gap-2">
                    <button 
                        onClick={(e) => handleOpenEdit(machine, e)}
                        className="p-1.5 bg-white/90 backdrop-blur rounded-full text-slate-500 hover:text-blue-600 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"
                        title="編輯"
                    >
                        <Edit size={14} />
                    </button>
                </div>

                <div className="h-40 bg-slate-100 relative overflow-hidden">
                   <img src={machine.image} alt={machine.name} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" />
                   <div className={`absolute top-3 left-3 px-2 py-1 rounded text-xs font-bold shadow-sm ${
                      machine.status === 'Active' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'
                   }`}>
                      {machine.status}
                   </div>
                </div>
                <div className="p-5">
                   <h3 className="font-bold text-lg text-slate-800 mb-1 truncate" title={machine.name}>{machine.name}</h3>
                   <p className="text-xs text-slate-500 mb-4">Code: {machine.code}</p>
                   
                   <div className="flex justify-between items-center text-sm text-slate-600 mb-2">
                      <span>專案進度</span>
                      <span className="font-bold">{machine.progress}%</span>
                   </div>
                   <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                      <div className={`h-full rounded-full ${machine.progress > 80 ? 'bg-emerald-500' : 'bg-amber-500'}`} style={{ width: `${machine.progress}%` }}></div>
                   </div>
                   
                   <div className="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                      <div className="flex-1">
                        {machine.members ? (
                          <>
                            <div className="flex -space-x-2 mb-1">
                              {machine.members.split(',').slice(0, 4).map((member, i) => (
                                <div key={i} className="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 border-2 border-white flex items-center justify-center text-white text-xs font-bold" title={member.trim()}>
                                  {member.trim().charAt(0)}
                                </div>
                              ))}
                              {machine.members.split(',').length > 4 && (
                                <div className="w-6 h-6 rounded-full bg-slate-300 border-2 border-white flex items-center justify-center text-slate-600 text-xs font-bold">
                                  +{machine.members.split(',').length - 4}
                                </div>
                              )}
                            </div>
                            <p className="text-xs text-slate-500 truncate" title={machine.members}>
                              {machine.members.split(',').slice(0, 2).map(m => m.trim()).join(', ')}
                              {machine.members.split(',').length > 2 && '...'}
                            </p>
                          </>
                        ) : (
                          <p className="text-xs text-slate-400">未設定成員</p>
                        )}
                      </div>
                      <span className="text-blue-600 text-sm font-medium group-hover:underline flex items-center ml-2">
                         進入專案 <ChevronRight size={16} />
                      </span>
                   </div>
                </div>
             </div>
           ))}
           
           <div 
              onClick={handleOpenAdd}
              className="bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center p-6 text-slate-400 hover:border-blue-400 hover:text-blue-500 transition-colors cursor-pointer h-full min-h-[300px]"
           >
              <PlusCircle size={48} className="mb-4 opacity-50" />
              <span className="font-medium">新增機台專案</span>
           </div>
        </div>

        {/* Analysis Section */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
           <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
              <h3 className="font-bold text-slate-800 mb-6 flex items-center">
                 <BarChart3 size={20} className="mr-2 text-blue-600" />
                 機台專案績效分析
              </h3>
              <div className="h-64">
                 <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={machines}>
                       <CartesianGrid strokeDasharray="3 3" vertical={false} />
                       <XAxis dataKey="code" />
                       <YAxis />
                       <Tooltip />
                       <Bar dataKey="progress" fill="#3b82f6" radius={[4, 4, 0, 0]} name="進度 (%)" />
                    </BarChart>
                 </ResponsiveContainer>
              </div>
           </div>
           
           <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
              <h3 className="font-bold text-slate-800 mb-6 flex items-center">
                 <Activity size={20} className="mr-2 text-rose-600" />
                 近期異常統計
              </h3>
              <div className="space-y-4">
                 {[
                    { machine: 'HSM-A1', issue: '馬達過熱警報', time: '2h ago', level: 'High' },
                    { machine: 'AOI-X5', issue: '影像辨識率下降', time: '5h ago', level: 'Medium' },
                    { machine: 'RO-R3', issue: '溫度曲線偏移', time: '1d ago', level: 'Low' },
                 ].map((item, idx) => (
                    <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                       <div className="flex items-center gap-3">
                          <div className={`w-2 h-2 rounded-full ${item.level === 'High' ? 'bg-rose-500' : item.level === 'Medium' ? 'bg-amber-500' : 'bg-blue-500'}`}></div>
                          <div>
                             <div className="font-bold text-slate-700 text-sm">{item.machine}</div>
                             <div className="text-xs text-slate-500">{item.issue}</div>
                          </div>
                       </div>
                       <span className="text-xs text-slate-400">{item.time}</span>
                    </div>
                 ))}
              </div>
           </div>
        </div>
      </div>
    </div>
  );
};

const DashboardView = ({ projects, tasks, changes, onViewDetails }) => {
  // Fallback to global PROJECTS if prop is missing (for safety)
  const displayProjects = projects || [];
  const displayTasks = tasks || [];
  const displayChanges = changes || [];

  // Calculate Stats
  const projectIds = displayProjects.map(p => p.id);
  const myTasks = displayTasks.filter(t => projectIds.includes(t.projectId) && t.status !== 'Done');
  const myChanges = displayChanges.filter(c => projectIds.includes(c.projectId));
  
  // Calculate Change Frequency (Mock Logic)
  const changeFrequency = myChanges.length > 5 ? 'High' : myChanges.length > 2 ? 'Medium' : 'Low';
  const changeColor = changeFrequency === 'High' ? 'text-rose-500' : changeFrequency === 'Medium' ? 'text-amber-500' : 'text-emerald-500';

  // Find Alerts (Delay Projects or High Risk Tasks)
  const delayProjects = displayProjects.filter(p => p.status === 'delay');
  const riskTasks = displayTasks.filter(t => projectIds.includes(t.projectId) && t.risk);

  return (
    <div className="space-y-6 animate-fade-in">
      {/* KPI Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-500 text-sm font-medium">進行中專案</p>
              <h3 className="text-3xl font-bold text-slate-800 mt-2">{displayProjects.length}</h3>
            </div>
            <div className="p-2 bg-blue-50 rounded-lg text-blue-600">
              <Briefcase size={20} />
            </div>
          </div>
          <div className="mt-4 flex items-center text-xs text-slate-400">
            <span className="text-emerald-500 font-medium flex items-center mr-2">
              <TrendingUp size={12} className="mr-1" /> +{displayProjects.filter(p => new Date(p.deadline) > new Date()).length}
            </span>
            本月活躍
          </div>
        </div>

        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-500 text-sm font-medium">延遲專案 (Alert)</p>
              <h3 className="text-3xl font-bold text-rose-600 mt-2">{delayProjects.length}</h3>
            </div>
            <div className="p-2 bg-rose-50 rounded-lg text-rose-600">
              <AlertCircle size={20} />
            </div>
          </div>
           <div className="mt-4 text-xs text-rose-500 font-medium">
            {delayProjects.length > 0 ? '需立即介入處理' : '目前進度良好'}
          </div>
        </div>

        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-500 text-sm font-medium">待辦事項 (To-Do)</p>
              <h3 className="text-3xl font-bold text-slate-800 mt-2">{myTasks.length}</h3>
            </div>
            <div className="p-2 bg-purple-50 rounded-lg text-purple-600">
              <ListTodo size={20} />
            </div>
          </div>
          <div className="mt-4 flex items-center text-xs text-slate-400">
             關聯專案任務
          </div>
        </div>

        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-500 text-sm font-medium">設變頻率 (TQM)</p>
              <h3 className={`text-3xl font-bold mt-2 ${changeColor}`}>{changeFrequency}</h3>
            </div>
            <div className="p-2 bg-amber-50 rounded-lg text-amber-600">
              <Activity size={20} />
            </div>
          </div>
          <div className="mt-4 text-xs text-slate-400">
            本月累計 {myChanges.length} 件變更
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Project Status Overview */}
        <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100 p-6">
          <h3 className="font-bold text-slate-800 mb-4 flex items-center">
            <LayoutDashboard size={18} className="mr-2 text-slate-400" />
            專案進度總覽 (Gantt 縮圖)
          </h3>
          <div className="space-y-4">
            {displayProjects.length === 0 ? (
                <div className="text-center py-10 text-slate-400">
                    <p>尚無專案，請至「專案列表」新增。</p>
                </div>
            ) : (
                displayProjects.map((project) => (
                <div key={project.id} className="group hover:bg-slate-50 p-3 rounded-lg transition-colors cursor-pointer border border-transparent hover:border-slate-100" onClick={() => onViewDetails(project)}>
                    <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center">
                        <span className="font-medium text-slate-700">{project.name}</span>
                        <span className="ml-3 text-xs text-slate-400">{project.owner}</span>
                    </div>
                    <ProjectStatusBadge status={project.status} />
                    </div>
                    <div className="relative h-2.5 bg-slate-100 rounded-full overflow-hidden">
                    <div 
                        className={`absolute top-0 left-0 h-full rounded-full ${
                        project.status === 'delay' ? 'bg-rose-500' : 
                        project.status === 'risk' ? 'bg-amber-500' : 'bg-emerald-500'
                        }`}
                        style={{ width: `${project.progress}%` }}
                    ></div>
                    </div>
                    <div className="flex justify-between mt-1 text-xs text-slate-400">
                    <span>Start</span>
                    <span>Deadline: {project.deadline}</span>
                    </div>
                </div>
                ))
            )}
          </div>
        </div>

        {/* High Priority Alerts */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
          <h3 className="font-bold text-slate-800 mb-4 flex items-center text-rose-600">
            <AlertTriangle size={18} className="mr-2" />
            本週重點異常
          </h3>
          <div className="space-y-3">
            {delayProjects.length === 0 && riskTasks.length === 0 ? (
                <div className="text-center py-8 text-slate-400 text-sm">
                    目前無重大異常
                </div>
            ) : (
                <>
                    {delayProjects.map(p => (
                        <div key={p.id} className="p-3 bg-rose-50 border border-rose-100 rounded-lg text-sm text-rose-800">
                            <div className="font-bold mb-1">{p.name} - 進度延遲</div>
                            <div className="text-xs opacity-80">Deadline: {p.deadline}</div>
                        </div>
                    ))}
                    {riskTasks.map(t => (
                        <div key={t.id} className="p-3 bg-amber-50 border border-amber-100 rounded-lg text-sm text-amber-800">
                            <div className="font-bold mb-1">高風險任務: {t.title}</div>
                            <div className="text-xs opacity-80">Owner: {t.owner}</div>
                        </div>
                    ))}
                </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

const ProjectListView = ({ onViewDetails, projects, onAddProject, onUpdateProject, onDeleteProject }) => {
  const [filter, setFilter] = useState('all');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingProject, setEditingProject] = useState(null);

  // Fallback to global PROJECTS if prop is missing
  const displayProjects = projects || PROJECTS;
  const filteredProjects = displayProjects.filter(p => filter === 'all' || p.status === filter);

  const handleOpenAdd = () => {
    setEditingProject(null);
    setIsModalOpen(true);
  };

  const handleOpenEdit = (project, e) => {
    e.stopPropagation(); // Prevent triggering row click
    setEditingProject(project);
    setIsModalOpen(true);
  };

  const handleDelete = (id, e) => {
    e.stopPropagation(); // Prevent triggering row click
    onDeleteProject(id);
  };

  const handleSubmit = (formData) => {
    if (editingProject) {
      onUpdateProject({ ...editingProject, ...formData });
    } else {
      onAddProject(formData);
    }
    setIsModalOpen(false);
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingProject ? "編輯專案" : "新增專案"}>
        <ProjectForm 
          initialData={editingProject} 
          onSubmit={handleSubmit} 
          onCancel={() => setIsModalOpen(false)} 
        />
      </Modal>

      <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h2 className="text-xl font-bold text-slate-800">專案清單</h2>
          <p className="text-sm text-slate-500">快速搜尋、篩選與定位問題專案</p>
        </div>
        <div className="flex gap-2">
          <button onClick={handleOpenAdd} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm">
            <Plus size={16} /> 新增專案
          </button>
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
            <input 
              type="text" 
              placeholder="搜尋專案、負責人..." 
              className="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64"
            />
          </div>
          <select 
            className="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={filter}
            onChange={(e) => setFilter(e.target.value)}
          >
            <option value="all">所有狀態</option>
            <option value="normal">正常</option>
            <option value="risk">有風險</option>
            <option value="delay">已延遲</option>
          </select>
        </div>
      </div>
      
      <div className="overflow-x-auto">
        <table className="w-full text-left border-collapse">
          <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-semibold">
            <tr>
              <th className="px-6 py-4">專案名稱</th>
              <th className="px-6 py-4">負責人</th>
              <th className="px-6 py-4">階段</th>
              <th className="px-6 py-4">進度</th>
              <th className="px-6 py-4">Deadline</th>
              <th className="px-6 py-4">狀態</th>
              <th className="px-6 py-4">操作</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {filteredProjects.map((project) => (
              <tr key={project.id} className="hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => onViewDetails(project)}>
                <td className="px-6 py-4 font-medium text-slate-800">{project.name}</td>
                <td className="px-6 py-4">
                  <div className="flex items-center">
                    <div className="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs mr-2 font-bold">
                      {project.owner[0]}
                    </div>
                    <span className="text-sm text-slate-600">{project.owner}</span>
                  </div>
                </td>
                <td className="px-6 py-4 text-sm text-slate-600">
                  <span className="px-2 py-1 bg-slate-100 rounded text-slate-600 text-xs">{project.stage}</span>
                </td>
                <td className="px-6 py-4">
                  <div className="flex items-center gap-2">
                    <div className="w-24 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                      <div className="h-full bg-blue-500" style={{ width: `${project.progress}%` }}></div>
                    </div>
                    <span className="text-xs text-slate-500">{project.progress}%</span>
                  </div>
                </td>
                <td className="px-6 py-4 text-sm text-slate-600">{project.deadline}</td>
                <td className="px-6 py-4">
                  <ProjectStatusBadge status={project.status} />
                </td>
                <td className="px-6 py-4">
                  <div className="flex items-center gap-2">
                    <button 
                      onClick={(e) => handleOpenEdit(project, e)}
                      className="p-1 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                      title="編輯"
                    >
                      <Edit size={16} />
                    </button>
                    <button 
                      onClick={(e) => handleDelete(project.id, e)}
                      className="p-1 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded transition-colors"
                      title="刪除"
                    >
                      <Trash2 size={16} />
                    </button>
                    <button 
                      onClick={() => onViewDetails(project)}
                      className="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center ml-2"
                    >
                      詳情 <ChevronRight size={16} />
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const ProjectDetailView = ({ project, onBack, tasks: allTasks, onAddTask, onUpdateTask, changes: allChanges, onAddChange, history: allHistory, onAddHistory, messages: allMessages, onAddMessage, onUpdateProject, onDeleteProject, user }) => {
  const tasks = allTasks.filter(t => t.projectId === project.id);
  const changes = allChanges.filter(c => c.projectId === project.id);
  const history = allHistory.filter(h => h.projectId === project.id);
  const messages = allMessages ? allMessages.filter(m => m.projectId === project.id) : [];

  const [activeTab, setActiveTab] = useState('kanban');
  const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
  const [isChangeModalOpen, setIsChangeModalOpen] = useState(false);
  const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
  const [isSpecsModalOpen, setIsSpecsModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [newTaskStatus, setNewTaskStatus] = useState('To Do');
  
  // Gantt State
  const [phases, setPhases] = useState(project.phases || [
    { id: 1, name: 'Phase 1', startDate: '2025-01-01', endDate: '2025-01-31', color: 'bg-blue-500' },
    { id: 2, name: 'Phase 2', startDate: '2025-02-01', endDate: '2025-02-28', color: 'bg-emerald-500' },
    { id: 3, name: 'Phase 3', startDate: '2025-03-01', endDate: '2025-03-20', color: 'bg-amber-400' }
  ]);
  const [isGanttModalOpen, setIsGanttModalOpen] = useState(false);
  const [editingPhase, setEditingPhase] = useState(null);

  const [newMessage, setNewMessage] = useState('');
  const [chatFile, setChatFile] = useState(null);

  const handleSendMessage = () => {
    if (!newMessage.trim() && !chatFile) return;
    const msg = {
      id: Date.now(),
      projectId: project.id,
      user: user?.displayName || 'Admin User',
      time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
      content: newMessage,
      avatar: user?.displayName?.[0] || 'A',
      role: user?.department || '研發經理',
      file: chatFile ? chatFile.name : null,
      fileData: chatFile ? chatFile.data : null
    };
    onAddMessage(msg);
    setNewMessage('');
    setChatFile(null);
  };

  const handleChatFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 10 * 1024 * 1024) {
            alert("檔案過大！請上傳 10MB 以下的檔案。");
            return;
        }
        const reader = new FileReader();
        reader.onloadend = () => {
            setChatFile({ name: file.name, data: reader.result });
        };
        reader.readAsDataURL(file);
    }
  };

  const openAddTask = (status = 'To Do') => {
    setEditingTask(null);
    setNewTaskStatus(status);
    setIsTaskModalOpen(true);
  };

  const openEditTask = (task) => {
    setEditingTask(task);
    setIsTaskModalOpen(true);
  };

  const handleTaskSubmit = (taskData) => {
    if (editingTask) {
      onUpdateTask({ ...editingTask, ...taskData });
    } else {
      onAddTask({ ...taskData, status: newTaskStatus, projectId: project.id });
    }
    setIsTaskModalOpen(false);
  };

  const handleGanttSubmit = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newPhase = {
      id: editingPhase ? editingPhase.id : Date.now(),
      name: formData.get('name'),
      startDate: formData.get('startDate'),
      endDate: formData.get('endDate'),
      color: formData.get('color')
    };
    
    let updatedPhases;
    if (editingPhase) {
      updatedPhases = phases.map(p => p.id === editingPhase.id ? newPhase : p);
    } else {
      updatedPhases = [...phases, newPhase];
    }
    setPhases(updatedPhases);
    onUpdateProject({ ...project, phases: updatedPhases });
    setIsGanttModalOpen(false);
  };

  if (!project) return null;

  return (
    <div className="space-y-6 animate-fade-in">
      {/* Modals */}
      <Modal isOpen={isSpecsModalOpen} onClose={() => setIsSpecsModalOpen(false)} title="編輯專案規格">
        <form onSubmit={(e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            onUpdateProject({ ...project, specs: formData.get('specs') });
            setIsSpecsModalOpen(false);
        }}>
            <textarea 
                name="specs" 
                defaultValue={project.specs} 
                className="w-full h-64 border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="輸入專案規格說明..."
            ></textarea>
            <div className="flex justify-end gap-2 pt-4">
                <button type="button" onClick={() => setIsSpecsModalOpen(false)} className="px-4 py-2 text-slate-600">取消</button>
                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">儲存</button>
            </div>
        </form>
      </Modal>

      <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={editingTask ? "編輯任務" : "新增任務"}>
        <TaskForm 
          initialData={editingTask || { title: '', status: newTaskStatus, owner: '', priority: 'P2', risk: false }} 
          onSubmit={handleTaskSubmit} 
          onCancel={() => setIsTaskModalOpen(false)} 
        />
      </Modal>

      <Modal isOpen={isChangeModalOpen} onClose={() => setIsChangeModalOpen(false)} title="新增設變紀錄 (ECO)">
        <ChangeForm onSubmit={(data) => { onAddChange({ ...data, projectId: project.id }); setIsChangeModalOpen(false); }} onCancel={() => setIsChangeModalOpen(false)} />
      </Modal>

      <Modal isOpen={isHistoryModalOpen} onClose={() => setIsHistoryModalOpen(false)} title="新增設計履歷">
        <HistoryForm onSubmit={(data) => { onAddHistory({ ...data, projectId: project.id }); setIsHistoryModalOpen(false); }} onCancel={() => setIsHistoryModalOpen(false)} />
      </Modal>

      <Modal isOpen={isGanttModalOpen} onClose={() => setIsGanttModalOpen(false)} title={editingPhase ? "編輯階段" : "新增階段"}>
        <form onSubmit={handleGanttSubmit} className="space-y-4">
          <div><label className="block text-sm font-medium mb-1">階段名稱</label><input name="name" defaultValue={editingPhase?.name} required className="w-full border p-2 rounded"/></div>
          <div className="grid grid-cols-2 gap-4">
            <div><label className="block text-sm font-medium mb-1">開始日期</label><input type="date" name="startDate" defaultValue={editingPhase?.startDate} required className="w-full border p-2 rounded"/></div>
            <div><label className="block text-sm font-medium mb-1">結束日期</label><input type="date" name="endDate" defaultValue={editingPhase?.endDate} required className="w-full border p-2 rounded"/></div>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">顏色標記</label>
            <select name="color" defaultValue={editingPhase?.color || 'bg-blue-500'} className="w-full border p-2 rounded">
              <option value="bg-blue-500">Blue</option>
              <option value="bg-emerald-500">Green</option>
              <option value="bg-amber-400">Yellow</option>
              <option value="bg-rose-500">Red</option>
            </select>
          </div>
          <div className="flex justify-end gap-2 pt-4">
             <button type="button" onClick={() => setIsGanttModalOpen(false)} className="px-4 py-2 text-slate-600">取消</button>
             <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">儲存</button>
          </div>
        </form>
      </Modal>

      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-full text-slate-500">
            <ArrowRight size={20} className="rotate-180" />
          </button>
          <div>
            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
              {project.name}
              <ProjectStatusBadge status={project.status} />
            </h1>
            <p className="text-slate-500 text-sm mt-1">
              負責人: {project.owner} | 部門: {project.department} | 類別: {project.category}
            </p>
          </div>
        </div>
        <div className="flex flex-wrap gap-2">
          <button onClick={() => openAddTask('To Do')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm shadow-blue-200">
            + 新增任務
          </button>
          <button className="px-4 py-2 border border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-50">
            產生報告
          </button>
          <button
            onClick={() => onDeleteProject(project.id)}
            className="px-4 py-2 border border-rose-200 text-rose-600 rounded-lg text-sm font-medium hover:bg-rose-50 flex items-center gap-2"
          >
            <Trash2 size={16} />
            刪除專案
          </button>
        </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-slate-200">
        <nav className="flex gap-6">
          {['dashboard', 'kanban', 'gantt', 'changes', 'history', 'files'].map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`pb-3 text-sm font-medium border-b-2 transition-colors capitalize ${
                activeTab === tab 
                  ? 'border-blue-500 text-blue-600' 
                  : 'border-transparent text-slate-500 hover:text-slate-700'
              }`}
            >
              {tab === 'dashboard' && '總覽'}
              {tab === 'kanban' && '任務看板 (Kanban)'}
              {tab === 'gantt' && '甘特圖 (Gantt)'}
              {tab === 'changes' && '變更紀錄 (TQM)'}
              {tab === 'history' && '產品設計履歷'}
              {tab === 'files' && '討論與檔案'}
            </button>
          ))}
        </nav>
      </div>

      {/* Tab Content */}
      <div className="min-h-[400px]">
        {activeTab === 'kanban' && (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 h-full">
            {['To Do', 'Doing', 'Testing', 'Done'].map((status) => (
              <div key={status} className="bg-slate-50 p-4 rounded-xl border border-slate-100 h-full flex flex-col">
                <h3 className="text-xs font-bold text-slate-500 uppercase mb-4 flex justify-between items-center">
                  {status}
                  <span className="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-[10px]">
                    {tasks.filter(t => t.status === status).length}
                  </span>
                </h3>
                <div className="space-y-3 flex-1 overflow-y-auto min-h-[200px]">
                  {tasks.filter(t => t.status === status).map(task => (
                    <div 
                      key={task.id} 
                      onClick={() => openEditTask(task)}
                      className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition-all hover:border-blue-300 group"
                    >
                      <div className="flex justify-between items-start mb-2">
                        <PriorityBadge priority={task.priority} />
                        <div className="flex gap-1">
                           {task.risk && <AlertCircle size={14} className="text-rose-500" />}
                           <Edit size={14} className="text-slate-300 opacity-0 group-hover:opacity-100" />
                        </div>
                      </div>
                      <h4 className="text-sm font-medium text-slate-800 mb-2">{task.title}</h4>
                      <div className="flex justify-between items-center text-xs text-slate-400">
                        <div className="flex items-center gap-1">
                          <UserCircle size={14} /> {task.owner}
                        </div>
                        <Clock size={14} />
                      </div>
                    </div>
                  ))}
                  <button 
                    onClick={() => openAddTask(status)}
                    className="w-full py-2 border-2 border-dashed border-slate-200 rounded-lg text-slate-400 text-sm hover:border-slate-300 hover:text-slate-500 transition-colors"
                  >
                    + Add Task
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'changes' && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
            <div className="flex justify-between items-center mb-6">
              <h3 className="font-bold text-slate-800">設變與異常紀錄 (Engineering Change Order)</h3>
              <div className="flex gap-2">
                <button onClick={() => setIsChangeModalOpen(true)} className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                   <Plus size={14}/> 新增紀錄
                </button>
                <span className="text-xs bg-rose-100 text-rose-700 px-2 py-1 rounded flex items-center">本月設變: {changes.length} 件</span>
              </div>
            </div>
            <table className="w-full text-left text-sm">
              <thead className="bg-slate-50 text-slate-500">
                <tr>
                  <th className="px-4 py-3">日期</th>
                  <th className="px-4 py-3">類型</th>
                  <th className="px-4 py-3">描述</th>
                  <th className="px-4 py-3">衝擊度</th>
                  <th className="px-4 py-3">發起人</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {changes.map(change => (
                  <tr key={change.id}>
                    <td className="px-4 py-3 text-slate-500">{change.date}</td>
                    <td className="px-4 py-3">
                      <span className={`px-2 py-1 rounded text-xs ${
                        change.type === '設計疏失' ? 'bg-rose-100 text-rose-700' : 
                        change.type === '客戶修改' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'
                      }`}>
                        {change.type}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-slate-800">{change.desc}</td>
                    <td className="px-4 py-3">
                      <span className={`font-bold ${
                        change.impact === 'High' ? 'text-rose-600' : 
                        change.impact === 'Medium' ? 'text-amber-600' : 'text-slate-600'
                      }`}>
                        {change.impact}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-slate-600">{change.owner}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
            <div className="flex justify-between items-center mb-6">
              <h3 className="font-bold text-slate-800">產品設計履歷 (Design History)</h3>
              <button onClick={() => setIsHistoryModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                <Plus size={16} /> 新增紀錄
              </button>
            </div>
            <div className="relative border-l-2 border-slate-200 ml-3 space-y-8">
              {history.map((item) => (
                <div key={item.id} className="relative pl-8">
                  <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-2 border-blue-500"></div>
                  <div className="bg-slate-50 p-4 rounded-lg border border-slate-100">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <span className="font-bold text-blue-600 mr-2">{item.version}</span>
                        <span className="text-sm text-slate-500">{item.date}</span>
                      </div>
                      <span className={`px-2 py-1 rounded text-xs font-medium ${
                        item.status === 'Approved' ? 'bg-emerald-100 text-emerald-700' : 
                        item.status === 'Rejected' ? 'bg-rose-100 text-rose-700' : 'bg-amber-100 text-amber-700'
                      }`}>
                        {item.status}
                      </span>
                    </div>
                    <h4 className="font-bold text-slate-800 mb-1">{item.action}</h4>
                    <p className="text-sm text-slate-600 mb-3">{item.desc}</p>
                    {item.attachment && (
                      <div className="mb-3">
                        <a href={item.attachment} download={item.fileName || 'download'} className="inline-flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-medium hover:bg-blue-100 transition-colors">
                          <Download size={14} />
                          {item.fileName || '下載附件'}
                        </a>
                      </div>
                    )}
                    <div className="flex items-center text-xs text-slate-400">
                      <UserCircle size={14} className="mr-1" />
                      {item.author}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        {activeTab === 'gantt' && (() => {
             const allDates = phases.flatMap(p => [new Date(p.startDate), new Date(p.endDate)]);
             const minDate = allDates.length ? new Date(Math.min(...allDates)) : new Date();
             const maxDate = allDates.length ? new Date(Math.max(...allDates)) : new Date();
             minDate.setDate(minDate.getDate() - 7);
             maxDate.setDate(maxDate.getDate() + 7);
             const totalDuration = (maxDate - minDate) / (1000 * 60 * 60 * 24);
             const millisPerDay = 1000 * 60 * 60 * 24;
             const safeDurationDays = totalDuration || 1;
             const formatShort = (date) => new Date(date).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });

             const getLeftPos = (dateStr) => ((new Date(dateStr) - minDate) / (millisPerDay * safeDurationDays)) * 100;
             const getWidth = (startStr, endStr) => (((new Date(endStr) - new Date(startStr)) / millisPerDay) / safeDurationDays) * 100;

             const ticks = [];
             for (let i = 0; i <= 10; i++) {
               const d = new Date(minDate.getTime() + (safeDurationDays * (i / 10) * millisPerDay));
               ticks.push({ label: `${d.getMonth() + 1}/${d.getDate()}`, left: i * 10 });
             }

             const stats = [
               { label: '階段數', value: phases.length, hint: '目前排程' },
               { label: '時間範圍', value: `${formatShort(minDate)} ~ ${formatShort(maxDate)}`, hint: '含緩衝期' },
               { label: '平均天數', value: `${Math.max(1, Math.round(safeDurationDays / Math.max(phases.length, 1)))} 天`, hint: '每段平均' }
             ];

             return (
               <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 space-y-6">
                 <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                   <div>
                     <p className="text-sm text-slate-500">時程甘特圖 (Timeline)</p>
                     <h3 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                       <Calendar size={20} className="text-blue-600" /> 專案時程甘特圖
                     </h3>
                     <p className="text-xs text-slate-400">日期會自動延伸，點擊階段即可編輯。</p>
                   </div>
                   <div className="flex flex-wrap gap-2 justify-end">
                     <button
                       onClick={() => { setEditingPhase(null); setIsGanttModalOpen(true); }}
                       className="px-4 py-2 bg-blue-600 text-white rounded-full text-sm font-medium hover:bg-blue-700 transition"
                     >
                       + 新增階段
                     </button>
                     <button className="px-4 py-2 border border-slate-200 text-slate-600 rounded-full text-sm font-medium hover:border-blue-300 hover:text-blue-600 transition">
                       匯出報表
                     </button>
                   </div>
                 </div>

                 <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                   {stats.map((stat) => (
                     <div key={stat.label} className="bg-slate-50 rounded-xl border border-slate-100 p-4">
                       <p className="text-xs text-slate-400 uppercase tracking-wide">{stat.label}</p>
                       <p className="text-lg font-bold text-slate-800">{stat.value}</p>
                       <p className="text-xs text-slate-500 mt-1">{stat.hint}</p>
                     </div>
                   ))}
                 </div>

                 <div className="relative overflow-hidden bg-slate-50 rounded-2xl border border-slate-100 p-5">
                   <div className="flex border-b border-slate-200 pb-3 mb-4">
                     <div className="w-24 text-xs text-slate-500 font-medium">階段</div>
                     <div className="flex-1 relative h-6">
                       {ticks.map((tick, idx) => (
                         <div key={idx} className="absolute text-xs text-slate-400 -translate-x-1/2" style={{ left: `${tick.left}%` }}>
                           {tick.label}
                         </div>
                       ))}
                     </div>
                   </div>
                   <div className="space-y-3">
                     {phases.map((phase) => (
                       <div
                         key={phase.id}
                         className="flex items-center gap-3 cursor-pointer"
                         onClick={() => { setEditingPhase(phase); setIsGanttModalOpen(true); }}
                       >
                         <div className="w-24 text-xs font-semibold text-slate-600 text-right">{phase.name}</div>
                         <div className="flex-1 h-10 bg-white rounded-2xl border border-slate-200 relative overflow-hidden">
                           {ticks.map((tick, idx) => (
                             <div
                               key={`tick-${phase.id}-${idx}`}
                               className="absolute top-0 bottom-0 border-l border-slate-100 border-dashed"
                               style={{ left: `${tick.left}%` }}
                             ></div>
                           ))}
                           <div
                             className={`absolute top-1 bottom-1 rounded-2xl ${phase.color} opacity-95 flex items-center justify-center text-[11px] text-white font-semibold shadow-lg`}
                             style={{ left: `${getLeftPos(phase.startDate)}%`, width: `${getWidth(phase.startDate, phase.endDate)}%` }}
                           >
                             {phase.startDate} ~ {phase.endDate}
                           </div>
                         </div>
                       </div>
                     ))}
                   </div>
                 </div>
               </div>
             );
        })()}
        
         {activeTab === 'dashboard' && (
             <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-50 p-6 rounded-lg text-center">
                    <p className="text-slate-500 mb-2">專案健康度</p>
                    <div className="text-4xl font-bold text-emerald-600">
                       {Math.round((tasks.filter(t => t.status === 'Done').length / tasks.length) * 100) || 0}%
                    </div>
                </div>
                 <div className="bg-slate-50 p-6 rounded-lg text-center">
                    <p className="text-slate-500 mb-2">待處理任務</p>
                    <div className="text-4xl font-bold text-slate-700">{tasks.filter(t => t.status !== 'Done').length}</div>
                </div>
                
                <div className="col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-slate-800">專案規格說明 (Project Specs)</h3>
                        <button onClick={() => setIsSpecsModalOpen(true)} className="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
                            <Edit size={16} /> 編輯
                        </button>
                    </div>
                    <div className="prose max-w-none text-slate-600 whitespace-pre-wrap bg-slate-50 p-4 rounded-lg min-h-[100px]">
                        {project.specs || "尚無規格說明..."}
                    </div>
                </div>
             </div>
        )}
        
        {activeTab === 'files' && (
          <div className="bg-white rounded-xl border border-slate-100 flex flex-col h-[600px]">
            {/* Chat Header */}
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
              <div>
                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                  <MessageSquare size={18} className="text-blue-600"/> 專案討論區
                </h3>
                <p className="text-xs text-slate-500 mt-1">與團隊成員討論專案細節、分享檔案</p>
              </div>
              <div className="flex -space-x-2">
                {['林', '張', '陳', 'A'].map((u, i) => (
                  <div key={i} className="w-8 h-8 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center text-xs font-bold text-slate-600">
                    {u}
                  </div>
                ))}
                <div className="w-8 h-8 rounded-full bg-slate-100 border-2 border-white flex items-center justify-center text-xs text-slate-400">
                  +3
                </div>
              </div>
            </div>

            {/* Messages Area */}
            <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50">
              {messages.map((msg) => {
                const isMe = msg.user === (user?.displayName || 'Admin User');
                return (
                <div key={msg.id} className={`flex gap-4 ${isMe ? 'flex-row-reverse' : ''}`}>
                  <div className={`w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-white shadow-sm
                    ${isMe ? 'bg-blue-600' : 'bg-slate-400'}`}>
                    {msg.avatar}
                  </div>
                  <div className={`max-w-[80%] ${isMe ? 'items-end' : 'items-start'} flex flex-col`}>
                    <div className="flex items-baseline gap-2 mb-1">
                      <span className="text-sm font-bold text-slate-700">{msg.user}</span>
                      <span className="text-xs text-slate-400">{msg.role} • {msg.time}</span>
                    </div>
                    <div className={`p-4 rounded-2xl shadow-sm text-sm leading-relaxed
                      ${isMe 
                        ? 'bg-blue-600 text-white rounded-tr-none' 
                        : 'bg-white text-slate-700 border border-slate-100 rounded-tl-none'}`}>
                      {msg.content}
                    </div>
                    {msg.file && (
                      <a href={msg.fileData || '#'} download={msg.file} className={`mt-2 flex items-center gap-2 px-3 py-2 rounded-lg border text-xs cursor-pointer hover:bg-slate-50 transition-colors
                        ${isMe ? 'bg-blue-50 border-blue-100 text-blue-700' : 'bg-white border-slate-200 text-slate-600'}`}>
                        <FileText size={14} />
                        <span className="font-medium">{msg.file}</span>
                        <Download size={14} className="ml-2 opacity-50" />
                      </a>
                    )}
                  </div>
                </div>
              )})}
            </div>

            {/* Input Area */}
            <div className="p-4 bg-white border-t border-slate-100 rounded-b-xl">
              {chatFile && (
                  <div className="mb-2 flex items-center gap-2 text-sm text-blue-600 bg-blue-50 px-3 py-1 rounded-lg w-fit">
                      <Paperclip size={14} />
                      <span>{chatFile.name}</span>
                      <button onClick={() => setChatFile(null)} className="hover:text-red-500 ml-2"><X size={14}/></button>
                  </div>
              )}
              <div className="flex gap-4">
                <label className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors cursor-pointer" title="上傳檔案">
                  <Paperclip size={20} />
                  <input type="file" className="hidden" onChange={handleChatFileUpload} />
                </label>
                <div className="flex-1 relative">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={(e) => setNewMessage(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                    placeholder="輸入訊息..."
                    className="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"
                  />
                  <button 
                    onClick={handleSendMessage}
                    className={`absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg transition-all
                      ${newMessage.trim() || chatFile
                        ? 'bg-blue-600 text-white shadow-md hover:bg-blue-700' 
                        : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                    disabled={!newMessage.trim() && !chatFile}
                  >
                    <Send size={16} />
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const AnalyticsView = ({ projects = [], tasks = [], changes = [] }) => {
  // Dynamic Data Calculation
  
  // 1. Department Load (Mock calculation based on active projects count per department)
  // In a real app, this would sum up task hours. Here we count projects/tasks.
  const deptLoadMap = { '機構部': 0, '電子部': 0, '軟體部': 0, '美工部': 0 };
  projects.forEach(p => {
    if (deptLoadMap[p.department] !== undefined) deptLoadMap[p.department] += 20; // Assume 20% load per project
  });
  tasks.forEach(t => {
     // Find project for task to get department? Or just assume owner's dept? 
     // Simplified: Randomly distribute task load or just use project load for now.
  });
  
  const dynamicLoadData = Object.keys(deptLoadMap).map(dept => ({
    name: dept,
    load: deptLoadMap[dept],
    capacity: 100
  }));

  // 2. On-Time Trend (Mock: Generate based on project deadlines)
  // If no data, show empty or default
  const dynamicTrendData = projects.length > 0 ? [
      { month: '5月', onTime: 92, delay: 8 }, // Keep some history or calculate from completed projects
      { month: '6月', onTime: 88, delay: 12 },
      { month: '7月', onTime: 85, delay: 15 },
      { month: '8月', onTime: 78, delay: 22 },
  ] : []; 
  // Better: Calculate from actual projects if possible, or just show empty if no projects.
  // Since we don't have historical trend data stored, we might have to hide this chart or show "No Data".
  // For now, let's show "No Data" if projects is empty.

  // 3. Change Type Distribution
  const changeTypeMap = {};
  changes.forEach(c => {
    changeTypeMap[c.type] = (changeTypeMap[c.type] || 0) + 1;
  });
  const dynamicChangeTypeData = Object.keys(changeTypeMap).map(type => ({
    name: type,
    value: changeTypeMap[type]
  }));

  if (projects.length === 0 && tasks.length === 0 && changes.length === 0) {
      return (
          <div className="flex flex-col items-center justify-center h-96 text-slate-400">
              <BarChart3 size={48} className="mb-4 opacity-20" />
              <p>尚無數據可供分析</p>
              <p className="text-xs mt-2">請先新增專案、任務與設變紀錄</p>
          </div>
      );
  }

  return (
    <div className="space-y-6 animate-fade-in">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Department Load */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <h3 className="font-bold text-slate-800 mb-4 flex items-center">
            <BarChart3 size={18} className="mr-2 text-slate-400" />
            各部門負載分析 (Load Balance)
          </h3>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={dynamicLoadData} layout="vertical">
                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                <XAxis type="number" domain={[0, 150]} />
                <YAxis dataKey="name" type="category" width={60} />
                <RechartsTooltip />
                <Bar dataKey="load" name="負載率 (%)" barSize={20} radius={[0, 4, 4, 0]}>
                  {dynamicLoadData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.load > 100 ? '#ef4444' : '#3b82f6'} />
                  ))}
                </Bar>
                <Bar dataKey="capacity" name="產能上限" barSize={20} fill="#e2e8f0" radius={[0, 4, 4, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
          <p className="text-xs text-slate-400 mt-2 text-center">* 紅色代表過載 (&gt;100%)，需進行資源調配</p>
        </div>

        {/* On-Time Trend */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <h3 className="font-bold text-slate-800 mb-4 flex items-center">
            <TrendingUp size={18} className="mr-2 text-slate-400" />
            專案準時率趨勢
          </h3>
          <div className="h-64 flex items-center justify-center">
            {dynamicTrendData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                <LineChart data={dynamicTrendData}>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                    <XAxis dataKey="month" />
                    <YAxis />
                    <RechartsTooltip />
                    <Legend />
                    <Line type="monotone" dataKey="onTime" name="準時率 (%)" stroke="#10b981" strokeWidth={2} />
                    <Line type="monotone" dataKey="delay" name="延遲率 (%)" stroke="#f43f5e" strokeWidth={2} />
                </LineChart>
                </ResponsiveContainer>
            ) : (
                <div className="text-slate-400 text-sm">資料不足，無法顯示趨勢</div>
            )}
          </div>
        </div>

        {/* Change Type Distribution */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <h3 className="font-bold text-slate-800 mb-4 flex items-center">
            <Activity size={18} className="mr-2 text-slate-400" />
            設變類型分析 (TQM)
          </h3>
          <div className="h-64 flex items-center justify-center">
             {dynamicChangeTypeData.length > 0 ? (
                 <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                    <Pie
                        data={dynamicChangeTypeData}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={80}
                        fill="#8884d8"
                        paddingAngle={5}
                        dataKey="value"
                    >
                        {dynamicChangeTypeData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                    </Pie>
                    <RechartsTooltip />
                    <Legend verticalAlign="bottom" height={36}/>
                    </PieChart>
                </ResponsiveContainer>
             ) : (
                 <div className="text-slate-400 text-sm">尚無設變紀錄</div>
             )}
          </div>
        </div>

         {/* Bottleneck Analysis */}
         <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <h3 className="font-bold text-slate-800 mb-4 flex items-center">
            <AlertCircle size={18} className="mr-2 text-slate-400" />
            AI 瓶頸診斷
          </h3>
          <div className="space-y-4">
             {changes.length > 0 || tasks.some(t => t.status === 'delay') ? (
                 <>
                    <div className="flex items-start gap-3">
                        <div className="p-2 bg-rose-100 rounded text-rose-600 mt-1"><XCircle size={16}/></div>
                        <div>
                            <h4 className="text-sm font-bold text-slate-800">偵測到潛在風險</h4>
                            <p className="text-xs text-slate-500">根據目前的設變頻率與任務延遲狀況，建議加強設計審查。</p>
                        </div>
                    </div>
                 </>
             ) : (
                 <div className="flex items-center justify-center h-32 text-slate-400 text-sm">
                     目前專案運行狀況良好，無顯著瓶頸。
                 </div>
             )}
          </div>
        </div>
      </div>
    </div>
  );
};

const EngineerDashboardView = ({ tasks = [], onUpdateTask, user }) => {
    const [editingTask, setEditingTask] = useState(null);

    // Filter tasks for the current user
    const userName = user?.displayName || '陳建宏';
    const myTasks = tasks.filter(t => t.owner === userName);
    const completedTasks = myTasks.filter(t => t.status === 'Done');
    const todoTasks = myTasks.filter(t => t.status === 'To Do');
    
    const handleSaveTask = (updatedTask) => {
        onUpdateTask(updatedTask);
        setEditingTask(null);
    };

    return (
        <div className="space-y-6 animate-fade-in">
             <div className="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl p-8 text-white">
                <div className="flex justify-between items-center">
                    <div>
                        <h2 className="text-2xl font-bold mb-2">早安，{userName} ({user?.department || 'Sr. Software Engineer'})</h2>
                        <p className="opacity-80">這是你本月的績效表現與待辦事項。</p>
                    </div>
                    <div className="text-right">
                        <div className="text-4xl font-bold">
                            {myTasks.length > 0 ? Math.round((completedTasks.length / myTasks.length) * 100) : 0}
                            <span className="text-lg font-normal opacity-70">%</span>
                        </div>
                        <div className="text-xs opacity-80">任務達成率</div>
                    </div>
                </div>
             </div>
             
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-white p-6 rounded-xl border border-slate-100">
                    <h3 className="text-slate-500 text-sm font-medium mb-2">本月完成任務</h3>
                    <div className="text-3xl font-bold text-slate-800">{completedTasks.length}</div>
                </div>
                <div className="bg-white p-6 rounded-xl border border-slate-100">
                    <h3 className="text-slate-500 text-sm font-medium mb-2">待處理任務</h3>
                    <div className="text-3xl font-bold text-slate-800">{todoTasks.length}</div>
                </div>
                <div className="bg-white p-6 rounded-xl border border-slate-100">
                    <h3 className="text-slate-500 text-sm font-medium mb-2">總任務數</h3>
                    <div className="text-3xl font-bold text-slate-800">{myTasks.length}</div>
                </div>
             </div>
             
             <div className="bg-white rounded-xl border border-slate-100 overflow-hidden">
                <div className="p-4 bg-slate-50 border-b border-slate-100 font-bold text-slate-700">我的任務清單 (To-Do)</div>
                <div className="divide-y divide-slate-100">
                    {myTasks.length === 0 ? (
                        <div className="p-8 text-center text-slate-400">目前沒有指派給您的任務</div>
                    ) : (
                        myTasks.map(task => (
                            <div key={task.id} className="p-4 flex items-center justify-between hover:bg-slate-50 cursor-pointer" onClick={() => setEditingTask(task)}>
                                <div className="flex items-center gap-3">
                                    <div className={`w-2 h-2 rounded-full ${task.priority === 'P1' ? 'bg-rose-500' : 'bg-blue-500'}`}></div>
                                    <span className="text-slate-800 font-medium">{task.title}</span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <span className="text-xs text-slate-400">{task.status}</span>
                                    <button className="text-slate-400 hover:text-blue-600"><ArrowRight size={18}/></button>
                                </div>
                            </div>
                        ))
                    )}
                </div>
             </div>

             {/* Edit Task Modal */}
             {editingTask && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
                    <div className="bg-white rounded-xl w-full max-w-lg mx-4 overflow-hidden shadow-2xl">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-slate-800">編輯任務</h3>
                            <button onClick={() => setEditingTask(null)} className="text-slate-400 hover:text-slate-600">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-6">
                            <TaskForm 
                                initialData={editingTask} 
                                onSubmit={handleSaveTask} 
                                onCancel={() => setEditingTask(null)} 
                            />
                        </div>
                    </div>
                </div>
             )}
        </div>
    )
}

const HistoryForm = ({ onSubmit, onCancel }) => {
  const [formData, setFormData] = useState({
    version: '',
    date: new Date().toISOString().split('T')[0],
    author: '陳建宏', // Default user
    action: '',
    desc: '',
    status: 'Pending',
    attachment: null,
    fileName: ''
  });
  const [fileName, setFileName] = useState('');

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        alert("檔案過大！請上傳 10MB 以下的檔案。");
        e.target.value = null;
        return;
      }
      setFileName(file.name);
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormData(prev => ({ ...prev, attachment: reader.result, fileName: file.name }));
      };
      reader.readAsDataURL(file);
    }
  };

  const handleRemoveFile = () => {
    setFileName('');
    setFormData(prev => ({ ...prev, attachment: null, fileName: '' }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">版本號 (Version)</label>
          <input
            type="text"
            name="version"
            value={formData.version}
            onChange={handleChange}
            className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder="e.g. V1.3"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">日期 (Date)</label>
          <input
            type="date"
            name="date"
            value={formData.date}
            onChange={handleChange}
            className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
            required
          />
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">作者 (Author)</label>
          <input
            type="text"
            name="author"
            value={formData.author}
            onChange={handleChange}
            className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">狀態 (Status)</label>
          <select
            name="status"
            value={formData.status}
            onChange={handleChange}
            className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
          >
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">動作 (Action)</label>
        <input
          type="text"
          name="action"
          value={formData.action}
          onChange={handleChange}
          className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
          placeholder="e.g. 規格變更"
          required
        />
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-700 mb-1">描述 (Description)</label>
        <textarea
          name="desc"
          value={formData.desc}
          onChange={handleChange}
          className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none h-24"
          placeholder="詳細描述變更內容..."
          required
        ></textarea>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-700 mb-2">附件 (Attachment)</label>
        <div className="flex items-center space-x-4">
          <label className="flex items-center gap-2 cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-300">
            <Upload size={18} />
            <span>選擇檔案</span>
            <input type="file" onChange={handleFileChange} className="hidden" />
          </label>
          {fileName && (
            <div className="flex items-center gap-2 text-sm text-green-600 bg-green-50 px-3 py-1 rounded-full">
              <span>{fileName}</span>
              <button type="button" onClick={handleRemoveFile} className="hover:text-red-500">
                <X size={14}/>
              </button>
            </div>
          )}
        </div>
        <p className="text-xs text-slate-400 mt-1">支援圖片與文件，最大 10MB</p>
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t border-slate-100">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
        >
          取消
        </button>
        <button
          type="submit"
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          新增紀錄
        </button>
      </div>
    </form>
  );
};

// --- Main App (ProjectApp) ---

const ProjectApp = ({ machine, onBackToMachines, user }) => {
  const [currentView, setCurrentView] = useState('dashboard');
  const [selectedProject, setSelectedProject] = useState(null);
  
  // Lifted State - Initialize with filtered data
  const [projects, setProjects] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [changes, setChanges] = useState([]);
  const [history, setHistory] = useState([]);
  const [messages, setMessages] = useState([]);

  // Sync with DB
  useEffect(() => {
    const unsubProjects = db.subscribe('rd_projects', (data) => setProjects(data.filter(p => p.machineId === machine.id)));
    const unsubTasks = db.subscribe('rd_tasks', (data) => setTasks(data));
    const unsubChanges = db.subscribe('rd_changes', (data) => setChanges(data));
    const unsubHistory = db.subscribe('rd_history', (data) => setHistory(data));
    const unsubMessages = db.subscribe('rd_messages', (data) => setMessages(data));
    
    return () => {
        unsubProjects();
        unsubTasks();
        unsubChanges();
        unsubHistory();
        unsubMessages();
    };
  }, [machine.id]);

  const handleViewDetails = (project) => {
    setSelectedProject(project);
    setCurrentView('detail');
  };

  const handleAddProject = async (newProject) => {
    await db.addDoc('rd_projects', { ...newProject, machineId: machine.id });
  };

  const handleUpdateProject = async (updatedProject) => {
    await db.updateDoc('rd_projects', updatedProject.id, updatedProject);
  };

  const handleDeleteProject = async (projectId) => {
    if (confirm('確定要刪除此專案嗎？')) {
      await db.deleteDoc('rd_projects', projectId);
      if (selectedProject?.id === projectId) {
        setSelectedProject(null);
        setCurrentView('list');
      }
    }
  };

  const handleAddTask = async (newTask) => {
    await db.addDoc('rd_tasks', newTask);
  };

  const handleUpdateTask = async (updatedTask) => {
    await db.updateDoc('rd_tasks', updatedTask.id, updatedTask);
  };

  const handleAddChange = async (newChange) => {
    await db.addDoc('rd_changes', newChange);
  };

  const handleAddHistory = async (newHistory) => {
    await db.addDoc('rd_history', newHistory);
  };

  const handleAddMessage = async (newMessage) => {
    await db.addDoc('rd_messages', newMessage);
  };

  const renderContent = () => {
    switch (currentView) {
      case 'dashboard':
        return <DashboardView projects={projects} tasks={tasks} changes={changes} onViewDetails={handleViewDetails} />;
      case 'list':
        return (
          <ProjectListView 
            projects={projects} 
            onViewDetails={handleViewDetails} 
            onAddProject={handleAddProject}
            onUpdateProject={handleUpdateProject}
            onDeleteProject={handleDeleteProject}
          />
        );
      case 'detail':
        return (
          <ProjectDetailView 
            project={selectedProject} 
            onBack={() => setCurrentView('list')} 
            tasks={tasks}
            onAddTask={handleAddTask}
            onUpdateTask={handleUpdateTask}
            changes={changes}
            onAddChange={handleAddChange}
            history={history}
            onAddHistory={handleAddHistory}
            messages={messages}
            onAddMessage={handleAddMessage}
            onUpdateProject={handleUpdateProject}
            onDeleteProject={handleDeleteProject}
            user={user}
          />
        );
      case 'analytics':
        return <AnalyticsView projects={projects} tasks={tasks} changes={changes} />;
      case 'engineer':
        return <EngineerDashboardView tasks={tasks} onUpdateTask={handleUpdateTask} user={user} />;
      default:
        return <DashboardView projects={projects} tasks={tasks} changes={changes} onViewDetails={handleViewDetails} />;
    }
  };

  const NavItem = ({ id, icon: Icon, label }) => (
    <button
      onClick={() => setCurrentView(id)}
      className={`w-full flex items-center px-4 py-3 mb-1 rounded-lg transition-all ${
        currentView === id || (currentView === 'detail' && id === 'list')
          ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' 
          : 'text-slate-400 hover:bg-slate-100 hover:text-slate-600'
      }`}
    >
      <Icon size={20} className="mr-3" />
      <span className="font-medium text-sm">{label}</span>
    </button>
  );

  return (
    <div className="flex h-screen bg-slate-50 text-slate-800 font-sans">
      {/* Sidebar */}
      <aside className="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col">
        <div className="p-6">
          <div className="flex items-center gap-2 text-blue-700 font-bold text-xl">
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
              <Activity size={20} />
            </div>
            R&D Nexus
          </div>
          <p className="text-xs text-slate-400 mt-1 pl-10">研發進度追蹤系統</p>
          {machine && (
             <div className="mt-4 p-3 bg-slate-50 rounded-lg border border-slate-100">
                <div className="text-xs text-slate-400 mb-1">Current Machine</div>
                <div className="font-bold text-slate-700 text-sm flex items-center gap-2">
                   <div className="w-2 h-2 rounded-full bg-emerald-500"></div>
                   {machine.name}
                </div>
             </div>
          )}
        </div>

        <nav className="flex-1 px-4 py-4 overflow-y-auto">
          <div className="mb-6">
            <p className="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">管理中心</p>
            <NavItem id="dashboard" icon={LayoutDashboard} label="總覽儀表板" />
            <NavItem id="list" icon={ListTodo} label="專案列表" />
            <NavItem id="analytics" icon={BarChart3} label="分析報告" />
          </div>
          
          <div className="mb-6">
            <p className="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">個人專區</p>
            <NavItem id="engineer" icon={UserCircle} label="我的績效與任務" />
          </div>
        </nav>

        <div className="p-4 border-t border-slate-100 space-y-2">
          <button className="flex items-center px-4 py-3 text-slate-400 hover:text-slate-600 w-full rounded-lg hover:bg-slate-50 transition-colors">
            <Settings size={20} className="mr-3" />
            <span className="font-medium text-sm">系統設定</span>
          </button>
          <button onClick={onBackToMachines} className="flex items-center px-4 py-3 text-slate-500 hover:text-slate-700 w-full rounded-lg hover:bg-slate-100 transition-colors">
            <ArrowRight size={20} className="mr-3 rotate-180" />
            <span className="font-medium text-sm">返回機台列表</span>
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col h-screen overflow-hidden">
        {/* Header (Mobile Only / Utility) */}
        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 md:hidden">
          <div className="font-bold text-lg text-slate-800">R&D Nexus</div>
          <button className="p-2 text-slate-500"><MoreVertical /></button>
        </header>
        
        <header className="hidden md:flex h-16 bg-white border-b border-slate-200 items-center justify-between px-8">
            <div className="flex items-center text-slate-400 text-sm">
                <span className="mr-2">最後更新時間: 2025-08-20 10:00</span>
                <button className="text-blue-600 hover:underline">重新整理</button>
            </div>
            <div className="flex items-center gap-4">
                 <div className="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm border border-indigo-200">
                    {user?.displayName?.[0] || 'A'}
                 </div>
                 <div className="text-sm">
                    <p className="font-bold text-slate-700">{user?.displayName || 'Admin User'}</p>
                    <p className="text-xs text-slate-500">{user?.department || '研發部經理'}</p>
                 </div>
            </div>
        </header>

        {/* Scrollable Area */}
        <div className="flex-1 overflow-y-auto p-4 md:p-8">
          <div className="max-w-7xl mx-auto">
            {renderContent()}
          </div>
        </div>
      </main>
    </div>
  );
};

// --- System Selector Component ---
const SystemSelector = ({ onSelect, onLogout, user }) => {
  const isAdmin = user?.role === 'admin';
  const gridClass = `grid grid-cols-1 ${isAdmin ? 'md:grid-cols-4' : 'md:grid-cols-3'} gap-8`;
  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
      <div className="max-w-4xl w-full">
        <div className="text-center mb-12">
          <h1 className="text-3xl font-bold text-slate-800 mb-2">歡迎回來，{user.displayName}</h1>
          <p className="text-slate-500">請選擇您要進入的系統</p>
        </div>
        
        <div className={gridClass}>
          <button 
            onClick={() => onSelect('TQM')}
            className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 border border-slate-200 group text-left"
          >
            <div className="bg-blue-100 w-16 h-16 rounded-xl flex items-center justify-center mb-6 group-hover:bg-blue-600 transition-colors">
              <CheckCircle2 className="w-8 h-8 text-blue-600 group-hover:text-white" />
            </div>
            <h2 className="text-2xl font-bold text-slate-800 mb-2">TQM 品質管理系統</h2>
            <p className="text-slate-500">管理異常紀錄、追蹤改善進度、統計分析報表。</p>
          </button>

          <button 
            onClick={() => onSelect('KPI')}
            className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 border border-slate-200 group text-left"
          >
            <div className="bg-purple-100 w-16 h-16 rounded-xl flex items-center justify-center mb-6 group-hover:bg-purple-600 transition-colors">
              <Target className="w-8 h-8 text-purple-600 group-hover:text-white" />
            </div>
            <h2 className="text-2xl font-bold text-slate-800 mb-2">KPI 績效系統</h2>
            <p className="text-slate-500">設定績效指標、評核員工表現、年度趨勢分析。</p>
          </button>

          <button 
            onClick={() => onSelect('PROJECT')}
            className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 border border-slate-200 group text-left"
          >
            <div className="bg-indigo-100 w-16 h-16 rounded-xl flex items-center justify-center mb-6 group-hover:bg-indigo-600 transition-colors">
              <Activity className="w-8 h-8 text-indigo-600 group-hover:text-white" />
            </div>
            <h2 className="text-2xl font-bold text-slate-800 mb-2">R&D Nexus</h2>
            <p className="text-slate-500">研發專案進度追蹤、甘特圖管理、資源負載分析。</p>
          </button>

          {isAdmin && (
            <button 
              onClick={() => onSelect('APPRAISAL')}
              className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 border border-slate-200 group text-left"
            >
              <div className="bg-amber-100 w-16 h-16 rounded-xl flex items-center justify-center mb-6 group-hover:bg-amber-600 transition-colors">
                <Shield className="w-8 h-8 text-amber-600 group-hover:text-white" />
              </div>
              <h2 className="text-2xl font-bold text-slate-800 mb-2">Appraisal 儀表板</h2>
              <p className="text-slate-500">管理者可以上傳 Excel 考核檔並快速生成分析儀表板。</p>
              <div className="mt-3 inline-flex items-center gap-2 text-xs font-bold text-amber-500 uppercase tracking-wide">
                管理員限定
              </div>
            </button>
          )}
        </div>

        <div className="mt-12 text-center">
          <button onClick={onLogout} className="text-slate-400 hover:text-slate-600 flex items-center justify-center mx-auto gap-2">
            <LogOut size={16} /> 登出帳號
          </button>
        </div>
      </div>
    </div>
  );
};

// --- R&D Nexus System Wrapper ---
const RDNexusSystem = ({ onBackToMenu, user }) => {
    const [selectedMachine, setSelectedMachine] = useState(null);
    const [machines, setMachines] = useState([]);

    useEffect(() => {
        const unsubscribe = db.subscribe('rd_machines', (data) => {
            setMachines(data);
        });
        return () => unsubscribe();
    }, []);

    const handleAddMachine = async (newMachine) => {
        await db.addDoc('rd_machines', { ...newMachine, id: 'M' + Date.now() });
    };

    const handleUpdateMachine = async (updatedMachine) => {
        await db.updateDoc('rd_machines', updatedMachine.id, updatedMachine);
    };

    if (selectedMachine) {
        return <ProjectApp machine={selectedMachine} user={user} onBackToMachines={() => setSelectedMachine(null)} />;
    }

    return (
        <MachineSelectionView 
            machines={machines}
            onSelect={setSelectedMachine} 
            onBack={onBackToMenu} 
            onAddMachine={handleAddMachine}
            onUpdateMachine={handleUpdateMachine}
        />
    );
};

const AppraisalWithDashboard = ({ onBackToMenu, user }) => {
  const [step, setStep] = useState(0);
  const [fileName, setFileName] = useState('');
  const [workbook, setWorkbook] = useState(null);
  const [sheetNames, setSheetNames] = useState([]);
  const [currentSheetName, setCurrentSheetName] = useState('');
  const [currentSheetData, setCurrentSheetData] = useState([]);
  const [employees, setEmployees] = useState([]);
  const [currentEmployeeIndex, setCurrentEmployeeIndex] = useState(0);
  const [errorMsg, setErrorMsg] = useState('');
  const [analysisData, setAnalysisData] = useState([]);
  const ANCHOR_TEXT = '評核判定基準';
  const MAIN_ITEM_REGEX = /^[一二三四五六七八九十]/;
  const SUB_ITEM_REGEX = /^[\(（]\d+[\)）]/;

  useEffect(() => {
    if (window.XLSX) {
      setStep(1);
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    script.async = true;
    script.onload = () => setStep(1);
    document.body.appendChild(script);
  }, []);

  useEffect(() => {
    if (workbook && currentSheetName && window.XLSX) {
      const worksheet = workbook.Sheets[currentSheetName];
      const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
      setCurrentSheetData(jsonData);
      analyzeFileStructure(jsonData);
      setCurrentEmployeeIndex(0);
    }
  }, [currentSheetName, workbook]);

  const handleFileUpload = (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    setFileName(file.name);
    setErrorMsg('');
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = e.target && e.target.result;
      if (data && window.XLSX) {
        try {
          const wb = window.XLSX.read(data, { type: 'array' });
          setWorkbook(wb);
          setSheetNames(wb.SheetNames);
          const firstValidSheet = wb.SheetNames.find((name) => !name.includes('相容性')) || wb.SheetNames[0];
          setCurrentSheetName(firstValidSheet);
          setStep(2);
        } catch (err) {
          setErrorMsg('無法讀取 Excel 檔案，請確認格式是否正確。');
        }
      }
    };
    reader.readAsArrayBuffer(file);
  };

  const analyzeFileStructure = (data) => {
    let anchorRowIndex = -1;
    const foundEmployees = [];
    for (let r = 0; r < Math.min(data.length, 30); r++) {
      if (data[r] && data[r].some((cell) => cell && String(cell).includes(ANCHOR_TEXT))) {
        anchorRowIndex = r;
        break;
      }
    }
    if (anchorRowIndex === -1) {
      setEmployees([]);
      return;
    }
    const nameRowIndex = anchorRowIndex - 1;
    if (nameRowIndex < 0) return;
    const nameRow = data[nameRowIndex];
    for (let c = 9; c < nameRow.length; c++) {
      const cell = nameRow[c] ? String(nameRow[c]).trim() : '';
      if (cell && cell.length > 0 && cell.length < 10 && !cell.includes('評核')) {
        foundEmployees.push({
          name: cell,
          colIndex: c,
          scoreCol: c,
          factCol: c + 1
        });
      }
    }
    setEmployees(foundEmployees);
  };

  const recalculateSheet = (data, scoreCol) => {
    const newData = [...data];
    let currentMainRowIndex = -1;
    let subItemsSum = 0;
    let hasSubItems = false;
    for (let i = 0; i < newData.length; i++) {
      const row = newData[i] || [];
      const title = row[0] ? String(row[0]).trim() : '';
      if (MAIN_ITEM_REGEX.test(title)) {
        if (currentMainRowIndex !== -1 && hasSubItems) {
          newData[currentMainRowIndex][scoreCol] = subItemsSum;
        }
        currentMainRowIndex = i;
        subItemsSum = 0;
        hasSubItems = false;
      } else if (SUB_ITEM_REGEX.test(title)) {
        if (currentMainRowIndex !== -1) {
          hasSubItems = true;
          const val = parseFloat(row[scoreCol]);
          if (!isNaN(val)) subItemsSum += val;
        }
      }
    }
    if (currentMainRowIndex !== -1 && hasSubItems) {
      newData[currentMainRowIndex][scoreCol] = subItemsSum;
    }
    return newData;
  };

  const handleScoreChange = (rowIndex, colIndex, value) => {
    const newData = [...currentSheetData];
    newData[rowIndex] = [...(newData[rowIndex] || [])];
    newData[rowIndex][colIndex] = value;
    const currentEmp = employees[currentEmployeeIndex];
    let updatedData = newData;
    if (currentEmp && colIndex === currentEmp.scoreCol) {
      updatedData = recalculateSheet(updatedData, colIndex);
    }
    setCurrentSheetData(updatedData);
    if (workbook && window.XLSX) {
      const newSheet = window.XLSX.utils.aoa_to_sheet(updatedData);
      workbook.Sheets[currentSheetName] = newSheet;
    }
  };

  const calculateTotalScore = (data, colIndex) => {
    let total = 0;
    data.forEach((row) => {
      const firstCell = row && row[0] ? String(row[0]).trim() : '';
      if (MAIN_ITEM_REGEX.test(firstCell)) {
        const val = parseFloat(row[colIndex]);
        if (!isNaN(val)) total += val;
      }
    });
    return total;
  };

  const performAnalysis = () => {
    if (!workbook || !window.XLSX) return;
    const results = [];
    workbook.SheetNames.forEach((sheetName) => {
      if (sheetName.includes('相容性')) return;
      const worksheet = workbook.Sheets[sheetName];
      const data = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
      let anchorRowIndex = -1;
      for (let r = 0; r < Math.min(data.length, 30); r++) {
        if (data[r] && data[r].some((cell) => cell && String(cell).includes(ANCHOR_TEXT))) {
          anchorRowIndex = r;
          break;
        }
      }
      if (anchorRowIndex === -1) return;
      const nameRow = data[anchorRowIndex - 1];
      if (!nameRow) return;
      for (let c = 9; c < nameRow.length; c++) {
        const name = nameRow[c] ? String(nameRow[c]).trim() : '';
        if (name && name.length > 0 && name.length < 10 && !name.includes('評核')) {
          const score = calculateTotalScore(data, c);
          results.push({
            name,
            department: sheetName,
            score
          });
        }
      }
    });
    results.sort((a, b) => b.score - a.score);
    setAnalysisData(results);
    setStep(3);
  };

  const handleDownloadXLSX = () => {
    if (!workbook || !window.XLSX) return;
    window.XLSX.writeFile(workbook, `已考核_${fileName}`);
  };

  const isCalculatedRow = (rowIndex) => {
    const nextRow = currentSheetData[rowIndex + 1];
    if (!nextRow) return false;
    const nextTitle = nextRow[0] ? String(nextRow[0]).trim() : '';
    return SUB_ITEM_REGEX.test(nextTitle);
  };

  const renderDashboard = () => {
    if (analysisData.length === 0) {
      return <div className="p-10 text-center text-slate-500">目前尚未產出分析結果。</div>;
    }
    const avgScore = (analysisData.reduce((acc, curr) => acc + curr.score, 0) / analysisData.length).toFixed(1);
    const highest = analysisData[0];
    const lowest = analysisData[analysisData.length - 1];
    const scoreGap = (highest.score - lowest.score).toFixed(1);
    const topFive = analysisData.slice(0, 5);
    const bottomFive = analysisData.slice(-5);
    return (
      <div className="bg-gray-50 h-full overflow-y-auto p-6">
        <div className="max-w-6xl mx-auto space-y-6">
          <div className="flex items-center justify-between flex-wrap gap-3">
            <div>
              <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <PieChartIcon className="text-blue-600" />
                績效戰情儀表板
              </h2>
              <p className="text-sm text-gray-500">依據 Excel 考核表自動計算排名與動態等級。</p>
            </div>
            <div className="flex flex-wrap items-center gap-2">
              <button onClick={onBackToMenu} className="flex items-center gap-2 px-4 py-2 text-sm text-slate-600 border border-slate-200 rounded-lg hover:border-slate-400">
                <LogOut size={16} /> 返回系統選單
              </button>
              <button onClick={() => setStep(2)} className="flex items-center text-gray-600 hover:text-blue-600 font-medium px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-200">
                <ArrowLeft className="w-4 h-4 mr-2" /> 返回考核表
              </button>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-blue-100 rounded-lg text-blue-600"><Users size={20} /></div>
                <span className="text-gray-500 font-medium">考核總人數</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{analysisData.length} <span className="text-sm font-normal text-gray-400">人</span></div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-green-100 rounded-lg text-green-600"><TrendingUp size={20} /></div>
                <span className="text-gray-500 font-medium">公司平均分</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{avgScore} <span className="text-sm font-normal text-gray-400">分</span></div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600"><PieChartIcon size={20} /></div>
                <span className="text-gray-500 font-medium">最高分</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{highest.score.toFixed(1)} <span className="text-sm font-normal text-gray-400">{highest.name}</span></div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-amber-100 rounded-lg text-amber-600"><LineChartIcon size={20} /></div>
                <span className="text-gray-500 font-medium">區間差距</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{scoreGap} <span className="text-sm font-normal text-gray-400">最高與最低</span></div>
            </div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div className="bg-white rounded-2xl border border-gray-100 shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-400 uppercase tracking-wide">Top 5 表現</p>
                  <p className="text-lg font-semibold text-gray-800">本輪表現亮眼</p>
                </div>
                <span className="text-sm text-gray-500">{topFive.length} 筆</span>
              </div>
              <div className="divide-y divide-gray-100 max-h-72 overflow-y-auto">
                {topFive.map((item, idx) => (
                  <div key={`top-${item.name}-${idx}`} className="px-6 py-4 flex items-center justify-between">
                    <div>
                      <p className="font-semibold text-gray-800">{idx + 1}. {item.name}</p>
                      <p className="text-xs text-gray-400">{item.department}</p>
                    </div>
                    <p className="font-bold text-lg text-green-600">{item.score.toFixed(1)}</p>
                  </div>
                ))}
              </div>
            </div>
            <div className="bg-white rounded-2xl border border-gray-100 shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-400 uppercase tracking-wide">待加強名單</p>
                  <p className="text-lg font-semibold text-gray-800">低於平均</p>
                </div>
                <span className="text-sm text-gray-500">{bottomFive.length} 筆</span>
              </div>
              <div className="divide-y divide-gray-100 max-h-72 overflow-y-auto">
                {bottomFive.map((item, idx) => {
                  const rank = analysisData.length - bottomFive.length + idx + 1;
                  return (
                    <div key={`low-${item.name}-${idx}`} className="px-6 py-4 flex items-center justify-between">
                      <div>
                        <p className="font-semibold text-gray-800">{rank}. {item.name}</p>
                        <p className="text-xs text-gray-400">{item.department}</p>
                      </div>
                      <p className="font-bold text-lg text-red-500">{item.score.toFixed(1)}</p>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          <div className="bg-white rounded-2xl border border-gray-100 shadow-sm">
            <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
              <p className="text-xs text-gray-400 uppercase tracking-wide">完整排名</p>
              <span className="text-sm text-gray-500">{analysisData.length} 筆</span>
            </div>
            <div className="divide-y divide-gray-100 max-h-96 overflow-y-auto">
              {analysisData.map((item, idx) => (
                <div key={`list-${idx}`} className="px-6 py-4 flex items-center justify-between">
                  <div>
                    <p className="text-sm font-semibold text-gray-800">{idx + 1}. {item.name}</p>
                    <p className="text-xs text-gray-400">{item.department}</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xs text-gray-400">score</p>
                    <p className="text-lg font-bold text-gray-800">{item.score.toFixed(1)}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderUploadStep = () => (
    <div className="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <p className="text-xs uppercase tracking-wider text-slate-400">步驟 1 / 3</p>
          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <Upload className="text-blue-600" /> Excel 上傳與解析
          </h2>
          <p className="text-sm text-slate-500">上傳考核表後即可在畫面中調整分數與事實欄位。</p>
        </div>
        <button onClick={onBackToMenu} className="flex items-center gap-2 text-sm text-slate-500 hover:text-slate-700">
          <ArrowLeft size={16} /> 返回系統選單
        </button>
      </div>
      <div className="rounded-2xl border border-dashed border-slate-300 p-8 text-center space-y-4">
        <Upload size={36} className="mx-auto text-blue-600" />
        <p className="text-sm text-slate-500">請上傳包含「評核判定基準」標頭的 Excel (.xlsx)</p>
        <label htmlFor="appraisal-upload" className="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-700 cursor-pointer">
          <Upload size={16} /> 點我選擇檔案
        </label>
        <input id="appraisal-upload" type="file" accept=".xlsx,.xls" className="hidden" onChange={handleFileUpload} />
        {fileName && <p className="text-xs text-slate-500">目前選擇：{fileName}</p>}
      </div>
      {errorMsg && <p className="text-sm text-red-600">{errorMsg}</p>}
      <div className="text-xs text-slate-400 space-y-1">
        <p>• 本系統會自動偵測包含「評核判定基準」的區段，並推敲所屬員工欄位。</p>
        <p>• 可直接在畫面上修正單項分數，系統會自動重新計算合計。</p>
      </div>
    </div>
  );

  const renderSheetEditor = () => {
    const selectedEmployee = employees[currentEmployeeIndex];
    const scoreCol = selectedEmployee?.scoreCol;
    const factCol = selectedEmployee?.factCol ?? (scoreCol !== undefined ? scoreCol + 1 : undefined);
    const rowsToDisplay = currentSheetData.slice(0, Math.min(currentSheetData.length, 80));

    return (
      <div className="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 space-y-6">
          <div className="flex flex-wrap items-start justify-between gap-3">
          <div>
            <p className="text-xs uppercase tracking-wider text-slate-400">步驟 2 / 3</p>
            <h2 className="text-2xl font-bold text-slate-800">調整考核表與欄位定位</h2>
            <p className="text-sm text-slate-500">確認每位員工的欄位與分數後，按下「生成儀表板」即可進入分析。</p>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <button onClick={handleDownloadXLSX} disabled={!workbook} className="flex items-center gap-2 px-4 py-2 text-sm border border-slate-200 rounded-lg hover:border-slate-400 disabled:opacity-50">
              <Download size={16} /> 下載調整後 Excel
            </button>
            <button onClick={() => setStep(1)} className="flex items-center gap-2 px-4 py-2 text-sm border border-slate-200 rounded-lg hover:border-slate-400">
              <X size={16} /> 重新上傳
            </button>
            <button onClick={performAnalysis} disabled={employees.length === 0} className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
              <PieChartIcon size={16} /> 生成儀表板
            </button>
              <button onClick={onBackToMenu} className="flex items-center gap-2 px-4 py-2 text-sm border border-slate-200 rounded-lg hover:border-slate-400 text-slate-600">
                <LogOut size={16} /> 離開模組
              </button>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="text-xs uppercase text-slate-400 tracking-wide">工作表</label>
            <select
              value={currentSheetName || ''}
              onChange={(event) => setCurrentSheetName(event.target.value)}
              className="mt-2 w-full border border-slate-200 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
            >
              {sheetNames.length === 0 ? (
                <option value="">尚無工作表可選</option>
              ) : (
                sheetNames.map((sheet) => (
                  <option key={sheet} value={sheet}>{sheet}</option>
                ))
              )}
            </select>
          </div>
          <div>
            <label className="text-xs uppercase text-slate-400 tracking-wide">選擇員工</label>
            <select
              value={employees.length ? currentEmployeeIndex : ''}
              onChange={(event) => {
                const parsed = Number(event.target.value);
                if (!Number.isNaN(parsed)) {
                  setCurrentEmployeeIndex(parsed);
                }
              }}
              className="mt-2 w-full border border-slate-200 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
            >
              {employees.length === 0 ? (
                <option value="">-----</option>
              ) : (
                employees.map((employee, idx) => (
                  <option key={`${employee.name}-${idx}`} value={idx}>{employee.name}</option>
                ))
              )}
            </select>
            {!employees.length && <p className="text-xs text-red-500 mt-2">尚未偵測到任何員工欄位，請確認 Excel 是否包含關鍵標題。</p>}
          </div>
        </div>

        {selectedEmployee ? (
          <div className="space-y-3">
            <div className="rounded-2xl border border-slate-200 overflow-hidden">
              <div className="flex flex-wrap items-center justify-between px-6 py-4 bg-slate-50">
                <div>
                  <p className="text-xs uppercase tracking-wide text-slate-500">目前檢視</p>
                  <p className="text-lg font-semibold text-slate-900">{selectedEmployee.name}</p>
                </div>
                <p className="text-sm text-slate-500">總分欄位：{scoreCol !== undefined ? scoreCol + 1 : '未偵測'}；事實欄位：{factCol !== undefined ? factCol + 1 : '未偵測'}</p>
              </div>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm text-left">
                  <thead className="text-xs uppercase tracking-wide text-slate-400 bg-white">
                    <tr>
                      <th className="px-4 py-3">項目</th>
                      <th className="px-4 py-3">得分</th>
                      <th className="px-4 py-3">事實描述</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rowsToDisplay.map((row, rowIndex) => {
                      const rowData = row || [];
                      const rowTitle = rowData[0] ? String(rowData[0]).trim() : '—';
                      const scoreValue = scoreCol !== undefined ? (rowData[scoreCol] !== undefined ? rowData[scoreCol] : '') : '';
                      const factValue = factCol !== undefined ? (rowData[factCol] !== undefined ? rowData[factCol] : '') : '';
                      const rowClass = isCalculatedRow(rowIndex) ? 'bg-amber-50' : rowIndex % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                      return (
                        <tr key={rowIndex} className={rowClass}>
                          <td className="border-t border-slate-100 px-4 py-3 text-slate-600">{rowTitle}</td>
                          <td className="border-t border-slate-100 px-4 py-3">
                            <input
                              type="text"
                              value={scoreValue}
                              onChange={(event) => scoreCol !== undefined && handleScoreChange(rowIndex, scoreCol, event.target.value)}
                              className="w-full bg-transparent text-slate-900 border-b border-slate-200 focus:border-blue-500 focus:outline-none"
                            />
                          </td>
                          <td className="border-t border-slate-100 px-4 py-3">
                            <input
                              type="text"
                              value={factValue}
                              onChange={(event) => factCol !== undefined && handleScoreChange(rowIndex, factCol, event.target.value)}
                              className="w-full bg-transparent text-slate-900 border-b border-slate-200 focus:border-blue-500 focus:outline-none"
                            />
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
            <p className="text-xs text-slate-400">若某筆項目是合計列 (以括弧開頭的子項)，系統會自動重新計算合計。</p>
          </div>
        ) : (
          <div className="rounded-2xl border border-amber-200 bg-amber-50 px-6 py-5 text-sm text-amber-900">
            尚未偵測到可用的員工欄位，請重新檢查 Excel 是否包含標頭「評核判定基準」或增加人員名稱。
          </div>
        )}
      </div>
    );
  };

  const renderStepContent = () => {
    if (step === 0) {
      return (
        <div className="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 text-center space-y-3">
          <div className="flex items-center justify-center text-blue-600">
            <RefreshCw size={24} />
          </div>
          <p className="text-lg font-semibold text-slate-800">正在載入 Excel 函式庫</p>
          <p className="text-sm text-slate-500">首次使用時將自動下載 xlsx.full.min.js，請稍候。</p>
        </div>
      );
    }
    if (step === 1) return renderUploadStep();
    if (step === 2) return renderSheetEditor();
    if (step === 3) return renderDashboard();
    return null;
  };

  return (
    <div className="min-h-screen bg-slate-100 py-10 px-4">
      <div className="max-w-6xl mx-auto">
        {renderStepContent()}
      </div>
    </div>
  );
};

// --- Root App Component ---
export default function App() {
  const [user, setUser] = useState(null);
  const [system, setSystem] = useState(null); // 'TQM', 'KPI', 'PROJECT'
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const savedUser = sessionStorage.getItem('tqm_user');
    if (savedUser) setUser(JSON.parse(savedUser));
    setLoading(false);
  }, []);

  const handleLogin = async (username, password, setError) => {
    try {
      const users = await db.getDocs('tqm_users', u => u.username === username);
      if (users.length === 0) { setError('帳號不存在'); return; }
      const userData = users[0];
      if (userData.password === password) {
        setUser(userData);
        sessionStorage.setItem('tqm_user', JSON.stringify(userData));
      } else { setError('密碼錯誤'); }
    } catch (err) { console.error(err); setError('登入系統發生錯誤'); }
  };

  const handleLogout = () => {
    setUser(null);
    setSystem(null);
    sessionStorage.removeItem('tqm_user');
  };

  // New DB Import/Export Handlers for Login Screen
  const handleImportDB = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (!data.users || !data.records) throw new Error('格式錯誤');
        db.importData(data);
        alert('資料庫載入成功！');
        window.location.reload(); 
      } catch (err) { alert('載入失敗：' + err.message); }
    };
    reader.readAsText(file);
  };

  if (loading) return <div className="h-screen flex items-center justify-center text-slate-500">系統載入中...</div>;

  if (!user) {
    return <LoginScreen onLogin={handleLogin} loading={false} onImportDB={handleImportDB} />;
  }

  if (!system) {
    return <SystemSelector onSelect={setSystem} onLogout={handleLogout} user={user} />;
  }

  if (system === 'TQM') {
    return <TQMApp appUser={user} onLogout={handleLogout} onBackToMenu={() => setSystem(null)} />;
  }

  if (system === 'KPI') {
    return <KPIApp onBackToMenu={() => setSystem(null)} />;
  }

  if (system === 'PROJECT') {
    return <RDNexusSystem user={user} onBackToMenu={() => setSystem(null)} />;
  }

  if (system === 'APPRAISAL') {
    return <AppraisalWithDashboard user={user} onBackToMenu={() => setSystem(null)} />;
  }

  return null;
}

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
