<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQM 品質管理系統 (本地版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            getDocs, 
            query, 
            where, 
            onSnapshot 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        // 將 Firebase 函數掛載到 window 以供後續使用
        window.firebase = {
            initializeApp,
            getAnalytics,
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            getDocs,
            query,
            where,
            onSnapshot,
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL
        };
    </script>
    <!-- <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0?external=react",
            "recharts": "https://esm.sh/recharts@2.10.3?external=react,react-dom"
        }
    }
    </script>
    <style> -->

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0?external=react",
            "recharts": "https://esm.sh/recharts@2.10.3?external=react,react-dom"
        }
    }
    </script>
    <style>
        /* === 主題變數 === */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-tertiary: #cbd5e1;
            --bg-card: rgba(255, 255, 255, 0.9);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        /* === 全域樣式優化 === */
        * {
            box-sizing: border-box;
        }
        
        body { 
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* 主題切換按鈕樣式 */
        .theme-toggle {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .theme-toggle.dark {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .theme-toggle.light {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
        }
        
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px var(--shadow-color);
        }
        
        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }
        
        /* 明亮主題覆蓋樣式 */
        [data-theme="light"] .bg-gradient-to-br.from-slate-900 {
            background: linear-gradient(to bottom right, #f1f5f9, #e2e8f0, #f1f5f9) !important;
        }
        
        [data-theme="light"] .bg-slate-900\/50 {
            background: rgba(241, 245, 249, 0.95) !important;
        }
        
        [data-theme="light"] .text-white {
            color: #1e293b !important;
        }
        
        [data-theme="light"] .text-slate-400 {
            color: #475569 !important;
        }
        
        [data-theme="light"] .text-slate-300 {
            color: #64748b !important;
        }
        
        [data-theme="light"] .text-slate-500 {
            color: #64748b !important;
        }
        
        [data-theme="light"] .bg-white\/10 {
            background: rgba(255, 255, 255, 0.9) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08) !important;
        }
        
        [data-theme="light"] .bg-white\/5 {
            background: rgba(255, 255, 255, 0.7) !important;
        }
        
        [data-theme="light"] .border-white\/10 {
            border-color: rgba(0, 0, 0, 0.1) !important;
        }
        
        [data-theme="light"] .bg-gradient-to-r.from-blue-400.to-cyan-400 {
            background: linear-gradient(to right, #3b82f6, #06b6d4) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
        }
        
        [data-theme="light"] .backdrop-blur-xl {
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
        }
        
        /* 滾動條美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #94a3b8, #64748b);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #64748b, #475569);
        }
        
        /* 卡片懸停效果 */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* 按鈕動畫 */
        .btn-animated {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-animated:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-animated:active {
            transform: translateY(0);
        }
        
        /* 漸層背景 */
        .gradient-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        /* 玻璃擬態效果 */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* 輸入框聚焦效果 */
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6 !important;
        }
        
        /* 動畫效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out;
        }
        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }
        
        /* 載入骨架屏 */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* 表格樣式優化 */
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        /* 側邊欄樣式 */
        .sidebar-item {
            transition: all 0.2s ease;
            border-radius: 12px;
            margin: 4px 8px;
        }
        .sidebar-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .sidebar-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        /* 狀態標籤 */
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        /* 數字計數動畫 */
        .count-up {
            transition: all 0.5s ease-out;
        }
        
        /* 響應式優化 */
        @media (max-width: 768px) {
            .card-hover:hover {
                transform: none;
            }
        }
        
        /* 🎉 慶祝動畫 */
        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes scale-in {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        .animate-scale-in {
            animation: scale-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
import ReactDOM from 'react-dom/client';
import React, { useState, useEffect, useMemo } from 'react';
import { 
  LayoutDashboard, 
  PlusCircle, 
  List, 
  BarChart3, 
  Download, 
  Trash2, 
  CheckCircle2, 
  AlertCircle, 
  Search,
  Filter,
  Image as ImageIcon,
  X,
  Upload,
  Edit,
  Save,
  Import,
  LogOut,
  Users,
  Shield,
  User,
  Lock,
  Database,
  FileJson,
  FileText, 
  TrendingUp, 
  Menu, 
  ChevronRight,
  ChevronDown,
  ChevronUp,
  Target, 
  RefreshCw,
  RefreshCcw,
  Calendar,
  LineChart as LineChartIcon,
  ListTodo, 
  UserCircle, 
  Settings, 
  AlertTriangle, 
  Clock, 
  ArrowRight, 
  ArrowLeft,
  Briefcase, 
  MessageSquare, 
  Activity, 
  MoreVertical, 
  XCircle, 
  Plus,
  Send,
  Eye,
  Paperclip,
  PieChart as PieChartIcon,
  Building,
  Building2,
  CheckCircle,
  Table as TableIcon,
  Cpu,
  Printer,
  Layers,
  FileBarChart,
  FileSpreadsheet,
  Presentation,
  ExternalLink,
  Link as LinkIcon,
  Calculator,
  GanttChart,
  BarChart3 as GanttChartIcon,
  Sun,
  Moon,
  Package,
  QrCode,
  Tag,
  Type,
  Globe,
  Edit3,
  Settings2,
  History,
  Check,
  Hash
} from 'lucide-react';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  Tooltip as RechartsTooltip,
  Legend, 
  ResponsiveContainer, 
  PieChart, 
  Pie, 
  Cell,
  LineChart,
  Line
} from 'recharts';

// --- Configuration ---
const CONFIG = {
  USE_FIREBASE: true, // 使用 Firebase 雲端資料庫
  DATABASE_TYPE: 'Firebase Firestore'
};

console.log('資料庫模式:', CONFIG.DATABASE_TYPE);


// // --- Remote Database Implementation (Server Mode) ---
// class RemoteDB {
//   constructor() {
//     this.listeners = {};
//     this.baseUrl = CONFIG.SERVER_URL + '/api';
//     this.pollingInterval = null;
//     this.cache = {}; // 簡單的前端快取，避免畫面閃爍
//   }

//   init() {
//     console.log("正在連接伺服器:", this.baseUrl);
//     // 每 2 秒向伺服器檢查一次最新資料 (輪詢)
//     this.pollingInterval = setInterval(() => {
//       Object.keys(this.listeners).forEach(collection => {
//         this._fetchAndNotify(collection);
//       });
//     }, 2000);
//   }

//   async _fetchAndNotify(collection) {
//     try {
//       const res = await fetch(`${this.baseUrl}/${collection}`);
//       if (res.ok) {
//         const data = await res.json();
//         // 只有當資料真的有變動時才通知 React 更新 (簡單比對)
//         if (JSON.stringify(this.cache[collection]) !== JSON.stringify(data)) {
//             this.cache[collection] = data;
//             if (this.listeners[collection]) {
//                 this.listeners[collection].forEach(cb => cb(data));
//             }
//         }
//       } else {
//           console.warn(`無法取得 ${collection} 資料, status: ${res.status}`);
//       }
//     } catch (e) {
//       console.error("伺服器連線錯誤:", e);
//     }
//   }

//   subscribe(collection, callback) {
//     if (!this.listeners[collection]) this.listeners[collection] = [];
//     this.listeners[collection].push(callback);
    
//     // 訂閱時立即抓取一次
//     this._fetchAndNotify(collection);
    
//     return () => {
//       this.listeners[collection] = this.listeners[collection].filter(cb => cb !== callback);
//     };
//   }

//   async addDoc(collectionName, data) {
//     // 確保有 ID
//     const docToAdd = { ...data, id: data.id || ('doc_' + Date.now() + Math.random().toString(36).substr(2, 9)) };
    
//     const res = await fetch(`${this.baseUrl}/${collectionName}`, {
//       method: 'POST',
//       headers: { 'Content-Type': 'application/json' },
//       body: JSON.stringify(docToAdd)
//     });
    
//     if (!res.ok) throw new Error('Server Error: ' + res.statusText);
    
//     const newDoc = await res.json();
//     this._fetchAndNotify(collectionName); // 立即更新畫面
//     return newDoc;
//   }

//   async updateDoc(collectionName, id, data) {
//     const res = await fetch(`${this.baseUrl}/${collectionName}/${id}`, {
//       method: 'PUT',
//       headers: { 'Content-Type': 'application/json' },
//       body: JSON.stringify(data)
//     });
    
//     if (!res.ok) throw new Error('Server Error: ' + res.statusText);
//     this._fetchAndNotify(collectionName); // 立即更新畫面
//   }

//   async deleteDoc(collectionName, id) {
//     const res = await fetch(`${this.baseUrl}/${collectionName}/${id}`, {
//       method: 'DELETE'
//     });
    
//     if (!res.ok) throw new Error('Server Error: ' + res.statusText);
//     this._fetchAndNotify(collectionName); // 立即更新畫面
//   }

//   async getDocs(collectionName, queryFn) {
//     try {
//       const res = await fetch(`${this.baseUrl}/${collectionName}`);
//       let list = await res.json();
//       if (queryFn) {
//         list = list.filter(queryFn);
//       }
//       return list;
//     } catch (e) {
//       console.error("GetDocs Error:", e);
//       return [];
//     }
//   }

//   // 伺服器模式下的匯出 (從伺服器抓所有資料)
//   async exportData() {
//     const collections = ['tqm_users', 'tqm_records', 'rd_projects', 'rd_tasks', 'rd_changes', 'rd_history', 'rd_messages', 'rd_machines'];
//     const exportObj = { version: '2.0', exportedAt: new Date().toISOString() };
    
//     for (const col of collections) {
//         exportObj[col] = await this.getDocs(col);
//     }
//     return exportObj;
//   }

//   async importData(data) {
//     if (!confirm("警告：匯入資料將會新增至現有伺服器資料庫中。\n若有重複 ID 的資料可能會失敗。\n確定要繼續嗎？")) return;

//     const collections = ['tqm_users', 'tqm_records', 'rd_machines', 'rd_projects', 'rd_tasks', 'rd_changes', 'rd_history', 'rd_messages'];
//     let successCount = 0;
//     let failCount = 0;

//     for (const col of collections) {
//         if (data[col] && Array.isArray(data[col])) {
//             for (const item of data[col]) {
//                 try {
//                     // 嘗試新增
//                     await this.addDoc(col, item);
//                     successCount++;
//                 } catch (e) {
//                     console.warn(`Import failed for ${col} item ${item.id}:`, e);
//                     // 如果失敗(例如ID重複)，嘗試用 updateDoc 覆蓋
//                     try {
//                         if (item.id) {
//                             await this.updateDoc(col, item.id, item);
//                             successCount++;
//                         } else {
//                             failCount++;
//                         }
//                     } catch (updateErr) {
//                         failCount++;
//                     }
//                 }
//             }
//         }
//     }
//     alert(`匯入完成！\n成功: ${successCount} 筆\n失敗/重複: ${failCount} 筆`);
//     window.location.reload();
//   }
// }

// // --- Mock Data for Machines ---
// const MACHINES = [
//     { id: 'M001', name: 'High-Speed Mounter A1', code: 'HSM-A1', status: 'Active', progress: 85, image: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&w=300&q=80', members: '' },
//     { id: 'M002', name: 'Inspection Unit X5', code: 'AOI-X5', status: 'Warning', progress: 60, image: 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?auto=format&fit=crop&w=300&q=80', members: '' },
//     { id: 'M003', name: 'Reflow Oven R3', code: 'RO-R3', status: 'Active', progress: 92, image: 'https://images.unsplash.com/photo-1581092335397-9583eb92d232?auto=format&fit=crop&w=300&q=80', members: '' },
//     { id: 'M004', name: 'Solder Paste Printer P2', code: 'SPP-P2', status: 'Active', progress: 78, image: 'https://images.unsplash.com/photo-1531297461136-82lw9f2125?auto=format&fit=crop&w=300&q=80', members: '' },
// ];

// // --- Mock Data ---
// const PROJECTS = [
//   { id: 1, machineId: 'M001', name: 'AI 視覺辨識模組 V2', owner: '陳建宏', department: '軟體部', stage: '驗證', progress: 85, status: 'normal', deadline: '2025-11-15', category: '新產品', specs: '1. 支援 4K 60fps 影像輸入\n2. 辨識準確率 > 99.5%\n3. 延遲 < 50ms' },
//   { id: 2, machineId: 'M001', name: '高頻通訊晶片散熱座', owner: '林怡君', department: '機構部', stage: '試產', progress: 60, status: 'risk', deadline: '2025-10-20', category: '改款', specs: '1. 散熱功率 15W\n2. 噪音 < 30dB' },
//   { id: 3, machineId: 'M001', name: '車用抬頭顯示器 (HUD)', owner: '張志偉', department: '電子部', stage: '設計', progress: 30, status: 'delay', deadline: '2025-09-30', category: '客製案', specs: '' },
//   { id: 4, machineId: 'M002', name: '企業內部 ERP 整合', owner: '王大明', department: '軟體部', stage: '規劃', progress: 10, status: 'normal', deadline: '2025-12-01', category: '內部案', specs: '' },
//   { id: 5, machineId: 'M002', name: '輕量化無人機機身', owner: '劉雅婷', department: '機構部', stage: '量產', progress: 98, status: 'normal', deadline: '2025-08-15', category: '新產品', specs: '' },
// ];

// const TASKS = [
//   { id: 101, projectId: 1, title: '散熱模擬測試報告', status: 'Doing', owner: '林怡君', priority: 'P1', risk: true },
//   { id: 102, projectId: 1, title: 'PCB 佈線優化', status: 'To Do', owner: '張志偉', priority: 'P2', risk: false },
//   { id: 103, projectId: 1, title: 'AI 模型訓練 (Dataset B)', status: 'Done', owner: '陳建宏', priority: 'P1', risk: false },
//   { id: 104, projectId: 1, title: '客戶需求變更確認', status: 'Review', owner: '王小美', priority: 'P3', risk: true },
// ];

// const CHANGES = [
//   { id: 1, projectId: 1, date: '2025-08-10', type: '設計改善', desc: '優化散熱鰭片結構', owner: '林怡君', impact: 'Low' },
//   { id: 2, projectId: 1, date: '2025-08-12', type: '客戶修改', desc: '新增 HDMI 介面需求', owner: '張志偉', impact: 'High' },
//   { id: 3, projectId: 1, date: '2025-08-15', type: '設計疏失', desc: '干涉檢查未通過', owner: '劉雅婷', impact: 'Medium' },
// ];

// const HISTORY = [
//   { id: 1, projectId: 1, version: 'V1.0', date: '2025-05-01', author: '林怡君', action: '初始設計建立', desc: '建立初步架構，包含主要散熱模組與 PCB 堆疊定義。', status: 'Approved' },
//   { id: 2, projectId: 1, version: 'V1.1', date: '2025-06-15', author: '張志偉', action: '規格變更', desc: '因應客戶需求增加 HDMI 2.1 支援，修改 I/O 板設計。', status: 'Approved' },
//   { id: 3, projectId: 1, version: 'V1.2', date: '2025-07-20', author: '陳建宏', action: '設計優化', desc: '優化散熱鰭片密度，降低整體重量 15%。', status: 'Pending' },
// ];

// const LOAD_DATA = [
//   { name: '機構部', load: 120, capacity: 100 },
//   { name: '電子部', load: 85, capacity: 100 },
//   { name: '軟體部', load: 95, capacity: 100 },
//   { name: '美工部', load: 40, capacity: 100 },
// ];

// const TREND_DATA = [
//   { month: '5月', onTime: 92, delay: 8 },
//   { month: '6月', onTime: 88, delay: 12 },
//   { month: '7月', onTime: 85, delay: 15 },
//   { month: '8月', onTime: 78, delay: 22 },
// ];

// const CHANGE_TYPE_DATA = [
//   { name: '設計改善', value: 45 },
//   { name: '設計疏失', value: 20 },
//   { name: '客戶修改', value: 25 },
//   { name: '料件問題', value: 10 },
// ];

// // --- Local Database Implementation ---
// class LocalDB {
//   constructor() {
//     this.listeners = {};
//     this.init();
//   }

//   init() {
//     const initData = (key, data) => {
//         const val = localStorage.getItem(key);
//         if (!val || val === "undefined" || val === "null") {
//             localStorage.setItem(key, JSON.stringify(data));
//         }
//     };

//     initData('tqm_users', [{
//         id: 'admin_001',
//         username: 'admin',
//         password: 'admin123',
//         displayName: '系統管理員',
//         department: '工程中心',
//         role: 'admin',
//         createdAt: new Date().toISOString()
//     }]);
    
//     initData('tqm_records', []);
    
//     // Initialize R&D Nexus Collections with Mock Data
//     initData('rd_machines', MACHINES);
//     initData('rd_projects', PROJECTS);
//     initData('rd_tasks', TASKS);
//     initData('rd_changes', CHANGES);
//     initData('rd_history', HISTORY);
//     initData('rd_messages', []);
//   }
// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyCMQqRd2JQlRpBsERWUkUpAqFSGBM_UmP0",
  authDomain: "rdsystemdatabase.firebaseapp.com",
  projectId: "rdsystemdatabase",
  storageBucket: "rdsystemdatabase.firebasestorage.app",
  messagingSenderId: "321370607244",
  appId: "1:321370607244:web:eaf0c8dc0ea9ca8212f5a9",
  measurementId: "G-T9PL70TLJ2"
};

// --- Firebase Database Implementation with Cache ---
class FirebaseDB {
  constructor() {
    console.log("正在初始化 Firebase...");
    this.cache = {}; // 本地快取
    this.cacheTimeout = 5 * 60 * 1000; // 快取 5 分鐘
    this.retryAttempts = 3; // 重試次數
    this.retryDelay = 1000; // 重試延遲（毫秒）
    this.isOnline = navigator.onLine;
    this.pendingRequests = new Map(); // 追蹤進行中的請求，避免重複
    this.subscriptionRetryCount = {}; // 追蹤訂閱重試次數
    this.activeSubscriptions = new Map(); // 追蹤活躍的訂閱
    
    // 監聽網路狀態變化
    window.addEventListener('online', () => {
      console.log('🌐 網路已連線');
      this.isOnline = true;
      this.refreshAllSubscriptions();
    });
    window.addEventListener('offline', () => {
      console.log('📴 網路已斷線');
      this.isOnline = false;
    });
    
    // 從 localStorage 載入持久化快取
    this.loadPersistentCache();
    
    try {
        this.app = window.firebase.initializeApp(firebaseConfig);
        this.db = window.firebase.getFirestore(this.app);
        this.storage = window.firebase.getStorage(this.app);
        this.analytics = window.firebase.getAnalytics(this.app);
        this.listeners = {};
        console.log("Firebase 連線成功！");
        console.log("Firebase Storage 已初始化");
        this.ensureAdminExists();
    } catch (e) {
        console.error("Firebase 初始化失敗:", e);
        alert("資料庫連線失敗，請檢查網路。");
    }
  }
  
  // 從 localStorage 載入快取
  loadPersistentCache() {
    try {
      const cached = localStorage.getItem('tqm_db_cache');
      if (cached) {
        const parsed = JSON.parse(cached);
        // 只使用未過期的快取（最多 30 分鐘）
        const maxAge = 30 * 60 * 1000;
        for (const [key, value] of Object.entries(parsed)) {
          if (Date.now() - value.timestamp < maxAge) {
            this.cache[key] = value;
            console.log(`📦 從本地快取載入 ${key} (${value.data?.length || 0} 筆)`);
          }
        }
      }
    } catch (e) {
      console.warn('載入持久化快取失敗:', e);
    }
  }
  
  // 儲存快取到 localStorage
  savePersistentCache() {
    try {
      // 只儲存重要的集合
      const importantCollections = ['rd_machines', 'rd_projects', 'tqm_users'];
      const toSave = {};
      for (const col of importantCollections) {
        if (this.cache[col]) {
          toSave[col] = this.cache[col];
        }
      }
      localStorage.setItem('tqm_db_cache', JSON.stringify(toSave));
    } catch (e) {
      console.warn('儲存持久化快取失敗:', e);
    }
  }
  
  // 刷新所有訂閱（網路恢復時使用）
  refreshAllSubscriptions() {
    console.log('🔄 刷新所有訂閱...');
    for (const [collectionName, sub] of this.activeSubscriptions) {
      if (sub.callback) {
        this.getDocs(collectionName).then(data => {
          sub.callback(data);
        }).catch(e => console.warn(`刷新 ${collectionName} 失敗:`, e));
      }
    }
  }

  async ensureAdminExists() {
      try {
          const q = window.firebase.query(window.firebase.collection(this.db, 'tqm_users'), window.firebase.where("username", "==", "admin"));
          const snapshot = await window.firebase.getDocs(q);
          if (snapshot.empty) {
              await window.firebase.setDoc(window.firebase.doc(this.db, 'tqm_users', 'admin_001'), {
                id: 'admin_001', username: 'admin', password: 'admin123',
                displayName: '系統管理員', department: '工程中心', role: 'admin',
                createdAt: new Date().toISOString()
              });
              console.log("預設管理員建立完成");
          }
      } catch (e) { console.warn("檢查管理員帳號錯誤:", e); }
  }

  // 優化的訂閱方法，加入錯誤處理和重試機制
  subscribe(collectionName, callback) {
    // 記錄活躍的訂閱
    this.activeSubscriptions.set(collectionName, { callback });
    
    // 先從快取載入（如果有），提供即時響應
    if (this.cache[collectionName]) {
      console.log(`📦 從快取載入 ${collectionName} (${this.cache[collectionName].data?.length || 0} 筆)`);
      // 使用 setTimeout 確保非同步執行，避免阻塞
      setTimeout(() => callback(this.cache[collectionName].data), 0);
    }

    // 如果離線，只使用快取
    if (!this.isOnline) {
      console.warn(`📴 離線模式，${collectionName} 使用快取`);
      return () => this.activeSubscriptions.delete(collectionName);
    }

    // 設定超時處理 - 10 秒後如果還沒載入成功，使用快取或空陣列
    let timeoutId = setTimeout(() => {
      if (this.cache[collectionName]) {
        console.warn(`⏰ ${collectionName} 載入超時，繼續使用快取數據`);
      } else {
        console.warn(`⏰ ${collectionName} 載入超時且無快取`);
        callback([]);
      }
    }, 10000);

    let unsubscribe = () => {};
    
    try {
      unsubscribe = window.firebase.onSnapshot(
        window.firebase.collection(this.db, collectionName),
        { includeMetadataChanges: false }, // 減少不必要的更新
        (snapshot) => {
          clearTimeout(timeoutId);
          this.subscriptionRetryCount[collectionName] = 0; // 重置重試計數
          
          const data = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
          
          // 更新快取
          this.cache[collectionName] = {
            data: data,
            timestamp: Date.now()
          };
          
          // 儲存到持久化快取
          this.savePersistentCache();
          
          console.log(`✅ ${collectionName} 訂閱成功 (${data.length} 筆)`);
          callback(data);
        },
        (error) => {
          clearTimeout(timeoutId);
          console.error(`❌ ${collectionName} 訂閱錯誤:`, error.message || error);
          
          // 使用快取作為備用
          if (this.cache[collectionName]) {
            console.log(`📦 錯誤後使用 ${collectionName} 快取數據`);
            callback(this.cache[collectionName].data);
          } else {
            callback([]);
          }
          
          // 嘗試重新訂閱（最多 3 次）
          const retryCount = this.subscriptionRetryCount[collectionName] || 0;
          if (retryCount < 3 && this.isOnline) {
            this.subscriptionRetryCount[collectionName] = retryCount + 1;
            console.log(`🔄 ${collectionName} 將在 ${(retryCount + 1) * 2} 秒後重試訂閱...`);
            setTimeout(() => {
              if (this.activeSubscriptions.has(collectionName)) {
                this.subscribe(collectionName, callback);
              }
            }, (retryCount + 1) * 2000);
          }
        }
      );
    } catch (error) {
      clearTimeout(timeoutId);
      console.error(`❌ ${collectionName} 訂閱失敗:`, error.message || error);
      
      if (this.cache[collectionName]) {
        callback(this.cache[collectionName].data);
      } else {
        callback([]);
      }
    }
    
    // 返回取消訂閱函數
    return () => {
      this.activeSubscriptions.delete(collectionName);
      unsubscribe();
    };
  }
  
  // 批次訂閱多個集合（優化效能）
  subscribeMultiple(collections, callbacks) {
    const unsubscribes = [];
    
    // 先立即從快取載入所有數據
    for (let i = 0; i < collections.length; i++) {
      const col = collections[i];
      if (this.cache[col]) {
        callbacks[i](this.cache[col].data);
      }
    }
    
    // 然後並行訂閱
    for (let i = 0; i < collections.length; i++) {
      const unsub = this.subscribe(collections[i], callbacks[i]);
      unsubscribes.push(unsub);
    }
    
    return () => unsubscribes.forEach(unsub => unsub());
  }

  async addDoc(collectionName, data) {
    const tempId = data.id ? String(data.id) : `temp_${Date.now()}`;
    
    // 樂觀更新：先更新本地快取
    if (this.cache[collectionName]) {
      const newData = { ...data, id: tempId };
      this.cache[collectionName].data = [...this.cache[collectionName].data, newData];
    }
    
    try {
      if (data.id) {
        const docId = String(data.id);
        await window.firebase.setDoc(window.firebase.doc(this.db, collectionName, docId), data);
        return data;
      } else {
        const docRef = await window.firebase.addDoc(window.firebase.collection(this.db, collectionName), data);
        await window.firebase.updateDoc(docRef, { id: docRef.id });
        
        // 更新快取中的臨時 ID
        if (this.cache[collectionName]) {
          const idx = this.cache[collectionName].data.findIndex(d => d.id === tempId);
          if (idx !== -1) {
            this.cache[collectionName].data[idx].id = docRef.id;
          }
        }
        
        return { ...data, id: docRef.id };
      }
    } catch (error) {
      // 回滾樂觀更新
      if (this.cache[collectionName]) {
        this.cache[collectionName].data = this.cache[collectionName].data.filter(d => d.id !== tempId);
      }
      throw error;
    }
  }

  async updateDoc(collectionName, id, data) {
    const docId = String(id);
    
    // 樂觀更新：先更新本地快取
    let originalData = null;
    if (this.cache[collectionName]) {
      const idx = this.cache[collectionName].data.findIndex(d => d.id === docId);
      if (idx !== -1) {
        originalData = { ...this.cache[collectionName].data[idx] };
        this.cache[collectionName].data[idx] = { ...this.cache[collectionName].data[idx], ...data };
      }
    }
    
    try {
      await window.firebase.updateDoc(window.firebase.doc(this.db, collectionName, docId), data);
    } catch (error) {
      // 回滾樂觀更新
      if (originalData && this.cache[collectionName]) {
        const idx = this.cache[collectionName].data.findIndex(d => d.id === docId);
        if (idx !== -1) {
          this.cache[collectionName].data[idx] = originalData;
        }
      }
      throw error;
    }
  }

  async deleteDoc(collectionName, id) {
    const docId = String(id);
    
    // 樂觀更新：先從本地快取移除
    let deletedData = null;
    let deletedIndex = -1;
    if (this.cache[collectionName]) {
      deletedIndex = this.cache[collectionName].data.findIndex(d => d.id === docId);
      if (deletedIndex !== -1) {
        deletedData = this.cache[collectionName].data[deletedIndex];
        this.cache[collectionName].data.splice(deletedIndex, 1);
      }
    }
    
    try {
      await window.firebase.deleteDoc(window.firebase.doc(this.db, collectionName, docId));
    } catch (error) {
      // 回滾樂觀更新
      if (deletedData && this.cache[collectionName]) {
        this.cache[collectionName].data.splice(deletedIndex, 0, deletedData);
      }
      throw error;
    }
  }

  // 上傳檔案到 Firebase Storage
  async uploadFile(file, folder = 'proposals', onProgress = null) {
    try {
      if (!file) {
        throw new Error('沒有選擇檔案');
      }

      // 檢查是否從 file:// 協議運行
      if (window.location.protocol === 'file:') {
        throw new Error('⚠️ 檔案上傳功能需要透過 HTTP 伺服器運行\n\n請使用以下方式之一：\n1. 將檔案上傳到雲端（Google Drive、OneDrive）並使用「貼上外部連結」功能\n2. 使用本地伺服器運行此系統（如 python -m http.server 或 Live Server）');
      }

      // 檢查檔案大小（限制 50MB）
      const maxSize = 50 * 1024 * 1024;
      if (file.size > maxSize) {
        throw new Error('檔案大小超過 50MB 限制');
      }

      // 產生唯一檔名
      const timestamp = Date.now();
      const randomStr = Math.random().toString(36).substring(2, 15);
      const fileExt = file.name.split('.').pop();
      const fileName = `${folder}/${timestamp}_${randomStr}.${fileExt}`;

      // 建立 Storage 參考 - 使用 modular API
      const storageRef = window.firebase.ref(this.storage, fileName);
      
      // 開始上傳
      const uploadTask = window.firebase.uploadBytesResumable(storageRef, file);

      return new Promise((resolve, reject) => {
        uploadTask.on(
          'state_changed',
          (snapshot) => {
            // 計算上傳進度
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log(`上傳進度: ${progress.toFixed(2)}%`);
            if (onProgress) {
              onProgress(progress);
            }
          },
          (error) => {
            console.error('上傳失敗:', error);
            reject(error);
          },
          async () => {
            // 上傳完成，取得下載 URL
            try {
              const downloadURL = await window.firebase.getDownloadURL(uploadTask.snapshot.ref);
              console.log('✅ 檔案上傳成功:', downloadURL);
              resolve({
                url: downloadURL,
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                path: fileName
              });
            } catch (error) {
              reject(error);
            }
          }
        );
      });
    } catch (error) {
      console.error('檔案上傳錯誤:', error);
      throw error;
    }
  }

  // 優化的 getDocs 方法，加入快取和重試機制
  async getDocs(collectionName, queryFn) {
    // 檢查快取
    const cached = this.cache[collectionName];
    if (cached && (Date.now() - cached.timestamp < this.cacheTimeout)) {
      console.log(`📦 從快取載入 ${collectionName} (${cached.data.length} 筆)`);
      let list = cached.data;
      if (queryFn) list = list.filter(queryFn);
      return list;
    }

    // 帶重試的載入邏輯
    for (let attempt = 1; attempt <= this.retryAttempts; attempt++) {
      try {
        console.log(`🔄 載入 ${collectionName} (嘗試 ${attempt}/${this.retryAttempts})`);
        
        const snapshot = await Promise.race([
          window.firebase.getDocs(window.firebase.collection(this.db, collectionName)),
          new Promise((_, reject) => 
            setTimeout(() => reject(new Error('請求超時')), 5000)
          )
        ]);
        
        let list = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
        
        // 更新快取
        this.cache[collectionName] = {
          data: list,
          timestamp: Date.now()
        };
        
        console.log(`✅ ${collectionName} 載入成功 (${list.length} 筆)`);
        
        if (queryFn) list = list.filter(queryFn);
        return list;
        
      } catch (error) {
        console.warn(`⚠️ ${collectionName} 載入失敗 (嘗試 ${attempt}/${this.retryAttempts}):`, error.message);
        
        // 如果不是最後一次嘗試，等待後重試
        if (attempt < this.retryAttempts) {
          await new Promise(resolve => setTimeout(resolve, this.retryDelay * attempt));
        } else {
          // 最後一次失敗，嘗試使用舊快取
          if (cached) {
            console.log(`📦 使用舊快取 ${collectionName} (${cached.data.length} 筆)`);
            let list = cached.data;
            if (queryFn) list = list.filter(queryFn);
            return list;
          }
          console.error(`❌ ${collectionName} 載入完全失敗，返回空陣列`);
          return [];
        }
      }
    }
    
    return [];
  }
  
  // 並行載入多個集合（優化效能）
  async getDocsParallel(collectionNames) {
    console.log(`🚀 並行載入 ${collectionNames.length} 個集合...`);
    const startTime = Date.now();
    
    const promises = collectionNames.map(col => 
      this.getDocs(col).catch(e => {
        console.warn(`⚠️ ${col} 載入失敗:`, e);
        return this.cache[col]?.data || [];
      })
    );
    
    const results = await Promise.all(promises);
    
    const resultMap = {};
    collectionNames.forEach((col, i) => {
      resultMap[col] = results[i];
    });
    
    console.log(`✅ 並行載入完成，耗時 ${Date.now() - startTime}ms`);
    return resultMap;
  }
  
  // 預載入常用集合
  async preloadCommonCollections() {
    const commonCollections = ['rd_machines', 'rd_projects', 'rd_tasks', 'tqm_users'];
    console.log('🔄 預載入常用集合...');
    return this.getDocsParallel(commonCollections);
  }
  
  // 清除所有快取
  clearCache() {
    this.cache = {};
    localStorage.removeItem('tqm_db_cache');
    console.log('🗑️ 快取已清除');
  }
  
  // 取得快取狀態
  getCacheStatus() {
    const status = {};
    for (const [key, value] of Object.entries(this.cache)) {
      status[key] = {
        count: value.data?.length || 0,
        age: Math.round((Date.now() - value.timestamp) / 1000) + '秒',
        fresh: Date.now() - value.timestamp < this.cacheTimeout
      };
    }
    return status;
  }
  
  // 為了相容你的匯入匯出功能
  async importData(data) {
    if (!confirm("確定匯入至雲端？")) return;
    const collections = ['tqm_users', 'tqm_records', 'rd_machines', 'rd_projects', 'rd_tasks', 'rd_changes', 'rd_history', 'rd_messages', 'spec_discussion_urls'];
    for (const col of collections) {
        if (data[col]) {
            for (const item of data[col]) await this.addDoc(col, item);
        }
    }
    alert("匯入完成，請重新整理頁面。");
  }
  
  async exportData() {
     const exportObj = { version: '3.0', exportedAt: new Date().toISOString() };
     const collections = ['tqm_users', 'tqm_records', 'rd_machines', 'rd_projects', 'rd_tasks', 'rd_changes', 'rd_history', 'rd_messages', 'spec_discussion_urls'];
     // 使用並行載入加速匯出
     const data = await this.getDocsParallel(collections);
     for (const col of collections) {
       exportObj[col] = data[col] || [];
     }
     return exportObj;
  }
}

// 初始化資料庫
const db = new FirebaseDB();

// --- Constants ---
const DEPARTMENTS = ["機構設計", "多媒體設計", "電子設計", "工程中心", "研發部", "軟體部", "製造部", "機構部", "電子部", "美工部", "業務部", "品保部", "管理部"];
const ISSUE_TYPES = [
  "設計疏失", "資料疏失", "公差問題", "組裝異常", 
  "程式異常", "配線異常", "供應商來料", "客戶因素", "其他"
];
const MONTHS = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658', '#8dd1e1', '#a4de6c'];



// --- Helper Functions ---
const parseCSV = (text) => {
  const result = [];
  let row = [];
  let inQuote = false;
  let currentToken = '';
  
  // Auto-detect delimiter (Comma or Tab)
  const firstLine = text.substring(0, 1000).split('\n')[0];
  const delimiter = firstLine.includes('\t') ? '\t' : ',';
  
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const nextChar = text[i + 1];

    if (char === '"') {
      if (inQuote && nextChar === '"') {
        currentToken += '"';
        i++;
      } else {
        inQuote = !inQuote;
      }
    } else if (char === delimiter && !inQuote) {
      row.push(currentToken.trim());
      currentToken = '';
    } else if ((char === '\r' || char === '\n') && !inQuote) {
      if (currentToken || row.length > 0) row.push(currentToken.trim());
      if (row.length > 0) result.push(row);
      row = [];
      currentToken = '';
      if (char === '\r' && nextChar === '\n') i++;
    } else {
      currentToken += char;
    }
  }
  if (currentToken || row.length > 0) row.push(currentToken.trim());
  if (row.length > 0) result.push(row);
  return result;
};

// --- Helper Components ---

const StatCard = ({ title, value, subtext, icon: Icon, colorClass, trend, trendValue }) => (
  <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100/50 card-hover relative overflow-hidden group">
    {/* 背景裝飾 */}
    <div className={`absolute top-0 right-0 w-32 h-32 ${colorClass} opacity-5 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500`}></div>
    
    <div className="relative flex items-center space-x-4">
      <div className={`p-4 rounded-2xl ${colorClass} bg-opacity-10 group-hover:scale-110 transition-transform duration-300`}>
        <Icon className={`w-7 h-7 ${colorClass.replace('bg-', 'text-')}`} />
      </div>
      <div className="flex-1">
        <p className="text-gray-500 text-sm font-medium mb-1">{title}</p>
        <div className="flex items-baseline gap-2">
          <h3 className="text-3xl font-bold text-gray-800">{value}</h3>
          {trend && (
            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${
              trend === 'up' ? 'text-emerald-600 bg-emerald-50' : 'text-rose-600 bg-rose-50'
            }`}>
              {trend === 'up' ? '↑' : '↓'} {trendValue}
            </span>
          )}
        </div>
        {subtext && <p className="text-xs text-gray-400 mt-1">{subtext}</p>}
      </div>
    </div>
  </div>
);

const ImageModal = ({ src, onClose }) => {
  if (!src) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fadeIn" onClick={onClose}>
      <div className="relative max-w-4xl max-h-[90vh] w-full flex flex-col items-center">
        <button onClick={onClose} className="absolute -top-12 right-0 text-white/80 hover:text-white transition-colors p-2 hover:bg-white/10 rounded-full"><X size={28} /></button>
        <img src={src} alt="Evidence" className="max-w-full max-h-[85vh] object-contain rounded-2xl shadow-2xl ring-1 ring-white/20" onClick={(e) => e.stopPropagation()} />
      </div>
    </div>
  );
};

const NavButton = ({ active, onClick, icon: Icon, label }) => (
  <button 
    onClick={onClick}
    className={`w-full flex items-center space-x-3 px-4 py-3.5 rounded-xl transition-all duration-200 ${
      active 
        ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg shadow-blue-500/25' 
        : 'text-slate-400 hover:bg-white/10 hover:text-white'
    }`}
  >
    <Icon size={20} />
    <span className="font-medium">{label}</span>
  </button>
);

// --- Login Screen Component (Updated with Import) ---
const LoginScreen = ({ onLogin, loading, onImportDB, onExportDB }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!username || !password) {
      setError('請輸入帳號與密碼');
      return;
    }
    onLogin(username, password, setError);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4 relative overflow-hidden">
      {/* 背景動態效果 */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute -top-40 -right-40 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
        <div className="absolute -bottom-40 -left-40 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style={{animationDelay: '1s'}}></div>
        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-cyan-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse" style={{animationDelay: '2s'}}></div>
      </div>
      
      <div className="relative bg-white/95 backdrop-blur-xl w-full max-w-md p-8 rounded-3xl shadow-2xl border border-white/20 animate-fadeIn">
        <div className="text-center mb-8">
          <div className="relative inline-block">
            <div className="absolute inset-0 bg-blue-600 rounded-2xl blur-lg opacity-50"></div>
            <div className="relative bg-gradient-to-br from-blue-500 to-blue-700 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl">
              <CheckCircle2 className="text-white w-10 h-10" />
            </div>
          </div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent">TQM 品質管理系統</h1>
          <p className="text-slate-500 mt-2 text-sm">全方位研發專案追蹤與品質管理平台</p>
          <div className="mt-3 inline-flex items-center gap-2 text-xs bg-gradient-to-r from-blue-50 to-cyan-50 text-blue-700 px-4 py-2 rounded-full border border-blue-100">
            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            Firebase 雲端連線中
          </div>
        </div>

        <form onSubmit={handleSubmit} className="space-y-5">
          {error && (
            <div className="bg-red-50 text-red-600 p-4 rounded-xl text-sm flex items-center gap-3 border border-red-100 animate-fadeIn">
              <div className="bg-red-100 p-2 rounded-lg">
                <AlertCircle size={18} />
              </div>
              <span>{error}</span>
            </div>
          )}
          
          <div className="space-y-2">
            <label className="block text-sm font-semibold text-slate-700">帳號</label>
            <div className="relative group">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <User className="text-slate-400 group-focus-within:text-blue-500 transition-colors" size={18} />
              </div>
              <input 
                type="text" 
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="w-full pl-12 pr-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 transition-all text-slate-700 placeholder-slate-400"
                placeholder="請輸入使用者帳號"
              />
            </div>
          </div>

          <div className="space-y-2">
            <label className="block text-sm font-semibold text-slate-700">密碼</label>
            <div className="relative group">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <Lock className="text-slate-400 group-focus-within:text-blue-500 transition-colors" size={18} />
              </div>
              <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full pl-12 pr-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 transition-all text-slate-700 placeholder-slate-400"
                placeholder="請輸入密碼"
              />
            </div>
          </div>

          <button 
            type="submit" 
            disabled={loading}
            className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
          >
            {loading ? (
              <>
                <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                驗證中...
              </>
            ) : (
              <>
                <LogOut size={18} />
                登入系統
              </>
            )}
          </button>
        </form>
        
        <div className="mt-8 pt-6 border-t border-slate-200 space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <label className="flex items-center justify-center gap-2 w-full p-3 text-slate-600 hover:text-blue-600 bg-slate-50 hover:bg-blue-50 rounded-xl cursor-pointer transition-all text-sm font-medium border-2 border-dashed border-slate-200 hover:border-blue-300 group">
               <Database size={18} className="group-hover:scale-110 transition-transform" />
               <span>載入備份</span>
               <input type="file" accept=".json" onChange={onImportDB} className="hidden" />
            </label>
            <button 
              onClick={onExportDB}
              className="flex items-center justify-center gap-2 w-full p-3 text-emerald-600 hover:text-emerald-700 bg-emerald-50 hover:bg-emerald-100 rounded-xl transition-all text-sm font-medium border-2 border-dashed border-emerald-200 hover:border-emerald-300 group"
            >
              <FileJson size={18} className="group-hover:scale-110 transition-transform" />
              <span>匯出備份</span>
            </button>
          </div>
          <p className="text-center text-xs text-slate-400">
            💾 定期備份您的資料，確保資料安全
          </p>
        </div>

        <div className="mt-4 text-center text-xs text-slate-400">
          預設管理員帳號: admin / admin123
        </div>
      </div>
    </div>
  );
};

// --- User Management Component ---
const UserManagement = ({ currentUser, onBackToMenu }) => {
  const [users, setUsers] = useState([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [formData, setFormData] = useState({
    username: '', password: '', displayName: '', department: DEPARTMENTS[0], role: 'user',
    permissions: ['TQM', 'KPI_PERSONAL', 'KPI', 'PROJECT', 'KPI_REPORT', 'WAR_ROOM', 'APPRAISAL', 'ELEC_SPEC'] // 預設全部權限
  });
  const [editId, setEditId] = useState(null);
  
  // 系統項目列表
  const SYSTEM_MODULES = [
    { id: 'TQM', name: 'TQM 品質管理' },
    { id: 'KPI_PERSONAL', name: 'KPI 個人填寫' },
    { id: 'KPI', name: 'KPI 管理儀表板' },
    { id: 'PROJECT', name: 'R&D Nexus 專案管理' },
    { id: 'KPI_REPORT', name: 'KPI 整合報告' },
    { id: 'WAR_ROOM', name: '產品開發戰情室' },
    { id: 'APPRAISAL', name: 'Appraisal 績效表' },
    { id: 'ELEC_SPEC', name: '電規追蹤系統' }
  ];

  useEffect(() => {
    const unsubscribe = db.subscribe('tqm_users', (data) => {
      setUsers(data);
    });
    return () => unsubscribe();
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      if (editId) {
        const updateData = { ...formData };
        if (!updateData.password) delete updateData.password;
        await db.updateDoc('tqm_users', editId, updateData);
        alert('帳號更新成功');
      } else {
        const existing = users.find(u => u.username === formData.username);
        if (existing) return alert('帳號已存在，請使用其他帳號');
        if (!formData.password) return alert('請設定密碼');
        await db.addDoc('tqm_users', { ...formData, createdAt: new Date().toISOString() });
        alert('帳號建立成功');
      }
      setIsModalOpen(false);
      resetForm();
    } catch (err) {
      console.error(err);
      alert('操作失敗');
    }
  };

  const handleDelete = async (id) => {
    if (!confirm('確定要刪除此帳號嗎？')) return;
    try { await db.deleteDoc('tqm_users', id); } catch (err) { console.error(err); }
  };

  const startEdit = (user) => {
    setEditId(user.id);
    setFormData({ 
      username: user.username, 
      password: '', 
      displayName: user.displayName, 
      department: user.department, 
      role: user.role,
      permissions: user.permissions || ['TQM', 'KPI_PERSONAL', 'KPI', 'PROJECT', 'KPI_REPORT', 'WAR_ROOM', 'APPRAISAL', 'ELEC_SPEC']
    });
    setIsModalOpen(true);
  };

  const resetForm = () => {
    setEditId(null);
    setFormData({ 
      username: '', 
      password: '', 
      displayName: '', 
      department: DEPARTMENTS[0], 
      role: 'user',
      permissions: ['TQM', 'KPI_PERSONAL', 'KPI', 'PROJECT', 'KPI_REPORT', 'WAR_ROOM', 'APPRAISAL', 'ELEC_SPEC']
    });
  };
  
  // 權限切換處理
  const handlePermissionToggle = (moduleId) => {
    const newPermissions = formData.permissions.includes(moduleId)
      ? formData.permissions.filter(p => p !== moduleId)
      : [...formData.permissions, moduleId];
    setFormData({...formData, permissions: newPermissions});
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8">
      <div className="max-w-6xl mx-auto space-y-6">
        <div className="flex justify-between items-center">
          <div>
            <h2 className="text-3xl font-bold text-white flex items-center gap-3">
              <div className="p-3 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl shadow-lg shadow-purple-500/25">
                <Users className="text-white w-6 h-6"/>
              </div>
              帳號管理
            </h2>
            <p className="text-slate-400 mt-2">管理系統使用者與權限設定</p>
          </div>
          <div className="flex items-center gap-3">
            <button onClick={() => { resetForm(); setIsModalOpen(true); }} className="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-5 py-3 rounded-xl text-sm transition-all shadow-lg shadow-blue-500/25"><PlusCircle size={18} /> 新增帳號</button>
            {onBackToMenu && (
              <button onClick={onBackToMenu} className="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-5 py-3 rounded-xl text-sm transition-all border border-white/10">
                <LogOut size={18} /> 返回
              </button>
            )}
          </div>
        </div>
        <div className="bg-white/5 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/10 overflow-hidden">
          <table className="w-full text-sm text-left text-slate-300">
            <thead className="bg-white/5 text-slate-400 uppercase text-xs border-b border-white/10">
              <tr>
                <th className="px-6 py-4 font-semibold">帳號</th>
                <th className="px-6 py-4 font-semibold">姓名</th>
                <th className="px-6 py-4 font-semibold">部門</th>
                <th className="px-6 py-4 font-semibold">權限角色</th>
                <th className="px-6 py-4 text-center font-semibold">操作</th>
              </tr>
            </thead>
            <tbody>
              {users.map((u, idx) => (
                <tr key={u.id} className={`border-b border-white/5 hover:bg-white/5 transition-colors ${idx % 2 === 0 ? 'bg-white/[0.02]' : ''}`}>
                  <td className="px-6 py-4 font-medium text-white">{u.username}</td>
                  <td className="px-6 py-4 text-slate-300">{u.displayName}</td>
                  <td className="px-6 py-4"><span className="px-3 py-1.5 bg-slate-700/50 rounded-lg text-xs text-slate-300 border border-slate-600/50">{u.department}</span></td>
                  <td className="px-6 py-4"><span className={`px-3 py-1.5 rounded-xl text-xs font-semibold ${u.role === 'admin' ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' : 'bg-slate-500/20 text-slate-400 border border-slate-500/30'}`}>{u.role === 'admin' ? '管理員' : '一般使用者'}</span></td>
                  <td className="px-6 py-4 text-center">
                    <div className="flex justify-center gap-2">
                      <button onClick={() => startEdit(u)} className="text-blue-400 hover:text-blue-300 p-2 hover:bg-blue-500/20 rounded-lg transition-all"><Edit size={16}/></button>
                      {u.username !== 'admin' && (<button onClick={() => handleDelete(u.id)} className="text-slate-500 hover:text-red-400 p-2 hover:bg-red-500/20 rounded-lg transition-all"><Trash2 size={16}/></button>)}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {isModalOpen && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fadeIn">
            <div className="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl shadow-2xl w-full max-w-md p-6 border border-white/10">
               <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                 <div className="p-2 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl">
                   {editId ? <Edit size={18} className="text-white"/> : <PlusCircle size={18} className="text-white"/>}
                 </div>
                 {editId ? '編輯帳號' : '新增帳號'}
               </h3>
               <form onSubmit={handleSubmit} className="space-y-4">
                  <div><label className="block text-xs font-bold text-slate-400 mb-2">帳號</label><input type="text" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} disabled={!!editId} className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white disabled:bg-white/5 disabled:text-slate-500 placeholder-slate-500" required /></div>
                  <div><label className="block text-xs font-bold text-slate-400 mb-2">密碼 {editId && '(不修改請留空)'}</label><input type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white placeholder-slate-500" required={!editId} /></div>
                  <div><label className="block text-xs font-bold text-slate-400 mb-2">姓名</label><input type="text" value={formData.displayName} onChange={e => setFormData({...formData, displayName: e.target.value})} className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white placeholder-slate-500" required /></div>
                  <div><label className="block text-xs font-bold text-slate-400 mb-2">部門</label><select value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})} className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white">{DEPARTMENTS.map(d => <option key={d} value={d} className="bg-slate-800">{d}</option>)}</select></div>
                  <div><label className="block text-xs font-bold text-slate-400 mb-2">權限角色</label><select value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white"><option value="user" className="bg-slate-800">一般使用者</option><option value="admin" className="bg-slate-800">系統管理員</option></select></div>
                  
                  <div className="border-t border-white/10 pt-4">
                    <label className="block text-xs font-bold text-slate-400 mb-3">📌 系統進入權限設定</label>
                    <div className="bg-white/5 backdrop-blur p-4 rounded-xl space-y-2 border border-white/10">
                      {SYSTEM_MODULES.map(module => (
                        <label key={module.id} className="flex items-center gap-3 cursor-pointer hover:bg-white/10 p-2.5 rounded-lg transition-all">
                          <input 
                            type="checkbox" 
                            checked={formData.permissions.includes(module.id)}
                            onChange={() => handlePermissionToggle(module.id)}
                            className="w-5 h-5 text-blue-500 rounded border-white/30 bg-white/10 focus:ring-blue-500"
                          />
                          <span className="text-sm text-slate-300">{module.name}</span>
                        </label>
                      ))}
                    </div>
                    <p className="text-xs text-slate-500 mt-3">💡 提示：管理員帳號預設擁有所有權限</p>
                  </div>
                  
                  <div className="flex justify-end gap-3 pt-4">
                    <button type="button" onClick={() => setIsModalOpen(false)} className="px-5 py-3 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl text-sm transition-all">取消</button>
                    <button type="submit" className="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-semibold hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all transform hover:scale-105">儲存</button>
                  </div>
               </form>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// --- Entry Form Component ---
const EntryForm = ({ onSubmit, currentUser }) => {
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0], department: currentUser.department || DEPARTMENTS[0], personName: currentUser.displayName || '',
    issueType: ISSUE_TYPES[0], description: '', isRepeat: false, status: '未改善', improvementMethod: '', note: '', attachment: null 
  });
  const [fileName, setFileName] = useState('');

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      // Firebase Firestore 單一文件限制約 1MB，設定檔案限制為 800KB
      const maxSize = 800 * 1024; // 800KB
      
      if (file.type.startsWith('image/')) {
        // 圖片檔案：進行壓縮
        const img = new Image();
        const canvas = document.createElement('canvas');
        const reader = new FileReader();
        
        reader.onload = (event) => {
          img.onload = () => {
            // 計算壓縮後的尺寸，最大寬度 1200px
            let width = img.width;
            let height = img.height;
            const maxWidth = 1200;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // 調整品質以控制大小
            let quality = 0.7;
            let compressedData = canvas.toDataURL('image/jpeg', quality);
            
            // 如果還是太大，繼續降低品質
            while (compressedData.length > maxSize * 1.37 && quality > 0.1) {
              quality -= 0.1;
              compressedData = canvas.toDataURL('image/jpeg', quality);
            }
            
            if (compressedData.length > maxSize * 1.37) {
              alert('圖片太大，即使壓縮後仍超過限制，請選擇較小的圖片');
              e.target.value = null;
              return;
            }
            
            setFileName(file.name);
            setFormData(prev => ({ ...prev, attachment: compressedData }));
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        // 非圖片檔案：檢查大小限制
        if (file.size > maxSize) {
          alert(`檔案過大！非圖片檔案請上傳 ${Math.round(maxSize/1024)}KB 以下的檔案。\n\n提示：建議使用雲端硬碟分享連結`);
          e.target.value = null;
          return;
        }
        setFileName(file.name);
        const reader = new FileReader();
        reader.onloadend = () => { setFormData(prev => ({ ...prev, attachment: reader.result })); };
        reader.readAsDataURL(file);
      }
    }
  };

  const handleRemoveFile = () => { setFileName(''); setFormData(prev => ({ ...prev, attachment: null })); };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.personName || !formData.description) return alert("請填寫完整資料");
    onSubmit(formData);
    setFormData(prev => ({ ...prev, description: '', isRepeat: false, status: '未改善', improvementMethod: '', note: '', attachment: null }));
    setFileName('');
  };

  return (
    <form onSubmit={handleSubmit} className="bg-white/10 backdrop-blur-xl p-8 rounded-2xl shadow-2xl border border-white/20 space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">發生日期</label>
          <input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-slate-400" />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">歸屬部門</label>
          <select name="department" value={formData.department} onChange={handleChange} className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-500 text-white">{DEPARTMENTS.map(d => <option key={d} value={d} className="bg-slate-800">{d}</option>)}</select>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">回報人員姓名</label>
          <input type="text" name="personName" value={formData.personName} onChange={handleChange} className="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-xl text-white/70" />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">回報類型</label>
          <select name="issueType" value={formData.issueType} onChange={handleChange} className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-500 text-white">{ISSUE_TYPES.map(t => <option key={t} value={t} className="bg-slate-800">{t}</option>)}</select>
        </div>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-2">問題/異常描述</label>
        <textarea name="description" rows="4" value={formData.description} onChange={handleChange} placeholder="請詳細描述異常情況..." className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-500 text-white placeholder-slate-500 resize-none"></textarea>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-3">佐證照片/附件</label>
        <div className="flex items-center space-x-4">
          <label className="flex items-center gap-2 cursor-pointer bg-white/10 hover:bg-white/20 text-slate-300 px-5 py-3 rounded-xl transition-all border border-white/20 backdrop-blur"><Upload size={18} /><span>選擇檔案</span><input type="file" onChange={handleFileChange} className="hidden" /></label>
          {fileName && (<div className="flex items-center gap-2 text-sm text-emerald-400 bg-emerald-500/20 px-4 py-2 rounded-xl border border-emerald-500/30"><span>{fileName}</span><button type="button" onClick={handleRemoveFile} className="hover:text-red-400 transition-colors"><X size={14}/></button></div>)}
        </div>
        <p className="text-xs text-slate-500 mt-2">支援圖片、PDF、Word、Excel 等格式，檔案大小限制 10MB</p>
        {formData.attachment && formData.attachment.startsWith('data:image') && <div className="mt-4"><img src={formData.attachment} alt="Preview" className="h-32 w-auto object-cover rounded-xl border border-white/20 shadow-lg" /></div>}
        {formData.attachment && !formData.attachment.startsWith('data:image') && <div className="mt-4 p-4 bg-blue-500/20 border border-blue-500/30 rounded-xl text-sm text-blue-400 flex items-center gap-2"><Paperclip size={16} /><span>已上傳: {fileName}</span></div>}
      </div>
      <div className="flex items-center space-x-6 p-5 bg-white/5 rounded-xl border border-white/10">
        <div className="flex items-center">
          <input type="checkbox" id="isRepeat" name="isRepeat" checked={formData.isRepeat} onChange={handleChange} className="w-5 h-5 text-blue-500 rounded border-white/30 bg-white/10 focus:ring-blue-500" />
          <label htmlFor="isRepeat" className="ml-3 text-sm font-medium text-slate-300">是否為重複發生？</label>
        </div>
        <div className="flex items-center space-x-3">
          <label className="text-sm font-medium text-slate-300">目前狀態：</label>
          <div className="flex space-x-2">{['未改善', '已改善'].map(status => (<button key={status} type="button" onClick={() => setFormData(prev => ({ ...prev, status }))} className={`px-4 py-2 rounded-xl text-xs font-semibold transition-all ${formData.status === status ? (status === '已改善' ? 'bg-emerald-500/20 text-emerald-400 ring-2 ring-emerald-500/50' : 'bg-red-500/20 text-red-400 ring-2 ring-red-500/50') : 'bg-white/5 border border-white/20 text-slate-400 hover:bg-white/10'}`}>{status}</button>))}</div>
        </div>
      </div>
      <div className="pt-6 border-t border-white/10 flex justify-end">
        <button type="submit" className="px-8 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-semibold rounded-xl hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all transform hover:scale-105">
          提交紀錄
        </button>
      </div>
    </form>
  );
};

// --- Edit Record Modal ---
const EditRecordModal = ({ record, onClose, onUpdate }) => {
  const [formData, setFormData] = useState({ 
    ...record, 
    improvementMethod: record.improvementMethod || '', 
    note: record.note || '',
    improvementAttachment: record.improvementAttachment || null,
    improvementAttachmentName: record.improvementAttachmentName || ''
  });
  const handleChange = (e) => { const { name, value, type, checked } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value })); };
  const handleSubmit = (e) => { e.preventDefault(); onUpdate(record.id, formData); };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 1024 * 1024) {
        alert('檔案過大！請選擇小於 1MB 的檔案');
        return;
      }
      const reader = new FileReader();
      reader.onload = (event) => {
        setFormData(prev => ({
          ...prev,
          improvementAttachment: event.target.result,
          improvementAttachmentName: file.name
        }));
      };
      reader.readAsDataURL(file);
    }
  };

  return (
    <div className="fixed inset-0 z-[50] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fadeIn">
      <div className="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col border border-white/10">
        <div className="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
          <h2 className="text-xl font-bold text-white flex items-center gap-3">
            <div className="p-2 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl">
              <Edit size={18} className="text-white"/>
            </div>
            編輯/更新案件紀錄
          </h2>
          <button onClick={onClose} className="text-slate-400 hover:text-white p-2 hover:bg-white/10 rounded-lg transition-all"><X size={24} /></button>
        </div>
        <form onSubmit={handleSubmit} className="p-6 space-y-6">
          <div className="bg-blue-500/10 backdrop-blur p-5 rounded-xl space-y-4 border border-blue-500/20">
             <h3 className="text-sm font-bold text-blue-400 uppercase tracking-wider mb-3">原始問題資訊</h3>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-xs font-semibold text-slate-400 mb-2">發生日期</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full text-sm p-3 bg-white/10 border border-white/20 rounded-xl text-white" /></div>
                <div><label className="block text-xs font-semibold text-slate-400 mb-2">部門</label><select name="department" value={formData.department} onChange={handleChange} className="w-full text-sm p-3 bg-white/10 border border-white/20 rounded-xl text-white">{DEPARTMENTS.map(d => <option key={d} value={d} className="bg-slate-800">{d}</option>)}</select></div>
                <div><label className="block text-xs font-semibold text-slate-400 mb-2">人員</label><input type="text" name="personName" value={formData.personName} onChange={handleChange} className="w-full text-sm p-3 bg-white/10 border border-white/20 rounded-xl text-white" /></div>
                <div><label className="block text-xs font-semibold text-slate-400 mb-2">類型</label><select name="issueType" value={formData.issueType} onChange={handleChange} className="w-full text-sm p-3 bg-white/10 border border-white/20 rounded-xl text-white">{ISSUE_TYPES.map(t => <option key={t} value={t} className="bg-slate-800">{t}</option>)}</select></div>
             </div>
             <div><label className="block text-xs font-semibold text-slate-400 mb-2">問題描述</label><textarea name="description" rows="2" value={formData.description} onChange={handleChange} className="w-full text-sm p-3 bg-white/10 border border-white/20 rounded-xl text-white resize-none"></textarea></div>
          </div>
          <div className="bg-emerald-500/10 backdrop-blur p-5 rounded-xl space-y-4 border border-emerald-500/20">
             <h3 className="text-sm font-bold text-emerald-400 uppercase tracking-wider mb-3 flex items-center gap-2"><CheckCircle2 size={16}/> 改善對策與追蹤</h3>
             <div><label className="block text-sm font-semibold text-slate-300 mb-2">改善對策 (Countermeasure)</label><textarea name="improvementMethod" rows="4" value={formData.improvementMethod} onChange={handleChange} placeholder="請填寫具體的改善方法、預防再發措施..." className="w-full p-4 bg-white/10 border border-emerald-500/30 rounded-xl focus:ring-2 focus:ring-emerald-500 text-sm text-white placeholder-slate-500 resize-none"></textarea></div>
             
             {/* 上傳檔案區塊 */}
             <div>
               <label className="block text-sm font-semibold text-slate-300 mb-3">改善輔助資料 (選填)</label>
               <div className="flex items-center gap-3">
                 <label className="flex-1 cursor-pointer">
                   <div className="border-2 border-dashed border-emerald-500/30 rounded-xl p-4 hover:border-emerald-500/60 transition-all bg-white/5 hover:bg-white/10">
                     <div className="flex items-center justify-center gap-3">
                       <Upload className="w-5 h-5 text-emerald-400" />
                       <span className="text-sm text-slate-400">
                         {formData.improvementAttachmentName || '點擊上傳檔案 (圖片/PDF/Excel)'}
                       </span>
                     </div>
                   </div>
                   <input
                     type="file"
                     className="hidden"
                     accept="image/*,.pdf,.xlsx,.xls,.doc,.docx"
                     onChange={handleFileUpload}
                   />
                 </label>
                 {formData.improvementAttachmentName && (
                   <button
                     type="button"
                     onClick={() => setFormData(prev => ({ ...prev, improvementAttachment: null, improvementAttachmentName: '' }))}
                     className="p-3 text-red-400 hover:bg-red-500/20 rounded-xl transition-all"
                     title="移除檔案"
                   >
                     <X className="w-5 h-5" />
                   </button>
                 )}
               </div>
               {formData.improvementAttachmentName && (
                 <p className="mt-3 text-sm text-emerald-400 flex items-center gap-2">
                   <CheckCircle2 className="w-4 h-4" />
                   已選擇: {formData.improvementAttachmentName}
                 </p>
               )}
               {/* 顯示已有附件 */}
               {record.improvementAttachment && !formData.improvementAttachmentName && (
                 <div className="mt-3 p-3 bg-emerald-500/20 rounded-xl flex items-center gap-2 border border-emerald-500/30">
                   <Paperclip className="w-4 h-4 text-emerald-400" />
                   <span className="text-sm text-emerald-300">已有附件: {record.improvementAttachmentName || '檔案'}</span>
                   {record.improvementAttachment.startsWith('data:image') ? (
                     <a href={record.improvementAttachment} target="_blank" className="text-blue-400 hover:text-blue-300 text-sm ml-auto">查看</a>
                   ) : (
                     <a href={record.improvementAttachment} download={record.improvementAttachmentName} className="text-blue-400 hover:text-blue-300 text-sm ml-auto">下載</a>
                   )}
                 </div>
               )}
             </div>
             
             <div><label className="block text-sm font-semibold text-slate-300 mb-2">備註/訊息</label><input type="text" name="note" value={formData.note} onChange={handleChange} placeholder="例如：已通知相關廠商、待主管確認..." className="w-full p-3 bg-white/10 border border-emerald-500/30 rounded-xl text-sm text-white placeholder-slate-500" /></div>
             <div className="flex flex-col md:flex-row gap-4 items-start md:items-center pt-3">
                <div className="flex items-center space-x-3"><label className="text-sm font-bold text-slate-300">目前狀態：</label><select name="status" value={formData.status} onChange={handleChange} className={`text-sm font-bold py-2 px-4 rounded-xl border-none ring-2 ${formData.status === '已改善' ? 'bg-emerald-500/20 text-emerald-400 ring-emerald-500/50' : 'bg-red-500/20 text-red-400 ring-red-500/50'}`}><option value="未改善" className="bg-slate-800">未改善</option><option value="已改善" className="bg-slate-800">已改善</option></select></div>
                <div className="flex items-center"><input type="checkbox" id="editIsRepeat" name="isRepeat" checked={formData.isRepeat} onChange={handleChange} className="w-5 h-5 text-blue-500 rounded border-white/30 bg-white/10" /><label htmlFor="editIsRepeat" className="ml-3 text-sm text-slate-400">標記為重複發生</label></div>
             </div>
          </div>
          <div className="flex justify-end gap-3 pt-5 border-t border-white/10">
            <button type="button" onClick={onClose} className="px-5 py-3 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl text-sm font-medium transition-all">取消</button>
            <button type="submit" className="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded-xl text-sm font-semibold shadow-lg shadow-blue-500/25 flex items-center gap-2 transition-all transform hover:scale-105"><Save size={16} /> 儲存更新</button>
          </div>
        </form>
      </div>
    </div>
  );
};

// --- Record Table ---
const RecordTable = ({ records, onDelete, onViewImage, onEdit, currentUser }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterDept, setFilterDept] = useState('All');
  const filteredRecords = records.filter(r => {
    const matchesSearch = r.description?.toLowerCase().includes(searchTerm.toLowerCase()) || r.personName?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesDept = filterDept === 'All' || r.department === filterDept;
    return matchesSearch && matchesDept;
  });

  return (
    <div className="bg-white/5 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/10 overflow-hidden">
      <div className="p-5 border-b border-white/10 flex gap-4 bg-white/5">
        <div className="relative flex-1 max-w-sm">
          <Search className="absolute left-4 top-3.5 text-slate-400" size={18} />
          <input type="text" placeholder="搜尋紀錄..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-11 pr-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-slate-400" />
        </div>
        <select value={filterDept} onChange={(e) => setFilterDept(e.target.value)} className="px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white">
          <option value="All" className="bg-slate-800">所有部門</option>
          {DEPARTMENTS.map(d => <option key={d} value={d} className="bg-slate-800">{d}</option>)}
        </select>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-sm text-left text-slate-300">
          <thead className="text-xs text-slate-400 uppercase bg-white/5 border-b border-white/10">
            <tr>
              <th className="px-6 py-4 font-semibold">日期</th>
              <th className="px-6 py-4 font-semibold">部門</th>
              <th className="px-6 py-4 font-semibold">人員</th>
              <th className="px-6 py-4 font-semibold">描述</th>
              <th className="px-6 py-4 text-center font-semibold">附件</th>
              <th className="px-6 py-4 text-center font-semibold">狀態</th>
              <th className="px-6 py-4 text-center font-semibold">操作</th>
            </tr>
          </thead>
          <tbody>
            {filteredRecords.map((r, idx) => (
              <tr key={r.id} className={`border-b border-white/5 hover:bg-white/5 transition-colors ${idx % 2 === 0 ? 'bg-white/[0.02]' : ''}`}>
                <td className="px-6 py-4 whitespace-nowrap text-slate-300">{r.date}</td>
                <td className="px-6 py-4"><span className="px-3 py-1.5 bg-slate-700/50 rounded-lg text-xs text-slate-300 border border-slate-600/50">{r.department}</span></td>
                <td className="px-6 py-4 text-slate-300">{r.personName}</td>
                <td className="px-6 py-4 max-w-xs truncate text-slate-400">{r.description}</td>
                <td className="px-6 py-4 text-center flex justify-center gap-2">
                  {/* 原始問題附件 */}
                  {r.attachment ? (r.attachment.startsWith('data:image') ? <button onClick={() => onViewImage(r.attachment)} className="text-blue-400 hover:text-blue-300 p-1.5 hover:bg-blue-500/20 rounded-lg transition-all" title="查看原始附件"><ImageIcon size={18}/></button> : <a href={r.attachment} download className="text-emerald-400 hover:text-emerald-300 p-1.5 hover:bg-emerald-500/20 rounded-lg transition-all" title="下載原始附件"><Paperclip size={18}/></a>) : null}
                  {/* 改善對策附件 */}
                  {r.improvementAttachment ? (r.improvementAttachment.startsWith('data:image') ? <button onClick={() => onViewImage(r.improvementAttachment)} className="text-purple-400 hover:text-purple-300 p-1.5 hover:bg-purple-500/20 rounded-lg transition-all" title={`查看改善附件: ${r.improvementAttachmentName || '圖片'}`}><ImageIcon size={18}/></button> : <a href={r.improvementAttachment} download={r.improvementAttachmentName || '改善附件'} className="text-orange-400 hover:text-orange-300 p-1.5 hover:bg-orange-500/20 rounded-lg transition-all" title={`下載改善附件: ${r.improvementAttachmentName || '檔案'}`}><Paperclip size={18}/></a>) : null}
                  {/* 都沒有附件時顯示 - */}
                  {!r.attachment && !r.improvementAttachment && <span className="text-slate-600">-</span>}
                </td>
                <td className="px-6 py-4 text-center">
                  <span className={`px-3 py-1.5 rounded-xl text-xs font-semibold ${r.status === '已改善' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`}>{r.status}</span>
                </td>
                <td className="px-6 py-4 text-center flex justify-center gap-1">
                  {/* 編輯權限：管理員 或 新增該紀錄的人 */}
                  {(currentUser.role === 'admin' || r.createdByUser === currentUser.username) && (
                    <button onClick={() => onEdit(r)} className="text-blue-400 hover:text-blue-300 p-2 hover:bg-blue-500/20 rounded-lg transition-all" title="編輯"><Edit size={16} /></button>
                  )}
                  {/* 刪除權限：僅管理員 */}
                  {currentUser.role === 'admin' && (
                    <button onClick={() => onDelete(r.id)} className="text-slate-500 hover:text-red-400 p-2 hover:bg-red-500/20 rounded-lg transition-all" title="刪除"><Trash2 size={16} /></button>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// --- KPI System Components ---

const DEPARTMENT_COLORS = {
  '機構設計課': '#3b82f6', // Blue
  '工程中心': '#8b5cf6',   // Purple
  '多媒體設計課': '#ec4899', // Pink
  '電子設計課': '#10b981',   // Green
  '線材設計課': '#f97316',   // Orange (New)
};

const MONTH_ORDER = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

const DEPARTMENT_TEMPLATES = {
  '機構設計課': [
    { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '', status: 'Achieved', note: '' },
    { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '設計周期縮短', target: '10%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '新設計提案', target: '1項', actual: '', status: 'Achieved', note: '' },
  ],
  '線材設計課': [
    { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '', status: 'Achieved', note: '' },
    { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '設計周期縮短', target: '10%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '新設計提案', target: '1項', actual: '', status: 'Achieved', note: '' },
  ],
  '工程中心': [
    { category: '質量', name: 'ERP更新準確率', target: '≥ 99%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '設變單改BOM', target: '≥ 98%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '試作圖處理時間', target: '縮短10%', actual: '', status: 'Achieved', note: '' },
    { category: '準確性', name: '目錄命名規範', target: '100%', actual: '', status: 'Achieved', note: '' },
    { category: '維護性', name: '文件備份', target: '100%', actual: '', status: 'Achieved', note: '' },
  ],
  '多媒體設計課': [
    { category: '質量', name: '客戶滿意度', target: '≥ 100%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '按時交付率', target: '≥ 100%', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '每季新風格', target: '1項', actual: '', status: 'Achieved', note: '' },
  ],
  '電子設計課': [
    { category: '質量', name: '錯誤率', target: '≤ 1.5%', actual: '', status: 'Achieved', note: '' },
    { category: '效率', name: '開發時間縮短', target: '5%以上', actual: '', status: 'Achieved', note: '' },
    { category: '創新', name: '問題改善案', target: '1項', actual: '', status: 'Achieved', note: '' },
  ]
};

const RAW_DATA_NOV = [
  {
    id: 1, name: '廖原頡', department: '機構設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '2%', status: 'Achieved', note: '錯誤2次/總數100次' },
      { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '98%', status: 'Achieved', note: '98次/100次' },
      { category: '效率', name: '設計周期縮短', target: '10%', actual: '8%', status: 'Warning', note: '未達標 (8% vs 10%)' },
      { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '2次', status: 'Achieved', note: '' },
      { category: '創新', name: '新設計提案', target: '1項', actual: '1項', status: 'Achieved', note: '' },
    ]
  },
  {
    id: 2, name: '劉素華', department: '機構設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '7%', status: 'Missed', note: '錯誤1次/總數14次 (未達成)' },
      { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '93%', status: 'Achieved', note: '13次/14次' },
      { category: '效率', name: '設計周期縮短', target: '10%', actual: '10%', status: 'Achieved', note: '目標達成' },
      { category: '效率', name: '月交付次數', target: '≥ 90%', actual: '100%', status: 'Achieved', note: '' },
      { category: '創新', name: '新設計提案', target: '100%', actual: '100%', status: 'Achieved', note: '' },
    ]
  },
  {
    id: 3, name: '李彥箴', department: '工程中心', month: '11月',
    metrics: [
      { category: '質量', name: 'ERP更新準確率', target: '≥ 99%', actual: '100%', status: 'Achieved', note: '無錯誤' },
      { category: '效率', name: '設變單改BOM', target: '≥ 98%', actual: '100%', status: 'Achieved', note: '7件全完成' },
      { category: '效率', name: '試作圖處理時間', target: '縮短10%', actual: '8%', status: 'Unknown', note: '無法評估 (資料完整度不一)' },
      { category: '準確性', name: '目錄命名規範', target: '100%', actual: '100%', status: 'Achieved', note: '無錯誤' },
      { category: '維護性', name: '文件備份', target: '100%', actual: '100%', status: 'Achieved', note: '歸檔完成' },
    ]
  },
  {
    id: 4, name: '黃佳雯', department: '多媒體設計課', month: '11月',
    metrics: [
      { category: '質量', name: '客戶滿意度', target: '≥ 100%', actual: '100%', status: 'Achieved', note: '滿意8次/總回饋8次' },
      { category: '創新', name: '每季新風格', target: '1項', actual: '1項', status: 'Achieved', note: '第一季風格達成' },
      { category: '效率', name: '按時交付率', target: '≥ 100%', actual: '100%', status: 'Achieved', note: '17次全按時' },
    ]
  },
  {
    id: 5, name: '王世昌', department: '電子設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 1.5%', actual: '1.3%', status: 'Achieved', note: '錯誤86行/總6495行' },
      { category: '效率', name: '開發時間縮短', target: '5%以上', actual: '12%', status: 'Achieved', note: '縮短1天 (12%)' },
      { category: '創新', name: '問題改善案', target: '1項', actual: '1項', status: 'Achieved', note: '馬達雜訊干擾改善' },
    ]
  },
  {
    id: 6, name: '黃泓銘', department: '線材設計課', month: '11月',
    metrics: [
      { category: '質量', name: '錯誤率', target: '≤ 3%', actual: '6%', status: 'Missed', note: '設變時遺漏刪除廢料 (96分)' },
      { category: '質量', name: '一次通過率', target: '≥ 90%', actual: '94%', status: 'Achieved', note: '導入 SOLIDWORKS Electrical 模擬' },
      { category: '效率', name: '設計周期縮短', target: '10%', actual: '5%', status: 'Missed', note: '未達標 (48分)，但抓線材長度變快' },
      { category: '效率', name: '月交付次數', target: '≥ 2次', actual: '3次', status: 'Achieved', note: '完成 D1141127-5 等3件' },
      { category: '創新', name: '新設計提案', target: '1項', actual: '1項', status: 'Achieved', note: 'F58B 使用保險絲座' },
    ]
  },
];

const generateHistory = () => {
  const history = [];
  const basePeople = RAW_DATA_NOV;
  basePeople.forEach(person => {
    for (let i = 0; i < 10; i++) { 
      const month = `${i + 1}月`;
      const mockMetrics = person.metrics.map(m => ({
        ...m,
        status: Math.random() > 0.8 ? 'Warning' : Math.random() > 0.9 ? 'Missed' : 'Achieved',
        actual: '模擬數據'
      }));
      history.push({
        id: Math.random(),
        name: person.name,
        department: person.department,
        month: month,
        metrics: mockMetrics
      });
    }
  });
  return [...history, ...RAW_DATA_NOV];
};

const StatusBadge = ({ status }) => {
  const styles = {
    Achieved: 'bg-green-100 text-green-800 border-green-200',
    Missed: 'bg-red-100 text-red-800 border-red-200',
    Warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    Unknown: 'bg-gray-100 text-gray-800 border-gray-200',
  };
  const labels = { Achieved: '達成', Missed: '未達成', Warning: '部分達成', Unknown: '無法評估' };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${styles[status] || styles.Unknown}`}>
      {labels[status] || status}
    </span>
  );
};

// --- KPI Personal Entry System (簡化版個人填寫) ---
const KPIPersonalEntryApp = ({ onBackToMenu, user }) => {
  const [currentMonth, setCurrentMonth] = useState('12月');
  const [formData, setFormData] = useState({
    workCompletion: {},
    quality: {},
    note: '',
    attachment: null,
    attachmentName: ''
  });
  
  // 自動取得的資料
  const [tqmRecords, setTqmRecords] = useState([]);
  const [rdTasks, setRdTasks] = useState([]);
  const [autoFetchedData, setAutoFetchedData] = useState(null);
  
  // 🔥 折疊狀態管理
  const [showFormulaDetails, setShowFormulaDetails] = useState(false);

  // 部門名稱對應 (用戶資料的部門 → KPI模板鍵名)
  const DEPARTMENT_MAPPING = {
    '機構設計': '機構設計課',
    '機構設計課': '機構設計課',
    '機構部': '機構設計課',
    '電子設計': '電子設計課',
    '電子設計課': '電子設計課',
    '電子部': '電子設計課',
    '多媒體設計': '多媒體設計課',
    '多媒體設計課': '多媒體設計課',
    '美工部': '多媒體設計課',
    '工程中心': '工程中心',
    '研發部': '工程中心',
    '軟體部': '工程中心',
    '線材設計': '線材設計課',
    '線材設計課': '線材設計課'
  };

  // 部門 KPI 模板 - 整合 KPI 績效系統的指標
  const DEPARTMENT_TEMPLATES = {
    '機構設計課': {
      // ========== KPI 指標 (品質50% + 效率50%) ==========
      indicators: [
        { 
          category: '品質', 
          name: '設計正確率', 
          target: '≥ 97%', 
          unit: '%', 
          weight: 25,
          kpiField: 'designAccuracyRate',
          calculate: (formData) => {
            // 設計正確率 = (總件數 - 設計錯誤) / 總件數 × 100
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const errors = (formData.quality?.['設計錯誤次數'] || 0) + (formData.quality?.['圖面錯誤次數'] || 0);
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - errors) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '品質', 
          name: '一次通過率', 
          target: '≥ 90%', 
          unit: '%', 
          weight: 25,
          kpiField: 'firstPassRate',
          calculate: (formData) => {
            // 一次通過率 = (總件數 - 返工件數) / 總件數 × 100
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const rework = formData.quality?.['返工/修改次數'] || 0;
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - rework) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '準時完成率', 
          target: '≥ 95%', 
          unit: '%', 
          weight: 25,
          kpiField: 'onTimeRate',
          calculate: (formData) => {
            // 準時完成率 = (總件數 - 逾期件數) / 總件數 × 100
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const late = formData.quality?.['逾期完成件數'] || 0;
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - late) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '月產出量達成率', 
          target: '≥ 100%', 
          unit: '%', 
          weight: 25,
          kpiField: 'outputAchievementRate',
          calculate: (formData) => {
            // 月產出量達成率 = 實際完成件數 / 目標件數 × 100
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const target = formData.targetOutput || 10; // 預設目標10件
            return Math.min(150, (totalWork / target) * 100).toFixed(1); // 上限150%
          }
        }
      ],
      workCompletion: [
        { name: '新機構設計', unit: '件', desc: '全新機構設計案' },
        { name: '設變/改版', unit: '件', desc: '設變或改版作業' },
        { name: '問題對策', unit: '件', desc: '品質問題處理' },
        { name: '圖面/文件', unit: '件', desc: '圖面與文件作業' }
      ],
      quality: [
        { name: '設計錯誤次數', type: 'number', unit: '次', desc: '結構/尺寸/材料錯誤' },
        { name: '圖面錯誤次數', type: 'number', unit: '次', desc: '圖面標註/公差錯誤' },
        { name: '返工/修改次數', type: 'number', unit: '次', desc: '需重新修改的件數' },
        { name: '逾期完成件數', type: 'number', unit: '件', desc: '超過預定完成日' }
      ],
      targetOutput: { label: '月目標產出件數', default: 10, desc: '部門設定的月目標' }
    },
    '電子設計課': {
      // ========== KPI 指標 (品質50% + 效率50%) ==========
      indicators: [
        { 
          category: '品質', 
          name: '電路設計正確率', 
          target: '≥ 98%', 
          unit: '%', 
          weight: 25,
          kpiField: 'circuitAccuracyRate',
          calculate: (formData) => {
            // 電路設計正確率 = (總件數 - 電路錯誤) / 總件數 × 100
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const errors = (formData.quality?.['電路設計錯誤'] || 0) + (formData.quality?.['PCB佈線錯誤'] || 0);
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - errors) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '品質', 
          name: '驗證通過率', 
          target: '≥ 95%', 
          unit: '%', 
          weight: 25,
          kpiField: 'verificationPassRate',
          calculate: (formData) => {
            // 驗證通過率 = (總件數 - 驗證失敗數) / 總件數 × 100
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const fail = (formData.quality?.['EMC/認證失敗'] || 0) + (formData.quality?.['功能驗證失敗'] || 0);
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - fail) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '準時完成率', 
          target: '≥ 95%', 
          unit: '%', 
          weight: 25,
          kpiField: 'onTimeRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const late = formData.quality?.['逾期完成件數'] || 0;
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - late) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '月產出量達成率', 
          target: '≥ 100%', 
          unit: '%', 
          weight: 25,
          kpiField: 'outputAchievementRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const target = formData.targetOutput || 8;
            return Math.min(150, (totalWork / target) * 100).toFixed(1);
          }
        }
      ],
      workCompletion: [
        { name: '電路/PCB設計', unit: '件', desc: '電路與PCB設計' },
        { name: '韌體開發', unit: '件', desc: '韌體功能開發' },
        { name: '問題對策', unit: '件', desc: '電路問題處理' },
        { name: '驗證/測試', unit: '件', desc: 'EMC/功能驗證' }
      ],
      quality: [
        { name: '電路設計錯誤', type: 'number', unit: '次', desc: '電路原理/元件錯誤' },
        { name: 'PCB佈線錯誤', type: 'number', unit: '次', desc: 'PCB Layout錯誤' },
        { name: 'EMC/認證失敗', type: 'number', unit: '次', desc: 'EMC或認證未通過' },
        { name: '功能驗證失敗', type: 'number', unit: '次', desc: '功能測試未通過' },
        { name: '逾期完成件數', type: 'number', unit: '件', desc: '超過預定完成日' }
      ],
      targetOutput: { label: '月目標產出件數', default: 8, desc: '部門設定的月目標' }
    },
    '工程中心': {
      // ========== KPI 指標 (品質50% + 效率50%) ==========
      indicators: [
        { 
          category: '品質', 
          name: 'BOM正確率', 
          target: '≥ 99%', 
          unit: '%', 
          weight: 25,
          kpiField: 'bomAccuracyRate',
          calculate: (formData) => {
            // BOM正確率 = (BOM處理數 - BOM錯誤) / BOM處理數 × 100
            const bomCount = formData.workCompletion?.['BOM建立/維護'] || 0;
            const errors = formData.quality?.['BOM錯誤次數'] || 0;
            if (bomCount === 0) return '100';
            return Math.max(0, ((bomCount - errors) / bomCount) * 100).toFixed(1);
          }
        },
        { 
          category: '品質', 
          name: 'ERP資料正確率', 
          target: '≥ 99%', 
          unit: '%', 
          weight: 25,
          kpiField: 'erpAccuracyRate',
          calculate: (formData) => {
            const erpCount = formData.workCompletion?.['ERP資料維護'] || 0;
            const errors = formData.quality?.['ERP資料錯誤'] || 0;
            if (erpCount === 0) return '100';
            return Math.max(0, ((erpCount - errors) / erpCount) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '設變處理及時率', 
          target: '≥ 98%', 
          unit: '%', 
          weight: 25,
          kpiField: 'ecoTimelyRate',
          calculate: (formData) => {
            const ecoCount = formData.workCompletion?.['設變單處理'] || 0;
            const late = formData.quality?.['設變逾期次數'] || 0;
            if (ecoCount === 0) return '100';
            return Math.max(0, ((ecoCount - late) / ecoCount) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '月處理量達成率', 
          target: '≥ 100%', 
          unit: '%', 
          weight: 25,
          kpiField: 'outputAchievementRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const target = formData.targetOutput || 50;
            return Math.min(150, (totalWork / target) * 100).toFixed(1);
          }
        }
      ],
      workCompletion: [
        { name: 'BOM建立/維護', unit: '件', desc: 'BOM表建立與維護' },
        { name: '設變單處理', unit: '件', desc: '設變單作業處理' },
        { name: 'ERP資料維護', unit: '件', desc: 'ERP系統資料維護' },
        { name: '文件歸檔', unit: '件', desc: '文件整理歸檔' }
      ],
      quality: [
        { name: 'BOM錯誤次數', type: 'number', unit: '次', desc: 'BOM資料錯誤' },
        { name: 'ERP資料錯誤', type: 'number', unit: '次', desc: 'ERP輸入錯誤' },
        { name: '設變逾期次數', type: 'number', unit: '次', desc: '設變處理逾期' },
        { name: '漏改/誤改次數', type: 'number', unit: '次', desc: '設變漏改或誤改' }
      ],
      targetOutput: { label: '月目標處理件數', default: 50, desc: '部門設定的月目標' }
    },
    '多媒體設計課': {
      // ========== KPI 指標 (品質50% + 效率50%) ==========
      indicators: [
        { 
          category: '品質', 
          name: '設計品質達成率', 
          target: '≥ 95%', 
          unit: '%', 
          weight: 25,
          kpiField: 'designQualityRate',
          calculate: (formData) => {
            // 設計品質達成率 = (總件數 - 重大修改) / 總件數 × 100
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const majorRevision = formData.quality?.['重大修改次數'] || 0;
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - majorRevision) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '品質', 
          name: '客戶/內部滿意率', 
          target: '≥ 90%', 
          unit: '%', 
          weight: 25,
          kpiField: 'satisfactionRate',
          calculate: (formData) => {
            // 滿意率 = 100 - (退件次數 × 5)
            const reject = formData.quality?.['退件/駁回次數'] || 0;
            return Math.max(0, 100 - reject * 5).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '準時交付率', 
          target: '≥ 95%', 
          unit: '%', 
          weight: 25,
          kpiField: 'onTimeDeliveryRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const late = formData.quality?.['逾期交付次數'] || 0;
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - late) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '月產出量達成率', 
          target: '≥ 100%', 
          unit: '%', 
          weight: 25,
          kpiField: 'outputAchievementRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const target = formData.targetOutput || 15;
            return Math.min(150, (totalWork / target) * 100).toFixed(1);
          }
        }
      ],
      workCompletion: [
        { name: 'UI/畫面設計', unit: '件', desc: '介面與畫面設計' },
        { name: '視覺素材', unit: '件', desc: '圖片/icon製作' },
        { name: '動畫/影片', unit: '件', desc: '動畫與影片製作' },
        { name: '文宣/包裝', unit: '件', desc: '文宣品與包裝設計' }
      ],
      quality: [
        { name: '重大修改次數', type: 'number', unit: '次', desc: '需大幅修改重做' },
        { name: '退件/駁回次數', type: 'number', unit: '次', desc: '成品被退回' },
        { name: '規格錯誤次數', type: 'number', unit: '次', desc: '尺寸/格式錯誤' },
        { name: '逾期交付次數', type: 'number', unit: '次', desc: '超過交付期限' }
      ],
      targetOutput: { label: '月目標產出件數', default: 15, desc: '部門設定的月目標' }
    },
    '線材設計課': {
      // ========== KPI 指標 (品質50% + 效率50%) ==========
      indicators: [
        { 
          category: '品質', 
          name: '設計正確率', 
          target: '≥ 97%', 
          unit: '%', 
          weight: 25,
          kpiField: 'designAccuracyRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const errors = (formData.quality?.['線材規格錯誤'] || 0) + (formData.quality?.['接頭選用錯誤'] || 0);
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - errors) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '品質', 
          name: '一次通過率', 
          target: '≥ 90%', 
          unit: '%', 
          weight: 25,
          kpiField: 'firstPassRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const rework = formData.quality?.['返工/修改次數'] || 0;
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - rework) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '準時完成率', 
          target: '≥ 95%', 
          unit: '%', 
          weight: 25,
          kpiField: 'onTimeRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const late = formData.quality?.['逾期完成件數'] || 0;
            if (totalWork === 0) return '100';
            return Math.max(0, ((totalWork - late) / totalWork) * 100).toFixed(1);
          }
        },
        { 
          category: '效率', 
          name: '月產出量達成率', 
          target: '≥ 100%', 
          unit: '%', 
          weight: 25,
          kpiField: 'outputAchievementRate',
          calculate: (formData) => {
            const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
            const target = formData.targetOutput || 12;
            return Math.min(150, (totalWork / target) * 100).toFixed(1);
          }
        }
      ],
      workCompletion: [
        { name: '新線材設計', unit: '件', desc: '全新線材設計案' },
        { name: '設變/改版', unit: '件', desc: '設變或改版作業' },
        { name: '問題對策', unit: '件', desc: '品質問題處理' },
        { name: '圖面/承認書', unit: '件', desc: '圖面與承認書作業' }
      ],
      quality: [
        { name: '線材規格錯誤', type: 'number', unit: '次', desc: '線徑/材質規格錯誤' },
        { name: '接頭選用錯誤', type: 'number', unit: '次', desc: '接頭型號選用錯誤' },
        { name: '返工/修改次數', type: 'number', unit: '次', desc: '需重新修改的件數' },
        { name: '逾期完成件數', type: 'number', unit: '件', desc: '超過預定完成日' }
      ],
      targetOutput: { label: '月目標產出件數', default: 12, desc: '部門設定的月目標' }
    }
  };

  // 取得用戶部門並對應到模板
  const rawDepartment = user?.department || '機構設計';
  const userDepartment = DEPARTMENT_MAPPING[rawDepartment] || '機構設計';
  const template = DEPARTMENT_TEMPLATES[userDepartment] || DEPARTMENT_TEMPLATES['機構設計'];

  // 初始化表單
  useEffect(() => {
    const initialWork = {};
    template.workCompletion.forEach(item => {
      initialWork[item.name] = 0;
    });
    const initialQuality = {};
    template.quality.forEach(item => {
      initialQuality[item.name] = 0; // 改為數字型態，預設0次
    });
    const initialIndicators = {};
    if (template.indicators) {
      template.indicators.forEach(item => {
        initialIndicators[item.kpiField] = '';
      });
    }
    setFormData({
      workCompletion: initialWork,
      quality: initialQuality,
      indicators: initialIndicators
    });
  }, [userDepartment]);

  // 🔥 自動訂閱 TQM 紀錄和 R&D Nexus 任務
  useEffect(() => {
    const unsubTqm = db.subscribe('tqm_records', setTqmRecords);
    const unsubTasks = db.subscribe('rd_tasks', setRdTasks);
    return () => {
      unsubTqm();
      unsubTasks();
    };
  }, []);

  // 🔥 根據選擇的月份自動計算 TQM 異常和任務完成/延誤資料
  useEffect(() => {
    const userName = user?.displayName || '';
    const monthNum = parseInt(currentMonth.replace('月', ''));
    const currentYear = new Date().getFullYear();
    
    // 過濾當月的 TQM 紀錄 (屬於此用戶或此用戶部門)
    const monthTqmRecords = tqmRecords.filter(r => {
      const recordDate = new Date(r.date);
      const recordMonth = recordDate.getMonth() + 1;
      const recordYear = recordDate.getFullYear();
      const isUserRecord = r.personName === userName || r.createdByUser === userName;
      return recordMonth === monthNum && recordYear === currentYear && isUserRecord;
    });
    
    // 過濾當月的 R&D Nexus 任務 (屬於此用戶)
    const monthTasks = rdTasks.filter(t => {
      // 檢查任務負責人
      if (t.owner !== userName) return false;
      
      // 檢查任務是否在當月完成或應該在當月完成
      const endDate = t.endDate ? new Date(t.endDate) : null;
      const startDate = t.startDate ? new Date(t.startDate) : null;
      
      if (endDate) {
        const taskMonth = endDate.getMonth() + 1;
        const taskYear = endDate.getFullYear();
        return taskMonth === monthNum && taskYear === currentYear;
      } else if (startDate) {
        const taskMonth = startDate.getMonth() + 1;
        const taskYear = startDate.getFullYear();
        return taskMonth === monthNum && taskYear === currentYear;
      }
      return false;
    });
    
    // 計算統計資料
    const tqmAbnormalCount = monthTqmRecords.filter(r => r.status !== '已改善').length;
    const tqmRepeatCount = monthTqmRecords.filter(r => r.isRepeat).length;
    const tqmTotal = monthTqmRecords.length;
    
    const tasksCompleted = monthTasks.filter(t => t.status === 'Done').length;
    const tasksTotal = monthTasks.length;
    const tasksOverdue = monthTasks.filter(t => {
      if (t.status === 'Done') return false;
      const endDate = t.endDate ? new Date(t.endDate) : null;
      if (!endDate) return false;
      return endDate < new Date();
    }).length;
    
    setAutoFetchedData({
      tqm: {
        total: tqmTotal,
        abnormal: tqmAbnormalCount,
        repeat: tqmRepeatCount,
        records: monthTqmRecords
      },
      tasks: {
        total: tasksTotal,
        completed: tasksCompleted,
        overdue: tasksOverdue,
        list: monthTasks
      }
    });
  }, [tqmRecords, rdTasks, currentMonth, user]);

  const handleWorkChange = (name, value) => {
    setFormData(prev => ({
      ...prev,
      workCompletion: { ...prev.workCompletion, [name]: parseInt(value) || 0 }
    }));
  };

  const handleQualityChange = (name, value) => {
    setFormData(prev => ({
      ...prev,
      quality: { ...prev.quality, [name]: parseInt(value) || 0 } // 改為數字處理
    }));
  };

  const handleIndicatorChange = (field, value) => {
    setFormData(prev => ({
      ...prev,
      indicators: { ...prev.indicators, [field]: value }
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // 🔥 自動計算 KPI 指標實際值
    const calculatedIndicators = {};
    if (template.indicators) {
      template.indicators.forEach(indicator => {
        if (indicator.calculate) {
          calculatedIndicators[indicator.kpiField] = indicator.calculate(formData);
        }
      });
    }
    
    // ========== 新版計分邏輯：以KPI指標為主 ==========
    
    // 1. KPI 績效指標總分 (70分) - 品質50% + 效率50%
    let kpiScore = 0;
    let kpiDetails = {};
    
    if (template.indicators) {
      template.indicators.forEach(indicator => {
        const value = parseFloat(calculatedIndicators[indicator.kpiField]) || 0;
        const weight = indicator.weight || 25; // 每個指標權重
        let achieved = false;
        
        // 檢查是否達標
        if (indicator.target.includes('≤')) {
          const threshold = parseFloat(indicator.target.replace('≤', '').trim());
          achieved = value <= threshold;
        } else if (indicator.target.includes('≥')) {
          const threshold = parseFloat(indicator.target.replace('≥', '').trim());
          achieved = value >= threshold;
        }
        
        // 計算此指標得分：達標得滿分，未達標按比例得分
        let itemScore = 0;
        if (achieved) {
          itemScore = weight * 0.7; // 滿分權重的70%
        } else {
          // 未達標：根據達成程度給分
          const targetValue = parseFloat(indicator.target.replace(/[≤≥%]/g, '').trim()) || 100;
          const ratio = Math.min(value / targetValue, 1);
          itemScore = weight * 0.7 * ratio;
        }
        
        kpiScore += itemScore;
        kpiDetails[indicator.name] = {
          value: value,
          target: indicator.target,
          achieved: achieved,
          weight: weight,
          score: itemScore.toFixed(1)
        };
      });
    }
    
    // 2. 工作產出量 (20分)
    const totalWork = Object.values(formData.workCompletion || {}).reduce((sum, val) => sum + val, 0);
    const targetOutput = template.targetOutput?.default || 10;
    const outputRate = Math.min(totalWork / targetOutput, 1.5); // 上限150%
    const outputScore = Math.min(20, 20 * outputRate);
    
    // 3. 品質無異常加分 (10分) - 零錯誤獎勵
    const totalErrors = Object.values(formData.quality || {}).reduce((sum, val) => sum + val, 0);
    const qualityBonus = totalErrors === 0 ? 10 : Math.max(0, 10 - totalErrors * 2);

    // 總分計算
    const totalScore = Math.min(100, kpiScore + outputScore + qualityBonus);
    
    // 等級評定
    let grade = 'F';
    let level = '不合格';
    if (totalScore >= 90) { grade = 'A'; level = '優秀'; }
    else if (totalScore >= 80) { grade = 'B'; level = '良好'; }
    else if (totalScore >= 70) { grade = 'C'; level = '合格'; }
    else if (totalScore >= 60) { grade = 'D'; level = '待改進'; }
    else { grade = 'F'; level = '不合格'; }

    // 儲存到資料庫
    try {
      // 1. 儲存到個人填寫記錄
      await db.addDoc('kpi_personal_entries', {
        userName: user.displayName,
        department: userDepartment,
        month: currentMonth,
        year: new Date().getFullYear(),
        
        // 原始填寫資料
        workCompletion: formData.workCompletion,
        quality: formData.quality,
        targetOutput: targetOutput,
        
        // 備註和附件
        note: formData.note || '',
        attachment: formData.attachment || null,
        attachmentName: formData.attachmentName || '',
        
        // 🔥 自動計算的 KPI 指標實際值
        indicators: calculatedIndicators,
        
        // 計算後的分數
        scores: {
          kpi: {
            total: parseFloat(kpiScore.toFixed(1)),
            details: kpiDetails
          },
          output: {
            total: parseFloat(outputScore.toFixed(1)),
            count: totalWork,
            target: targetOutput,
            rate: (outputRate * 100).toFixed(1)
          },
          quality: {
            bonus: parseFloat(qualityBonus.toFixed(1)),
            errorCount: totalErrors
          },
          total: parseFloat(totalScore.toFixed(1)),
          grade: grade,
          level: level
        },
        
        createdAt: new Date().toISOString()
      });

      // 2. 🔥 同步儲存到 KPI 績效系統 (kpi_performance)
      const kpiMetrics = template.indicators ? template.indicators.map(ind => ({
        category: ind.category,
        name: ind.name,
        target: ind.target,
        weight: ind.weight || 25,
        actual: `${calculatedIndicators[ind.kpiField]}${ind.unit}`,
        status: (() => {
          const numValue = parseFloat(calculatedIndicators[ind.kpiField]);
          const targetStr = ind.target;
          if (targetStr.includes('≤')) {
            const threshold = parseFloat(targetStr.replace('≤', '').trim());
            return numValue <= threshold ? 'Achieved' : 'Missed';
          } else if (targetStr.includes('≥')) {
            const threshold = parseFloat(targetStr.replace('≥', '').trim());
            return numValue >= threshold ? 'Achieved' : 'Missed';
          }
          return 'Pending';
        })(),
        note: ''
      })) : [];

      await db.addDoc('kpi_performance', {
        name: user.displayName,
        department: userDepartment,
        month: currentMonth,
        year: new Date().getFullYear(),
        date: new Date().toISOString().split('T')[0],
        metrics: kpiMetrics,
        scores: {
          kpi: parseFloat(kpiScore.toFixed(1)),
          output: parseFloat(outputScore.toFixed(1)),
          qualityBonus: parseFloat(qualityBonus.toFixed(1)),
          total: parseFloat(totalScore.toFixed(1))
        },
        grade: grade,
        level: level,
        // 🔥 新增：備註和附件
        note: formData.note || '',
        attachment: formData.attachment || null,
        attachmentName: formData.attachmentName || '',
        createdAt: new Date().toISOString()
      });

      console.log('✅ KPI 資料已同步到績效系統');
      console.log('📝 備註:', formData.note);
      console.log('📎 附件:', formData.attachmentName);

      // 顯示詳細結果
      const indicatorsText = template.indicators ? 
        '\n\n📊 KPI 績效指標達成 (自動計算)\n' + 
        template.indicators.map(ind => {
          const val = calculatedIndicators[ind.kpiField];
          const detail = kpiDetails[ind.name];
          const status = detail?.achieved ? '✓達標' : '✗未達標';
          return `  • ${ind.name}: ${val}${ind.unit} (目標:${ind.target}) ${status}`;
        }).join('\n') : '';
      
      alert(`✅ 已提交 ${currentMonth} KPI 資料！

━━━━━━━━━━━━━━━━━━━━━
📊 新版KPI評分結果
━━━━━━━━━━━━━━━━━━━━━

🎯 KPI指標績效: ${kpiScore.toFixed(1)} / 70 分
${Object.entries(kpiDetails).map(([name, detail]) => 
  `  • ${name}: ${detail.value}${template.indicators.find(i=>i.name===name)?.unit||''} → ${detail.score}分 ${detail.achieved ? '✓' : '✗'}`
).join('\n')}

📈 工作產出量: ${outputScore.toFixed(1)} / 20 分
  (完成 ${totalWork} 件, 目標 ${targetOutput} 件, 達成率 ${(outputRate * 100).toFixed(1)}%)

🛡️ 品質零錯誤獎勵: ${qualityBonus.toFixed(1)} / 10 分
  (品質異常 ${totalErrors} 件)
${indicatorsText}

━━━━━━━━━━━━━━━━━━━━━
✨ 總分: ${totalScore.toFixed(1)} 分
🏆 等級: ${grade} (${level})
━━━━━━━━━━━━━━━━━━━━━`);
      
      // 重置表單
      const initialWork = {};
      template.workCompletion.forEach(item => {
        initialWork[item.name] = 0;
      });
      const initialQuality = {};
      template.quality.forEach(item => {
        initialQuality[item.name] = 0;
      });
      const initialIndicators = {};
      if (template.indicators) {
        template.indicators.forEach(item => {
          initialIndicators[item.kpiField] = '';
        });
      }
      setFormData({
        workCompletion: initialWork,
        quality: initialQuality,
        indicators: initialIndicators
      });
    } catch (error) {
      console.error('提交錯誤:', error);
      alert('提交失敗,請重試');
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
      {/* 頂部導航 */}
      <nav className="bg-white shadow-sm border-b sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-blue-600 rounded-lg">
              <Target className="w-6 h-6 text-white"/>
            </div>
            <div>
              <h1 className="font-bold text-lg text-slate-800">個人 KPI 填寫</h1>
              <p className="text-xs text-slate-500">簡單、快速、不用算分數</p>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-sm">
              <div className="flex items-center gap-2">
                <User className="w-4 h-4 text-slate-400"/>
                <span className="font-medium">{user?.displayName || '使用者'}</span>
              </div>
              <div className="flex items-center gap-2 text-slate-600">
                <Building className="w-4 h-4 text-slate-400"/>
                <span className="text-xs">{userDepartment}</span>
              </div>
            </div>
            <button 
              onClick={onBackToMenu}
              className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center gap-2 text-sm font-medium transition-colors"
            >
              <LogOut className="w-4 h-4"/>返回
            </button>
          </div>
        </div>
      </nav>

      {/* 主要內容 */}
      <main className="max-w-4xl mx-auto px-4 py-8">
        {/* 月份選擇 */}
        <div className="bg-white rounded-xl shadow-sm p-4 mb-6 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Calendar className="w-5 h-5 text-blue-600"/>
            <span className="font-medium text-slate-700">填寫月份:</span>
            <select 
              value={currentMonth}
              onChange={(e) => setCurrentMonth(e.target.value)}
              className="px-4 py-2 border border-slate-300 rounded-lg font-medium bg-white focus:ring-2 focus:ring-blue-500 outline-none"
            >
              {['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'].map(m => (
                <option key={m} value={m}>{m}</option>
              ))}
            </select>
          </div>
          <div className="text-sm text-slate-500">
            {userDepartment} 專屬表單
          </div>
        </div>

        {/* 🔥 自動抓取的資料摘要 */}
        {autoFetchedData && (
          <div className="bg-gradient-to-r from-emerald-50 to-cyan-50 rounded-xl shadow-sm p-6 border-2 border-emerald-200 mb-6">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center">
                <RefreshCcw className="w-6 h-6 text-white"/>
              </div>
              <div>
                <h2 className="text-lg font-bold text-emerald-800">🤖 自動帶入資料 ({currentMonth})</h2>
                <p className="text-sm text-emerald-600">系統自動從 TQM 紀錄和 R&D Nexus 抓取您的資料</p>
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* TQM 紀錄摘要 */}
              <div className="bg-white p-4 rounded-lg border border-rose-200">
                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                  <span className="bg-rose-100 text-rose-700 px-2 py-0.5 rounded text-xs">TQM</span>
                  品質異常紀錄
                </h3>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-slate-600">本月異常總數:</span>
                    <span className="font-bold text-rose-600">{autoFetchedData.tqm.total} 件</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-600">未改善:</span>
                    <span className={`font-bold ${autoFetchedData.tqm.abnormal > 0 ? 'text-red-600' : 'text-green-600'}`}>
                      {autoFetchedData.tqm.abnormal} 件
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-600">重複發生:</span>
                    <span className={`font-bold ${autoFetchedData.tqm.repeat > 0 ? 'text-orange-600' : 'text-green-600'}`}>
                      {autoFetchedData.tqm.repeat} 件
                    </span>
                  </div>
                </div>
                {autoFetchedData.tqm.total > 0 && (
                  <div className="mt-3 pt-3 border-t border-slate-200">
                    <p className="text-xs text-slate-500 mb-2">最近紀錄:</p>
                    <div className="max-h-24 overflow-y-auto space-y-1">
                      {autoFetchedData.tqm.records.slice(0, 3).map((r, i) => (
                        <div key={i} className="text-xs p-2 bg-slate-50 rounded">
                          <span className="text-slate-400">{r.date}</span>
                          <span className="mx-2">|</span>
                          <span className="font-medium">{r.issueType}</span>
                          <span className={`ml-2 px-1.5 py-0.5 rounded text-[10px] ${r.status === '已改善' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {r.status}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
              
              {/* R&D Nexus 任務摘要 */}
              <div className="bg-white p-4 rounded-lg border border-blue-200">
                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                  <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">R&D Nexus</span>
                  任務完成狀況
                </h3>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-slate-600">本月任務總數:</span>
                    <span className="font-bold text-blue-600">{autoFetchedData.tasks.total} 件</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-600">已完成:</span>
                    <span className="font-bold text-green-600">{autoFetchedData.tasks.completed} 件</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-600">已逾期未完成:</span>
                    <span className={`font-bold ${autoFetchedData.tasks.overdue > 0 ? 'text-red-600' : 'text-green-600'}`}>
                      {autoFetchedData.tasks.overdue} 件
                    </span>
                  </div>
                </div>
                {autoFetchedData.tasks.total > 0 && (
                  <div className="mt-3 pt-3 border-t border-slate-200">
                    <p className="text-xs text-slate-500 mb-2">任務列表:</p>
                    <div className="max-h-24 overflow-y-auto space-y-1">
                      {autoFetchedData.tasks.list.slice(0, 3).map((t, i) => (
                        <div key={i} className="text-xs p-2 bg-slate-50 rounded flex justify-between items-center">
                          <span className="font-medium truncate flex-1">{t.title}</span>
                          <span className={`ml-2 px-1.5 py-0.5 rounded text-[10px] ${
                            t.status === 'Done' ? 'bg-green-100 text-green-700' : 
                            t.status === 'Doing' ? 'bg-blue-100 text-blue-700' : 
                            'bg-slate-100 text-slate-700'
                          }`}>
                            {t.status}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
            
            {/* 一鍵帶入按鈕 */}
            <div className="mt-4 flex gap-3">
              <button
                type="button"
                onClick={() => {
                  // 將 R&D Nexus 任務完成數自動帶入工作產出量
                  const newWorkCompletion = { ...formData.workCompletion };
                  const firstWorkKey = Object.keys(newWorkCompletion)[0];
                  if (firstWorkKey && autoFetchedData.tasks.completed > 0) {
                    newWorkCompletion[firstWorkKey] = autoFetchedData.tasks.completed;
                  }
                  
                  // 將 TQM 異常和逾期自動帶入品質狀況
                  const newQuality = { ...formData.quality };
                  // 嘗試對應品質欄位
                  if (newQuality['逾期完成件數'] !== undefined) {
                    newQuality['逾期完成件數'] = autoFetchedData.tasks.overdue;
                  }
                  
                  setFormData(prev => ({
                    ...prev,
                    workCompletion: newWorkCompletion,
                    quality: newQuality
                  }));
                  
                  alert(`✅ 已自動帶入資料:\n• 任務完成數: ${autoFetchedData.tasks.completed} 件\n• 逾期任務: ${autoFetchedData.tasks.overdue} 件\n• TQM異常: ${autoFetchedData.tqm.total} 件\n\n請檢查並補充其他資料`);
                }}
                className="flex-1 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors"
              >
                <Download className="w-5 h-5"/>
                一鍵帶入 R&D Nexus 資料
              </button>
              <button
                type="button"
                onClick={() => {
                  // 詳細檢視
                  const taskDetails = autoFetchedData.tasks.list.map(t => `• ${t.title} [${t.status}]`).join('\n');
                  const tqmDetails = autoFetchedData.tqm.records.map(r => `• ${r.date} ${r.issueType} [${r.status}]`).join('\n');
                  alert(`📊 ${currentMonth} 詳細資料\n\n━━ R&D Nexus 任務 (${autoFetchedData.tasks.total}件) ━━\n${taskDetails || '無任務'}\n\n━━ TQM 異常紀錄 (${autoFetchedData.tqm.total}件) ━━\n${tqmDetails || '無紀錄'}`);
                }}
                className="px-4 py-3 border-2 border-emerald-300 text-emerald-700 rounded-lg font-medium hover:bg-emerald-50 transition-colors"
              >
                查看詳細
              </button>
            </div>
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* 🔥 自動計算公式說明 - 可折疊 */}
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-sm border-2 border-blue-200 overflow-hidden">
            {/* 標題列 - 可點擊折疊/展開 */}
            <div 
              className="flex items-center justify-between p-4 cursor-pointer hover:bg-blue-100 transition-colors"
              onClick={() => setShowFormulaDetails(!showFormulaDetails)}
            >
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                  <Calculator className="w-6 h-6 text-white"/>
                </div>
                <div>
                  <h2 className="text-lg font-bold text-blue-800">📐 自動計算公式說明</h2>
                  <p className="text-sm text-blue-600">系統會根據您填寫的數據自動計算 KPI 績效指標</p>
                </div>
              </div>
              <button 
                type="button"
                className="p-2 rounded-lg hover:bg-blue-200 transition-colors"
              >
                {showFormulaDetails ? (
                  <ChevronUp className="w-6 h-6 text-blue-700" />
                ) : (
                  <ChevronDown className="w-6 h-6 text-blue-700" />
                )}
              </button>
            </div>
            
            {/* 可折疊內容 */}
            {showFormulaDetails && (
              <div className="p-6 pt-0 space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* KPI績效指標計算 (70分) */}
                  <div className="bg-white p-4 rounded-lg border border-blue-200">
                    <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                      <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">70%</span>
                      KPI績效指標 (品質+效率)
                    </h3>
                    <div className="text-xs text-slate-600 space-y-1">
                      <p>• 品質指標佔50%：設計準確率、一次通過率</p>
                      <p>• 效率指標佔50%：準時率、產出達成率</p>
                      <p>• 達標計分：每項指標達標得滿分權重</p>
                      <p>• 未達標按比例計分：達成率 × 權重</p>
                    </div>
                  </div>
                  
                  {/* 工作產出量計算 (20分) */}
                  <div className="bg-white p-4 rounded-lg border border-green-200">
                    <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                      <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">20%</span>
                      工作產出量計算
                    </h3>
                    <div className="text-xs text-slate-600 space-y-1">
                      <p>• 基礎目標：每月 {template.targetOutput?.default || 10} 件工作任務</p>
                      <p>• 計分公式：<code className="bg-slate-100 px-1 rounded">實際完成數 ÷ 目標數 × 20</code></p>
                      <p>• 達成率上限150%，最高得20分</p>
                      <p>• 範例：完成15件/目標10件 = 30分(上限20分)</p>
                    </div>
                  </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* 品質零錯誤獎勵 (10分) */}
                  <div className="bg-white p-4 rounded-lg border border-orange-200">
                    <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                      <span className="bg-orange-100 text-orange-700 px-2 py-0.5 rounded text-xs">10%</span>
                      品質零錯誤獎勵
                    </h3>
                    <div className="text-xs text-slate-600 space-y-1">
                      <p>• 零錯誤獎勵：品質異常為0時得滿分10分</p>
                      <p>• 每發生1次品質異常扣2分</p>
                      <p>• 計分公式：<code className="bg-slate-100 px-1 rounded">10 - (異常次數 × 2)</code></p>
                      <p>• 範例：2次異常 → 10-4=6分</p>
                    </div>
                  </div>
                  
                  {/* KPI 指標自動計算 */}
                  <div className="bg-white p-4 rounded-lg border border-cyan-200">
                    <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                      <span className="bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded text-xs">自動</span>
                      KPI 績效指標自動計算
                    </h3>
                    <div className="text-xs text-slate-600 space-y-1">
                      <p>• 品質指標：根據錯誤次數計算準確率</p>
                      <p>• 效率指標：根據工作產出和準時率計算</p>
                      <p>• 系統自動從您填寫的數據計算</p>
                      <p>• 提交後同步到KPI管理系統</p>
                    </div>
                  </div>
                </div>
                
                {/* 總分計算說明 */}
                <div className="p-3 bg-blue-100 rounded-lg">
                  <p className="text-sm text-blue-800 font-medium">
                    📊 總分公式: <code className="bg-white px-2 py-0.5 rounded">KPI績效指標(70分) + 工作產出量(20分) + 品質零錯誤獎勵(10分) = 總分(滿分100分)</code>
                  </p>
                  <p className="text-xs text-blue-600 mt-1">
                    等級評定: A(≥90優秀) | B(≥80良好) | C(≥70合格) | D(≥60待改進) | F(&lt;60不合格)
                  </p>
                </div>
              </div>
            )}
          </div>

          {/* 模組一：工作產出量 */}
          <div className="bg-white rounded-xl shadow-sm p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <CheckCircle className="w-6 h-6 text-green-600"/>
              </div>
              <div>
                <h2 className="text-lg font-bold text-slate-800">模組一：工作產出量 (20分)</h2>
                <p className="text-sm text-slate-500">這個月你實際完成了哪些研發工作？月目標: {template.targetOutput?.default || 10} 件</p>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {template.workCompletion.map((item, idx) => (
                <div key={idx} className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                  <div className="flex items-center justify-between mb-2">
                    <label className="block text-sm font-medium text-slate-700">
                      {item.name}
                    </label>
                    <div className="text-xs text-slate-500">
                      {item.description || '填寫實際完成數量'}
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <input
                      type="number"
                      min="0"
                      value={formData.workCompletion[item.name] || 0}
                      onChange={(e) => handleWorkChange(item.name, e.target.value)}
                      className="w-24 px-3 py-2 border border-slate-300 rounded-lg text-center text-lg font-bold focus:ring-2 focus:ring-green-500 outline-none"
                    />
                    <span className="text-slate-600">{item.unit}</span>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
              <p className="text-sm text-blue-700">
                ✨ <strong>填寫提示:</strong> 只需填寫數量,系統會自動計算達成率並轉換為KPI指標
              </p>
            </div>
          </div>

          {/* 模組二：品質狀況 (影響品質獎勵10分) */}
          <div className="bg-white rounded-xl shadow-sm p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                <AlertCircle className="w-6 h-6 text-orange-600"/>
              </div>
              <div>
                <h2 className="text-lg font-bold text-slate-800">模組二：品質狀況 (10分獎勵)</h2>
                <p className="text-sm text-slate-500">這個月有沒有品質異常？零異常可得滿分10分獎勵</p>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {template.quality.map((item, idx) => {
                const count = formData.quality[item.name] || 0;
                const penalty = 2; // 每次品質異常扣2分
                const totalPenalty = count * penalty;
                
                return (
                  <div key={idx} className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <div className="flex items-center justify-between mb-2">
                      <label className="block text-sm font-medium text-slate-700">
                        {item.name}
                      </label>
                      <span className="text-xs text-slate-500 bg-white px-2 py-1 rounded border">
                        {item.desc}
                      </span>
                    </div>
                    <div className="flex items-center gap-3">
                      <input
                        type="number"
                        min="0"
                        value={count}
                        onChange={(e) => handleQualityChange(item.name, e.target.value)}
                        className="w-24 px-3 py-2 border border-slate-300 rounded-lg text-center text-lg font-bold focus:ring-2 focus:ring-orange-500 outline-none"
                      />
                      <span className="text-slate-600">{item.unit}</span>
                      {count > 0 && (
                        <span className="ml-auto text-sm font-medium text-red-600">
                          扣 {totalPenalty} 分
                        </span>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="mt-4 p-3 bg-orange-50 rounded-lg border border-orange-100">
              <p className="text-sm text-orange-700">
                ⚠️ <strong>評分說明:</strong> 品質基礎獎勵10分,每次品質異常扣2分,最低0分
              </p>
            </div>
          </div>

          {/* 模組三：備註說明 */}
          <div className="bg-white rounded-xl shadow-sm p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <FileText className="w-6 h-6 text-purple-600"/>
              </div>
              <div>
                <h2 className="text-lg font-bold text-slate-800">模組三：備註說明 (選填)</h2>
                <p className="text-sm text-slate-500">如有需要補充說明的事項，可在此填寫並上傳附件</p>
              </div>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">備註內容</label>
                <textarea
                  value={formData.note || ''}
                  onChange={(e) => setFormData(prev => ({ ...prev, note: e.target.value }))}
                  placeholder="輸入補充說明，例如：本月有特殊專案加班、協助其他部門工作..."
                  rows={4}
                  className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">上傳附件 (選填)</label>
                <div className="flex items-center gap-4">
                  <label className="flex-1 cursor-pointer">
                    <div className="border-2 border-dashed border-slate-300 rounded-lg p-4 hover:border-purple-400 transition-colors">
                      <div className="flex items-center justify-center gap-3">
                        <Upload className="w-6 h-6 text-slate-400" />
                        <span className="text-sm text-slate-500">
                          {formData.attachmentName || '點擊上傳檔案 (支援圖片、PDF、Excel)'}
                        </span>
                      </div>
                    </div>
                    <input
                      type="file"
                      className="hidden"
                      accept="image/*,.pdf,.xlsx,.xls,.doc,.docx"
                      onChange={(e) => {
                        const file = e.target.files[0];
                        if (file) {
                          if (file.size > 1024 * 1024) {
                            alert('檔案過大！請選擇小於 1MB 的檔案');
                            return;
                          }
                          const reader = new FileReader();
                          reader.onload = (event) => {
                            setFormData(prev => ({
                              ...prev,
                              attachment: event.target.result,
                              attachmentName: file.name
                            }));
                          };
                          reader.readAsDataURL(file);
                        }
                      }}
                    />
                  </label>
                  {formData.attachmentName && (
                    <button
                      type="button"
                      onClick={() => setFormData(prev => ({ ...prev, attachment: null, attachmentName: '' }))}
                      className="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                      title="移除附件"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  )}
                </div>
                {formData.attachmentName && (
                  <p className="mt-2 text-sm text-green-600 flex items-center gap-1">
                    <CheckCircle className="w-4 h-4" />
                    已選擇: {formData.attachmentName}
                  </p>
                )}
              </div>
            </div>

            <div className="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-100">
              <p className="text-sm text-purple-700">
                📎 <strong>提示:</strong> 附件僅作為輔助說明，檔案限制 1MB 以內
              </p>
            </div>
          </div>

          {/* 提交按鈕 */}
          <div className="flex gap-4">
            <button
              type="submit"
              className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2"
            >
              <Save className="w-5 h-5"/>
              提交 {currentMonth} KPI 資料
            </button>
            <button
              type="button"
              onClick={() => {
                const initialWork = {};
                template.workCompletion.forEach(item => {
                  initialWork[item.name] = 0;
                });
                const initialQuality = {};
                template.quality.forEach(item => {
                  initialQuality[item.name] = 0;
                });
                const initialIndicators = {};
                if (template.indicators) {
                  template.indicators.forEach(item => {
                    initialIndicators[item.kpiField] = '';
                  });
                }
                setFormData({
                  workCompletion: initialWork,
                  quality: initialQuality,
                  indicators: initialIndicators,
                  note: '',
                  attachment: null,
                  attachmentName: ''
                });
              }}
              className="px-6 py-4 border-2 border-slate-300 text-slate-600 font-medium rounded-xl hover:bg-slate-50 transition-all"
            >
              重置
            </button>
          </div>

          {/* 🔥 部門 KPI 績效指標 (自動計算) - 移到提交按鈕下方 */}
          {template.indicators && template.indicators.length > 0 && (
            <div className="bg-white rounded-xl shadow-sm p-6 border-2 border-indigo-200">
              <div className="flex items-center gap-3 mb-6">
                <div className="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                  <Target className="w-6 h-6 text-indigo-600"/>
                </div>
                <div>
                  <h2 className="text-lg font-bold text-slate-800">部門 KPI 績效指標 (自動計算)</h2>
                  <p className="text-sm text-slate-500">根據您填寫的工作數據自動計算,提交後同步到管理系統</p>
                </div>
              </div>

              <div className="space-y-4">
                {template.indicators.map((indicator, idx) => {
                  const calculatedValue = indicator.calculate ? indicator.calculate(formData) : '-';
                  const targetMet = (() => {
                    if (!calculatedValue || calculatedValue === '-') return null;
                    const numValue = parseFloat(calculatedValue);
                    const targetStr = indicator.target;
                    
                    if (targetStr.includes('≤')) {
                      const threshold = parseFloat(targetStr.replace('≤', '').trim());
                      return numValue <= threshold;
                    } else if (targetStr.includes('≥')) {
                      const threshold = parseFloat(targetStr.replace('≥', '').trim());
                      return numValue >= threshold;
                    }
                    return null;
                  })();
                  
                  // 生成計算公式說明
                  const getFormulaExplanation = () => {
                    const wc = formData.workCompletion || {};
                    const q = formData.quality || {};
                    const totalWork = Object.values(wc).reduce((sum, val) => sum + val, 0);
                    const target = formData.targetOutput || template.targetOutput?.default || 10;
                    
                    // ========== 機構設計課 ==========
                    if (userDepartment === '機構設計課') {
                      if (indicator.kpiField === 'designAccuracyRate') {
                        const e1 = q['設計錯誤次數'] || 0;
                        const e2 = q['圖面錯誤次數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${e1+e2}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'firstPassRate') {
                        const rework = q['返工/修改次數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${rework}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'onTimeRate') {
                        const late = q['逾期完成件數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${late}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'outputAchievementRate') {
                        return `${totalWork} ÷ ${target} × 100 = ${calculatedValue}% (上限150%)`;
                      }
                    }
                    
                    // ========== 電子設計課 ==========
                    if (userDepartment === '電子設計課') {
                      if (indicator.kpiField === 'circuitAccuracyRate') {
                        const e1 = q['電路設計錯誤'] || 0;
                        const e2 = q['PCB佈線錯誤'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${e1+e2}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'verificationPassRate') {
                        const f1 = q['EMC/認證失敗'] || 0;
                        const f2 = q['功能驗證失敗'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${f1+f2}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'onTimeRate') {
                        const late = q['逾期完成件數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${late}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'outputAchievementRate') {
                        return `${totalWork} ÷ ${target} × 100 = ${calculatedValue}% (上限150%)`;
                      }
                    }
                    
                    // ========== 工程中心 ==========
                    if (userDepartment === '工程中心') {
                      if (indicator.kpiField === 'bomAccuracyRate') {
                        const bom = wc['BOM建立/維護'] || 0;
                        const err = q['BOM錯誤次數'] || 0;
                        if (bom === 0) return `BOM件數:0 → 預設100%`;
                        return `(${bom} - ${err}) ÷ ${bom} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'erpAccuracyRate') {
                        const erp = wc['ERP資料維護'] || 0;
                        const err = q['ERP資料錯誤'] || 0;
                        if (erp === 0) return `ERP件數:0 → 預設100%`;
                        return `(${erp} - ${err}) ÷ ${erp} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'ecoTimelyRate') {
                        const eco = wc['設變單處理'] || 0;
                        const late = q['設變逾期次數'] || 0;
                        if (eco === 0) return `設變單:0 → 預設100%`;
                        return `(${eco} - ${late}) ÷ ${eco} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'outputAchievementRate') {
                        return `${totalWork} ÷ ${target} × 100 = ${calculatedValue}% (上限150%)`;
                      }
                    }
                    
                    // ========== 多媒體設計課 ==========
                    if (userDepartment === '多媒體設計課') {
                      if (indicator.kpiField === 'designQualityRate') {
                        const major = q['重大修改次數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${major}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'satisfactionRate') {
                        const reject = q['退件/駁回次數'] || 0;
                        return `100 - (${reject} × 5) = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'onTimeDeliveryRate') {
                        const late = q['逾期交付次數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${late}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'outputAchievementRate') {
                        return `${totalWork} ÷ ${target} × 100 = ${calculatedValue}% (上限150%)`;
                      }
                    }
                    
                    // ========== 線材設計課 ==========
                    if (userDepartment === '線材設計課') {
                      if (indicator.kpiField === 'designAccuracyRate') {
                        const e1 = q['線材規格錯誤'] || 0;
                        const e2 = q['接頭選用錯誤'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${e1+e2}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'firstPassRate') {
                        const rework = q['返工/修改次數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${rework}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'onTimeRate') {
                        const late = q['逾期完成件數'] || 0;
                        if (totalWork === 0) return `總件數:0 → 預設100%`;
                        return `(${totalWork} - ${late}) ÷ ${totalWork} × 100 = ${calculatedValue}%`;
                      }
                      if (indicator.kpiField === 'outputAchievementRate') {
                        return `${totalWork} ÷ ${target} × 100 = ${calculatedValue}% (上限150%)`;
                      }
                    }
                    
                    return '自動計算';
                  };
                  
                  return (
                    <div key={idx} className={`p-4 rounded-lg border-2 ${
                      targetMet === true ? 'bg-green-50 border-green-300' : 
                      targetMet === false ? 'bg-red-50 border-red-300' : 
                      'bg-indigo-50 border-indigo-200'
                    }`}>
                      <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className={`px-2 py-1 text-xs rounded font-medium ${
                              targetMet === true ? 'bg-green-600 text-white' :
                              targetMet === false ? 'bg-red-600 text-white' :
                              'bg-indigo-600 text-white'
                            }`}>
                              {indicator.category}
                            </span>
                            <span className="font-medium text-slate-800">{indicator.name}</span>
                          </div>
                          <div className="text-xs text-slate-600 mt-1">
                            目標: <span className="font-medium text-indigo-600">{indicator.target}</span>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className={`text-2xl font-bold ${
                            targetMet === true ? 'text-green-600' :
                            targetMet === false ? 'text-red-600' :
                            'text-indigo-600'
                          }`}>
                            {calculatedValue}
                          </div>
                          <div className="text-xs text-slate-500">{indicator.unit}</div>
                        </div>
                      </div>
                      
                      {/* 計算公式說明 */}
                      <div className="mt-3 p-2 bg-white/70 rounded border border-slate-200">
                        <div className="text-xs text-slate-600 mb-1">
                          <span className="font-semibold text-slate-700">📐 計算公式:</span>
                        </div>
                        <div className="text-xs font-mono text-slate-800 bg-slate-100 px-2 py-1 rounded">
                          {getFormulaExplanation()}
                        </div>
                      </div>
                      
                      {targetMet !== null && (
                        <div className={`mt-2 text-xs font-medium ${
                          targetMet ? 'text-green-700' : 'text-red-700'
                        }`}>
                          {targetMet ? '✓ 已達成目標' : '✗ 未達成目標'}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              <div className="mt-4 p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                <p className="text-sm text-indigo-700">
                  🤖 <strong>自動計算:</strong> 這些KPI指標會根據您填寫的工作產出量與品質狀況自動計算,無需手動輸入。每項指標佔25%,總計100%對應70分滿分。
                </p>
              </div>
            </div>
          )}

          {/* 說明區 */}
          <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border-2 border-blue-100">
            <h3 className="font-bold text-slate-800 mb-3">📋 填寫說明</h3>
            <ul className="space-y-2 text-sm text-slate-700">
              <li className="flex items-start gap-2">
                <span className="text-green-600 font-bold">✓</span>
                <span><strong>工程師只填數量和狀態</strong> - 不需要計算百分比、效率、達成率</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-green-600 font-bold">✓</span>
                <span><strong>系統自動計算分數</strong> - 加權、評分、趨勢都在後台處理</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-green-600 font-bold">✓</span>
                <span><strong>主管看到完整分析</strong> - 管理 KPI 儀表板會顯示部門整體表現</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-blue-600 font-bold">ℹ</span>
                <span><strong>每月5分鐘完成</strong> - 設計目標就是讓工程師快速填寫</span>
              </li>
            </ul>
          </div>
        </form>
      </main>
    </div>
  );
};

const KpiCard = ({ title, value, subtext, icon: Icon, trend }) => (
  <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/10 hover:bg-white/10 transition-all duration-300 group relative overflow-hidden">
    <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-white/5 to-transparent rounded-full -mr-12 -mt-12 group-hover:scale-150 transition-transform duration-500"></div>
    <div className="flex justify-between items-start relative">
      <div>
        <p className="text-sm font-medium text-slate-400">{title}</p>
        <h3 className="text-3xl font-bold text-white mt-2">{value}</h3>
      </div>
      <div className={`p-3 rounded-xl ${trend === 'up' ? 'bg-emerald-500/20 ring-1 ring-emerald-500/30' : trend === 'down' ? 'bg-red-500/20 ring-1 ring-red-500/30' : 'bg-slate-500/20 ring-1 ring-slate-500/30'}`}>
        <Icon className={`w-6 h-6 ${trend === 'up' ? 'text-emerald-400' : trend === 'down' ? 'text-red-400' : 'text-slate-400'}`} />
      </div>
    </div>
    <div className="mt-4 flex items-center text-sm">
      <span className={`${trend === 'up' ? 'text-emerald-400' : trend === 'down' ? 'text-red-400' : 'text-slate-500'} font-medium`}>
        {subtext}
      </span>
    </div>
  </div>
);

const KPIApp = ({ onBackToMenu }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [data, setData] = useState([]);
  const [selectedPerson, setSelectedPerson] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [dashboardMonth, setDashboardMonth] = useState('12月');
  const [analysisPerson, setAnalysisPerson] = useState('');
  const [formData, setFormData] = useState({ name: '', department: '', month: '12月', metrics: [] });

  // 🔥 從 Firebase 訂閱 KPI 績效資料
  useEffect(() => {
    // 先載入假資料作為示範
    const historyData = generateHistory();
    
    // 訂閱 Firebase kpi_performance 集合
    const unsub = db.subscribe('kpi_performance', (firebaseData) => {
      console.log('📊 KPI App: 載入 Firebase 資料', firebaseData);
      
      // 合併假資料和 Firebase 資料
      const combinedData = [...historyData];
      
      firebaseData.forEach(record => {
        // 檢查是否已存在相同記錄（根據姓名和月份）
        const existingIndex = combinedData.findIndex(
          d => d.name === record.name && d.month === record.month
        );
        
        // 轉換 Firebase 資料格式
        const formattedRecord = {
          id: record.id,
          name: record.name,
          department: record.department,
          month: record.month,
          metrics: record.metrics || [],
          scores: record.scores,
          grade: record.grade,
          level: record.level,
          createdAt: record.createdAt
        };
        
        if (existingIndex >= 0) {
          // 更新現有記錄
          combinedData[existingIndex] = formattedRecord;
        } else {
          // 新增記錄
          combinedData.push(formattedRecord);
        }
      });
      
      setData(combinedData);
      
      // 設定預設分析對象
      if (combinedData.length > 0 && !analysisPerson) {
        setAnalysisPerson(combinedData[0].name);
      }
    });
    
    return () => unsub && unsub();
  }, []);

  const calculateRate = (metrics) => {
    if (!metrics || metrics.length === 0) return 0;
    const achieved = metrics.filter(m => m.status === 'Achieved').length;
    return Math.round((achieved / metrics.length) * 100);
  };

  const dashboardData = useMemo(() => data.filter(d => d.month === dashboardMonth), [data, dashboardMonth]);
  const totalMetrics = dashboardData.reduce((acc, curr) => acc + curr.metrics.length, 0);
  const achievedMetrics = dashboardData.reduce((acc, curr) => acc + curr.metrics.filter(m => m.status === 'Achieved').length, 0);
  const overallRate = totalMetrics > 0 ? Math.round((achievedMetrics / totalMetrics) * 100) : 0;
  const missedMetrics = dashboardData.flatMap(p => p.metrics.filter(m => m.status === 'Missed').map(m => ({ ...m, person: p.name, dept: p.department })));

  const departmentPerformance = useMemo(() => {
    const depts = {};
    dashboardData.forEach(person => {
      if (!depts[person.department]) depts[person.department] = { name: person.department, total: 0, achieved: 0, count: 0 };
      person.metrics.forEach(m => {
        depts[person.department].total += 1;
        if (m.status === 'Achieved') depts[person.department].achieved += 1;
      });
      depts[person.department].count += 1;
    });
    return Object.values(depts).map(d => ({ name: d.name, rate: d.total > 0 ? Math.round((d.achieved / d.total) * 100) : 0, headcount: d.count }));
  }, [dashboardData]);

  const analysisChartData = useMemo(() => {
    const personRecords = data.filter(d => d.name === analysisPerson);
    return MONTH_ORDER.map(month => {
      const record = personRecords.find(r => r.month === month);
      return { month, score: record ? calculateRate(record.metrics) : null };
    });
  }, [data, analysisPerson]);

  const analysisStats = useMemo(() => {
    const validScores = analysisChartData.filter(d => d.score !== null).map(d => d.score);
    if (validScores.length === 0) return { avg: 0, max: 0, min: 0 };
    return { avg: Math.round(validScores.reduce((a, b) => a + b, 0) / validScores.length), max: Math.max(...validScores), min: Math.min(...validScores) };
  }, [analysisChartData]);

  const uniquePeople = useMemo(() => [...new Set(data.map(d => d.name))], [data]);

  const handleFormChange = (e) => {
    const { name, value } = e.target;
    if (name === 'department') {
      const template = DEPARTMENT_TEMPLATES[value] || [];
      setFormData({ ...formData, [name]: value, metrics: JSON.parse(JSON.stringify(template)) });
    } else { setFormData({ ...formData, [name]: value }); }
  };

  const handleMetricChange = (index, field, value) => {
    const newMetrics = [...formData.metrics];
    newMetrics[index][field] = value;
    setFormData({ ...formData, metrics: newMetrics });
  };

  const addMetricRow = () => setFormData({ ...formData, metrics: [...formData.metrics, { category: '質量', name: '', target: '', actual: '', status: 'Achieved', note: '' }] });
  const removeMetricRow = (index) => setFormData({ ...formData, metrics: formData.metrics.filter((_, i) => i !== index) });

  // 🔥 刪除 KPI 記錄
  const handleDeleteRecord = async (record) => {
    if (!confirm(`確定要刪除 ${record.name} 的 ${record.month} KPI 記錄嗎？`)) return;
    
    try {
      // 如果有 Firebase ID，從 Firebase 刪除
      if (record.id && typeof record.id === 'string' && record.id.length > 10) {
        await db.deleteDoc('kpi_performance', record.id);
        console.log('✅ 已從 Firebase 刪除');
      }
      // 從本地 state 移除
      setData(prev => prev.filter(d => d.id !== record.id));
      alert(`已刪除 ${record.name} 的 ${record.month} 記錄`);
    } catch (error) {
      console.error('刪除失敗:', error);
      alert('刪除失敗: ' + error.message);
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.name || !formData.department) return alert('請填寫完整資訊');
    setData([...data, { id: Date.now(), ...formData }]);
    alert(`已儲存 ${formData.name} 的資料！`);
    setFormData({ name: '', department: '', month: '12月', metrics: [] });
    setActiveTab('list');
  };

  const filteredData = data.filter(p => (p.name.includes(searchTerm) || p.department.includes(searchTerm)) && (dashboardMonth === 'All' ? true : p.month === dashboardMonth));

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 font-sans text-slate-900">
      <nav className="bg-slate-900/50 backdrop-blur-xl text-white shadow-2xl sticky top-0 z-30 border-b border-white/10">
        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg shadow-blue-500/25">
              <Target className="w-6 h-6 text-white"/>
            </div>
            <span className="font-bold text-xl bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">KPI 績效系統</span>
          </div>
          <div className="flex space-x-2">
            <button onClick={() => setActiveTab('dashboard')} className={`px-4 py-2 rounded-xl text-sm font-medium flex items-center transition-all ${activeTab === 'dashboard' ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg shadow-blue-500/25' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}><LayoutDashboard className="w-4 h-4 mr-2"/>儀表板</button>
            <button onClick={() => setActiveTab('analysis')} className={`px-4 py-2 rounded-xl text-sm font-medium flex items-center transition-all ${activeTab === 'analysis' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/25' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}><LineChartIcon className="w-4 h-4 mr-2"/>個人分析</button>
            <button onClick={() => setActiveTab('list')} className={`px-4 py-2 rounded-xl text-sm font-medium flex items-center transition-all ${activeTab === 'list' ? 'bg-gradient-to-r from-emerald-600 to-green-600 text-white shadow-lg shadow-emerald-500/25' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}><FileText className="w-4 h-4 mr-2"/>報表</button>
            <button onClick={() => setActiveTab('entry')} className={`px-4 py-2 rounded-xl text-sm font-medium flex items-center transition-all ${activeTab === 'entry' ? 'bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg shadow-amber-500/25' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}><PlusCircle className="w-4 h-4 mr-2"/>新增</button>
            <button onClick={onBackToMenu} className="px-4 py-2 rounded-xl text-sm font-medium flex items-center bg-white/10 text-white hover:bg-white/20 ml-4 border border-white/10 transition-all"><LogOut className="w-4 h-4 mr-2"/>返回</button>
          </div>
        </div>
      </nav>
      <main className="max-w-7xl mx-auto px-4 py-8">
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-white">{activeTab === 'dashboard' ? '績效儀表板' : activeTab === 'analysis' ? '年度個人分析' : activeTab === 'list' ? '詳細報表' : '資料填寫'}</h1>
          <p className="text-slate-400 mt-1">即時追蹤與分析員工績效表現</p>
        </div>
        {activeTab === 'dashboard' && (
          <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center bg-white/5 backdrop-blur-xl p-5 rounded-2xl shadow-xl border border-white/10">
              <div className="flex items-center space-x-3"><Calendar className="w-5 h-5 text-blue-400" /><span className="font-bold text-slate-300">數據月份：</span><select value={dashboardMonth} onChange={(e) => setDashboardMonth(e.target.value)} className="bg-white/10 border border-white/20 text-white text-sm rounded-xl p-2.5 outline-none font-medium">{MONTH_ORDER.map(m => <option key={m} value={m} className="bg-slate-800">{m}</option>)}</select></div>
              <div className="text-sm text-slate-400 px-3 py-1.5 bg-white/5 rounded-lg">顯示 {dashboardData.length} 筆資料</div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <KpiCard title="該月總達成率" value={`${overallRate}%`} subtext="KPI 指標平均" icon={TrendingUp} trend="up" />
              <KpiCard title="評核人數" value={dashboardData.length.toString()} subtext={`${dashboardMonth} 份數`} icon={Users} trend="neutral" />
              <KpiCard title="待改善項目" value={missedMetrics.length.toString()} subtext="未達標總數" icon={AlertCircle} trend="down" />
              <KpiCard title="完美達成" value={dashboardData.filter(p => calculateRate(p.metrics) === 100).length.toString()} subtext="達成率 100%" icon={CheckCircle2} trend="up" />
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/10 lg:col-span-2">
                <h3 className="text-lg font-bold text-white mb-4">{dashboardMonth} - 部門績效總覽</h3>
                <div className="h-64"><ResponsiveContainer width="100%" height="100%"><BarChart data={departmentPerformance} layout="vertical" margin={{ left: 40 }}><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="rgba(255,255,255,0.1)" /><XAxis type="number" domain={[0, 100]} unit="%" stroke="#94a3b8" /><YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12, fill: '#94a3b8'}} stroke="#94a3b8" /><RechartsTooltip cursor={{fill: 'rgba(255,255,255,0.05)'}} contentStyle={{backgroundColor:'rgba(30,41,59,0.95)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'12px'}} /><Bar dataKey="rate" name="達成率" radius={[0, 4, 4, 0]}>{departmentPerformance.map((entry, index) => (<Cell key={`cell-${index}`} fill={DEPARTMENT_COLORS[entry.name] || '#cbd5e1'} />))}</Bar></BarChart></ResponsiveContainer></div>
              </div>
              <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/10">
                <h3 className="text-lg font-bold text-red-400 mb-4 flex items-center"><AlertCircle className="w-5 h-5 mr-2" /> {dashboardMonth} 異常項目</h3>
                <div className="space-y-3 max-h-64 overflow-y-auto pr-2 custom-scrollbar">{missedMetrics.length > 0 ? (missedMetrics.map((item, idx) => (<div key={idx} className="p-4 bg-red-500/10 rounded-xl border border-red-500/20"><div className="flex justify-between items-center mb-2"><span className="font-bold text-white">{item.person}</span><span className="text-xs text-slate-400 bg-white/10 px-2 py-1 rounded-lg">{item.dept}</span></div><div className="text-sm text-red-400 font-medium">{item.name}</div><div className="text-xs text-red-300/70 mt-1">目標: {item.target} | 實際: {item.actual}</div></div>))) : (<div className="text-center py-8 text-slate-500">本月無異常項目，表現優異！</div>)}</div>
              </div>
            </div>
          </div>
        )}
        {activeTab === 'analysis' && (
          <div className="space-y-6 animate-fade-in">
             <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/10">
               <div className="flex flex-col md:flex-row justify-between items-center mb-6">
                 <h3 className="text-lg font-bold text-white flex items-center mb-4 md:mb-0"><LineChartIcon className="w-6 h-6 mr-2 text-purple-400" />個人年度績效趨勢</h3>
                 <div className="flex items-center space-x-3"><span className="text-sm font-medium text-slate-400">選擇分析對象：</span><select value={analysisPerson} onChange={(e) => setAnalysisPerson(e.target.value)} className="bg-white/10 border border-white/20 text-white text-sm rounded-xl p-2.5 outline-none font-medium min-w-[150px]">{uniquePeople.map(p => <option key={p} value={p} className="bg-slate-800">{p}</option>)}</select></div>
               </div>
               <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                 <div className="bg-purple-500/10 backdrop-blur p-4 rounded-xl text-center border border-purple-500/20"><p className="text-xs text-purple-400 font-bold uppercase">年度平均分</p><p className="text-3xl font-bold text-white mt-1">{analysisStats.avg}</p></div>
                 <div className="bg-emerald-500/10 backdrop-blur p-4 rounded-xl text-center border border-emerald-500/20"><p className="text-xs text-emerald-400 font-bold uppercase">歷史最高分</p><p className="text-3xl font-bold text-white mt-1">{analysisStats.max}</p></div>
                 <div className="bg-slate-500/10 backdrop-blur p-4 rounded-xl text-center border border-slate-500/20"><p className="text-xs text-slate-400 font-bold uppercase">歷史最低分</p><p className="text-3xl font-bold text-white mt-1">{analysisStats.min}</p></div>
                 <div className="bg-blue-500/10 backdrop-blur p-4 rounded-xl text-center border border-blue-500/20"><p className="text-xs text-blue-400 font-bold uppercase">所屬部門</p><p className="text-lg font-bold text-white mt-2">{data.find(d => d.name === analysisPerson)?.department || 'N/A'}</p></div>
               </div>
               <div className="h-80 w-full"><ResponsiveContainer width="100%" height="100%"><LineChart data={analysisChartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(255,255,255,0.1)" /><XAxis dataKey="month" stroke="#94a3b8" /><YAxis domain={[0, 100]} stroke="#94a3b8" /><RechartsTooltip contentStyle={{backgroundColor:'rgba(30,41,59,0.95)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'12px'}} /><Legend /><Line type="monotone" dataKey="score" name="KPI 達成率" stroke="#a855f7" strokeWidth={3} activeDot={{ r: 8 }} connectNulls={true} /></LineChart></ResponsiveContainer></div>
             </div>
          </div>
        )}
        {activeTab === 'list' && (
          <div className="bg-white/5 backdrop-blur-xl rounded-2xl shadow-xl border border-white/10 overflow-hidden">
            <div className="p-5 border-b border-white/10 flex flex-col sm:flex-row justify-between items-center gap-4">
              <h3 className="text-lg font-bold text-white flex items-center"><span className="bg-blue-500/20 text-blue-400 text-xs px-3 py-1 rounded-lg mr-3">{dashboardMonth}</span>員工列表</h3>
              <div className="relative w-full sm:w-64"><Search className="absolute left-4 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-500" /><input type="text" placeholder="搜尋姓名或部門..." className="w-full pl-11 pr-4 py-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
            </div>
            <div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-white/5 text-slate-400 font-semibold border-b border-white/10"><tr><th className="p-4">姓名</th><th className="p-4">部門</th><th className="p-4">月份</th><th className="p-4 text-center">達成率</th><th className="p-4">狀態</th><th className="p-4">操作</th></tr></thead><tbody className="divide-y divide-white/5">{filteredData.length > 0 ? filteredData.map((person) => { const rate = calculateRate(person.metrics); return (<tr key={person.id} className="hover:bg-white/5 transition-colors"><td className="p-4 font-medium text-white">{person.name}</td><td className="p-4"><span className="px-3 py-1.5 bg-slate-700/50 rounded-lg text-slate-300 text-xs border border-slate-600/50">{person.department}</span></td><td className="p-4 text-slate-400">{person.month}</td><td className="p-4 text-center"><div className="flex items-center justify-center space-x-2"><div className="w-16 bg-slate-700 rounded-full h-1.5"><div className={`h-1.5 rounded-full ${rate === 100 ? 'bg-emerald-500' : rate >= 80 ? 'bg-amber-500' : 'bg-red-500'}`} style={{ width: `${rate}%` }}></div></div><span className="text-xs text-slate-300">{rate}%</span></div></td><td className="p-4">{rate === 100 ? <span className="text-emerald-400 flex items-center text-xs font-bold"><CheckCircle2 className="w-3 h-3 mr-1"/> 優異</span> : rate < 80 ? <span className="text-red-400 flex items-center text-xs font-bold"><AlertCircle className="w-3 h-3 mr-1"/> 需改善</span> : <span className="text-amber-400 flex items-center text-xs font-bold"><TrendingUp className="w-3 h-3 mr-1"/> 良好</span>}</td><td className="p-4"><div className="flex items-center gap-2"><button onClick={() => setSelectedPerson(person)} className="text-blue-400 hover:text-blue-300 font-medium text-xs flex items-center px-3 py-1.5 bg-blue-500/10 rounded-lg hover:bg-blue-500/20 transition-all">查看 <ChevronRight className="w-3 h-3 ml-1" /></button><button onClick={() => handleDeleteRecord(person)} className="text-red-400 hover:text-red-300 p-2 rounded-lg hover:bg-red-500/20 transition-all" title="刪除記錄"><Trash2 className="w-4 h-4" /></button></div></td></tr>); }) : (<tr><td colSpan="6" className="p-8 text-center text-slate-500">沒有找到 {dashboardMonth} 符合條件的資料</td></tr>)}</tbody></table></div>
          </div>
        )}
        {activeTab === 'entry' && (
          <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-slate-100 p-6">
             <div className="border-b border-slate-100 pb-4 mb-6"><h3 className="text-lg font-bold text-slate-800 flex items-center"><PlusCircle className="w-5 h-5 mr-2 text-blue-600" /> 新增資料</h3><p className="text-slate-500 text-sm mt-1">選部門自動帶入指標</p></div>
             <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label className="block text-sm font-medium mb-1">姓名</label><input type="text" name="name" value={formData.name} onChange={handleFormChange} className="w-full p-2 border rounded focus:border-blue-500 outline-none" required /></div><div><label className="block text-sm font-medium mb-1">部門</label><select name="department" value={formData.department} onChange={handleFormChange} className="w-full p-2 border rounded focus:border-blue-500 outline-none" required><option value="" disabled>請選擇</option>{Object.keys(DEPARTMENT_COLORS).map(dept => <option key={dept} value={dept}>{dept}</option>)}</select></div><div><label className="block text-sm font-medium mb-1">月份</label><select name="month" value={formData.month} onChange={handleFormChange} className="w-full p-2 border rounded focus:border-blue-500 outline-none">{MONTH_ORDER.map(m => <option key={m} value={m}>{m}</option>)}</select></div></div>
                <div><div className="flex justify-between items-center mb-2"><label className="font-bold">指標明細</label><div className="space-x-2"><button type="button" onClick={() => {if(formData.department) setFormData({...formData, metrics: JSON.parse(JSON.stringify(DEPARTMENT_TEMPLATES[formData.department]))})}} className="text-xs bg-slate-100 px-3 py-1 rounded hover:bg-slate-200"><RefreshCw className="w-3 h-3 inline mr-1"/>重置</button><button type="button" onClick={addMetricRow} className="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100"><PlusCircle className="w-3 h-3 inline mr-1"/>新增</button></div></div>{formData.metrics.length === 0 ? <p className="text-center py-8 bg-slate-50 text-slate-400 rounded">請先選擇部門</p> : <div className="space-y-3">{formData.metrics.map((m, i) => (<div key={i} className="flex flex-col md:flex-row gap-2 p-3 bg-slate-50 rounded border border-slate-200 items-start md:items-center"><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">類別</span><input value={m.category} onChange={e => handleMetricChange(i, 'category', e.target.value)} className="w-full p-1 text-sm border rounded"/></div><div className="flex-1"><span className="text-xs text-slate-500 block">項目</span><input value={m.name} onChange={e => handleMetricChange(i, 'name', e.target.value)} className="w-full p-1 text-sm border rounded"/></div><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">目標</span><input value={m.target} onChange={e => handleMetricChange(i, 'target', e.target.value)} className="w-full p-1 text-sm border rounded"/></div><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">實際</span><input value={m.actual} onChange={e => handleMetricChange(i, 'actual', e.target.value)} className="w-full p-1 text-sm border rounded bg-white"/></div><div className="w-full md:w-24"><span className="text-xs text-slate-500 block">狀態</span><select value={m.status} onChange={e => handleMetricChange(i, 'status', e.target.value)} className="w-full p-1 text-sm border rounded"><option value="Achieved">達成</option><option value="Missed">未達成</option><option value="Warning">部分</option><option value="Unknown">未知</option></select></div><button type="button" onClick={() => removeMetricRow(i)} className="text-red-400 hover:text-red-600 p-2"><Trash2 className="w-4 h-4"/></button></div>))}</div>}</div>
                <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-bold flex justify-center items-center"><Save className="w-5 h-5 mr-2"/>儲存</button>
             </form>
          </div>
        )}
      </main>
      {selectedPerson && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10"><div><h2 className="text-2xl font-bold">{selectedPerson.name}</h2><p className="text-sm text-slate-500">{selectedPerson.department} | {selectedPerson.month}</p></div><button onClick={() => setSelectedPerson(null)}><X className="w-6 h-6 text-slate-400 hover:text-slate-600"/></button></div>
            <div className="p-6">
              <div className="mb-6">
                <h4 className="font-bold mb-2">指標明細</h4>
                <div className="border rounded-lg overflow-hidden">
                  <table className="w-full text-sm">
                    <thead className="bg-slate-50 text-slate-600"><tr><th className="p-3 text-left">類別</th><th className="p-3 text-left">項目</th><th className="p-3">目標/實際</th><th className="p-3">狀態</th><th className="p-3">備註</th></tr></thead>
                    <tbody className="divide-y">{selectedPerson.metrics.map((m, i) => (<tr key={i}><td className="p-3 text-slate-500">{m.category}</td><td className="p-3 font-medium">{m.name}</td><td className="p-3">{m.target} <span className="text-slate-400">/</span> <span className="font-bold text-blue-600">{m.actual}</span></td><td className="p-3"><StatusBadge status={m.status}/></td><td className="p-3 text-slate-500 text-xs">{m.note}</td></tr>))}</tbody>
                  </table>
                </div>
              </div>
              {/* 🔥 備註說明和附件區塊 - 永遠顯示 */}
              <div className="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <h4 className="font-bold mb-3 flex items-center text-slate-700"><FileText className="w-4 h-4 mr-2" />備註說明</h4>
                <div className="mb-3">
                  <p className="text-sm text-slate-600 whitespace-pre-wrap">{selectedPerson.note || '（無備註）'}</p>
                </div>
                <div className="flex items-center gap-2 pt-2 border-t border-slate-200">
                  <Paperclip className="w-4 h-4 text-slate-400" />
                  <span className="text-sm text-slate-500">附件：</span>
                  {selectedPerson.attachment ? (
                    selectedPerson.attachment.startsWith('data:image') ? (
                      <a href={selectedPerson.attachment} target="_blank" className="text-blue-600 hover:underline text-sm">{selectedPerson.attachmentName || '查看圖片'}</a>
                    ) : (
                      <a href={selectedPerson.attachment} download={selectedPerson.attachmentName || '附件'} className="text-blue-600 hover:underline text-sm">{selectedPerson.attachmentName || '下載附件'}</a>
                    )
                  ) : (
                    <span className="text-sm text-slate-400">（無附件）</span>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// --- Main App Component (TQM) ---
const TQMApp = ({ appUser, onLogout, onBackToMenu }) => {
  const [records, setRecords] = useState([]);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [viewImage, setViewImage] = useState(null); 
  const [editingRecord, setEditingRecord] = useState(null);
  const [importEncoding, setImportEncoding] = useState('Big5'); // Default to Big5 for Excel compatibility

  useEffect(() => {
    if (!appUser) return;
    const unsubscribe = db.subscribe('tqm_records', (data) => {
      const sorted = [...data].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      setRecords(sorted);
    });
    return () => unsubscribe();
  }, [appUser]);

  const handleLogout = onLogout;

  const handleAddRecord = async (formData) => {
    try {
      // 檢查附件大小
      if (formData.attachment && formData.attachment.length > 1024 * 1024) {
        alert('附件過大！Firestore 限制單一文件 1MB，請壓縮圖片或移除附件');
        return;
      }
      await db.addDoc('tqm_records', { ...formData, createdAt: new Date().toISOString(), userId: appUser.id, createdByUser: appUser.username });
      alert('TQM紀錄已新增！'); setActiveTab('list');
    } catch (e) { 
      console.error("Error adding document: ", e); 
      const errMsg = e.toString();
      if (errMsg.includes('exceeds') || errMsg.includes('too large') || errMsg.includes('1048487')) {
        alert('新增失敗: 資料過大！\n\nFirestore 限制單一文件 1MB，請移除附件或使用較小的圖片');
      } else {
        alert('新增失敗: ' + errMsg);
      }
    }
  };

  const handleUpdateRecord = async (id, updatedData) => {
    try { await db.updateDoc('tqm_records', id, { ...updatedData, updatedAt: new Date().toISOString(), updatedByUser: appUser.username }); setEditingRecord(null); } catch (e) { console.error("Error updating document: ", e); alert('更新失敗，請重試。'); }
  };

  const handleDelete = async (id) => { if (!confirm('確定要刪除此筆紀錄嗎？')) return; try { await db.deleteDoc('tqm_records', id); } catch (e) { console.error("Error deleting: ", e); } };

  const handleImportCSV = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        const text = event.target.result;
        const cleanText = text.charCodeAt(0) === 0xFEFF ? text.slice(1) : text;
        const rows = parseCSV(cleanText);
        if (rows.length < 2) return alert("CSV 格式錯誤");
        const header = rows[0].map(h => h.trim());
        const dataRows = rows.slice(1);
        const getColIndex = (names) => header.findIndex(h => names.some(n => h.includes(n)));
        const colMap = {
          date: getColIndex(['日期']), legacyMonth: getColIndex(['月份']), dept: getColIndex(['部門', '課別']),
          person: getColIndex(['人員', '姓名']), type: getColIndex(['回報類型', 'TQM回報類型']), desc: getColIndex(['問題描述', '異常描述', 'TQM回報問題/異常描述']),
          repeat: getColIndex(['重複']), status: getColIndex(['狀態', '改善狀態']), method: getColIndex(['改善對策', '永久改善措施']), note: getColIndex(['備註', '訊息'])
        };
        if (colMap.dept === -1 || colMap.desc === -1) return alert("無法辨識 CSV 格式，請確認標題列是否正確。");
        let count = 0;
        const currentYear = new Date().getFullYear();
        for (const row of dataRows) {
          if (row.length < 2) continue;
          let recordDate = new Date().toISOString().split('T')[0];
          if (colMap.date !== -1 && row[colMap.date]) {
             const dStr = row[colMap.date].trim();
             // Normalize date format YYYY/MM/DD -> YYYY-MM-DD
             const parts = dStr.split(/[\/\-\.]/);
             if (parts.length === 3) {
                recordDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
             } else {
                recordDate = dStr;
             }
          }
          else if (colMap.legacyMonth !== -1 && row[colMap.legacyMonth]) {
            const m = row[colMap.legacyMonth].match(/(\d+)/)?.[1].padStart(2, '0');
            if(m) recordDate = `${currentYear}-${m}-01`;
          }
          const dept = DEPARTMENTS.find(d => (row[colMap.dept]||'').includes(d)) || (row[colMap.dept]||'其他');
          const isRepeat = (colMap.repeat !== -1 ? row[colMap.repeat] : '').includes('是');
          const status = (colMap.status !== -1 ? row[colMap.status] : '').includes('已改善') ? '已改善' : '未改善';
          await db.addDoc('tqm_records', {
            date: recordDate, department: dept, personName: (colMap.person !== -1 ? row[colMap.person] : '匯入資料').trim(),
            issueType: (colMap.type !== -1 ? row[colMap.type] : '其他').trim(), description: (colMap.desc !== -1 ? row[colMap.desc] : '').trim(),
            isRepeat: isRepeat, status: status, improvementMethod: colMap.method !== -1 ? row[colMap.method] : '',
            note: colMap.note !== -1 ? row[colMap.note] : '批量匯入',
            createdAt: new Date().toISOString(), userId: appUser.id, createdByUser: appUser.username
          });
          count++;
        }
        alert(`成功匯入 ${count} 筆資料！`); e.target.value = null;
      } catch (error) { alert("匯入失敗：" + error.message); }
    };
    reader.readAsText(file, importEncoding);
  };

  // --- New DB Import/Export Handlers ---
  const handleImportDB = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (!data.users || !data.records) throw new Error('格式錯誤');
        db.importData(data);
        alert('資料庫載入成功！');
        window.location.reload(); 
      } catch (err) { alert('載入失敗：' + err.message); }
    };
    reader.readAsText(file);
  };

  const handleExportDB = () => {
    const data = db.exportData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TQM_Database_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
  };

  const stats = useMemo(() => {
    const total = records.length;
    const resolved = records.filter(r => r.status === '已改善').length;
    const unresolved = total - resolved;
    const repeats = records.filter(r => r.isRepeat).length;
    return { total, resolved, unresolved, repeats, improvementRate: total > 0 ? ((resolved / total) * 100).toFixed(1) : 0, repeatRate: total > 0 ? ((repeats / total) * 100).toFixed(1) : 0 };
  }, [records]);

  const chartData = useMemo(() => {
    const trendMap = {}; MONTHS.forEach(m => trendMap[m] = { name: m, 案件數: 0, 重複: 0 });
    const deptMap = {}; DEPARTMENTS.forEach(d => deptMap[d] = { name: d, value: 0 });
    const typeMap = {};
    records.forEach(r => {
      const m = MONTHS[new Date(r.date).getMonth()];
      if (trendMap[m]) { trendMap[m].案件數++; if(r.isRepeat) trendMap[m].重複++; }
      if (deptMap[r.department]) deptMap[r.department].value++;
      if (!typeMap[r.issueType]) typeMap[r.issueType] = { name: r.issueType, value: 0 };
      typeMap[r.issueType].value++;
    });
    return { trendData: Object.values(trendMap), deptData: Object.values(deptMap).filter(d => d.value > 0), typeData: Object.values(typeMap) };
  }, [records]);

  const handleExportCSV = () => {
    if (records.length === 0) return alert("無資料可匯出");
    const headers = ["日期", "部門", "人員", "TQM回報類型", "重複發生", "改善狀態", "問題描述", "改善對策", "備註/訊息", "有無附件"];
    const csvString = '\uFEFF' + [headers.join(','), ...records.map(r => [
      r.date, r.department, r.personName, r.issueType, r.isRepeat?"是":"否", r.status,
      `"${(r.description||'').replace(/"/g,'""')}"`, `"${(r.improvementMethod||'').replace(/"/g,'""')}"`,
      `"${(r.note||'').replace(/"/g,'""')}"`, r.attachment?"有":"無"
    ].join(','))].join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csvString], {type:'text/csv'}));
    a.download = `TQM_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex font-sans text-slate-900">
      {viewImage && <ImageModal src={viewImage} onClose={() => setViewImage(null)} />}
      {editingRecord && <EditRecordModal record={editingRecord} onClose={() => setEditingRecord(null)} onUpdate={handleUpdateRecord} />}

      <aside className="w-72 bg-slate-900/50 backdrop-blur-xl text-white flex-shrink-0 hidden md:flex flex-col border-r border-white/10">
        <div className="p-6 border-b border-white/10">
          <h1 className="text-xl font-bold flex items-center gap-2">
            <div className="p-2 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg shadow-blue-500/25">
              <CheckCircle2 className="w-5 h-5 text-white" />
            </div>
            <span className="bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">TQM 管理系統</span>
          </h1>
          <div className="mt-5 flex items-center gap-3 bg-white/5 backdrop-blur p-4 rounded-2xl border border-white/10">
             <div className="bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl w-10 h-10 flex items-center justify-center text-sm font-bold shadow-lg">{appUser.displayName[0]}</div>
             <div><p className="text-sm font-semibold text-white">{appUser.displayName}</p><p className="text-xs text-slate-400 flex items-center gap-1">{appUser.role === 'admin' ? <Shield size={10} className="text-purple-400"/> : <User size={10}/>}{appUser.role === 'admin' ? '系統管理員' : '一般使用者'}</p></div>
          </div>
        </div>
        <nav className="flex-1 p-4 space-y-2">
          <NavButton active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={LayoutDashboard} label="總覽儀表板" />
          <NavButton active={activeTab === 'entry'} onClick={() => setActiveTab('entry')} icon={PlusCircle} label="新增紀錄" />
          <NavButton active={activeTab === 'list'} onClick={() => setActiveTab('list')} icon={List} label="紀錄清單" />
          <NavButton active={activeTab === 'analysis'} onClick={() => setActiveTab('analysis')} icon={BarChart3} label="統計分析" />
          {appUser.role === 'admin' && (<><div className="border-t border-white/10 my-3 pt-3 text-xs text-slate-500 px-3 uppercase tracking-wider">管理功能</div><NavButton active={activeTab === 'users'} onClick={() => setActiveTab('users')} icon={Users} label="帳號管理" /></>)}
        </nav>
        <div className="p-4 border-t border-white/10 space-y-2">
          <button onClick={handleExportDB} className="w-full flex items-center justify-center gap-2 text-emerald-400 hover:text-white hover:bg-emerald-500/20 transition-all py-3 text-sm border border-emerald-500/30 rounded-xl backdrop-blur">
             <FileJson size={16} /> 匯出資料庫 (備份)
          </button>
        </div>
      </aside>

      <div className="md:hidden fixed top-0 w-full bg-slate-900/90 backdrop-blur-xl text-white z-50 p-4 flex justify-between items-center border-b border-white/10">
        <span className="font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">TQM System</span>
        <button onClick={handleLogout} className="p-2 hover:bg-white/10 rounded-lg transition-colors"><LogOut size={20} /></button>
      </div>

      <main className="flex-1 p-4 md:p-8 overflow-y-auto mt-12 md:mt-0">
        {activeTab === 'dashboard' && (
          <div className="space-y-6 max-w-7xl mx-auto">
             <header className="flex justify-between items-center mb-6">
               <div>
                 <h2 className="text-3xl font-bold text-white mb-1">年度 TQM 總覽</h2>
                 <p className="text-slate-400">即時監控品質管理數據</p>
               </div>
               <div className="flex items-center gap-3">
                 <button onClick={handleExportCSV} className="flex items-center gap-2 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-5 py-2.5 rounded-xl text-sm transition-all shadow-lg shadow-emerald-500/25"><Download size={16} /> 匯出報表</button>
                 <button onClick={onBackToMenu} className="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-xl text-sm transition-all backdrop-blur border border-white/10"><LogOut size={16} /> 返回</button>
               </div>
             </header>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <StatCard title="年度總回報件數" value={stats.total} subtext="累積案件" icon={List} colorClass="bg-blue-500 text-blue-600" />
              <StatCard title="改善率" value={`${stats.improvementRate}%`} subtext={`已改善: ${stats.resolved} 件`} icon={CheckCircle2} colorClass="bg-green-500 text-green-600" />
              <StatCard title="重複發生件數" value={stats.repeats} subtext={`重複率: ${stats.repeatRate}%`} icon={AlertCircle} colorClass="bg-red-500 text-red-600" />
              <StatCard title="待處理案件" value={stats.unresolved} subtext="需追蹤進度" icon={Filter} colorClass="bg-orange-500 text-orange-600" />
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
               <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/10 h-80">
                 <h3 className="text-white font-semibold mb-4">月度趨勢</h3>
                 <ResponsiveContainer><LineChart data={chartData.trendData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(255,255,255,0.1)"/><XAxis dataKey="name" stroke="#94a3b8"/><YAxis stroke="#94a3b8"/><Tooltip contentStyle={{backgroundColor:'rgba(30,41,59,0.95)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'12px'}}/><Legend/><Line type="monotone" dataKey="案件數" stroke="#3b82f6" strokeWidth={2}/><Line type="monotone" dataKey="重複" stroke="#ef4444" strokeWidth={2}/></LineChart></ResponsiveContainer>
               </div>
               <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/10 h-80">
                 <h3 className="text-white font-semibold mb-4">問題類型分佈</h3>
                 <ResponsiveContainer><PieChart><Pie data={chartData.typeData} cx="50%" cy="50%" outerRadius={80} fill="#8884d8" dataKey="value" label>{chartData.typeData.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Pie><Tooltip contentStyle={{backgroundColor:'rgba(30,41,59,0.95)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'12px'}}/></PieChart></ResponsiveContainer>
               </div>
            </div>
          </div>
        )}
        {activeTab === 'entry' && (<div className="max-w-2xl mx-auto"><h2 className="text-2xl font-bold text-white mb-6">新增 TQM 紀錄</h2><EntryForm onSubmit={handleAddRecord} currentUser={appUser} /></div>)}
        {activeTab === 'list' && (
          <div className="max-w-7xl mx-auto space-y-6">
            <div className="flex justify-between items-end">
              <div>
                <h2 className="text-2xl font-bold text-white">歷史紀錄清單</h2>
                <p className="text-slate-400 text-sm mt-1">管理與追蹤所有品質問題紀錄</p>
              </div>
            <div className="flex items-center gap-2">
              <select value={importEncoding} onChange={e=>setImportEncoding(e.target.value)} className="text-sm border border-white/20 rounded-xl p-2.5 bg-white/10 text-white backdrop-blur">
                <option value="UTF-8" className="bg-slate-800">UTF-8</option>
                <option value="Big5" className="bg-slate-800">Big5 (Excel)</option>
              </select>
              <label className="flex items-center gap-2 cursor-pointer bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 px-4 py-2.5 rounded-xl text-sm transition-all border border-blue-500/30 shadow-lg backdrop-blur"><Import size={16} /><span>匯入舊資料 (CSV)</span><input type="file" accept=".csv" onChange={handleImportCSV} className="hidden" /></label>
            </div></div>
            <RecordTable records={records} onDelete={handleDelete} onViewImage={setViewImage} onEdit={setEditingRecord} currentUser={appUser} />
          </div>
        )}
        {activeTab === 'analysis' && (
           <div className="max-w-7xl mx-auto space-y-6">
             <h2 className="text-2xl font-bold text-white mb-6">進階統計分析</h2>
             <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96"><h3 className="mb-4 font-bold">部門案件統計</h3><ResponsiveContainer><BarChart data={chartData.deptData} layout="vertical"><CartesianGrid horizontal vertical={false}/><XAxis type="number"/><YAxis dataKey="name" type="category" width={80}/><Tooltip/><Bar dataKey="value" fill="#6366f1"/></BarChart></ResponsiveContainer></div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96 overflow-y-auto"><h3 className="mb-4 font-bold">類型排行</h3><table className="w-full text-sm text-left"><thead><tr className="bg-gray-50"><th className="p-2">類型</th><th className="p-2">數量</th></tr></thead><tbody>{chartData.typeData.sort((a,b)=>b.value-a.value).map(d=><tr key={d.name} className="border-b"><td className="p-2">{d.name}</td><td className="p-2">{d.value}</td></tr>)}</tbody></table></div>
             </div>
           </div>
        )}
        {activeTab === 'users' && appUser.role === 'admin' && (<UserManagement currentUser={appUser} />)}
      </main>
    </div>
  );
}

// --- Project Management System (R&D Nexus) ---



// --- Components ---

const Modal = ({ isOpen, onClose, title, children, size = 'default' }) => {
  if (!isOpen) return null;
  const sizeClasses = {
    default: 'max-w-lg',
    large: 'max-w-2xl',
    xlarge: 'max-w-4xl'
  };
  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
      <div className={`bg-slate-800/95 backdrop-blur-xl rounded-2xl shadow-2xl w-full ${sizeClasses[size] || sizeClasses.default} max-h-[90vh] overflow-y-auto border border-white/10`}>
        <div className="p-6 border-b border-white/10 flex justify-between items-center sticky top-0 bg-slate-800/95 backdrop-blur-xl z-10 rounded-t-2xl">
          <h2 className="text-xl font-bold text-white">{title}</h2>
          <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-xl transition-colors">
            <X size={20} className="text-slate-400 hover:text-white" />
          </button>
        </div>
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>
  );
};

const TaskForm = ({ onSubmit, initialData, onCancel }) => {
  const [formData, setFormData] = useState(initialData || {
    title: '',
    status: 'To Do',
    owner: '',
    priority: 'P2',
    risk: false,
    startDate: new Date().toISOString().split('T')[0],
    endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-2">任務標題</label>
        <input 
          type="text" 
          required
          className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white placeholder-slate-500"
          value={formData.title}
          onChange={e => setFormData({...formData, title: e.target.value})}
        />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">負責人</label>
          <input 
            type="text" 
            required
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white placeholder-slate-500"
            value={formData.owner}
            onChange={e => setFormData({...formData, owner: e.target.value})}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">狀態</label>
          <select 
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white appearance-none cursor-pointer"
            value={formData.status}
            onChange={e => setFormData({...formData, status: e.target.value})}
          >
            <option value="To Do" className="bg-slate-800">待辦</option>
            <option value="Doing" className="bg-slate-800">進行中</option>
            <option value="Testing" className="bg-slate-800">測試中</option>
            <option value="Done" className="bg-slate-800">完成</option>
          </select>
        </div>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">優先級</label>
          <select 
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white appearance-none cursor-pointer"
            value={formData.priority}
            onChange={e => setFormData({...formData, priority: e.target.value})}
          >
            <option value="P0" className="bg-slate-800">P0 (緊急)</option>
            <option value="P1" className="bg-slate-800">P1 (高)</option>
            <option value="P2" className="bg-slate-800">P2 (中)</option>
            <option value="P3" className="bg-slate-800">P3 (低)</option>
          </select>
        </div>
        <div className="flex items-center pt-8">
          <label className="flex items-center cursor-pointer group">
            <input 
              type="checkbox" 
              className="w-5 h-5 text-rose-500 rounded border-white/20 bg-white/5 focus:ring-rose-500/50 focus:ring-offset-0"
              checked={formData.risk}
              onChange={e => setFormData({...formData, risk: e.target.checked})}
            />
            <span className="ml-3 text-sm text-slate-300 group-hover:text-white transition-colors">⚠️ 標記為高風險</span>
          </label>
        </div>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">開始日期</label>
          <input 
            type="date" 
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white"
            value={formData.startDate}
            onChange={e => setFormData({...formData, startDate: e.target.value})}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">結束日期</label>
          <input 
            type="date" 
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white"
            value={formData.endDate}
            onChange={e => setFormData({...formData, endDate: e.target.value})}
          />
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-6">
        <button type="button" onClick={onCancel} className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl text-sm font-medium transition-all">取消</button>
        <button type="submit" className="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all">儲存任務</button>
      </div>
    </form>
  );
};

const ProjectForm = ({ onSubmit, initialData, onCancel }) => {
  const [formData, setFormData] = useState(initialData || {
    name: '',
    owner: '',
    department: '研發部',
    stage: '規劃',
    progress: 0,
    status: 'normal',
    startDate: new Date().toISOString().split('T')[0],
    deadline: '',
    category: '新產品'
  });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-5">
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-2">專案名稱 *</label>
        <input 
          type="text" 
          name="name"
          required
          className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white placeholder-slate-500"
          value={formData.name}
          onChange={handleChange}
          placeholder="輸入專案名稱"
        />
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">負責人 *</label>
          <input 
            type="text" 
            name="owner"
            required
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white placeholder-slate-500"
            value={formData.owner}
            onChange={handleChange}
            placeholder="輸入負責人姓名"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">部門</label>
          <select 
            name="department"
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white appearance-none cursor-pointer"
            value={formData.department}
            onChange={handleChange}
          >
            <option value="業務部" className="bg-slate-800">業務部</option>
            <option value="研發部" className="bg-slate-800">研發部</option>
            <option value="線材部" className="bg-slate-800">線材部</option>
            <option value="多媒體部" className="bg-slate-800">多媒體部</option>
            <option value="工程中心" className="bg-slate-800">工程中心</option>
            <option value="製造部" className="bg-slate-800">製造部</option>
          </select>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">階段</label>
          <select 
            name="stage"
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white appearance-none cursor-pointer"
            value={formData.stage}
            onChange={handleChange}
          >
            <option value="規劃" className="bg-slate-800">規劃</option>
            <option value="設計" className="bg-slate-800">設計</option>
            <option value="開發" className="bg-slate-800">開發</option>
            <option value="測試" className="bg-slate-800">測試</option>
            <option value="驗證" className="bg-slate-800">驗證</option>
            <option value="量產" className="bg-slate-800">量產</option>
            <option value="結案" className="bg-slate-800">結案</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">進度 (%)</label>
          <input 
            type="number" 
            name="progress"
            min="0"
            max="100"
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white"
            value={formData.progress}
            onChange={handleChange}
            placeholder="0-100"
          />
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">狀態</label>
          <select 
            name="status"
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white appearance-none cursor-pointer"
            value={formData.status}
            onChange={handleChange}
          >
            <option value="normal" className="bg-slate-800">正常 (Normal)</option>
            <option value="risk" className="bg-slate-800">風險 (Risk)</option>
            <option value="delay" className="bg-slate-800">延遲 (Delay)</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">截止日期</label>
          <input 
            type="date" 
            name="deadline"
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white [color-scheme:dark]"
            value={formData.deadline}
            onChange={handleChange}
          />
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">開始日期</label>
          <input 
            type="date" 
            name="startDate"
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white [color-scheme:dark]"
            value={formData.startDate}
            onChange={handleChange}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">類別</label>
          <select 
            name="category"
            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white appearance-none cursor-pointer"
            value={formData.category}
            onChange={handleChange}
          >
            <option value="新產品" className="bg-slate-800">新產品</option>
            <option value="改款" className="bg-slate-800">改款</option>
            <option value="內部案" className="bg-slate-800">內部案</option>
            <option value="客戶案" className="bg-slate-800">客戶案</option>
            <option value="研發案" className="bg-slate-800">研發案</option>
          </select>
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-6 border-t border-white/10">
        <button type="button" onClick={onCancel} className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl text-sm font-medium transition-all">取消</button>
        <button type="submit" className="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all">儲存專案</button>
      </div>
    </form>
  );
};

const ChangeForm = ({ onSubmit, onCancel }) => {
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    type: '設計改善',
    desc: '',
    owner: '',
    impact: 'Low'
  });

  return (
    <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">日期</label>
          <input type="date" required className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">類型</label>
          <select className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white appearance-none cursor-pointer" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}>
            <option className="bg-slate-800">設計改善</option><option className="bg-slate-800">設計疏失</option><option className="bg-slate-800">客戶修改</option><option className="bg-slate-800">料件問題</option>
          </select>
        </div>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-2">變更描述</label>
        <textarea required className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white placeholder-slate-500" rows="3" value={formData.desc} onChange={e => setFormData({...formData, desc: e.target.value})}></textarea>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">發起人</label>
          <input type="text" required className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white placeholder-slate-500" value={formData.owner} onChange={e => setFormData({...formData, owner: e.target.value})} />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">衝擊度</label>
          <select className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white appearance-none cursor-pointer" value={formData.impact} onChange={e => setFormData({...formData, impact: e.target.value})}>
            <option className="bg-slate-800">Low</option><option className="bg-slate-800">Medium</option><option className="bg-slate-800">High</option>
          </select>
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-6">
        <button type="button" onClick={onCancel} className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl text-sm font-medium transition-all">取消</button>
        <button type="submit" className="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all">提交變更</button>
      </div>
    </form>
  );
};

const ProjectStatusBadge = ({ status }) => {
  const styles = {
    normal: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
    risk: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
    delay: 'bg-rose-500/20 text-rose-400 border-rose-500/30',
  };
  
  const labels = {
    normal: '正常',
    risk: '風險',
    delay: '延遲',
  };

  return (
    <span className={`px-2.5 py-1 rounded-lg text-xs font-bold border ${styles[status] || styles.normal}`}>
      {labels[status] || status}
    </span>
  );
};

const PriorityBadge = ({ priority }) => {
  const styles = {
    P0: 'bg-rose-500/20 text-rose-400 border border-rose-500/30',
    P1: 'bg-orange-500/20 text-orange-400 border border-orange-500/30',
    P2: 'bg-blue-500/20 text-blue-400 border border-blue-500/30',
    P3: 'bg-slate-500/20 text-slate-400 border border-slate-500/30',
  };
  return <span className={`px-2 py-0.5 rounded-lg text-xs font-bold ${styles[priority] || styles.P2}`}>{priority}</span>;
};

// --- Views ---

const MachineForm = ({ initialData, onSubmit, onCancel }) => {
  const [formData, setFormData] = useState(initialData || {
    name: '',
    code: '',
    status: 'Active',
    progress: 0,
    image: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&w=300&q=80',
    members: ''
  });
  const [uploadError, setUploadError] = useState('');

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // 檢查文件大小 (10MB = 10 * 1024 * 1024 bytes)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
      setUploadError('圖片大小超過 10MB，請選擇較小的圖片');
      e.target.value = '';
      return;
    }

    // 檢查文件類型
    if (!file.type.startsWith('image/')) {
      setUploadError('請選擇圖片檔案 (JPG, PNG, GIF 等)');
      e.target.value = '';
      return;
    }

    setUploadError('正在處理圖片...');

    // 讀取並壓縮圖片
    const reader = new FileReader();
    reader.onloadend = () => {
      const img = new Image();
      img.onload = () => {
        // 壓縮圖片至最大寬度 1200px
        const maxWidth = 1200;
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        // 轉換為 Base64，調整品質直到符合 Firestore 限制
        let quality = 0.8;
        let base64 = canvas.toDataURL('image/jpeg', quality);
        
        // Firestore 欄位限制約 1MB，我們設定安全值為 800KB
        const maxBase64Size = 800 * 1024;
        
        while (base64.length > maxBase64Size && quality > 0.1) {
          quality -= 0.1;
          base64 = canvas.toDataURL('image/jpeg', quality);
        }

        if (base64.length > maxBase64Size) {
          setUploadError('圖片壓縮後仍超過儲存限制，請選擇更小的圖片或使用圖片網址');
          e.target.value = '';
          return;
        }

        setUploadError('');
        setFormData(prev => ({ ...prev, image: base64 }));
      };
      
      img.onerror = () => {
        setUploadError('圖片載入失敗，請重試');
        e.target.value = '';
      };
      
      img.src = reader.result;
    };
    
    reader.onerror = () => {
      setUploadError('讀取檔案失敗，請重試');
      e.target.value = '';
    };
    
    reader.readAsDataURL(file);
  };

  return (
    <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-5">
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">機台名稱 (Machine Name)</label>
        <input name="name" value={formData.name} onChange={handleChange} required className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all" />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">代碼 (Code)</label>
          <input name="code" value={formData.code} onChange={handleChange} required className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all" />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">狀態 (Status)</label>
          <select name="status" value={formData.status} onChange={handleChange} className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all appearance-none cursor-pointer" style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'right 12px center', backgroundSize: '20px' }}>
            <option value="Active" className="bg-slate-800">Active</option>
            <option value="Warning" className="bg-slate-800">Warning</option>
            <option value="Maintenance" className="bg-slate-800">Maintenance</option>
          </select>
        </div>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">進度 (Progress %)</label>
        <input type="number" name="progress" value={formData.progress} onChange={handleChange} min="0" max="100" className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all" />
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">專案成員 (Members)</label>
        <input name="members" value={formData.members} onChange={handleChange} className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all" placeholder="請輸入成員名稱，多人請用逗號分隔" />
        <p className="text-xs text-slate-500 mt-1.5">例如：張三, 李四, 王五</p>
      </div>
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">專案圖片</label>
        <div className="space-y-3">
          <label className="block w-full cursor-pointer">
            <div className="bg-white/5 border border-white/10 hover:border-white/20 rounded-xl px-4 py-3 text-sm text-slate-300 flex items-center gap-3 transition-all">
              <div className="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-lg shadow-blue-500/25">
                <Upload size={16} />
                選擇圖片
              </div>
              <span className="text-slate-500">或拖曳圖片至此</span>
            </div>
            <input 
              type="file" 
              accept="image/*" 
              onChange={handleImageUpload}
              className="hidden"
            />
          </label>
          <p className="text-xs text-slate-500">支援 JPG, PNG, GIF 等圖片格式，檔案大小限制 10MB (系統會自動壓縮至適合儲存的大小)</p>
          {uploadError && (
            <div className={`text-xs px-4 py-3 rounded-xl border flex items-center gap-2 ${
              uploadError.includes('處理中') || uploadError.includes('正在') 
                ? 'text-blue-400 bg-blue-500/10 border-blue-500/30' 
                : 'text-rose-400 bg-rose-500/10 border-rose-500/30'
            }`}>
              {uploadError.includes('處理中') || uploadError.includes('正在') ? '⏳' : '⚠️'} {uploadError}
            </div>
          )}
          <div className="text-xs text-slate-400">或輸入圖片網址:</div>
          <input 
            name="image" 
            value={formData.image} 
            onChange={handleChange} 
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all text-sm" 
            placeholder="https://..." 
          />
        </div>
        {formData.image && (
            <div className="mt-3 h-40 w-full bg-white/5 rounded-xl overflow-hidden border border-white/10">
                <img 
                  src={formData.image} 
                  alt="Preview" 
                  className="w-full h-full object-cover" 
                  onError={(e) => {
                    // 使用 Unsplash 的可靠備用圖片
                    e.target.src = 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&w=300&q=80';
                    e.target.onerror = null; // 防止無限循環
                  }} 
                />
            </div>
        )}
      </div>
      <div className="flex justify-end gap-3 pt-4 border-t border-white/10">
        <button type="button" onClick={onCancel} className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl transition-all">取消</button>
        <button type="submit" className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg hover:shadow-blue-500/25 transition-all font-medium">儲存</button>
      </div>
    </form>
  );
};

// 個人戰情室組件 - 優化版本（分批載入）
const PersonalDashboard = ({ onBack, machines, onSelectMachine }) => {
  const [showAllTasks, setShowAllTasks] = React.useState(false);
  const [allProjects, setAllProjects] = React.useState([]);
  const [allTasks, setAllTasks] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [loadingStage, setLoadingStage] = React.useState('準備中...');
  const [progressPercent, setProgressPercent] = React.useState(0);
  const [projectProposals, setProjectProposals] = React.useState([]); // 專案企畫書
  const [showProposalModal, setShowProposalModal] = React.useState(false);
  const [selectedProjectForProposal, setSelectedProjectForProposal] = React.useState(null);
  const [proposalVersionHistory, setProposalVersionHistory] = React.useState([]);
  const [showVersionHistory, setShowVersionHistory] = React.useState(false);
  const [uploadProgress, setUploadProgress] = React.useState(0);
  const [isUploading, setIsUploading] = React.useState(false);
  const [selectedFile, setSelectedFile] = React.useState(null);
  
  // 安全地解析 currentUser - 從 sessionStorage 獲取
  let currentUser = { username: '未知使用者', displayName: '未知使用者' };
  try {
    const userStr = sessionStorage.getItem('tqm_user');
    if (userStr) {
      const parsed = JSON.parse(userStr);
      currentUser = {
        username: parsed.username || parsed.displayName || '未知使用者',
        displayName: parsed.displayName || parsed.username || '未知使用者',
        ...parsed
      };
    }
  } catch (e) {
    console.error('解析 currentUser 失敗:', e);
  }

  // 點擊甘特圖項目跳轉到專案/任務看板
  const handleItemClick = async (item) => {
    if (item.type === '專案') {
      // 找到專案對應的機台
      const project = allProjects.find(p => p.id === item.id.replace('project-', ''));
      if (project && project.machineId) {
        const machine = machines.find(m => m.id === project.machineId);
        if (machine) {
          // 設定要自動打開的專案
          sessionStorage.setItem('openProjectId', project.id);
          console.log('🎯 直接選擇機台並打開專案:', { 
            machineId: machine.id, 
            machineName: machine.name,
            projectId: project.id, 
            projectName: project.name 
          });
          // 直接選擇機台（會觸發 ProjectApp 渲染，然後 ProjectApp 會檢查 sessionStorage 並自動打開專案）
          if (onSelectMachine) {
            onSelectMachine(machine);
          }
        } else {
          alert('找不到對應的機台');
        }
      } else {
        alert('找不到對應的專案資料');
      }
    } else if (item.type === '任務') {
      // 找到任務對應的專案
      const task = allTasks.find(t => t.id === item.id.replace('task-', ''));
      if (task && task.projectId) {
        const project = allProjects.find(p => p.id === task.projectId);
        if (project && project.machineId) {
          const machine = machines.find(m => m.id === project.machineId);
          if (machine) {
            // 設定要自動打開的專案
            sessionStorage.setItem('openProjectId', project.id);
            console.log('🎯 直接選擇機台並打開專案 (從任務):', { 
              machineId: machine.id, 
              machineName: machine.name,
              projectId: project.id, 
              projectName: project.name,
              taskId: task.id,
              taskName: task.name
            });
            // 直接選擇機台（會觸發 ProjectApp 渲染，然後 ProjectApp 會檢查 sessionStorage 並自動打開專案）
            if (onSelectMachine) {
              onSelectMachine(machine);
            }
          } else {
            alert('找不到對應的機台');
          }
        } else {
          // 專案不存在或沒有 machineId，這是孤兒任務
          const deleteOrphan = confirm(`此任務「${task.title || task.name || '未命名'}」的專案已被刪除。\n\n是否要刪除這個孤兒任務？`);
          if (deleteOrphan) {
            try {
              await db.deleteDoc('rd_tasks', task.id);
              alert('已刪除孤兒任務');
              // 更新任務列表
              const tasks = await db.getDocs('rd_tasks');
              setAllTasks(tasks || []);
            } catch (e) {
              alert('刪除失敗: ' + e.message);
            }
          }
        }
      } else {
        alert('找不到對應的任務資料');
      }
    }
  };

  // 分批載入數據 - 優化版本
  React.useEffect(() => {
    const fetchDataInBatches = async () => {
      try {
        setLoading(true);
        setLoadingStage('正在載入專案資料...');
        setProgressPercent(10);
        
        // 先載入專案數據
        const projectsPromise = db.getDocs('rd_projects');
        
        setProgressPercent(30);
        const projects = await projectsPromise;
        setAllProjects(projects || []);
        
        setLoadingStage('正在載入任務資料...');
        setProgressPercent(50);
        
        // 再載入任務數據
        const tasksPromise = db.getDocs('rd_tasks');
        
        setProgressPercent(70);
        const tasks = await tasksPromise;
        setAllTasks(tasks || []);
        
        // 載入企畫書數據
        const proposals = await db.getDocs('rd_project_proposals');
        setProjectProposals(proposals || []);
        
        setProgressPercent(90);
        setLoadingStage('資料處理中...');
        
        // 給一點時間讓 React 渲染
        await new Promise(resolve => setTimeout(resolve, 100));
        
        setProgressPercent(100);
        setLoadingStage('完成！');
        
      } catch (e) {
        console.error('獲取數據失敗:', e);
        setLoadingStage('載入失敗');
      } finally {
        setTimeout(() => {
          setLoading(false);
        }, 200);
      }
    };
    
    fetchDataInBatches();
  }, []);
  
  // 過濾與當前用戶相關的專案和任務
  const userProjects = showAllTasks ? allProjects : allProjects.filter(project => 
    project.members?.includes(currentUser.username) || 
    project.members?.includes(currentUser.displayName) ||
    project.owner === currentUser.username ||
    project.owner === currentUser.displayName ||
    project.createdBy === currentUser.username ||
    project.createdBy === currentUser.displayName
  );
  
  const userTasks = showAllTasks ? allTasks : allTasks.filter(task => 
    task.assignee === currentUser.username || 
    task.assignee === currentUser.displayName ||
    task.owner === currentUser.username ||
    task.owner === currentUser.displayName ||
    task.assignedTo === currentUser.username ||
    task.assignedTo === currentUser.displayName ||
    task.responsiblePerson === currentUser.username ||
    task.responsiblePerson === currentUser.displayName
  );
  
  // 找出孤兒任務（projectId 對應的專案不存在）
  const projectIds = allProjects.map(p => p.id);
  const orphanTasks = allTasks.filter(task => task.projectId && !projectIds.includes(task.projectId));
  
  // 過濾掉孤兒任務，只顯示有效的任務
  const validUserTasks = userTasks.filter(task => {
    // 如果任務沒有 projectId，保留它
    if (!task.projectId) return true;
    // 如果任務的 projectId 存在於專案列表中，保留它
    return projectIds.includes(task.projectId);
  });
  
  // 清理孤兒任務的函數
  const handleCleanOrphanTasks = async () => {
    if (orphanTasks.length === 0) {
      alert('沒有需要清理的孤兒任務');
      return;
    }
    
    const confirmMsg = `發現 ${orphanTasks.length} 個孤兒任務（專案已被刪除）：\n\n` +
      orphanTasks.slice(0, 5).map(t => `• ${t.title || t.name || '未命名'}`).join('\n') +
      (orphanTasks.length > 5 ? `\n... 還有 ${orphanTasks.length - 5} 個` : '') +
      `\n\n確定要刪除這些任務嗎？`;
    
    if (confirm(confirmMsg)) {
      try {
        for (const task of orphanTasks) {
          await db.deleteDoc('rd_tasks', task.id);
        }
        alert(`已成功刪除 ${orphanTasks.length} 個孤兒任務`);
        // 重新載入任務
        const tasks = await db.getDocs('rd_tasks');
        setAllTasks(tasks || []);
      } catch (e) {
        console.error('刪除孤兒任務失敗:', e);
        alert('刪除失敗: ' + e.message);
      }
    }
  };
  
  // 調試信息
  console.log('👤 當前使用者:', currentUser);
  console.log('📁 所有專案數:', allProjects.length);
  console.log('📋 所有任務數:', allTasks.length);
  console.log('✅ 使用者專案:', userProjects);
  console.log('✅ 使用者任務:', userTasks);
  console.log('⚠️ 孤兒任務數:', orphanTasks.length);
  console.log('✅ 有效任務數:', validUserTasks.length);
  if (allTasks.length > 0) {
    console.log('📝 任務樣本:', allTasks[0]);
  }
  
  // 合併專案和任務，轉換為甘特圖所需的格式（使用過濾後的有效任務）
  const ganttItems = [
    ...userProjects.map(project => ({
      id: `project-${project.id}`,
      name: project.name || project.title,
      type: '專案',
      startDate: project.startDate || project.createdAt || new Date().toISOString(),
      endDate: project.endDate || project.deadline || new Date(Date.now() + 7*24*60*60*1000).toISOString(),
      progress: project.progress || 0,
      status: project.status || 'active',
      machine: machines.find(m => m.id === project.machineId)?.name || project.machineName || '未指定',
      color: 'blue'
    })),
    ...validUserTasks.map(task => ({
      id: `task-${task.id}`,
      name: task.title || task.name || '未命名任務',
      type: '任務',
      startDate: task.startDate || task.createdAt || task.createTime || new Date().toISOString(),
      endDate: task.endDate || task.deadline || task.dueDate || new Date(Date.now() + 7*24*60*60*1000).toISOString(),
      progress: task.status === 'completed' || task.status === 'Done' ? 100 : 
                task.status === 'in-progress' || task.status === 'Doing' ? 50 : 0,
      status: task.status,
      machine: task.machine || task.machineName || task.projectName || '未指定',
      color: 'green'
    }))
  ].filter(item => item.name && item.startDate && item.endDate)
   .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
  
  console.log('📊 甘特圖項目數:', ganttItems.length);
  console.log('📊 甘特圖項目:', ganttItems);
  
  // 計算日期範圍
  const getDateRange = () => {
    if (ganttItems.length === 0) return [];
    
    const today = new Date();
    const startDate = new Date(Math.min(
      ...ganttItems.map(item => new Date(item.startDate).getTime()),
      today.getTime()
    ));
    const endDate = new Date(Math.max(
      ...ganttItems.map(item => new Date(item.endDate).getTime()),
      today.getTime()
    ));
    
    // 擴展範圍以顯示更多天數
    startDate.setDate(startDate.getDate() - 7);
    endDate.setDate(endDate.getDate() + 14);
    
    const dates = [];
    const current = new Date(startDate);
    while (current <= endDate) {
      dates.push(new Date(current));
      current.setDate(current.getDate() + 1);
    }
    return dates;
  };
  
  const dateRange = getDateRange();
  const totalDays = dateRange.length;
  
  // 計算項目在時間軸上的位置
  const getItemPosition = (item) => {
    const start = new Date(item.startDate);
    const end = new Date(item.endDate);
    const rangeStart = dateRange[0];
    
    const startOffset = Math.floor((start - rangeStart) / (1000 * 60 * 60 * 24));
    const duration = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
    
    return {
      left: `${(startOffset / totalDays) * 100}%`,
      width: `${(duration / totalDays) * 100}%`
    };
  };

  // 載入動畫組件
  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8 flex items-center justify-center">
        <div className="max-w-md w-full">
          <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-8">
            {/* 標題 */}
            <div className="text-center mb-6">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl mb-4 shadow-lg shadow-blue-500/25">
                <GanttChartIcon size={32} className="text-white animate-pulse" />
              </div>
              <h2 className="text-2xl font-bold text-white mb-2">載入個人戰情室</h2>
              <p className="text-slate-400 text-sm">{loadingStage}</p>
            </div>

            {/* 進度條 */}
            <div className="mb-6">
              <div className="flex justify-between text-xs text-slate-400 mb-2">
                <span>載入進度</span>
                <span className="font-semibold text-cyan-400">{progressPercent}%</span>
              </div>
              <div className="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full transition-all duration-500 ease-out"
                  style={{ width: `${progressPercent}%` }}
                >
                  <div className="h-full w-full bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse"></div>
                </div>
              </div>
            </div>

            {/* 載入步驟指示 */}
            <div className="space-y-3">
              <div className={`flex items-center gap-3 p-3 rounded-xl transition-all ${
                progressPercent >= 10 ? 'bg-blue-500/10 text-blue-400 border border-blue-500/30' : 'bg-white/5 text-slate-500 border border-white/5'
              }`}>
                <div className={`w-6 h-6 rounded-full flex items-center justify-center ${
                  progressPercent >= 30 ? 'bg-blue-500 text-white' : progressPercent >= 10 ? 'bg-blue-500/30 text-blue-400' : 'bg-white/10 text-slate-600'
                }`}>
                  {progressPercent >= 30 ? '✓' : '1'}
                </div>
                <span className="text-sm font-medium">載入專案資料</span>
              </div>
              
              <div className={`flex items-center gap-3 p-3 rounded-xl transition-all ${
                progressPercent >= 50 ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/30' : 'bg-white/5 text-slate-500 border border-white/5'
              }`}>
                <div className={`w-6 h-6 rounded-full flex items-center justify-center ${
                  progressPercent >= 70 ? 'bg-emerald-500 text-white' : progressPercent >= 50 ? 'bg-emerald-500/30 text-emerald-400' : 'bg-white/10 text-slate-600'
                }`}>
                  {progressPercent >= 70 ? '✓' : '2'}
                </div>
                <span className="text-sm font-medium">載入任務資料</span>
              </div>
              
              <div className={`flex items-center gap-3 p-3 rounded-xl transition-all ${
                progressPercent >= 90 ? 'bg-violet-500/10 text-violet-400 border border-violet-500/30' : 'bg-white/5 text-slate-500 border border-white/5'
              }`}>
                <div className={`w-6 h-6 rounded-full flex items-center justify-center ${
                  progressPercent >= 100 ? 'bg-violet-500 text-white' : progressPercent >= 90 ? 'bg-violet-500/30 text-violet-400' : 'bg-white/10 text-slate-600'
                }`}>
                  {progressPercent >= 100 ? '✓' : '3'}
                </div>
                <span className="text-sm font-medium">資料處理與渲染</span>
              </div>
            </div>

            {/* 載入提示 */}
            <div className="mt-6 text-center">
              <p className="text-xs text-slate-500">
                💡 首次載入可能需要幾秒鐘，請稍候...
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8 animate-fade-in">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-2xl font-bold text-white flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-blue-500/25">
                <GanttChartIcon size={22} className="text-white" />
              </div>
              個人戰情室
            </h1>
            <p className="text-slate-400 mt-2 ml-13">
              使用者：{currentUser.displayName} ({currentUser.username}) | 所有相關專案與任務總覽
            </p>
          </div>
          <div className="flex items-center gap-3">
            <label className="flex items-center gap-2 bg-white/5 backdrop-blur-xl px-4 py-2.5 rounded-xl border border-white/10 cursor-pointer hover:bg-white/10 transition-all">
              <input 
                type="checkbox" 
                checked={showAllTasks}
                onChange={(e) => setShowAllTasks(e.target.checked)}
                className="w-4 h-4 text-blue-500 rounded focus:ring-2 focus:ring-blue-500/50 bg-white/5 border-white/20"
              />
              <span className="text-sm text-slate-300">顯示所有任務</span>
            </label>
            <button 
              onClick={onBack} 
              className="flex items-center gap-2 bg-gradient-to-r from-rose-500 to-pink-500 hover:shadow-lg hover:shadow-rose-500/25 text-white px-5 py-2.5 rounded-xl text-sm transition-all font-medium"
            >
              <LogOut size={16} /> 返回
            </button>
          </div>
        </div>

        {/* 統計卡片 - 深色主題版本 */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div className="relative overflow-hidden bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-blue-500/30 transition-all duration-300 hover:bg-white/10 group">
            <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-full -mr-12 -mt-12 group-hover:scale-150 transition-transform duration-500"></div>
            <div className="relative z-10">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-slate-400 text-sm font-medium mb-1">總專案數</p>
                  <p className="text-4xl font-bold text-white mt-2">{userProjects.length}</p>
                  <p className="text-blue-400 text-xs mt-2">進行中的專案</p>
                </div>
                <div className="bg-gradient-to-br from-blue-500 to-cyan-500 p-3 rounded-xl shadow-lg shadow-blue-500/25">
                  <Briefcase className="text-white" size={28} />
                </div>
              </div>
            </div>
          </div>
          
          <div className="relative overflow-hidden bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-emerald-500/30 transition-all duration-300 hover:bg-white/10 group">
            <div className="absolute top-0 right-0 w-24 h-24 bg-emerald-500/10 rounded-full -mr-12 -mt-12 group-hover:scale-150 transition-transform duration-500"></div>
            <div className="relative z-10">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-slate-400 text-sm font-medium mb-1">總任務數</p>
                  <p className="text-4xl font-bold text-white mt-2">{userTasks.length}</p>
                  <p className="text-emerald-400 text-xs mt-2">待完成的任務</p>
                </div>
                <div className="bg-gradient-to-br from-emerald-500 to-green-500 p-3 rounded-xl shadow-lg shadow-emerald-500/25">
                  <ListTodo className="text-white" size={28} />
                </div>
              </div>
            </div>
          </div>
          
          <div className="relative overflow-hidden bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-amber-500/30 transition-all duration-300 hover:bg-white/10 group">
            <div className="absolute top-0 right-0 w-24 h-24 bg-amber-500/10 rounded-full -mr-12 -mt-12 group-hover:scale-150 transition-transform duration-500"></div>
            <div className="relative z-10">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-slate-400 text-sm font-medium mb-1">進行中</p>
                  <p className="text-4xl font-bold text-white mt-2">
                    {ganttItems.filter(item => item.status === 'in-progress' || item.status === 'active').length}
                  </p>
                  <p className="text-amber-400 text-xs mt-2">正在執行中</p>
                </div>
                <div className="bg-gradient-to-br from-amber-500 to-orange-500 p-3 rounded-xl shadow-lg shadow-amber-500/25">
                  <Activity className="text-white" size={28} />
                </div>
              </div>
            </div>
          </div>
          
          <div className="relative overflow-hidden bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-violet-500/30 transition-all duration-300 hover:bg-white/10 group">
            <div className="absolute top-0 right-0 w-24 h-24 bg-violet-500/10 rounded-full -mr-12 -mt-12 group-hover:scale-150 transition-transform duration-500"></div>
            <div className="relative z-10">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-slate-400 text-sm font-medium mb-1">已完成</p>
                  <p className="text-4xl font-bold text-white mt-2">
                    {ganttItems.filter(item => item.status === 'completed').length}
                  </p>
                  <p className="text-violet-400 text-xs mt-2">成功完成</p>
                </div>
                <div className="bg-gradient-to-br from-violet-500 to-purple-500 p-3 rounded-xl shadow-lg shadow-violet-500/25">
                  <CheckCircle className="text-white" size={28} />
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* 專案企畫書管理區塊 */}
        <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden mb-8">
          <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-6 border-b border-white/10">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="bg-white/20 p-2.5 rounded-xl shadow-lg">
                  <FileText size={24} className="text-white" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white">專案企畫書管理</h2>
                  <p className="text-white/80 text-sm mt-1">📋 上傳、查看和管理專案企畫書及版本記錄</p>
                </div>
              </div>
              <button
                onClick={() => {
                  setSelectedProjectForProposal(null);
                  setShowProposalModal(true);
                }}
                className="flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-5 py-2.5 rounded-xl text-sm transition-all font-medium shadow-lg"
              >
                <Plus size={18} />
                上傳企畫書
              </button>
            </div>
          </div>
          
          <div className="p-6">
            {projectProposals.length === 0 ? (
              <div className="text-center py-12">
                <div className="w-20 h-20 rounded-2xl bg-white/5 flex items-center justify-center mx-auto mb-4">
                  <FileText size={40} className="text-slate-500" />
                </div>
                <p className="text-slate-400 mb-2">目前沒有專案企畫書</p>
                <p className="text-slate-500 text-sm">點擊上方按鈕上傳第一份企畫書</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {projectProposals.map((proposal) => {
                  const project = allProjects.find(p => p.id === proposal.projectId);
                  const isLatest = !projectProposals.some(p => 
                    p.projectId === proposal.projectId && 
                    new Date(p.uploadedAt) > new Date(proposal.uploadedAt)
                  );
                  
                  return (
                    <div
                      key={proposal.id}
                      className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl p-5 hover:border-purple-500/50 hover:bg-white/10 transition-all group"
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <FileText size={18} className="text-purple-400" />
                            <h3 className="text-white font-bold text-sm truncate">
                              {project?.name || '未知專案'}
                            </h3>
                          </div>
                          {isLatest && (
                            <span className="inline-block px-2 py-0.5 bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-xs rounded-full">
                              最新版本
                            </span>
                          )}
                        </div>
                      </div>
                      
                      <div className="space-y-2 mb-4 text-sm">
                        <div className="flex items-center gap-2 text-slate-400">
                          <span className="text-xs">版本：</span>
                          <span className="text-white font-medium">{proposal.version}</span>
                        </div>
                        <div className="flex items-center gap-2 text-slate-400">
                          <span className="text-xs">上傳者：</span>
                          <span className="text-white">{proposal.uploadedBy}</span>
                        </div>
                        <div className="flex items-center gap-2 text-slate-400">
                          <span className="text-xs">日期：</span>
                          <span className="text-white">{new Date(proposal.uploadedAt).toLocaleDateString('zh-TW')}</span>
                        </div>
                        {proposal.notes && (
                          <div className="mt-2 p-2 bg-white/5 rounded border border-white/10">
                            <p className="text-xs text-slate-300">{proposal.notes}</p>
                          </div>
                        )}
                      </div>
                      
                      <div className="flex gap-2">
                        <a
                          href={proposal.fileUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-3 py-2 rounded-lg text-xs font-medium transition-all shadow-lg shadow-blue-500/25"
                        >
                          <Eye size={14} />
                          查看文件
                        </a>
                        <button
                          onClick={() => {
                            const history = projectProposals
                              .filter(p => p.projectId === proposal.projectId)
                              .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
                            setProposalVersionHistory(history);
                            setShowVersionHistory(true);
                          }}
                          className="flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20 text-slate-300 px-3 py-2 rounded-lg text-xs font-medium transition-all border border-white/10"
                          title="查看版本歷史"
                        >
                          <Clock size={14} />
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>

        {/* 甘特圖 - 深色主題版本 */}
        <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden">
          <div className="bg-white/5 p-6 border-b border-white/10">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="bg-gradient-to-br from-blue-500 to-cyan-500 p-2.5 rounded-xl shadow-lg shadow-blue-500/25">
                  <GanttChartIcon size={24} className="text-white" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white">專案與任務甘特圖</h2>
                  <p className="text-slate-400 text-sm mt-1">📊 時間軸視圖顯示所有相關項目的進度與時程安排</p>
                </div>
              </div>
              {/* 孤兒任務清理按鈕 */}
              {orphanTasks.length > 0 && (
                <button
                  onClick={handleCleanOrphanTasks}
                  className="flex items-center gap-2 px-4 py-2.5 bg-rose-500/10 border border-rose-500/30 hover:bg-rose-500/20 text-rose-400 rounded-xl transition-all text-sm font-medium"
                  title={`發現 ${orphanTasks.length} 個孤兒任務（專案已被刪除）`}
                >
                  <Trash2 size={16} />
                  清理孤兒任務 ({orphanTasks.length})
                </button>
              )}
            </div>
          </div>
          
          {ganttItems.length === 0 ? (
            <div className="p-12 text-center">
              <div className="w-20 h-20 rounded-2xl bg-white/5 flex items-center justify-center mx-auto mb-4">
                <GanttChartIcon size={40} className="text-slate-500" />
              </div>
              <p className="text-slate-400 mb-2">目前沒有相關的專案或任務</p>
              <p className="text-slate-500 text-sm">
                使用者：{currentUser.displayName} ({currentUser.username}) | 
                專案總數：{allProjects.length} | 
                任務總數：{allTasks.length}
              </p>
              {allTasks.length > 0 && !showAllTasks && (
                <div className="mt-4">
                  <p className="text-xs text-slate-500 mb-3">
                    💡 系統找到 {allTasks.length} 個任務，但沒有分配給您。
                  </p>
                  <button
                    onClick={() => setShowAllTasks(true)}
                    className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 hover:shadow-lg hover:shadow-blue-500/25 text-white text-sm rounded-xl transition-all font-medium"
                  >
                    顯示所有任務
                  </button>
                </div>
              )}
            </div>
          ) : (
            <div className="p-6 overflow-x-auto">
              {/* 時間軸標題 - 深色主題版本 */}
              <div className="flex mb-6">
                <div className="w-64 flex-shrink-0 pr-4">
                  <div className="text-xs font-semibold text-slate-400 uppercase tracking-wide">項目名稱</div>
                </div>
                <div className="flex-1 relative h-20 bg-white/5 rounded-t-xl border-b-2 border-white/10">
                  {dateRange.map((date, index) => {
                    if (index % 7 === 0 || index === dateRange.length - 1) {
                      const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                      return (
                        <div 
                          key={index} 
                          className="absolute top-0 text-xs"
                          style={{ left: `${(index / totalDays) * 100}%` }}
                        >
                          <div className="transform -translate-x-1/2">
                            <div className={`font-bold text-sm mb-1 ${
                              isWeekend ? 'text-rose-400' : 'text-white'
                            }`}>
                              {date.getMonth() + 1}/{date.getDate()}
                            </div>
                            <div className={`text-xs px-2 py-0.5 rounded ${
                              isWeekend ? 'bg-rose-500/20 text-rose-400' : 'bg-white/10 text-slate-400'
                            }`}>
                              {['日', '一', '二', '三', '四', '五', '六'][date.getDay()]}
                            </div>
                          </div>
                        </div>
                      );
                    }
                    return null;
                  })}
                </div>
              </div>

              {/* 今天標記線 */}
              <div className="relative">
                <div className="flex">
                  <div className="w-64 flex-shrink-0"></div>
                  <div className="flex-1 relative">
                    {(() => {
                      const today = new Date();
                      today.setHours(0, 0, 0, 0);
                      const rangeStart = dateRange[0];
                      const todayOffset = Math.floor((today - rangeStart) / (1000 * 60 * 60 * 24));
                      if (todayOffset >= 0 && todayOffset < totalDays) {
                        return (
                          <div 
                            className="absolute top-0 bottom-0 w-0.5 bg-rose-500 z-10"
                            style={{ left: `${(todayOffset / totalDays) * 100}%` }}
                          >
                            <div className="absolute -top-5 left-1/2 transform -translate-x-1/2 text-xs text-rose-400 font-semibold whitespace-nowrap">
                              今天
                            </div>
                          </div>
                        );
                      }
                      return null;
                    })()}
                  </div>
                </div>

                {/* 甘特圖項目 - 深色主題版本 */}
                {ganttItems.map((item, index) => {
                  const position = getItemPosition(item);
                  const statusColors = {
                    'completed': 'from-emerald-400 to-emerald-600',
                    'in-progress': 'from-blue-400 to-cyan-500',
                    'active': 'from-blue-400 to-cyan-500',
                    'pending': 'from-slate-400 to-slate-600',
                    'todo': 'from-slate-400 to-slate-600',
                    'Doing': 'from-blue-400 to-cyan-500',
                    'Done': 'from-emerald-400 to-emerald-600',
                    'To Do': 'from-slate-400 to-slate-600'
                  };
                  const isEven = index % 2 === 0;
                  
                  return (
                    <div 
                      key={item.id} 
                      className={`flex items-center mb-2 group ${
                        isEven ? 'bg-white/[0.02]' : ''
                      } p-3 rounded-xl hover:bg-white/5 transition-colors duration-200 cursor-pointer`}
                      onClick={() => handleItemClick(item)}
                    >
                      <div className="w-64 flex-shrink-0 pr-4">
                        <div className="text-sm font-semibold text-white truncate group-hover:text-cyan-400 transition-colors flex items-center gap-2">
                          {item.name}
                          <span className="text-xs text-cyan-400 opacity-0 group-hover:opacity-100 transition-opacity">
                            點擊查看 →
                          </span>
                        </div>
                        <div className="flex items-center gap-2 mt-1.5">
                          <span className={`text-xs px-2.5 py-1 rounded-full font-medium ${
                            item.type === '專案' 
                              ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' 
                              : 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
                          }`}>
                            {item.type === '專案' ? '📁' : '✓'} {item.type}
                          </span>
                          <span className="text-xs text-slate-500 bg-white/5 px-2 py-1 rounded-full">
                            🏢 {item.machine}
                          </span>
                        </div>
                      </div>
                      <div className="flex-1 relative h-12">
                        {/* 背景網格線 */}
                        <div className="absolute inset-0 flex">
                          {[...Array(10)].map((_, i) => (
                            <div key={i} className="flex-1 border-r border-white/5"></div>
                          ))}
                        </div>
                        
                        {/* 進度條 */}
                        <div 
                          className={`absolute top-1/2 transform -translate-y-1/2 h-9 rounded-lg bg-gradient-to-r ${
                            statusColors[item.status] || 'from-slate-400 to-slate-600'
                          } shadow-lg group-hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden group-hover:scale-105`}
                          style={position}
                          title={`點擊查看詳情\n${item.name}\n開始: ${new Date(item.startDate).toLocaleDateString()}\n結束: ${new Date(item.endDate).toLocaleDateString()}\n進度: ${item.progress}%`}
                        >
                          {/* 光澤效果 */}
                          <div className="absolute inset-0 bg-gradient-to-t from-transparent via-white/20 to-transparent"></div>
                          
                          {/* 進度條內部填充 */}
                          <div 
                            className="absolute inset-0 bg-white/30 transition-all duration-500"
                            style={{ width: `${item.progress}%` }}
                          ></div>
                          
                          {/* 文字標籤 */}
                          <div className="absolute inset-0 flex items-center justify-center">
                            <span className="text-xs text-white font-bold px-3 truncate drop-shadow-md">
                              {item.progress}%
                            </span>
                          </div>
                          
                          {/* 懸停時顯示詳細信息 */}
                          <div className="absolute -top-20 left-1/2 transform -translate-x-1/2 bg-slate-900/95 backdrop-blur-xl text-white text-xs p-3 rounded-xl shadow-xl border border-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-20 pointer-events-none">
                            <div className="font-semibold mb-1 text-cyan-400">👆 點擊查看詳情</div>
                            <div className="font-semibold mb-1">{item.name}</div>
                            <div>📅 {new Date(item.startDate).toLocaleDateString()} - {new Date(item.endDate).toLocaleDateString()}</div>
                            <div>📊 進度: {item.progress}%</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>

        {/* 圖例 - 深色主題版本 */}
        <div className="mt-8 bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
          <div className="flex items-center gap-8 flex-wrap">
            <div className="flex items-center gap-2">
              <div className="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div>
              <span className="text-sm font-bold text-white">狀態圖例</span>
            </div>
            <div className="h-6 w-px bg-white/20"></div>
            <div className="flex items-center gap-3 bg-white/5 px-3 py-2 rounded-xl border border-white/10 hover:border-white/20 transition-all">
              <div className="w-6 h-6 bg-gradient-to-r from-blue-400 to-cyan-500 rounded-lg shadow-lg shadow-blue-500/25"></div>
              <span className="text-sm font-medium text-slate-300">進行中</span>
            </div>
            <div className="flex items-center gap-3 bg-white/5 px-3 py-2 rounded-xl border border-white/10 hover:border-white/20 transition-all">
              <div className="w-6 h-6 bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-lg shadow-lg shadow-emerald-500/25"></div>
              <span className="text-sm font-medium text-slate-300">已完成</span>
            </div>
            <div className="flex items-center gap-3 bg-white/5 px-3 py-2 rounded-xl border border-white/10 hover:border-white/20 transition-all">
              <div className="w-6 h-6 bg-gradient-to-r from-slate-400 to-slate-600 rounded-lg"></div>
              <span className="text-sm font-medium text-slate-300">待處理</span>
            </div>
            <div className="h-6 w-px bg-white/20"></div>
            <div className="flex items-center gap-3 bg-white/5 px-3 py-2 rounded-xl border border-white/10">
              <div className="w-1 h-6 bg-rose-500 rounded-full shadow-lg shadow-rose-500/25"></div>
              <span className="text-sm font-medium text-rose-400">📍 今天</span>
            </div>
          </div>
        </div>

        {/* 上傳企畫書 Modal */}
        {showProposalModal && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-slate-800 rounded-2xl border border-white/10 shadow-2xl max-w-lg w-full animate-fade-in">
              <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-6 rounded-t-2xl">
                <h3 className="text-xl font-bold text-white flex items-center gap-2">
                  <Upload size={24} />
                  上傳專案企畫書
                </h3>
              </div>
              
              <form onSubmit={async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                try {
                  setIsUploading(true);
                  setUploadProgress(0);
                  
                  let fileUrl = formData.get('fileUrl');
                  let fileName = '';
                  let fileSize = 0;
                  
                  // 如果有選擇檔案，先上傳檔案
                  if (selectedFile) {
                    const uploadResult = await db.uploadFile(
                      selectedFile,
                      'project_proposals',
                      (progress) => setUploadProgress(progress)
                    );
                    fileUrl = uploadResult.url;
                    fileName = uploadResult.fileName;
                    fileSize = uploadResult.fileSize;
                  } else if (!fileUrl) {
                    throw new Error('請選擇檔案或輸入文件連結');
                  }
                  
                  const proposalData = {
                    id: `proposal_${Date.now()}`,
                    projectId: formData.get('projectId'),
                    version: formData.get('version'),
                    fileUrl: fileUrl,
                    fileName: fileName || '外部連結',
                    fileSize: fileSize,
                    notes: formData.get('notes'),
                    uploadedBy: currentUser.displayName,
                    uploadedAt: new Date().toISOString()
                  };
                  
                  await db.addDoc('rd_project_proposals', proposalData);
                  const updatedProposals = await db.getDocs('rd_project_proposals');
                  setProjectProposals(updatedProposals || []);
                  setShowProposalModal(false);
                  setSelectedFile(null);
                  setUploadProgress(0);
                  alert('✅ 企畫書上傳成功！');
                } catch (error) {
                  console.error('上傳失敗:', error);
                  alert('❌ 上傳失敗：' + error.message);
                } finally {
                  setIsUploading(false);
                }
              }} className="p-6 space-y-4">
                <div>
                  <label className="block text-slate-300 text-sm font-medium mb-2">
                    選擇專案 *
                  </label>
                  <select
                    name="projectId"
                    required
                    className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white outline-none focus:border-purple-500/50 transition-all"
                  >
                    <option value="" className="bg-slate-800">請選擇專案</option>
                    {userProjects.map(project => {
                      const machine = machines.find(m => m.id === project.machineId);
                      return (
                        <option key={project.id} value={project.id} className="bg-slate-800">
                          {machine ? `${machine.name} - ${project.name}` : project.name}
                        </option>
                      );
                    })}
                  </select>
                </div>
                
                <div>
                  <label className="block text-slate-300 text-sm font-medium mb-2">
                    版本號 *
                  </label>
                  <input
                    type="text"
                    name="version"
                    placeholder="例如：v1.0, v2.1, 2024-Q1"
                    required
                    className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 outline-none focus:border-purple-500/50 transition-all"
                  />
                </div>
                
                <div>
                  <label className="block text-slate-300 text-sm font-medium mb-2">
                    上傳檔案
                  </label>
                  
                  {/* 檔案協議警告 */}
                  {window.location.protocol === 'file:' && (
                    <div className="mb-3 bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
                      <div className="flex items-start gap-2">
                        <AlertTriangle size={18} className="text-amber-400 flex-shrink-0 mt-0.5" />
                        <div className="text-xs text-amber-300">
                          <p className="font-medium mb-1">⚠️ 目前無法直接上傳檔案</p>
                          <p className="text-amber-400/80">請使用「貼上外部連結」功能，或透過 HTTP 伺服器運行此系統</p>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  <div className="space-y-3">
                    <div className="flex items-center gap-3">
                      <label className="flex-1 cursor-pointer">
                        <div className="bg-white/5 border-2 border-dashed border-white/20 hover:border-purple-500/50 rounded-xl px-4 py-6 text-center transition-all">
                          <Upload size={32} className="mx-auto mb-2 text-slate-400" />
                          <p className="text-sm text-slate-300 mb-1">
                            {selectedFile ? selectedFile.name : '點擊選擇檔案'}
                          </p>
                          <p className="text-xs text-slate-500">
                            支援 PDF、Word、Excel、PowerPoint 等格式（最大 50MB）
                          </p>
                        </div>
                        <input
                          type="file"
                          onChange={(e) => {
                            const file = e.target.files[0];
                            if (file) {
                              setSelectedFile(file);
                              console.log('已選擇檔案:', file.name, '大小:', (file.size / 1024 / 1024).toFixed(2), 'MB');
                            }
                          }}
                          className="hidden"
                          accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt"
                        />
                      </label>
                      {selectedFile && (
                        <button
                          type="button"
                          onClick={() => setSelectedFile(null)}
                          className="p-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all"
                          title="移除檔案"
                        >
                          <X size={20} />
                        </button>
                      )}
                    </div>
                    
                    {selectedFile && (
                      <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
                        <div className="flex items-center gap-2 text-sm text-blue-400">
                          <FileText size={16} />
                          <span className="flex-1 truncate">{selectedFile.name}</span>
                          <span className="text-xs">({(selectedFile.size / 1024 / 1024).toFixed(2)} MB)</span>
                        </div>
                      </div>
                    )}
                    
                    <div className="text-center text-slate-400 text-sm">
                      ── 或 ──
                    </div>
                    
                    <div>
                      <input
                        type="url"
                        name="fileUrl"
                        placeholder="貼上外部連結 (https://...)" 
                        disabled={!!selectedFile}
                        className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 outline-none focus:border-purple-500/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                      />
                      <p className="text-xs text-slate-400 mt-1">💡 Google Drive、OneDrive 等雲端連結</p>
                    </div>
                  </div>
                </div>
                
                {/* 上傳進度條 */}
                {isUploading && uploadProgress > 0 && (
                  <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm text-blue-400">上傳中...</span>
                      <span className="text-sm font-bold text-blue-400">{uploadProgress.toFixed(0)}%</span>
                    </div>
                    <div className="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                      <div 
                        className="h-full bg-gradient-to-r from-blue-500 to-cyan-500 transition-all duration-300"
                        style={{ width: `${uploadProgress}%` }}
                      />
                    </div>
                  </div>
                )}
                
                <div>
                  <label className="block text-slate-300 text-sm font-medium mb-2">
                    更新說明
                  </label>
                  <textarea
                    name="notes"
                    placeholder="請描述此版本的更新內容或重點..."
                    rows={3}
                    className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 outline-none focus:border-purple-500/50 transition-all resize-none"
                  />
                </div>
                
                <div className="flex gap-3 pt-4">
                  <button
                    type="submit"
                    disabled={isUploading}
                    className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-4 py-2.5 rounded-xl font-medium transition-all shadow-lg shadow-purple-500/25 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {isUploading ? (
                      <>
                        <RefreshCw size={18} className="animate-spin" />
                        上傳中...
                      </>
                    ) : (
                      '確認上傳'
                    )}
                  </button>
                  <button
                    type="button"
                    onClick={() => {
                      setShowProposalModal(false);
                      setSelectedFile(null);
                      setUploadProgress(0);
                    }}
                    disabled={isUploading}
                    className="px-6 bg-white/10 hover:bg-white/20 text-slate-300 py-2.5 rounded-xl font-medium transition-all border border-white/10 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

        {/* 版本歷史 Modal */}
        {showVersionHistory && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-slate-800 rounded-2xl border border-white/10 shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden animate-fade-in">
              <div className="bg-gradient-to-r from-blue-500 to-cyan-500 p-6 rounded-t-2xl">
                <h3 className="text-xl font-bold text-white flex items-center gap-2">
                  <Clock size={24} />
                  版本歷史記錄
                </h3>
              </div>
              
              <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)]">
                {proposalVersionHistory.length === 0 ? (
                  <div className="text-center py-8 text-slate-400">
                    暫無版本記錄
                  </div>
                ) : (
                  <div className="space-y-4">
                    {proposalVersionHistory.map((proposal, index) => {
                      const project = allProjects.find(p => p.id === proposal.projectId);
                      return (
                        <div
                          key={proposal.id}
                          className="bg-white/5 border border-white/10 rounded-xl p-5 hover:border-blue-500/50 hover:bg-white/10 transition-all"
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div className="flex-1">
                              <div className="flex items-center gap-3 mb-2">
                                <h4 className="text-white font-bold">{project?.name || '未知專案'}</h4>
                                <span className="px-3 py-1 bg-blue-500/20 border border-blue-500/30 text-blue-400 text-sm rounded-full font-medium">
                                  {proposal.version}
                                </span>
                                {index === 0 && (
                                  <span className="px-2 py-0.5 bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-xs rounded-full">
                                    最新
                                  </span>
                                )}
                              </div>
                              <div className="grid grid-cols-2 gap-4 text-sm mb-3">
                                <div className="text-slate-400">
                                  <span className="text-xs">上傳者：</span>
                                  <span className="text-white ml-1">{proposal.uploadedBy}</span>
                                </div>
                                <div className="text-slate-400">
                                  <span className="text-xs">上傳時間：</span>
                                  <span className="text-white ml-1">
                                    {new Date(proposal.uploadedAt).toLocaleString('zh-TW')}
                                  </span>
                                </div>
                              </div>
                              {proposal.notes && (
                                <div className="bg-white/5 border border-white/10 rounded-lg p-3 mb-3">
                                  <p className="text-sm text-slate-300">{proposal.notes}</p>
                                </div>
                              )}
                            </div>
                          </div>
                          <a
                            href={proposal.fileUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-blue-500/25"
                          >
                            <Eye size={16} />
                            查看此版本
                          </a>
                        </div>
                      );
                    })}
                  </div>
                )}
                
                <div className="mt-6">
                  <button
                    onClick={() => setShowVersionHistory(false)}
                    className="w-full bg-white/10 hover:bg-white/20 text-slate-300 px-4 py-2.5 rounded-xl font-medium transition-all border border-white/10"
                  >
                    關閉
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const MachineSelectionView = ({ machines, onSelect, onBack, onAddMachine, onUpdateMachine, user }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingMachine, setEditingMachine] = useState(null);
  const [showPersonalDashboard, setShowPersonalDashboard] = useState(false);

  // 過濾機台：管理員顯示全部，一般使用者只顯示 members 中包含自己的機台
  const filteredMachines = React.useMemo(() => {
    if (!user) return machines;
    
    // 管理員顯示全部
    if (user.role === 'admin') {
      return machines;
    }
    
    // 一般使用者只顯示 members 中包含自己的機台
    return machines.filter(machine => {
      if (!machine.members) return false;
      
      const memberList = machine.members.split(',').map(m => m.trim());
      // 檢查 members 中是否包含使用者的 displayName 或 username
      return memberList.some(member => 
        member === user.displayName || 
        member === user.username ||
        member.includes(user.displayName) ||
        member.includes(user.username)
      );
    });
  }, [machines, user]);

  const handleOpenAdd = () => {
    setEditingMachine(null);
    setIsModalOpen(true);
  };

  const handleOpenEdit = (machine, e) => {
    e.stopPropagation();
    setEditingMachine(machine);
    setIsModalOpen(true);
  };

  const handleSubmit = (data) => {
    if (editingMachine) {
        onUpdateMachine({ ...editingMachine, ...data });
    } else {
        onAddMachine(data);
    }
    setIsModalOpen(false);
  };

  // 如果顯示個人戰情室，返回該視圖
  if (showPersonalDashboard) {
    return <PersonalDashboard 
      onBack={() => setShowPersonalDashboard(false)} 
      machines={machines} 
      onSelectMachine={onSelect} 
    />;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8 animate-fade-in">
      {/* 背景裝飾 */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-20 left-10 w-72 h-72 bg-blue-500/10 rounded-full blur-3xl"></div>
        <div className="absolute bottom-20 right-10 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl"></div>
        <div className="absolute top-1/2 left-1/2 w-64 h-64 bg-cyan-500/5 rounded-full blur-3xl"></div>
      </div>

      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingMachine ? "編輯機台專案" : "新增機台專案"}>
        <MachineForm initialData={editingMachine} onSubmit={handleSubmit} onCancel={() => setIsModalOpen(false)} />
      </Modal>

      <div className="max-w-7xl mx-auto relative z-10">
        {/* Header */}
        <div className="flex items-center justify-between mb-10">
          <div>
            <div className="flex items-center gap-4 mb-3">
              <div className="p-3 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg shadow-indigo-500/30">
                <Activity className="w-8 h-8 text-white" />
              </div>
              <div>
                <h1 className="text-4xl font-bold text-white tracking-tight">R&D Nexus</h1>
                <p className="text-slate-400 mt-1">產品機台專案選擇分析 • Product Machine Project</p>
              </div>
            </div>
          </div>
          <div className="flex gap-3 items-center">
             <button 
                onClick={() => setShowPersonalDashboard(true)} 
                className="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-5 py-3 rounded-xl text-sm transition-all shadow-lg shadow-blue-500/25 font-medium"
             >
                <GanttChartIcon size={18} /> 個人戰情室
             </button>
             <button onClick={onBack} className="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-5 py-3 rounded-xl text-sm transition-all backdrop-blur border border-white/10">
              <LogOut size={18} /> 返回主選單
            </button>
          </div>
        </div>

        {/* Status Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
          <div className="bg-white/5 backdrop-blur-xl p-5 rounded-2xl border border-white/10 flex items-center gap-4">
            <div className="p-3 bg-emerald-500/20 rounded-xl">
              <CheckCircle2 className="w-6 h-6 text-emerald-400" />
            </div>
            <div>
              <p className="text-slate-400 text-sm">運作正常</p>
              <p className="text-2xl font-bold text-white">{filteredMachines.filter(m => m.status === 'Active').length}</p>
            </div>
          </div>
          <div className="bg-white/5 backdrop-blur-xl p-5 rounded-2xl border border-white/10 flex items-center gap-4">
            <div className="p-3 bg-amber-500/20 rounded-xl">
              <AlertCircle className="w-6 h-6 text-amber-400" />
            </div>
            <div>
              <p className="text-slate-400 text-sm">需關注</p>
              <p className="text-2xl font-bold text-white">{filteredMachines.filter(m => m.status !== 'Active').length}</p>
            </div>
          </div>
          <div className="bg-white/5 backdrop-blur-xl p-5 rounded-2xl border border-white/10 flex items-center gap-4">
            <div className="p-3 bg-blue-500/20 rounded-xl">
              <Briefcase className="w-6 h-6 text-blue-400" />
            </div>
            <div>
              <p className="text-slate-400 text-sm">機台總數</p>
              <p className="text-2xl font-bold text-white">{filteredMachines.length}</p>
            </div>
          </div>
          <div className="bg-white/5 backdrop-blur-xl p-5 rounded-2xl border border-white/10 flex items-center gap-4">
            <div className="p-3 bg-purple-500/20 rounded-xl">
              <TrendingUp className="w-6 h-6 text-purple-400" />
            </div>
            <div>
              <p className="text-slate-400 text-sm">平均進度</p>
              <p className="text-2xl font-bold text-white">{filteredMachines.length > 0 ? Math.round(filteredMachines.reduce((a, m) => a + (parseInt(m.progress, 10) || 0), 0) / filteredMachines.length) : 0}%</p>
            </div>
          </div>
        </div>

        {/* Machine Cards Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
           {filteredMachines.map((machine, index) => (
             <div 
                key={machine.id} 
                onClick={() => onSelect(machine)}
                className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden hover:bg-white/10 hover:-translate-y-2 transition-all duration-300 cursor-pointer group relative"
                style={{ animationDelay: `${index * 50}ms` }}
             >
                <div className="absolute top-4 right-4 z-10 flex gap-2">
                    <button 
                        onClick={(e) => handleOpenEdit(machine, e)}
                        className="p-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-slate-400 hover:text-white hover:bg-white/20 shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-200"
                        title="編輯"
                    >
                        <Edit size={16} />
                    </button>
                </div>

                <div className="h-44 bg-gradient-to-br from-slate-700 to-slate-800 relative overflow-hidden">
                   <img src={machine.image} alt={machine.name} className="w-full h-full object-cover opacity-70 group-hover:opacity-90 group-hover:scale-110 transition-all duration-500" />
                   <div className="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent"></div>
                   <div className={`absolute top-4 left-4 px-3 py-1.5 rounded-xl text-xs font-bold shadow-lg backdrop-blur-sm ${
                      machine.status === 'Active' ? 'bg-emerald-500/90 text-white' : 'bg-amber-500/90 text-white'
                   }`}>
                      <span className="flex items-center gap-1.5">
                        <span className="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                        {machine.status === 'Active' ? '運作中' : '需關注'}
                      </span>
                   </div>
                </div>
                <div className="p-5">
                   <h3 className="font-bold text-lg text-white mb-1 truncate group-hover:text-blue-400 transition-colors" title={machine.name}>{machine.name}</h3>
                   <p className="text-xs text-slate-500 mb-4 font-mono">CODE: {machine.code}</p>
                   
                   <div className="flex justify-between items-center text-sm text-slate-400 mb-2">
                      <span className="font-medium">專案進度</span>
                      <span className="font-bold text-white">{machine.progress}%</span>
                   </div>
                   <div className="w-full h-2 bg-slate-700/50 rounded-full overflow-hidden">
                      <div className={`h-full rounded-full transition-all duration-500 ${
                        machine.progress >= 80 ? 'bg-gradient-to-r from-emerald-400 to-emerald-500' : 
                        machine.progress >= 50 ? 'bg-gradient-to-r from-blue-400 to-blue-500' : 
                        'bg-gradient-to-r from-amber-400 to-amber-500'
                      }`} style={{ width: `${machine.progress}%` }}></div>
                   </div>
                   
                   <div className="mt-5 pt-4 border-t border-white/10 flex justify-between items-center">
                      <div className="flex-1">
                        {machine.members ? (
                          <>
                            <div className="flex -space-x-2 mb-1.5">
                              {machine.members.split(',').slice(0, 4).map((member, i) => (
                                <div key={i} className="w-7 h-7 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 border-2 border-slate-800 flex items-center justify-center text-white text-xs font-bold shadow-sm" title={member.trim()}>
                                  {member.trim().charAt(0)}
                                </div>
                              ))}
                              {machine.members.split(',').length > 4 && (
                                <div className="w-7 h-7 rounded-full bg-slate-700 border-2 border-slate-800 flex items-center justify-center text-slate-400 text-xs font-bold">
                                  +{machine.members.split(',').length - 4}
                                </div>
                              )}
                            </div>
                            <p className="text-xs text-slate-500 truncate" title={machine.members}>
                              {machine.members.split(',').slice(0, 2).map(m => m.trim()).join(', ')}
                              {machine.members.split(',').length > 2 && '...'}
                            </p>
                          </>
                        ) : (
                          <p className="text-xs text-slate-600">未設定成員</p>
                        )}
                      </div>
                      <span className="text-blue-400 text-sm font-semibold flex items-center gap-1 group-hover:gap-2 transition-all">
                         進入 <ChevronRight size={16} className="group-hover:translate-x-1 transition-transform" />
                      </span>
                   </div>
                </div>
             </div>
           ))}
           
           <div 
              onClick={handleOpenAdd}
              className="bg-white/5 backdrop-blur-xl rounded-2xl border-2 border-dashed border-white/20 flex flex-col items-center justify-center p-8 text-slate-500 hover:border-blue-500/50 hover:text-blue-400 hover:bg-white/10 transition-all duration-300 cursor-pointer h-full min-h-[300px] group"
           >
              <div className="w-20 h-20 rounded-2xl bg-white/10 flex items-center justify-center mb-4 group-hover:scale-110 group-hover:bg-blue-500/20 transition-all duration-300">
                <PlusCircle size={40} className="opacity-50 group-hover:opacity-100 transition-opacity" />
              </div>
              <span className="font-semibold text-lg">新增機台專案</span>
              <span className="text-sm mt-1 text-slate-600">點擊開始建立</span>
           </div>
        </div>

        {/* Analysis Section */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
           <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
              <h3 className="font-bold text-white mb-6 flex items-center">
                 <div className="p-2 bg-blue-500/20 rounded-xl mr-3">
                   <BarChart3 size={20} className="text-blue-400" />
                 </div>
                 機台專案績效分析
              </h3>
              <div className="h-64">
                 <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={machines}>
                       <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(255,255,255,0.1)" />
                       <XAxis dataKey="code" stroke="#94a3b8" />
                       <YAxis stroke="#94a3b8" />
                       <Tooltip contentStyle={{backgroundColor:'rgba(30,41,59,0.95)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'12px', color: '#fff'}} />
                       <Bar dataKey="progress" fill="#3b82f6" radius={[4, 4, 0, 0]} name="進度 (%)" />
                    </BarChart>
                 </ResponsiveContainer>
              </div>
           </div>
           
           <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
              <h3 className="font-bold text-white mb-6 flex items-center">
                 <div className="p-2 bg-rose-500/20 rounded-xl mr-3">
                   <Activity size={20} className="text-rose-400" />
                 </div>
                 近期異常統計
              </h3>
              <div className="space-y-3">
                 {[
                    { machine: 'HSM-A1', issue: '馬達過熱警報', time: '2h ago', level: 'High' },
                    { machine: 'AOI-X5', issue: '影像辨識率下降', time: '5h ago', level: 'Medium' },
                    { machine: 'RO-R3', issue: '溫度曲線偏移', time: '1d ago', level: 'Low' },
                 ].map((item, idx) => (
                    <div key={idx} className="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/10 hover:bg-white/10 transition-colors">
                       <div className="flex items-center gap-3">
                          <div className={`w-3 h-3 rounded-full ${item.level === 'High' ? 'bg-rose-500 shadow-lg shadow-rose-500/50' : item.level === 'Medium' ? 'bg-amber-500 shadow-lg shadow-amber-500/50' : 'bg-blue-500 shadow-lg shadow-blue-500/50'}`}></div>
                          <div>
                             <div className="font-bold text-white text-sm">{item.machine}</div>
                             <div className="text-xs text-slate-400">{item.issue}</div>
                          </div>
                       </div>
                       <span className="text-xs text-slate-500 bg-white/5 px-3 py-1 rounded-lg">{item.time}</span>
                    </div>
                 ))}
              </div>
           </div>
        </div>
      </div>
    </div>
  );
};

const DashboardView = ({ projects, tasks, changes, history, onViewDetails }) => {
  // Fallback to global PROJECTS if prop is missing (for safety)
  const displayProjects = projects || [];
  const displayTasks = tasks || [];
  const displayChanges = changes || [];
  const displayHistory = history || [];

  // Calculate Stats
  const projectIds = displayProjects.map(p => p.id);
  const myTasks = displayTasks.filter(t => projectIds.includes(t.projectId) && t.status !== 'Done');
  const myChanges = displayChanges.filter(c => projectIds.includes(c.projectId));
  
  // Calculate Change Frequency (Mock Logic)
  const changeFrequency = myChanges.length > 5 ? 'High' : myChanges.length > 2 ? 'Medium' : 'Low';
  const changeColor = changeFrequency === 'High' ? 'text-rose-500' : changeFrequency === 'Medium' ? 'text-amber-500' : 'text-emerald-500';

  // Find Alerts (Delay Projects or High Risk Tasks)
  const delayProjects = displayProjects.filter(p => p.status === 'delay');
  const riskTasks = displayTasks.filter(t => projectIds.includes(t.projectId) && t.risk);

  return (
    <div className="space-y-6 animate-fade-in">
      {/* KPI Cards - 專業深色玻璃風格 */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-5">
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-white/20 transition-all group">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-400 text-sm font-medium">進行中專案</p>
              <h3 className="text-4xl font-bold text-white mt-2">{displayProjects.length}</h3>
            </div>
            <div className="p-3 bg-blue-500/20 rounded-xl text-blue-400 group-hover:scale-110 transition-transform">
              <Briefcase size={24} />
            </div>
          </div>
          <div className="mt-4 flex items-center text-xs text-slate-500">
            <span className="text-emerald-400 font-medium flex items-center mr-2 px-2 py-1 bg-emerald-500/10 rounded-lg">
              <TrendingUp size={12} className="mr-1" /> +{displayProjects.filter(p => new Date(p.deadline) > new Date()).length}
            </span>
            本月活躍
          </div>
        </div>

        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-rose-500/30 transition-all group">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-400 text-sm font-medium">延遲專案 (Alert)</p>
              <h3 className="text-4xl font-bold text-rose-400 mt-2">{delayProjects.length}</h3>
            </div>
            <div className="p-3 bg-rose-500/20 rounded-xl text-rose-400 group-hover:scale-110 transition-transform">
              <AlertCircle size={24} />
            </div>
          </div>
           <div className="mt-4 text-xs font-medium px-3 py-1.5 rounded-lg inline-block">
            {delayProjects.length > 0 ? (
              <span className="text-rose-400 bg-rose-500/10 px-3 py-1.5 rounded-lg">⚠️ 需立即介入處理</span>
            ) : (
              <span className="text-emerald-400 bg-emerald-500/10 px-3 py-1.5 rounded-lg">✓ 目前進度良好</span>
            )}
          </div>
        </div>

        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-purple-500/30 transition-all group">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-400 text-sm font-medium">待辦事項 (To-Do)</p>
              <h3 className="text-4xl font-bold text-white mt-2">{myTasks.length}</h3>
            </div>
            <div className="p-3 bg-purple-500/20 rounded-xl text-purple-400 group-hover:scale-110 transition-transform">
              <ListTodo size={24} />
            </div>
          </div>
          <div className="mt-4 flex items-center text-xs text-slate-500">
            <span className="px-2 py-1 bg-white/5 rounded-lg">📋 關聯專案任務</span>
          </div>
        </div>

        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-amber-500/30 transition-all group">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-slate-400 text-sm font-medium">設變頻率 (TQM)</p>
              <h3 className={`text-4xl font-bold mt-2 ${changeFrequency === 'High' ? 'text-rose-400' : changeFrequency === 'Medium' ? 'text-amber-400' : 'text-emerald-400'}`}>{changeFrequency}</h3>
            </div>
            <div className="p-3 bg-amber-500/20 rounded-xl text-amber-400 group-hover:scale-110 transition-transform">
              <Activity size={24} />
            </div>
          </div>
          <div className="mt-4 text-xs text-slate-500">
            <span className="px-2 py-1 bg-white/5 rounded-lg">本月累計 {myChanges.length} 件變更</span>
          </div>
        </div>
      </div>

      {/* 完整甘特圖區域 - 深色專業風格 */}
      <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6 mb-6">
        <h3 className="font-bold text-white mb-5 flex items-center">
          <div className="p-2.5 bg-blue-500/20 rounded-xl mr-3">
            <LayoutDashboard size={20} className="text-blue-400" />
          </div>
          所有專案甘特圖總覽
          <span className="ml-3 text-xs text-slate-500 font-normal bg-white/5 px-3 py-1 rounded-lg">{displayProjects.length} 個專案</span>
        </h3>
        <div className="overflow-x-auto">
          {displayProjects.length === 0 ? (
            <div className="text-center py-12 text-slate-400">
              <div className="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <Briefcase size={32} className="text-slate-500" />
              </div>
              <p>尚無專案，請至「專案列表」新增。</p>
            </div>
          ) : (
            <div className="min-w-[800px]">
              {/* 甘特圖表頭 */}
              <div className="flex border-b border-white/10 pb-3 mb-4">
                <div className="w-48 flex-shrink-0 text-xs font-semibold text-slate-400 uppercase tracking-wider">專案名稱</div>
                <div className="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 text-center uppercase tracking-wider">負責人</div>
                <div className="w-16 flex-shrink-0 text-xs font-semibold text-slate-400 text-center uppercase tracking-wider">狀態</div>
                <div className="flex-1 flex justify-between text-xs text-slate-500 px-2">
                  <span>開始</span>
                  <span>進度條</span>
                  <span>截止</span>
                </div>
                <div className="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 text-center uppercase tracking-wider">進度</div>
              </div>
              {/* 甘特圖項目 */}
              <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                {displayProjects.map((project) => {
                  const validProgress = Math.min(Math.max(parseFloat(project.progress) || 0, 0), 100);
                  const statusColor = project.status === 'delay' ? 'bg-gradient-to-r from-rose-500 to-pink-500' : 
                    project.status === 'risk' ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 
                    project.status === 'Completed' ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-gradient-to-r from-emerald-500 to-teal-500';
                  const bgColor = project.status === 'delay' ? 'hover:bg-rose-500/10' : 
                    project.status === 'risk' ? 'hover:bg-amber-500/10' : 'hover:bg-white/5';
                  
                  return (
                    <div 
                      key={project.id} 
                      className={`flex items-center py-3 px-3 rounded-xl cursor-pointer transition-all border border-transparent hover:border-white/10 ${bgColor}`}
                      onClick={() => onViewDetails(project)}
                    >
                      <div className="w-48 flex-shrink-0">
                        <span className="font-medium text-sm text-white truncate block" title={project.name}>{project.name}</span>
                        <span className="text-xs text-slate-500">{project.category || '一般'}</span>
                      </div>
                      <div className="w-20 flex-shrink-0 text-xs text-slate-400 text-center truncate" title={project.owner}>{project.owner}</div>
                      <div className="w-16 flex-shrink-0 flex justify-center">
                        <ProjectStatusBadge status={project.status} />
                      </div>
                      <div className="flex-1 px-3">
                        <div className="relative h-7 bg-white/5 rounded-lg overflow-hidden border border-white/5">
                          <div 
                            className={`absolute top-0 left-0 h-full rounded-lg transition-all ${statusColor}`}
                            style={{ width: `${validProgress}%` }}
                          >
                            {validProgress > 15 && (
                              <span className="absolute inset-0 flex items-center justify-center text-xs text-white font-bold">
                                {validProgress.toFixed(0)}%
                              </span>
                            )}
                          </div>
                          {validProgress <= 15 && (
                            <span className="absolute inset-0 flex items-center justify-center text-xs text-slate-400 font-medium">
                              {validProgress.toFixed(0)}%
                            </span>
                          )}
                        </div>
                        <div className="flex justify-between mt-1.5 text-xs text-slate-500">
                          <span>{project.startDate || project.createdAt?.split('T')[0] || '-'}</span>
                          <span>{project.deadline || '-'}</span>
                        </div>
                      </div>
                      <div className="w-20 flex-shrink-0 text-center">
                        <span className={`text-sm font-bold px-2 py-1 rounded-lg ${validProgress >= 80 ? 'text-emerald-400 bg-emerald-500/10' : validProgress >= 50 ? 'text-amber-400 bg-amber-500/10' : 'text-rose-400 bg-rose-500/10'}`}>
                          {validProgress.toFixed(0)}%
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Project Status Overview - 深色風格 */}
        <div className="lg:col-span-2 bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
          <h3 className="font-bold text-white mb-5 flex items-center">
            <div className="p-2 bg-slate-500/20 rounded-xl mr-3">
              <LayoutDashboard size={18} className="text-slate-400" />
            </div>
            專案進度摘要
          </h3>
          <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2">
            {displayProjects.length === 0 ? (
                <div className="text-center py-10 text-slate-400">
                    <p>尚無專案，請至「專案列表」新增。</p>
                </div>
            ) : (
                displayProjects.slice(0, 5).map((project) => {
                const validProgress = Math.min(Math.max(parseFloat(project.progress) || 0, 0), 100);
                return (
                <div key={project.id} className="group hover:bg-white/5 p-4 rounded-xl transition-colors cursor-pointer border border-transparent hover:border-white/10" onClick={() => onViewDetails(project)}>
                    <div className="flex justify-between items-center mb-3">
                    <div className="flex items-center">
                        <span className="font-medium text-white">{project.name}</span>
                        <span className="ml-3 text-xs text-slate-500 bg-white/5 px-2 py-1 rounded-lg">{project.owner}</span>
                    </div>
                    <ProjectStatusBadge status={project.status} />
                    </div>
                    <div className="relative h-2.5 bg-white/10 rounded-full overflow-hidden">
                    <div 
                        className={`absolute top-0 left-0 h-full rounded-full ${
                        project.status === 'delay' ? 'bg-gradient-to-r from-rose-500 to-pink-500' : 
                        project.status === 'risk' ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 'bg-gradient-to-r from-emerald-500 to-teal-500'
                        }`}
                        style={{ width: `${validProgress}%` }}
                    ></div>
                    </div>
                    <div className="flex justify-between mt-2 text-xs text-slate-500">
                    <span>Start</span>
                    <span>Deadline: {project.deadline}</span>
                    </div>
                </div>
                );})
            )}
            {displayProjects.length > 5 && (
              <div className="text-center text-xs text-slate-500 py-3 bg-white/5 rounded-xl">
                還有 {displayProjects.length - 5} 個專案，請查看上方完整甘特圖
              </div>
            )}
          </div>
        </div>

        {/* Recent Changes - 深色風格 */}
        <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
          <h3 className="font-bold text-white mb-5 flex items-center">
            <div className="p-2 bg-blue-500/20 rounded-xl mr-3">
              <Activity size={18} className="text-blue-400" />
            </div>
            最近專案動態
          </h3>
          <div className="space-y-3 max-h-[280px] overflow-y-auto pr-1">
            {(() => {
              // 過濾出屬於當前機台專案的歷史記錄
              const projectIds = displayProjects.map(p => p.id);
              const machineHistory = displayHistory.filter(item => 
                item.projectId && projectIds.includes(item.projectId)
              );
              
              if (machineHistory.length === 0) {
                return (
                  <div className="text-center py-10 text-slate-500 text-sm">
                    <div className="w-12 h-12 bg-white/5 rounded-xl flex items-center justify-center mx-auto mb-3">
                      <Activity size={24} className="text-slate-600" />
                    </div>
                    尚無變更記錄
                  </div>
                );
              }
              
              return machineHistory.slice(0, 5).map((item, index) => {
                const project = displayProjects.find(p => p.id === item.projectId);
                const projectName = project ? project.name : '未知專案';
                
                // 決定顏色和圖示 - 深色主題
                let bgColor = 'bg-blue-500/10';
                let borderColor = 'border-blue-500/20';
                let textColor = 'text-blue-400';
                let icon = '📄';
                
                if (item.type === '新增專案' || item.action === '新增專案') {
                  bgColor = 'bg-emerald-500/10';
                  borderColor = 'border-emerald-500/20';
                  textColor = 'text-emerald-400';
                  icon = '➕';
                } else if (item.type === '新增任務' || item.action === '新增任務') {
                  bgColor = 'bg-cyan-500/10';
                  borderColor = 'border-cyan-500/20';
                  textColor = 'text-cyan-400';
                  icon = '✔️';
                } else if (item.type === '更新專案' || item.action === '更新專案') {
                  bgColor = 'bg-amber-500/10';
                  borderColor = 'border-amber-500/20';
                  textColor = 'text-amber-400';
                  icon = '✏️';
                } else if (item.type === '更新任務' || item.action === '更新任務') {
                  bgColor = 'bg-purple-500/10';
                  borderColor = 'border-purple-500/20';
                  textColor = 'text-purple-400';
                  icon = '🔄';
                }
                
                // 格式化時間
                const timestamp = item.createdAt || item.date || item.timestamp;
                const timeStr = timestamp ? new Date(timestamp).toLocaleString('zh-TW', { 
                  month: '2-digit', 
                  day: '2-digit', 
                  hour: '2-digit', 
                  minute: '2-digit' 
                }) : '-';
                
                return (
                  <div key={item.id || index} className={`p-3.5 ${bgColor} border ${borderColor} rounded-xl text-sm ${textColor} hover:scale-[1.01] transition-transform`}>
                    <div className="flex items-start justify-between mb-1.5">
                      <div className="flex items-center gap-2.5 flex-1">
                        <span className="text-base">{icon}</span>
                        <div className="flex-1">
                          <div className="font-bold text-white">{item.type || item.action || '變更'}</div>
                          <div className="text-xs text-slate-400 mt-0.5">
                            {projectName} {item.description && `- ${item.description}`}
                          </div>
                        </div>
                      </div>
                      <span className="text-xs text-slate-500 bg-white/5 px-2 py-1 rounded-lg whitespace-nowrap ml-2">{timeStr}</span>
                    </div>
                    {item.user && (
                      <div className="text-xs text-slate-500 mt-1.5 flex items-center gap-1">
                        👤 {item.user}
                      </div>
                    )}
                  </div>
                );
              });
            })()}
          </div>
        </div>
      </div>
    </div>
  );
};

const ProjectListView = ({ onViewDetails, projects, onAddProject, onUpdateProject, onDeleteProject }) => {
  const [filter, setFilter] = useState('all');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingProject, setEditingProject] = useState(null);

  // Fallback to global PROJECTS if prop is missing
  const displayProjects = projects || PROJECTS;
  const filteredProjects = displayProjects.filter(p => filter === 'all' || p.status === filter);

  const handleOpenAdd = () => {
    setEditingProject(null);
    setIsModalOpen(true);
  };

  const handleOpenEdit = (project, e) => {
    e.stopPropagation(); // Prevent triggering row click
    setEditingProject(project);
    setIsModalOpen(true);
  };

  const handleDelete = (id, e) => {
    e.stopPropagation(); // Prevent triggering row click
    onDeleteProject(id);
  };

  const handleSubmit = (formData) => {
    if (editingProject) {
      onUpdateProject({ ...editingProject, ...formData });
    } else {
      onAddProject(formData);
    }
    setIsModalOpen(false);
  };

  return (
    <>
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingProject ? "編輯專案" : "新增專案"} size="large">
        <ProjectForm 
          initialData={editingProject} 
          onSubmit={handleSubmit} 
          onCancel={() => setIsModalOpen(false)} 
        />
      </Modal>
      
      <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden">
        <div className="p-6 border-b border-white/10 flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h2 className="text-xl font-bold text-white flex items-center gap-3">
              <div className="p-2.5 bg-blue-500/20 rounded-xl">
                <ListTodo size={20} className="text-blue-400" />
              </div>
              專案清單
            </h2>
          <p className="text-sm text-slate-400 mt-1 ml-12">快速搜尋、篩選與定位問題專案</p>
        </div>
        <div className="flex gap-3 flex-wrap">
          <button onClick={handleOpenAdd} className="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all">
            <Plus size={16} /> 新增專案
          </button>
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} />
            <input 
              type="text" 
              placeholder="搜尋專案、負責人..." 
              className="pl-9 pr-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 w-64 backdrop-blur"
            />
          </div>
          <select 
            className="px-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 backdrop-blur appearance-none cursor-pointer"
            value={filter}
            onChange={(e) => setFilter(e.target.value)}
          >
            <option value="all" className="bg-slate-800">所有狀態</option>
            <option value="normal" className="bg-slate-800">正常</option>
            <option value="risk" className="bg-slate-800">有風險</option>
            <option value="delay" className="bg-slate-800">已延遲</option>
          </select>
        </div>
      </div>
      
      <div className="overflow-x-auto">
        <table className="w-full text-left border-collapse">
          <thead className="bg-white/5 text-slate-400 text-xs uppercase font-semibold tracking-wider">
            <tr>
              <th className="px-6 py-4">專案名稱</th>
              <th className="px-6 py-4">負責人</th>
              <th className="px-6 py-4">階段</th>
              <th className="px-6 py-4">進度</th>
              <th className="px-6 py-4">Deadline</th>
              <th className="px-6 py-4">狀態</th>
              <th className="px-6 py-4">操作</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/5">
            {filteredProjects.map((project) => (
              <tr key={project.id} className="hover:bg-white/5 transition-colors cursor-pointer group" onClick={() => onViewDetails(project)}>
                <td className="px-6 py-4 font-medium text-white">{project.name}</td>
                <td className="px-6 py-4">
                  <div className="flex items-center">
                    <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 text-white flex items-center justify-center text-xs mr-3 font-bold shadow-lg shadow-blue-500/20">
                      {project.owner[0]}
                    </div>
                    <span className="text-sm text-slate-300">{project.owner}</span>
                  </div>
                </td>
                <td className="px-6 py-4 text-sm">
                  <span className="px-3 py-1.5 bg-white/10 rounded-lg text-slate-300 text-xs border border-white/5">{project.stage}</span>
                </td>
                <td className="px-6 py-4">
                  <div className="flex items-center gap-3">
                    <div className="w-28 h-2 bg-white/10 rounded-full overflow-hidden">
                      <div className={`h-full rounded-full ${project.status === 'delay' ? 'bg-gradient-to-r from-rose-500 to-pink-500' : project.status === 'risk' ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 'bg-gradient-to-r from-emerald-500 to-teal-500'}`} style={{ width: `${project.progress}%` }}></div>
                    </div>
                    <span className={`text-xs font-medium ${project.progress >= 80 ? 'text-emerald-400' : project.progress >= 50 ? 'text-amber-400' : 'text-rose-400'}`}>{project.progress}%</span>
                  </div>
                </td>
                <td className="px-6 py-4 text-sm text-slate-400">{project.deadline}</td>
                <td className="px-6 py-4">
                  <ProjectStatusBadge status={project.status} />
                </td>
                <td className="px-6 py-4">
                  <div className="flex items-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                    <button 
                      onClick={(e) => handleOpenEdit(project, e)}
                      className="p-2 text-slate-400 hover:text-blue-400 hover:bg-blue-500/10 rounded-lg transition-all"
                      title="編輯"
                    >
                      <Edit size={16} />
                    </button>
                    <button 
                      onClick={(e) => handleDelete(project.id, e)}
                      className="p-2 text-slate-400 hover:text-rose-400 hover:bg-rose-500/10 rounded-lg transition-all"
                      title="刪除"
                    >
                      <Trash2 size={16} />
                    </button>
                    <button 
                      onClick={() => onViewDetails(project)}
                      className="text-blue-400 hover:text-blue-300 text-sm font-medium flex items-center ml-2 px-3 py-1.5 hover:bg-blue-500/10 rounded-lg transition-all"
                    >
                      詳情 <ChevronRight size={16} />
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      </div>
    </>
  );
};

const ProjectDetailView = ({ project, machine, onBack, tasks: allTasks, onAddTask, onUpdateTask, changes: allChanges, onAddChange, history: allHistory, onAddHistory, messages: allMessages, onAddMessage, meetings: allMeetings, onAddMeeting, onUpdateMeeting, onDeleteMeeting, notifications: allNotifications, onAddNotification, allUsers, onUpdateProject, onDeleteProject, user }) => {
  const tasks = allTasks.filter(t => t.projectId === project.id);
  const changes = allChanges.filter(c => c.projectId === project.id);
  const history = allHistory.filter(h => h.projectId === project.id);
  const messages = allMessages ? allMessages.filter(m => m.projectId === project.id) : [];
  const meetings = allMeetings ? allMeetings.filter(m => m.projectId === project.id) : [];

  const [activeTab, setActiveTab] = useState('kanban');
  const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
  const [isChangeModalOpen, setIsChangeModalOpen] = useState(false);
  const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
  const [isSpecsModalOpen, setIsSpecsModalOpen] = useState(false);
  const [isMeetingModalOpen, setIsMeetingModalOpen] = useState(false);
  const [isNotificationModalOpen, setIsNotificationModalOpen] = useState(false);
  const [editingMeeting, setEditingMeeting] = useState(null);
  const [editingTask, setEditingTask] = useState(null);
  const [newTaskStatus, setNewTaskStatus] = useState('To Do');
  const [taskViewFilter, setTaskViewFilter] = useState('all'); // 'all' | 'my' | 'department'
  const [selectedDepartment, setSelectedDepartment] = useState(''); // 選擇的部門
  
  // 取得所有不重複的部門列表
  const departmentList = React.useMemo(() => {
    if (!allUsers) return [];
    const depts = [...new Set(allUsers.map(u => u.department).filter(Boolean))];
    return depts.sort();
  }, [allUsers]);
  
  // 🔥 檢查是否從跑馬燈跳轉，自動切換到指定頁籤
  useEffect(() => {
    const targetTab = sessionStorage.getItem('openProjectTab');
    if (targetTab) {
      setActiveTab(targetTab);
      sessionStorage.removeItem('openProjectTab');
      console.log('🎯 自動切換到頁籤:', targetTab);
    }
    
    // 🔥 檢查是否需要打開特定任務
    const targetTaskId = sessionStorage.getItem('openTaskId');
    if (targetTaskId) {
      const task = tasks.find(t => t.id === targetTaskId);
      if (task) {
        setEditingTask(task);
        setIsTaskModalOpen(true);
        console.log('🎯 自動打開任務:', task.title);
      }
      sessionStorage.removeItem('openTaskId');
    }
  }, [tasks]);
  
  // 🔥 自動計算專案進度（混合計算法）
  useEffect(() => {
    if (!project || tasks.length === 0) return;
    
    // 1️⃣ 任務完成度計算（權重 60%）
    const taskWeights = {
      'Done': 1.0,
      'Testing': 0.8,
      'Doing': 0.5,
      'To Do': 0
    };
    const totalTaskWeight = tasks.reduce((sum, task) => 
      sum + (taskWeights[task.status] || 0), 0
    );
    const taskProgress = tasks.length > 0 ? (totalTaskWeight / tasks.length) * 100 : 0;
    
    // 2️⃣ 時間進度計算（權重 30%）
    let timeProgress = 0;
    if (project.startDate && project.deadline) {
      const start = new Date(project.startDate);
      const end = new Date(project.deadline);
      const today = new Date();
      const totalDays = (end - start) / (1000 * 60 * 60 * 24);
      const passedDays = (today - start) / (1000 * 60 * 60 * 24);
      timeProgress = Math.max(0, Math.min(100, (passedDays / totalDays) * 100));
    }
    
    // 3️⃣ 階段完成度計算（權重 10%）
    let phaseProgress = 0;
    if (phases && phases.length > 0) {
      const today = new Date();
      const completedPhases = phases.filter(p => new Date(p.endDate) < today).length;
      phaseProgress = (completedPhases / phases.length) * 100;
    }
    
    // 🎯 綜合進度計算
    const autoProgress = Math.round(
      taskProgress * 0.6 + 
      timeProgress * 0.3 + 
      phaseProgress * 0.1
    );
    
    // 只有當進度變化時才更新（避免無限循環）
    if (autoProgress !== project.progress) {
      console.log('📊 自動更新專案進度:', {
        任務完成度: taskProgress.toFixed(1) + '%',
        時間進度: timeProgress.toFixed(1) + '%',
        階段完成度: phaseProgress.toFixed(1) + '%',
        綜合進度: autoProgress + '%'
      });
      onUpdateProject({ ...project, progress: autoProgress });
    }
  }, [tasks, phases, project.startDate, project.deadline]);
  
  // Gantt State
  const [phases, setPhases] = useState(project.phases || [
    { id: 1, name: 'Phase 1', startDate: '2025-01-01', endDate: '2025-01-31', color: 'bg-blue-500' },
    { id: 2, name: 'Phase 2', startDate: '2025-02-01', endDate: '2025-02-28', color: 'bg-emerald-500' },
    { id: 3, name: 'Phase 3', startDate: '2025-03-01', endDate: '2025-03-20', color: 'bg-amber-400' }
  ]);
  const [isGanttModalOpen, setIsGanttModalOpen] = useState(false);
  const [editingPhase, setEditingPhase] = useState(null);
  const [showCelebration, setShowCelebration] = useState(false);
  const [completedTaskName, setCompletedTaskName] = useState('');

  const [newMessage, setNewMessage] = useState('');
  const [chatFile, setChatFile] = useState(null);

  const handleSendMessage = () => {
    if (!newMessage.trim() && !chatFile) return;
    const msg = {
      id: Date.now(),
      projectId: project.id,
      user: user?.displayName || 'Admin User',
      time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
      content: newMessage,
      avatar: user?.displayName?.[0] || 'A',
      role: user?.department || '研發經理',
      file: chatFile ? chatFile.name : null,
      fileData: chatFile ? chatFile.data : null
    };
    onAddMessage(msg);
    setNewMessage('');
    setChatFile(null);
  };

  const handleChatFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
        // Firebase Firestore 單一文件限制約 1MB，設定檔案限制為 800KB
        const maxSize = 800 * 1024; // 800KB
        
        if (file.type.startsWith('image/')) {
          // 圖片檔案：進行壓縮
          const img = new Image();
          const canvas = document.createElement('canvas');
          const reader = new FileReader();
          
          reader.onload = (event) => {
            img.onload = () => {
              // 計算壓縮後的尺寸，最大寬度 1200px
              let width = img.width;
              let height = img.height;
              const maxWidth = 1200;
              
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              // 調整品質以控制大小
              let quality = 0.7;
              let compressedData = canvas.toDataURL('image/jpeg', quality);
              
              // 如果還是太大，繼續降低品質
              while (compressedData.length > maxSize * 1.37 && quality > 0.1) {
                quality -= 0.1;
                compressedData = canvas.toDataURL('image/jpeg', quality);
              }
              
              if (compressedData.length > maxSize * 1.37) {
                alert('圖片太大，即使壓縮後仍超過限制，請選擇較小的圖片');
                e.target.value = null;
                return;
              }
              
              setChatFile({ name: file.name, data: compressedData });
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          // 非圖片檔案：檢查大小限制
          if (file.size > maxSize) {
            alert(`檔案過大！非圖片檔案請上傳 ${Math.round(maxSize/1024)}KB 以下的檔案。\n\n提示：建議使用雲端硬碟分享連結`);
            e.target.value = null;
            return;
          }
          const reader = new FileReader();
          reader.onloadend = () => {
            setChatFile({ name: file.name, data: reader.result });
          };
          reader.readAsDataURL(file);
        }
    }
  };

  const openAddTask = (status = 'To Do') => {
    setEditingTask(null);
    setNewTaskStatus(status);
    setIsTaskModalOpen(true);
  };

  const openEditTask = (task) => {
    setEditingTask(task);
    setIsTaskModalOpen(true);
  };

  const handleTaskSubmit = (taskData) => {
    // 檢查是否將任務狀態改為完成
    const isTaskCompleted = taskData.status === 'Done' || taskData.status === '完成';
    const wasNotCompleted = editingTask && (editingTask.status !== 'Done' && editingTask.status !== '完成');
    
    if (editingTask) {
      onUpdateTask({ ...editingTask, ...taskData });
      
      // 如果任務從未完成變成完成，顯示慶祝動畫
      if (isTaskCompleted && wasNotCompleted) {
        setCompletedTaskName(taskData.title || editingTask.title);
        setShowCelebration(true);
        // 3秒後自動關閉
        setTimeout(() => setShowCelebration(false), 3000);
      }
    } else {
      onAddTask({ ...taskData, status: newTaskStatus, projectId: project.id });
      
      // 如果新任務直接設為完成，也顯示慶祝
      if (isTaskCompleted) {
        setCompletedTaskName(taskData.title);
        setShowCelebration(true);
        setTimeout(() => setShowCelebration(false), 3000);
      }
    }
    setIsTaskModalOpen(false);
  };

  const handleGanttSubmit = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newPhase = {
      id: editingPhase ? editingPhase.id : Date.now(),
      name: formData.get('name'),
      startDate: formData.get('startDate'),
      endDate: formData.get('endDate'),
      color: formData.get('color')
    };
    
    let updatedPhases;
    if (editingPhase) {
      updatedPhases = phases.map(p => p.id === editingPhase.id ? newPhase : p);
    } else {
      updatedPhases = [...phases, newPhase];
    }
    setPhases(updatedPhases);
    onUpdateProject({ ...project, phases: updatedPhases });
    setIsGanttModalOpen(false);
  };

  if (!project) return null;

  return (
    <div className="space-y-6 animate-fade-in">
      {/* Modals */}
      <Modal isOpen={isSpecsModalOpen} onClose={() => setIsSpecsModalOpen(false)} title="編輯專案規格">
        <form onSubmit={(e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            onUpdateProject({ ...project, specs: formData.get('specs') });
            setIsSpecsModalOpen(false);
        }}>
            <textarea 
                name="specs" 
                defaultValue={project.specs} 
                className="w-full h-64 bg-white/5 border border-white/10 rounded-xl p-4 focus:ring-2 focus:ring-blue-500/50 outline-none text-white placeholder-slate-500"
                placeholder="輸入專案規格說明..."
            ></textarea>
            <div className="flex justify-end gap-3 pt-4">
                <button type="button" onClick={() => setIsSpecsModalOpen(false)} className="px-4 py-2 text-slate-400 hover:text-white transition-colors">取消</button>
                <button type="submit" className="px-5 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25">儲存</button>
            </div>
        </form>
      </Modal>

      <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={editingTask ? "編輯任務" : "新增任務"}>
        <TaskForm 
          initialData={editingTask || { title: '', status: newTaskStatus, owner: '', priority: 'P2', risk: false }} 
          onSubmit={handleTaskSubmit} 
          onCancel={() => setIsTaskModalOpen(false)} 
        />
      </Modal>

      <Modal isOpen={isChangeModalOpen} onClose={() => setIsChangeModalOpen(false)} title="新增設變紀錄 (ECO)">
        <ChangeForm onSubmit={(data) => { onAddChange({ ...data, projectId: project.id }); setIsChangeModalOpen(false); }} onCancel={() => setIsChangeModalOpen(false)} />
      </Modal>

      <Modal isOpen={isHistoryModalOpen} onClose={() => setIsHistoryModalOpen(false)} title="新增設計履歷">
        <HistoryForm onSubmit={(data) => { onAddHistory({ ...data, projectId: project.id }); setIsHistoryModalOpen(false); }} onCancel={() => setIsHistoryModalOpen(false)} />
      </Modal>

      <Modal isOpen={isMeetingModalOpen} onClose={() => { setIsMeetingModalOpen(false); setEditingMeeting(null); }} title={editingMeeting ? "編輯會議紀錄" : "新增設計會議紀錄"}>
        <MeetingForm 
          initialData={editingMeeting}
          onSubmit={(data) => { 
            if (editingMeeting) {
              onUpdateMeeting({ ...editingMeeting, ...data });
            } else {
              onAddMeeting({ ...data, projectId: project.id });
            }
            setIsMeetingModalOpen(false); 
            setEditingMeeting(null);
          }} 
          onCancel={() => { setIsMeetingModalOpen(false); setEditingMeeting(null); }} 
        />
      </Modal>

      {/* 發送通知 Modal */}
      <Modal isOpen={isNotificationModalOpen} onClose={() => setIsNotificationModalOpen(false)} title="📢 發送專案通知">
        <NotificationForm 
          project={project}
          machine={machine}
          projectTasks={tasks}
          allUsers={allUsers || []}
          currentUser={user}
          onSubmit={(data) => { 
            onAddNotification(data);
            setIsNotificationModalOpen(false);
            alert(`✅ 通知已發送給 ${data.recipients.length} 位成員！`);
          }} 
          onCancel={() => setIsNotificationModalOpen(false)} 
        />
      </Modal>

      <Modal isOpen={isGanttModalOpen} onClose={() => setIsGanttModalOpen(false)} title={editingPhase ? "編輯階段" : "新增階段"}>
        <form onSubmit={handleGanttSubmit} className="space-y-4">
          <div><label className="block text-sm font-medium mb-2 text-slate-300">階段名稱</label><input name="name" defaultValue={editingPhase?.name} required className="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 outline-none"/></div>
          <div className="grid grid-cols-2 gap-4">
            <div><label className="block text-sm font-medium mb-2 text-slate-300">開始日期</label><input type="date" name="startDate" defaultValue={editingPhase?.startDate} required className="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-white focus:ring-2 focus:ring-blue-500/50 outline-none"/></div>
            <div><label className="block text-sm font-medium mb-2 text-slate-300">結束日期</label><input type="date" name="endDate" defaultValue={editingPhase?.endDate} required className="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-white focus:ring-2 focus:ring-blue-500/50 outline-none"/></div>
          </div>
          <div>
            <label className="block text-sm font-medium mb-2 text-slate-300">顏色標記</label>
            <select name="color" defaultValue={editingPhase?.color || 'bg-blue-500'} className="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-white focus:ring-2 focus:ring-blue-500/50 outline-none">
              <option value="bg-blue-500" className="bg-slate-800">Blue</option>
              <option value="bg-emerald-500" className="bg-slate-800">Green</option>
              <option value="bg-amber-400" className="bg-slate-800">Yellow</option>
              <option value="bg-rose-500" className="bg-slate-800">Red</option>
            </select>
          </div>
          <div className="flex justify-end gap-3 pt-4">
             <button type="button" onClick={() => setIsGanttModalOpen(false)} className="px-4 py-2 text-slate-400 hover:text-white transition-colors">取消</button>
             <button type="submit" className="px-5 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25">儲存</button>
          </div>
        </form>
      </Modal>

      {/* Header - 專業深色風格 */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
        <div className="flex items-center gap-4">
          <button onClick={onBack} className="p-3 hover:bg-white/10 rounded-xl text-slate-400 hover:text-white transition-all">
            <ArrowRight size={20} className="rotate-180" />
          </button>
          <div>
            <h1 className="text-2xl font-bold text-white flex items-center gap-3">
              {project.name}
              <ProjectStatusBadge status={project.status} />
            </h1>
            <p className="text-slate-400 text-sm mt-2 flex flex-wrap gap-4">
              <span className="flex items-center gap-1.5"><UserCircle size={14} /> {project.owner}</span>
              <span className="flex items-center gap-1.5">🏢 {project.department}</span>
              <span className="flex items-center gap-1.5">📁 {project.category}</span>
            </p>
          </div>
        </div>
        <div className="flex flex-wrap gap-3">
          <button onClick={() => openAddTask('To Do')} className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all flex items-center gap-2">
            <Plus size={16} /> 新增任務
          </button>
          <button 
            onClick={() => setIsNotificationModalOpen(true)}
            className="px-4 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl text-sm font-medium hover:from-amber-600 hover:to-orange-600 shadow-lg shadow-amber-500/25 transition-all flex items-center gap-2"
          >
            <Send size={16} /> 發送通知
          </button>
          <button className="px-4 py-2.5 bg-white/5 border border-white/10 text-slate-300 rounded-xl text-sm font-medium hover:bg-white/10 transition-all">
            產生報告
          </button>
          {user?.role === 'admin' && (
            <button
              onClick={() => onDeleteProject(project.id)}
              className="px-4 py-2.5 bg-rose-500/10 border border-rose-500/20 text-rose-400 rounded-xl text-sm font-medium hover:bg-rose-500/20 flex items-center gap-2 transition-all"
            >
              <Trash2 size={16} />
              刪除專案
            </button>
          )}
        </div>
      </div>

      {/* Tabs - 深色風格 */}
      <div className="border-b border-white/10 px-2">
        <nav className="flex gap-1 overflow-x-auto">
          {['dashboard', 'kanban', 'gantt', 'meetings', 'changes', 'history', 'files'].map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`pb-3 px-4 text-sm font-medium border-b-2 transition-all whitespace-nowrap ${
                activeTab === tab 
                  ? 'border-blue-500 text-blue-400 bg-blue-500/5 rounded-t-lg' 
                  : 'border-transparent text-slate-500 hover:text-white hover:bg-white/5 rounded-t-lg'
              }`}
            >
              {tab === 'dashboard' && '📊 總覽'}
              {tab === 'kanban' && '📋 任務看板'}
              {tab === 'gantt' && '📅 甘特圖'}
              {tab === 'meetings' && '📝 會議紀錄'}
              {tab === 'changes' && '🔄 變更紀錄'}
              {tab === 'history' && '📜 設計履歷'}
              {tab === 'files' && '💬 討論檔案'}
            </button>
          ))}
        </nav>
      </div>

      {/* Tab Content */}
      <div className="min-h-[400px]">
        {activeTab === 'kanban' && (
          <>
          {/* 🔥 任務篩選器 */}
          <div className="mb-4 flex items-center gap-3 flex-wrap">
            <span className="text-sm text-slate-400">顯示：</span>
            <div className="flex gap-2 flex-wrap">
              <button
                onClick={() => setTaskViewFilter('all')}
                className={`px-4 py-2 rounded-xl text-sm font-medium transition-all ${
                  taskViewFilter === 'all'
                    ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/25'
                    : 'bg-white/5 text-slate-400 hover:bg-white/10 border border-white/10'
                }`}
              >
                <span className="flex items-center gap-2">
                  <Users size={14} /> 全部任務
                </span>
              </button>
              <div className="relative flex items-center gap-1">
                <button
                  onClick={() => {
                    setTaskViewFilter('department');
                    if (!selectedDepartment && user?.department) setSelectedDepartment(user.department);
                  }}
                  className={`px-4 py-2 rounded-l-xl text-sm font-medium transition-all ${
                    taskViewFilter === 'department'
                      ? 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white shadow-lg shadow-purple-500/25'
                      : 'bg-white/5 text-slate-400 hover:bg-white/10 border border-white/10'
                  }`}
                >
                  <span className="flex items-center gap-2">
                    <Building2 size={14} /> 部門任務
                  </span>
                </button>
                <select
                  value={selectedDepartment}
                  onChange={(e) => {
                    setSelectedDepartment(e.target.value);
                    setTaskViewFilter('department');
                  }}
                  className={`px-2 py-2 rounded-r-xl text-sm font-medium transition-all cursor-pointer ${
                    taskViewFilter === 'department'
                      ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg shadow-purple-500/25'
                      : 'bg-white/5 text-slate-400 hover:bg-white/10 border border-white/10'
                  }`}
                  style={{ minWidth: '100px' }}
                >
                  <option value="" className="bg-slate-800 text-slate-300">選擇部門</option>
                  {departmentList.map(dept => (
                    <option key={dept} value={dept} className="bg-slate-800 text-slate-300">{dept}</option>
                  ))}
                </select>
              </div>
              <button
                onClick={() => setTaskViewFilter('my')}
                className={`px-4 py-2 rounded-xl text-sm font-medium transition-all ${
                  taskViewFilter === 'my'
                    ? 'bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-lg shadow-emerald-500/25'
                    : 'bg-white/5 text-slate-400 hover:bg-white/10 border border-white/10'
                }`}
              >
                <span className="flex items-center gap-2">
                  <UserCircle size={14} /> 我的任務
                </span>
              </button>
            </div>
            <span className="text-xs text-slate-500 ml-auto">
              {taskViewFilter === 'all' ? '顯示所有任務' : taskViewFilter === 'department' ? `顯示 ${selectedDepartment || '所選部門'} 的任務` : `顯示 ${user?.displayName || user?.username || '我'} 的任務`}
            </span>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-5 h-full">
            {['To Do', 'Doing', 'Testing', 'Done'].map((status) => {
              const statusColors = {
                'To Do': { bg: 'bg-slate-500/10', border: 'border-slate-500/20', badge: 'bg-slate-500/20 text-slate-400' },
                'Doing': { bg: 'bg-blue-500/10', border: 'border-blue-500/20', badge: 'bg-blue-500/20 text-blue-400' },
                'Testing': { bg: 'bg-amber-500/10', border: 'border-amber-500/20', badge: 'bg-amber-500/20 text-amber-400' },
                'Done': { bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', badge: 'bg-emerald-500/20 text-emerald-400' }
              };
              const colors = statusColors[status];
              return (
              <div key={status} className={`${colors.bg} backdrop-blur-xl p-5 rounded-2xl border ${colors.border} h-full flex flex-col`}>
                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex justify-between items-center">
                  {status}
                  <span className={`${colors.badge} px-2.5 py-1 rounded-lg text-[11px] font-bold`}>
                    {tasks.filter(t => {
                    // 先按狀態篩選
                    if (t.status !== status) return false;
                    // 再按篩選器篩選
                    if (taskViewFilter === 'all') return true;
                    if (taskViewFilter === 'my') {
                      return t.owner === user?.displayName || t.owner === user?.username || 
                             t.assignee === user?.displayName || t.assignee === user?.username;
                    }
                    if (taskViewFilter === 'department') {
                      const taskOwnerUser = allUsers?.find(u => u.displayName === t.owner || u.username === t.owner);
                      return selectedDepartment ? taskOwnerUser?.department === selectedDepartment : taskOwnerUser?.department === user?.department;
                    }
                    return true;
                  }).length}
                  </span>
                </h3>
                <div className="space-y-3 flex-1 overflow-y-auto min-h-[200px] pr-1">
                  {tasks.filter(t => {
                    // 先按狀態篩選
                    if (t.status !== status) return false;
                    // 再按篩選器篩選
                    if (taskViewFilter === 'all') return true;
                    if (taskViewFilter === 'my') {
                      return t.owner === user?.displayName || t.owner === user?.username || 
                             t.assignee === user?.displayName || t.assignee === user?.username;
                    }
                    if (taskViewFilter === 'department') {
                      const taskOwnerUser = allUsers?.find(u => u.displayName === t.owner || u.username === t.owner);
                      return selectedDepartment ? taskOwnerUser?.department === selectedDepartment : taskOwnerUser?.department === user?.department;
                    }
                    return true;
                  }).map(task => (
                    <div 
                      key={task.id} 
                      onClick={() => openEditTask(task)}
                      className="bg-white/5 backdrop-blur p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/10 hover:border-white/20 transition-all group"
                    >
                      <div className="flex justify-between items-start mb-3">
                        <PriorityBadge priority={task.priority} />
                        <div className="flex gap-2">
                           {task.risk && <AlertCircle size={14} className="text-rose-400" />}
                           <Edit size={14} className="text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                        </div>
                      </div>
                      <h4 className="text-sm font-medium text-white mb-3">{task.title}</h4>
                      <div className="flex justify-between items-center text-xs text-slate-500">
                        <div className="flex items-center gap-1.5 bg-white/5 px-2 py-1 rounded-lg">
                          <UserCircle size={12} /> {task.owner}
                        </div>
                        <Clock size={14} className="text-slate-600" />
                      </div>
                    </div>
                  ))}
                  <button 
                    onClick={() => openAddTask(status)}
                    className="w-full py-3 border-2 border-dashed border-white/10 rounded-xl text-slate-500 text-sm hover:border-white/20 hover:text-slate-400 hover:bg-white/5 transition-all"
                  >
                    + 新增任務
                  </button>
                </div>
              </div>
            );})}
          </div>
          </>
        )}

        {activeTab === 'meetings' && (
          <div className="space-y-6">
            {/* Header */}
            <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
              <div className="flex justify-between items-center">
                <h3 className="font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl shadow-lg shadow-indigo-500/25">
                    <Users size={18} className="text-white" />
                  </div>
                  設計會議紀錄
                </h3>
                <div className="flex gap-3 items-center">
                  <span className="text-xs bg-indigo-500/20 text-indigo-400 px-3 py-1.5 rounded-lg flex items-center border border-indigo-500/20">
                    共 {meetings.length} 場會議
                  </span>
                  <button 
                    onClick={() => { setEditingMeeting(null); setIsMeetingModalOpen(true); }} 
                    className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25 transition-all"
                  >
                    <Plus size={14}/> 新增會議紀錄
                  </button>
                </div>
              </div>
            </div>

            {/* Meeting List */}
            {meetings.length === 0 ? (
              <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-12 text-center">
                <div className="w-20 h-20 rounded-2xl bg-white/5 flex items-center justify-center mx-auto mb-4">
                  <Users className="w-10 h-10 text-slate-500" />
                </div>
                <h3 className="text-lg font-bold text-slate-400 mb-2">尚無會議紀錄</h3>
                <p className="text-slate-500 mb-4">點擊上方「新增會議紀錄」按鈕來添加第一個會議</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {meetings.map((meeting) => (
                  <div 
                    key={meeting.id} 
                    className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 hover:border-white/20 hover:bg-white/10 transition-all overflow-hidden group"
                  >
                    {/* Meeting Card Header */}
                    <div className="p-5 border-b border-white/10">
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-500/25">
                            {meeting.date ? new Date(meeting.date).getDate() : '?'}
                          </div>
                          <div>
                            <h4 className="font-bold text-white text-lg">{meeting.title}</h4>
                            <div className="flex items-center gap-3 mt-1 text-xs text-slate-500">
                              <span className="flex items-center gap-1">
                                <Calendar size={12} />
                                {meeting.date}
                              </span>
                              {meeting.time && (
                                <span className="flex items-center gap-1">
                                  <Clock size={12} />
                                  {meeting.time}
                                </span>
                              )}
                              {meeting.location && (
                                <span className="flex items-center gap-1 bg-white/5 px-2 py-0.5 rounded">
                                  📍 {meeting.location}
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button 
                            onClick={() => { setEditingMeeting(meeting); setIsMeetingModalOpen(true); }}
                            className="p-2 bg-white/5 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition-all"
                            title="編輯"
                          >
                            <Edit size={14} />
                          </button>
                          <button 
                            onClick={() => onDeleteMeeting(meeting.id)}
                            className="p-2 bg-rose-500/10 hover:bg-rose-500/20 rounded-lg text-rose-400 transition-all"
                            title="刪除"
                          >
                            <Trash2 size={14} />
                          </button>
                        </div>
                      </div>

                      {/* Attendees */}
                      <div className="flex items-center gap-2 mt-3">
                        <span className="text-xs text-slate-500">出席者:</span>
                        <div className="flex flex-wrap gap-1">
                          {meeting.attendees?.split(',').slice(0, 5).map((attendee, i) => (
                            <span key={i} className="text-xs bg-white/10 text-slate-300 px-2 py-0.5 rounded-full">
                              {attendee.trim()}
                            </span>
                          ))}
                          {meeting.attendees?.split(',').length > 5 && (
                            <span className="text-xs text-slate-500">+{meeting.attendees.split(',').length - 5} 人</span>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Meeting Card Body */}
                    <div className="p-5 space-y-4 text-sm">
                      {meeting.agenda && (
                        <div>
                          <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                            <ListTodo size={12} /> 會議議程
                          </div>
                          <p className="text-slate-300 whitespace-pre-wrap bg-white/5 p-3 rounded-xl border border-white/5">{meeting.agenda}</p>
                        </div>
                      )}

                      {meeting.decisions && (
                        <div>
                          <div className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                            <CheckCircle size={12} /> 決議事項
                          </div>
                          <p className="text-slate-300 whitespace-pre-wrap bg-emerald-500/10 p-3 rounded-xl border border-emerald-500/20">{meeting.decisions}</p>
                        </div>
                      )}

                      {meeting.actionItems && (
                        <div>
                          <div className="text-xs font-bold text-amber-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                            <AlertCircle size={12} /> 待辦事項
                          </div>
                          <p className="text-slate-300 whitespace-pre-wrap bg-amber-500/10 p-3 rounded-xl border border-amber-500/20">{meeting.actionItems}</p>
                        </div>
                      )}

                      {meeting.notes && (
                        <div>
                          <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                            <FileText size={12} /> 備註
                          </div>
                          <p className="text-slate-400 whitespace-pre-wrap">{meeting.notes}</p>
                        </div>
                      )}

                      {meeting.nextMeetingDate && (
                        <div className="pt-3 border-t border-white/10">
                          <span className="text-xs text-blue-400 flex items-center gap-2">
                            <Calendar size={12} />
                            下次會議: {meeting.nextMeetingDate}
                          </span>
                        </div>
                      )}

                      {meeting.attachment && (
                        <div className="pt-3 border-t border-white/10">
                          <a 
                            href={meeting.attachment} 
                            download={meeting.fileName}
                            className="inline-flex items-center gap-2 text-xs text-cyan-400 hover:text-cyan-300 transition-colors bg-cyan-500/10 px-3 py-2 rounded-lg border border-cyan-500/20"
                          >
                            <Download size={14} />
                            {meeting.fileName || '下載附件'}
                          </a>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'changes' && (
          <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
            <div className="flex justify-between items-center mb-6">
              <h3 className="font-bold text-white flex items-center gap-3">
                <div className="p-2 bg-amber-500/20 rounded-xl">
                  <Activity size={18} className="text-amber-400" />
                </div>
                設變與異常紀錄 (Engineering Change Order)
              </h3>
              <div className="flex gap-3">
                <button onClick={() => setIsChangeModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/25">
                   <Plus size={14}/> 新增紀錄
                </button>
                <span className="text-xs bg-rose-500/20 text-rose-400 px-3 py-1.5 rounded-lg flex items-center border border-rose-500/20">本月設變: {changes.length} 件</span>
              </div>
            </div>
            <table className="w-full text-left text-sm">
              <thead className="bg-white/5 text-slate-400 text-xs uppercase tracking-wider">
                <tr>
                  <th className="px-4 py-3 rounded-l-lg">日期</th>
                  <th className="px-4 py-3">類型</th>
                  <th className="px-4 py-3">描述</th>
                  <th className="px-4 py-3">衝擊度</th>
                  <th className="px-4 py-3 rounded-r-lg">發起人</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-white/5">
                {changes.map(change => (
                  <tr key={change.id} className="hover:bg-white/5 transition-colors">
                    <td className="px-4 py-4 text-slate-400">{change.date}</td>
                    <td className="px-4 py-4">
                      <span className={`px-2.5 py-1 rounded-lg text-xs font-medium ${
                        change.type === '設計疏失' ? 'bg-rose-500/20 text-rose-400 border border-rose-500/20' : 
                        change.type === '客戶修改' ? 'bg-purple-500/20 text-purple-400 border border-purple-500/20' : 'bg-blue-500/20 text-blue-400 border border-blue-500/20'
                      }`}>
                        {change.type}
                      </span>
                    </td>
                    <td className="px-4 py-4 text-white">{change.desc}</td>
                    <td className="px-4 py-4">
                      <span className={`font-bold px-2 py-1 rounded-lg ${
                        change.impact === 'High' ? 'text-rose-400 bg-rose-500/10' : 
                        change.impact === 'Medium' ? 'text-amber-400 bg-amber-500/10' : 'text-slate-400 bg-white/5'
                      }`}>
                        {change.impact}
                      </span>
                    </td>
                    <td className="px-4 py-4 text-slate-300">{change.owner}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
            <div className="flex justify-between items-center mb-6">
              <div>
                <h3 className="font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-purple-500/20 rounded-xl">
                    <Clock size={18} className="text-purple-400" />
                  </div>
                  產品設計履歷 (Design History)
                </h3>
                <p className="text-xs text-slate-500 mt-2 ml-12">包含手動新增與任務異動自動記錄</p>
              </div>
              <button onClick={() => setIsHistoryModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:from-blue-600 hover:to-cyan-600 transition-all text-sm font-medium shadow-lg shadow-blue-500/25">
                <Plus size={16} /> 新增紀錄
              </button>
            </div>
            <div className="relative border-l-2 border-white/10 ml-3 space-y-6">
              {history.map((item) => (
                <div key={item.id} className="relative pl-8">
                  <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-900 border-2 ${
                    item.autoGenerated ? 'border-purple-500 shadow-lg shadow-purple-500/30' : 'border-blue-500 shadow-lg shadow-blue-500/30'
                  }`}></div>
                  <div className={`p-5 rounded-xl border ${
                    item.autoGenerated ? 'bg-purple-500/10 border-purple-500/20' : 'bg-white/5 border-white/10'
                  }`}>
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex items-center gap-3 flex-wrap">
                        <span className="font-bold text-blue-400 bg-blue-500/10 px-2 py-1 rounded-lg">{item.version}</span>
                        <span className="text-sm text-slate-500">
                          {item.createdAt ? new Date(item.createdAt).toLocaleString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                          }) : item.date}
                        </span>
                        {item.autoGenerated && (
                          <span className="px-2.5 py-1 bg-purple-500/20 text-purple-400 rounded-lg text-xs font-medium border border-purple-500/20">
                            🤖 自動記錄
                          </span>
                        )}
                      </div>
                      <span className={`px-3 py-1.5 rounded-lg text-xs font-medium ${
                        item.status === 'Approved' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/20' : 
                        item.status === 'Rejected' ? 'bg-rose-500/20 text-rose-400 border border-rose-500/20' : 'bg-amber-500/20 text-amber-400 border border-amber-500/20'
                      }`}>
                        {item.status}
                      </span>
                    </div>
                    <h4 className="font-bold text-white mb-2">{item.action}</h4>
                    <p className="text-sm text-slate-400 mb-4">{item.desc}</p>
                    {item.changes && item.changes.length > 0 && (
                      <div className="mb-4 p-4 bg-white/5 rounded-xl border border-white/10">
                        <p className="text-xs font-medium text-slate-400 mb-3 uppercase tracking-wider">變更詳情：</p>
                        <div className="space-y-2">
                          {item.changes.map((change, idx) => (
                            <div key={idx} className="text-xs text-slate-400 flex items-center gap-2 flex-wrap">
                              <span className="font-medium text-slate-300">{change.field}:</span>
                              <span className="line-through text-rose-400 bg-rose-500/10 px-2 py-0.5 rounded">{change.from}</span>
                              <span className="text-slate-500">→</span>
                              <span className="text-emerald-400 font-medium bg-emerald-500/10 px-2 py-0.5 rounded">{change.to}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    {item.attachment && (
                      <div className="mb-4">
                        <a href={item.attachment} download={item.fileName || 'download'} className="inline-flex items-center gap-2 px-4 py-2.5 bg-blue-500/10 text-blue-400 rounded-xl text-xs font-medium hover:bg-blue-500/20 transition-colors border border-blue-500/20">
                          <Download size={14} />
                          {item.fileName || '下載附件'}
                        </a>
                      </div>
                    )}
                    <div className="flex items-center text-xs text-slate-500">
                      <UserCircle size={14} className="mr-1.5" />
                      {item.author}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        {activeTab === 'gantt' && (() => {
             // 從任務自動產生甘特圖項目
             const getTaskColor = (status, priority) => {
               if (status === 'Done') return 'bg-emerald-500';
               if (status === 'Testing') return 'bg-purple-500';
               if (status === 'Doing') return 'bg-blue-500';
               if (priority === 'P0') return 'bg-rose-500';
               if (priority === 'P1') return 'bg-orange-500';
               return 'bg-slate-400';
             };

             const taskGanttItems = tasks
               .filter(task => task.startDate && task.endDate)
               .map(task => ({
                 id: `task-${task.id}`,
                 name: task.title,
                 startDate: task.startDate,
                 endDate: task.endDate,
                 color: getTaskColor(task.status, task.priority),
                 isTask: true,
                 status: task.status,
                 owner: task.owner
               }));

             // 合併手動新增的階段和任務
             const allGanttItems = [...phases, ...taskGanttItems];

             const allDates = allGanttItems.flatMap(p => [new Date(p.startDate), new Date(p.endDate)]);
             const minDate = allDates.length ? new Date(Math.min(...allDates)) : new Date();
             const maxDate = allDates.length ? new Date(Math.max(...allDates)) : new Date();
             minDate.setDate(minDate.getDate() - 7);
             maxDate.setDate(maxDate.getDate() + 7);
             const totalDuration = (maxDate - minDate) / (1000 * 60 * 60 * 24);
             const millisPerDay = 1000 * 60 * 60 * 24;
             const safeDurationDays = totalDuration || 1;
             const formatShort = (date) => new Date(date).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });

             const getLeftPos = (dateStr) => ((new Date(dateStr) - minDate) / (millisPerDay * safeDurationDays)) * 100;
             const getWidth = (startStr, endStr) => (((new Date(endStr) - new Date(startStr)) / millisPerDay) / safeDurationDays) * 100;

             const ticks = [];
             for (let i = 0; i <= 10; i++) {
               const d = new Date(minDate.getTime() + (safeDurationDays * (i / 10) * millisPerDay));
               ticks.push({ label: `${d.getMonth() + 1}/${d.getDate()}`, left: i * 10 });
             }

             const stats = [
               { label: '階段數', value: phases.length, hint: '手動新增' },
               { label: '任務數', value: taskGanttItems.length, hint: '自動帶入' },
               { label: '時間範圍', value: `${formatShort(minDate)} ~ ${formatShort(maxDate)}`, hint: '含緩衝期' }
             ];

             return (
               <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6 space-y-6">
                 <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                   <div>
                     <h3 className="text-xl font-bold text-white flex items-center gap-3">
                       <div className="p-2.5 bg-blue-500/20 rounded-xl">
                         <Calendar size={20} className="text-blue-400" />
                       </div>
                       專案時程甘特圖
                     </h3>
                     <p className="text-xs text-slate-400 mt-2 ml-12">任務會自動帶入甘特圖，顏色依狀態區分。點擊階段可編輯。</p>
                   </div>
                   <div className="flex flex-wrap gap-3 justify-end">
                     <button
                       onClick={() => { setEditingPhase(null); setIsGanttModalOpen(true); }}
                       className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-medium hover:from-blue-600 hover:to-cyan-600 transition-all shadow-lg shadow-blue-500/25"
                     >
                       + 新增階段
                     </button>
                     <button className="px-4 py-2.5 bg-white/5 border border-white/10 text-slate-300 rounded-xl text-sm font-medium hover:bg-white/10 transition-all">
                       匯出報表
                     </button>
                   </div>
                 </div>

                 {/* 圖例說明 - 深色主題 */}
                 <div className="flex flex-wrap gap-4 text-xs p-4 bg-white/5 rounded-xl border border-white/10">
                   <span className="text-slate-400 font-medium">任務狀態：</span>
                   <span className="flex items-center gap-1.5"><span className="w-3 h-3 rounded bg-slate-500"></span> <span className="text-slate-300">To Do</span></span>
                   <span className="flex items-center gap-1.5"><span className="w-3 h-3 rounded bg-blue-500"></span> <span className="text-slate-300">Doing</span></span>
                   <span className="flex items-center gap-1.5"><span className="w-3 h-3 rounded bg-purple-500"></span> <span className="text-slate-300">Testing</span></span>
                   <span className="flex items-center gap-1.5"><span className="w-3 h-3 rounded bg-emerald-500"></span> <span className="text-slate-300">Done</span></span>
                   <span className="text-slate-600">|</span>
                   <span className="flex items-center gap-1.5"><span className="w-3 h-3 rounded bg-rose-500"></span> <span className="text-slate-300">P0 緊急</span></span>
                   <span className="flex items-center gap-1.5"><span className="w-3 h-3 rounded bg-orange-500"></span> <span className="text-slate-300">P1 重要</span></span>
                 </div>

                 <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                   {stats.map((stat) => (
                     <div key={stat.label} className="bg-white/5 backdrop-blur rounded-xl border border-white/10 p-4 hover:border-white/20 transition-colors">
                       <p className="text-xs text-slate-500 uppercase tracking-wider">{stat.label}</p>
                       <p className="text-lg font-bold text-white mt-1">{stat.value}</p>
                       <p className="text-xs text-slate-500 mt-1">{stat.hint}</p>
                     </div>
                   ))}
                 </div>

                 <div className="relative overflow-hidden bg-white/5 backdrop-blur rounded-2xl border border-white/10 p-5">
                   <div className="flex border-b border-white/10 pb-3 mb-4">
                     <div className="w-32 text-xs text-slate-400 font-medium">項目</div>
                     <div className="flex-1 relative h-6">
                       {ticks.map((tick, idx) => (
                         <div key={idx} className="absolute text-xs text-slate-500 -translate-x-1/2" style={{ left: `${tick.left}%` }}>
                           {tick.label}
                         </div>
                       ))}
                     </div>
                   </div>

                   {/* 手動新增的階段 */}
                   {phases.length > 0 && (
                     <div className="mb-6">
                       <p className="text-xs text-slate-400 mb-3 font-medium flex items-center gap-2">
                         <span className="w-5 h-5 bg-blue-500/20 rounded flex items-center justify-center">📋</span>
                         專案階段
                       </p>
                       <div className="space-y-3">
                         {phases.map((phase) => (
                           <div
                             key={phase.id}
                             className="flex items-center gap-3 group"
                           >
                             <div className="w-32 text-xs font-semibold text-slate-300 text-right truncate flex items-center justify-end gap-1" title={phase.name}>
                               <button
                                 onClick={(e) => {
                                   e.stopPropagation();
                                   if (confirm(`確定要刪除階段「${phase.name}」嗎？`)) {
                                     const updatedPhases = phases.filter(p => p.id !== phase.id);
                                     setPhases(updatedPhases);
                                     // 🔥 同步更新到資料庫
                                     onUpdateProject({ ...project, phases: updatedPhases });
                                   }
                                 }}
                                 className="opacity-0 group-hover:opacity-100 p-1 text-rose-400 hover:bg-rose-500/10 rounded transition-all"
                                 title="刪除階段"
                               >
                                 <Trash2 size={12} />
                               </button>
                               <span 
                                 className="truncate cursor-pointer hover:text-blue-400"
                                 onClick={() => { setEditingPhase(phase); setIsGanttModalOpen(true); }}
                               >{phase.name}</span>
                             </div>
                             <div 
                               className="flex-1 h-10 bg-white/5 rounded-xl border border-white/10 relative overflow-hidden cursor-pointer hover:border-blue-500/30 transition"
                               onClick={() => { setEditingPhase(phase); setIsGanttModalOpen(true); }}
                             >
                               {ticks.map((tick, idx) => (
                                 <div
                                   key={`tick-${phase.id}-${idx}`}
                                   className="absolute top-0 bottom-0 border-l border-white/5 border-dashed"
                                   style={{ left: `${tick.left}%` }}
                                 ></div>
                               ))}
                               <div
                                 className={`absolute top-1 bottom-1 rounded-lg ${phase.color} opacity-95 flex items-center justify-center text-[11px] text-white font-semibold shadow-lg`}
                                 style={{ left: `${getLeftPos(phase.startDate)}%`, width: `${getWidth(phase.startDate, phase.endDate)}%` }}
                               >
                                 {phase.startDate} ~ {phase.endDate}
                               </div>
                             </div>
                           </div>
                         ))}
                       </div>
                     </div>
                   )}

                   {/* 任務自動帶入 */}
                   {taskGanttItems.length > 0 && (
                     <div>
                       <p className="text-xs text-slate-400 mb-3 font-medium flex items-center gap-2">
                         <span className="w-5 h-5 bg-emerald-500/20 rounded flex items-center justify-center">✅</span>
                         任務時程 (自動帶入)
                       </p>
                       <div className="space-y-3">
                         {taskGanttItems.map((item) => {
                           const originalTaskId = item.id.replace('task-', '');
                           return (
                           <div
                             key={item.id}
                             className="flex items-center gap-3 group"
                           >
                             <div className="w-32 text-xs font-semibold text-slate-300 text-right truncate flex items-center justify-end gap-1" title={item.name}>
                               <button
                                 onClick={(e) => {
                                   e.stopPropagation();
                                   if (confirm(`確定要從甘特圖移除任務「${item.name}」嗎？\n(這將清除任務的開始/結束日期，任務本身不會刪除)`)) {
                                     // 更新任務，清除日期
                                     const taskToUpdate = tasks.find(t => t.id === originalTaskId);
                                     if (taskToUpdate) {
                                       // 🔥 修正：handleUpdateTask 只需要一個參數，且必須包含 id
                                       handleUpdateTask({ ...taskToUpdate, id: originalTaskId, startDate: '', endDate: '' });
                                     }
                                   }
                                 }}
                                 className="opacity-0 group-hover:opacity-100 p-1 text-rose-400 hover:bg-rose-500/10 rounded transition-all"
                                 title="從甘特圖移除"
                               >
                                 <Trash2 size={12} />
                               </button>
                               <div className="text-right">
                                 <span className="block truncate">{item.name}</span>
                                 <span className="text-[10px] text-slate-500 font-normal">{item.owner}</span>
                               </div>
                             </div>
                             <div className="flex-1 h-10 bg-white/5 rounded-xl border border-white/10 relative overflow-hidden">
                               {ticks.map((tick, idx) => (
                                 <div
                                   key={`tick-${item.id}-${idx}`}
                                   className="absolute top-0 bottom-0 border-l border-white/5 border-dashed"
                                   style={{ left: `${tick.left}%` }}
                                 ></div>
                               ))}
                               <div
                                 className={`absolute top-1 bottom-1 rounded-2xl ${item.color} opacity-95 flex items-center justify-center text-[11px] text-white font-semibold shadow-lg`}
                                 style={{ left: `${getLeftPos(item.startDate)}%`, width: `${getWidth(item.startDate, item.endDate)}%` }}
                               >
                                 {item.status}
                               </div>
                             </div>
                           </div>
                         );})}
                       </div>
                     </div>
                   )}

                   {allGanttItems.length === 0 && (
                     <div className="text-center py-12 text-slate-400">
                       <div className="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mx-auto mb-4">
                         <Calendar size={32} className="text-slate-500" />
                       </div>
                       <p className="text-white mb-1">尚無時程資料</p>
                       <p className="text-xs text-slate-500">請新增階段或建立含日期的任務</p>
                     </div>
                   )}
                 </div>
               </div>
             );
        })()}
        
         {activeTab === 'dashboard' && (
             <div className="grid grid-cols-2 gap-5">
                <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 text-center hover:border-emerald-500/30 transition-colors group">
                    <p className="text-slate-400 mb-3 text-sm">專案健康度</p>
                    <div className="text-5xl font-bold text-emerald-400 group-hover:scale-105 transition-transform">
                       {Math.round((tasks.filter(t => t.status === 'Done').length / tasks.length) * 100) || 0}%
                    </div>
                    <div className="mt-3 h-2 bg-white/10 rounded-full overflow-hidden">
                      <div className="h-full bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full transition-all" style={{width: `${Math.round((tasks.filter(t => t.status === 'Done').length / tasks.length) * 100) || 0}%`}}></div>
                    </div>
                </div>
                 <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 text-center hover:border-blue-500/30 transition-colors group">
                    <p className="text-slate-400 mb-3 text-sm">待處理任務</p>
                    <div className="text-5xl font-bold text-white group-hover:scale-105 transition-transform">{tasks.filter(t => t.status !== 'Done').length}</div>
                    <p className="text-xs text-slate-500 mt-3">共 {tasks.length} 個任務</p>
                </div>
                
                <div className="col-span-2 bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
                    <div className="flex justify-between items-center mb-5">
                        <h3 className="font-bold text-white flex items-center gap-3">
                          <div className="p-2 bg-indigo-500/20 rounded-xl">
                            <FileText size={18} className="text-indigo-400" />
                          </div>
                          專案規格說明 (Project Specs)
                        </h3>
                        <button onClick={() => setIsSpecsModalOpen(true)} className="text-blue-400 hover:text-blue-300 text-sm font-medium flex items-center gap-2 px-3 py-2 hover:bg-blue-500/10 rounded-lg transition-all">
                            <Edit size={16} /> 編輯
                        </button>
                    </div>
                    <div className="prose max-w-none text-slate-300 whitespace-pre-wrap bg-white/5 p-5 rounded-xl border border-white/10 min-h-[100px]">
                        {project.specs || "尚無規格說明..."}
                    </div>
                </div>
             </div>
        )}
        
        {activeTab === 'files' && (
          <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 flex flex-col h-[600px]">
            {/* Chat Header */}
            <div className="p-5 border-b border-white/10 flex justify-between items-center">
              <div>
                <h3 className="font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-blue-500/20 rounded-xl">
                    <MessageSquare size={18} className="text-blue-400"/>
                  </div>
                  專案討論區
                </h3>
                <p className="text-xs text-slate-500 mt-2 ml-12">與團隊成員討論專案細節、分享檔案</p>
              </div>
              <div className="flex -space-x-2">
                {['林', '張', '陳', 'A'].map((u, i) => (
                  <div key={i} className="w-9 h-9 rounded-xl bg-gradient-to-br from-slate-600 to-slate-700 border-2 border-slate-800 flex items-center justify-center text-xs font-bold text-white shadow-lg">
                    {u}
                  </div>
                ))}
                <div className="w-9 h-9 rounded-xl bg-white/10 border-2 border-slate-800 flex items-center justify-center text-xs text-slate-400">
                  +3
                </div>
              </div>
            </div>

            {/* Messages Area - 深色主題 */}
            <div className="flex-1 overflow-y-auto p-6 space-y-5">
              {messages.map((msg) => {
                const isMe = msg.user === (user?.displayName || 'Admin User');
                return (
                <div key={msg.id} className={`flex gap-4 ${isMe ? 'flex-row-reverse' : ''}`}>
                  <div className={`w-10 h-10 rounded-xl flex-shrink-0 flex items-center justify-center font-bold text-white shadow-lg
                    ${isMe ? 'bg-gradient-to-br from-blue-500 to-cyan-500' : 'bg-gradient-to-br from-slate-600 to-slate-700'}`}>
                    {msg.avatar}
                  </div>
                  <div className={`max-w-[80%] ${isMe ? 'items-end' : 'items-start'} flex flex-col`}>
                    <div className="flex items-baseline gap-2 mb-1.5">
                      <span className="text-sm font-bold text-white">{msg.user}</span>
                      <span className="text-xs text-slate-500">{msg.role} • {msg.time}</span>
                    </div>
                    <div className={`p-4 rounded-2xl text-sm leading-relaxed
                      ${isMe 
                        ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-tr-none shadow-lg shadow-blue-500/20' 
                        : 'bg-white/10 text-slate-200 border border-white/10 rounded-tl-none'}`}>
                      {msg.content}
                    </div>
                    {msg.file && (
                      <a href={msg.fileData || '#'} download={msg.file} className={`mt-2 flex items-center gap-2 px-4 py-2.5 rounded-xl text-xs cursor-pointer transition-all
                        ${isMe ? 'bg-blue-500/20 border border-blue-500/20 text-blue-300 hover:bg-blue-500/30' : 'bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10'}`}>
                        <FileText size={14} />
                        <span className="font-medium">{msg.file}</span>
                        <Download size={14} className="ml-2 opacity-50" />
                      </a>
                    )}
                  </div>
                </div>
              )})}
            </div>

            {/* Input Area - 深色主題 */}
            <div className="p-4 bg-white/5 border-t border-white/10 rounded-b-2xl">
              {chatFile && (
                  <div className="mb-3 flex items-center gap-2 text-sm text-blue-400 bg-blue-500/10 px-4 py-2 rounded-xl w-fit border border-blue-500/20">
                      <Paperclip size={14} />
                      <span>{chatFile.name}</span>
                      <button onClick={() => setChatFile(null)} className="hover:text-rose-400 ml-2 transition-colors"><X size={14}/></button>
                  </div>
              )}
              <div className="flex gap-3">
                <label className="p-3 text-slate-400 hover:text-blue-400 hover:bg-blue-500/10 rounded-xl transition-all cursor-pointer" title="上傳檔案">
                  <Paperclip size={20} />
                  <input type="file" className="hidden" onChange={handleChatFileUpload} />
                </label>
                <div className="flex-1 relative">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={(e) => setNewMessage(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                    placeholder="輸入訊息..."
                    className="w-full pl-5 pr-14 py-3.5 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all text-white placeholder-slate-500"
                  />
                  <button 
                    onClick={handleSendMessage}
                    className={`absolute right-2 top-1/2 -translate-y-1/2 p-2.5 rounded-xl transition-all
                      ${newMessage.trim() || chatFile
                        ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/25 hover:from-blue-600 hover:to-cyan-600' 
                        : 'bg-white/10 text-slate-500 cursor-not-allowed'}`}
                    disabled={!newMessage.trim() && !chatFile}
                  >
                    <Send size={16} />
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* 🎉 任務完成慶祝彈窗 */}
      {showCelebration && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in">
          <div className="relative bg-gradient-to-br from-purple-600 via-pink-500 to-orange-500 p-1 rounded-3xl shadow-2xl animate-scale-in">
            <div className="bg-slate-900 rounded-3xl p-8 text-center relative overflow-hidden">
              {/* 背景動畫光暈 */}
              <div className="absolute inset-0 bg-gradient-to-r from-purple-500/20 via-pink-500/20 to-orange-500/20 animate-pulse"></div>
              
              {/* 主要內容 */}
              <div className="relative z-10 space-y-5">
                {/* 獎杯圖標 */}
                <div className="flex justify-center animate-bounce">
                  <div className="w-24 h-24 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-2xl shadow-yellow-500/50">
                    <svg className="w-14 h-14 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                    </svg>
                  </div>
                </div>

                {/* 慶祝文字 */}
                <div className="space-y-2">
                  <h2 className="text-4xl font-bold text-white">
                    {['🎉 太棒了！', '✨ 完美完成！', '🏆 真厲害！', '💪 做得好！', '🌟 超讚！'][Math.floor(Math.random() * 5)]}
                  </h2>
                  <p className="text-xl text-slate-300">成功完成任務</p>
                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 mt-4 border border-white/20">
                    <p className="text-lg font-medium text-white break-words">{completedTaskName}</p>
                  </div>
                </div>

                {/* 鼓勵語句 */}
                <div className="space-y-2">
                  <p className="text-base text-purple-200 font-medium">
                    {[
                      '繼續保持這個節奏！ 💯',
                      '你的效率令人驚艷！ 🚀',
                      '每一步都在進步！ ⭐',
                      '團隊因你而更強大！ 💪',
                      '成功源於堅持不懈！ 🎯'
                    ][Math.floor(Math.random() * 5)]}
                  </p>
                </div>

                {/* 關閉按鈕 */}
                <button
                  onClick={() => setShowCelebration(false)}
                  className="mt-6 px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold text-lg hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg shadow-purple-500/30 hover:shadow-xl hover:shadow-purple-500/50 transform hover:scale-105"
                >
                  繼續努力 🚀
                </button>
              </div>

              {/* 裝飾性粒子效果 */}
              <div className="absolute top-4 left-4 w-3 h-3 bg-yellow-400 rounded-full animate-ping"></div>
              <div className="absolute top-8 right-6 w-2 h-2 bg-pink-400 rounded-full animate-ping" style={{animationDelay: '0.3s'}}></div>
              <div className="absolute bottom-6 left-8 w-2 h-2 bg-purple-400 rounded-full animate-ping" style={{animationDelay: '0.6s'}}></div>
              <div className="absolute bottom-10 right-10 w-3 h-3 bg-orange-400 rounded-full animate-ping" style={{animationDelay: '0.9s'}}></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const AnalyticsView = ({ projects = [], tasks = [], changes = [] }) => {
  // ============== 實際數據計算 ==============
  
  // 1. 專案狀態統計
  const projectStats = {
    total: projects.length,
    normal: projects.filter(p => p.status === 'normal').length,
    risk: projects.filter(p => p.status === 'risk').length,
    delay: projects.filter(p => p.status === 'delay').length,
    avgProgress: projects.length > 0 
      ? Math.round(projects.reduce((sum, p) => sum + (p.progress || 0), 0) / projects.length) 
      : 0
  };

  // 2. 任務狀態統計
  const taskStats = {
    total: tasks.length,
    todo: tasks.filter(t => t.status === 'To Do').length,
    doing: tasks.filter(t => t.status === 'Doing').length,
    testing: tasks.filter(t => t.status === 'Testing').length,
    done: tasks.filter(t => t.status === 'Done').length
  };
  
  // 3. 任務完成率
  const taskCompletionRate = taskStats.total > 0 
    ? Math.round((taskStats.done / taskStats.total) * 100) 
    : 0;

  // 4. 人員任務負載分析
  const ownerTaskMap = {};
  tasks.forEach(t => {
    if (t.owner) {
      if (!ownerTaskMap[t.owner]) {
        ownerTaskMap[t.owner] = { total: 0, done: 0, doing: 0, todo: 0, overdue: 0 };
      }
      ownerTaskMap[t.owner].total++;
      if (t.status === 'Done') ownerTaskMap[t.owner].done++;
      else if (t.status === 'Doing' || t.status === 'Testing') ownerTaskMap[t.owner].doing++;
      else ownerTaskMap[t.owner].todo++;
      
      // 檢查是否逾期
      if (t.endDate && new Date(t.endDate) < new Date() && t.status !== 'Done') {
        ownerTaskMap[t.owner].overdue++;
      }
    }
  });
  
  const ownerLoadData = Object.entries(ownerTaskMap)
    .map(([name, data]) => ({
      name,
      ...data,
      completionRate: data.total > 0 ? Math.round((data.done / data.total) * 100) : 0
    }))
    .sort((a, b) => b.total - a.total)
    .slice(0, 8);

  // 5. 專案進度分佈
  const progressDistribution = [
    { name: '0-25%', value: projects.filter(p => p.progress <= 25).length, color: '#ef4444' },
    { name: '26-50%', value: projects.filter(p => p.progress > 25 && p.progress <= 50).length, color: '#f97316' },
    { name: '51-75%', value: projects.filter(p => p.progress > 50 && p.progress <= 75).length, color: '#eab308' },
    { name: '76-99%', value: projects.filter(p => p.progress > 75 && p.progress < 100).length, color: '#22c55e' },
    { name: '完成', value: projects.filter(p => p.progress === 100).length, color: '#10b981' }
  ].filter(d => d.value > 0);

  // 6. 部門專案分佈
  const deptProjectMap = {};
  projects.forEach(p => {
    const dept = p.department || '未分類';
    if (!deptProjectMap[dept]) deptProjectMap[dept] = { count: 0, progress: 0 };
    deptProjectMap[dept].count++;
    deptProjectMap[dept].progress += (p.progress || 0);
  });
  
  const deptData = Object.entries(deptProjectMap)
    .map(([name, data]) => ({
      name,
      專案數: data.count,
      平均進度: Math.round(data.progress / data.count)
    }))
    .sort((a, b) => b.專案數 - a.專案數);

  // 7. 逾期任務列表
  const overdueTasks = tasks.filter(t => {
    if (!t.endDate || t.status === 'Done') return false;
    return new Date(t.endDate) < new Date();
  }).map(t => {
    const project = projects.find(p => p.id === t.projectId);
    const daysOverdue = Math.floor((new Date() - new Date(t.endDate)) / (1000 * 60 * 60 * 24));
    return { ...t, projectName: project?.name || '未知專案', daysOverdue };
  }).sort((a, b) => b.daysOverdue - a.daysOverdue).slice(0, 10);

  // 8. 即將到期任務（7天內）
  const upcomingTasks = tasks.filter(t => {
    if (!t.endDate || t.status === 'Done') return false;
    const daysLeft = Math.floor((new Date(t.endDate) - new Date()) / (1000 * 60 * 60 * 24));
    return daysLeft >= 0 && daysLeft <= 7;
  }).map(t => {
    const project = projects.find(p => p.id === t.projectId);
    const daysLeft = Math.floor((new Date(t.endDate) - new Date()) / (1000 * 60 * 60 * 24));
    return { ...t, projectName: project?.name || '未知專案', daysLeft };
  }).sort((a, b) => a.daysLeft - b.daysLeft).slice(0, 10);

  // 9. 專案階段分佈
  const stageMap = {};
  projects.forEach(p => {
    const stage = p.stage || '未分類';
    stageMap[stage] = (stageMap[stage] || 0) + 1;
  });
  const stageData = Object.entries(stageMap).map(([name, value]) => ({ name, value }));

  // 10. 風險專案列表
  const riskProjects = projects
    .filter(p => p.status === 'risk' || p.status === 'delay')
    .map(p => {
      const projectTasks = tasks.filter(t => t.projectId === p.id);
      const completedTasks = projectTasks.filter(t => t.status === 'Done').length;
      return {
        ...p,
        taskCount: projectTasks.length,
        completedTasks,
        taskProgress: projectTasks.length > 0 ? Math.round((completedTasks / projectTasks.length) * 100) : 0
      };
    });

  // 圖表顏色
  const CHART_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

  // 空數據狀態
  if (projects.length === 0 && tasks.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-96 text-slate-400">
        <BarChart3 size={64} className="mb-4 opacity-20" />
        <p className="text-xl">尚無數據可供分析</p>
        <p className="text-sm mt-2">請先新增專案與任務</p>
      </div>
    );
  }

  return (
    <div className="space-y-6 animate-fade-in">
      {/* 頂部統計卡片 */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div className="bg-gradient-to-br from-blue-500/20 to-blue-600/10 backdrop-blur-xl p-5 rounded-2xl border border-blue-500/20">
          <div className="text-blue-400 text-sm font-medium mb-1">總專案數</div>
          <div className="text-3xl font-bold text-white">{projectStats.total}</div>
        </div>
        <div className="bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 backdrop-blur-xl p-5 rounded-2xl border border-emerald-500/20">
          <div className="text-emerald-400 text-sm font-medium mb-1">正常專案</div>
          <div className="text-3xl font-bold text-white">{projectStats.normal}</div>
        </div>
        <div className="bg-gradient-to-br from-amber-500/20 to-amber-600/10 backdrop-blur-xl p-5 rounded-2xl border border-amber-500/20">
          <div className="text-amber-400 text-sm font-medium mb-1">風險專案</div>
          <div className="text-3xl font-bold text-white">{projectStats.risk}</div>
        </div>
        <div className="bg-gradient-to-br from-rose-500/20 to-rose-600/10 backdrop-blur-xl p-5 rounded-2xl border border-rose-500/20">
          <div className="text-rose-400 text-sm font-medium mb-1">延遲專案</div>
          <div className="text-3xl font-bold text-white">{projectStats.delay}</div>
        </div>
        <div className="bg-gradient-to-br from-violet-500/20 to-violet-600/10 backdrop-blur-xl p-5 rounded-2xl border border-violet-500/20">
          <div className="text-violet-400 text-sm font-medium mb-1">總任務數</div>
          <div className="text-3xl font-bold text-white">{taskStats.total}</div>
        </div>
        <div className="bg-gradient-to-br from-cyan-500/20 to-cyan-600/10 backdrop-blur-xl p-5 rounded-2xl border border-cyan-500/20">
          <div className="text-cyan-400 text-sm font-medium mb-1">任務完成率</div>
          <div className="text-3xl font-bold text-white">{taskCompletionRate}%</div>
        </div>
      </div>

      {/* 第一行圖表 */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* 任務狀態分佈 */}
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            <div className="p-2 bg-blue-500/20 rounded-lg"><ListTodo size={18} className="text-blue-400" /></div>
            任務狀態分佈
          </h3>
          <div className="h-72">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={[
                { name: '待辦', value: taskStats.todo, fill: '#64748b' },
                { name: '進行中', value: taskStats.doing, fill: '#3b82f6' },
                { name: '測試中', value: taskStats.testing, fill: '#f59e0b' },
                { name: '已完成', value: taskStats.done, fill: '#10b981' }
              ]}>
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis dataKey="name" stroke="#94a3b8" />
                <YAxis stroke="#94a3b8" />
                <RechartsTooltip 
                  contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Bar dataKey="value" name="任務數" radius={[8, 8, 0, 0]}>
                  {[
                    { fill: '#64748b' },
                    { fill: '#3b82f6' },
                    { fill: '#f59e0b' },
                    { fill: '#10b981' }
                  ].map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.fill} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* 專案進度分佈 */}
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            <div className="p-2 bg-emerald-500/20 rounded-lg"><Target size={18} className="text-emerald-400" /></div>
            專案進度分佈
          </h3>
          <div className="h-72 flex items-center">
            {progressDistribution.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={progressDistribution}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={100}
                    paddingAngle={3}
                    dataKey="value"
                    label={({ name, value }) => `${name}: ${value}`}
                    labelLine={{ stroke: '#64748b' }}
                  >
                    {progressDistribution.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <RechartsTooltip 
                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                  />
                </PieChart>
              </ResponsiveContainer>
            ) : (
              <div className="w-full text-center text-slate-500">無專案數據</div>
            )}
          </div>
        </div>
      </div>

      {/* 人員任務負載分析 */}
      <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
        <h3 className="font-bold text-white mb-4 flex items-center gap-2">
          <div className="p-2 bg-violet-500/20 rounded-lg"><Users size={18} className="text-violet-400" /></div>
          人員任務負載分析
          <span className="ml-auto text-sm text-slate-400 font-normal">共 {Object.keys(ownerTaskMap).length} 位成員</span>
        </h3>
        {ownerLoadData.length > 0 ? (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="text-left text-slate-400 text-sm border-b border-white/10">
                  <th className="pb-3 pl-2">成員</th>
                  <th className="pb-3 text-center">總任務</th>
                  <th className="pb-3 text-center">已完成</th>
                  <th className="pb-3 text-center">進行中</th>
                  <th className="pb-3 text-center">待辦</th>
                  <th className="pb-3 text-center">逾期</th>
                  <th className="pb-3 text-center">完成率</th>
                  <th className="pb-3 pr-2">進度</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-white/5">
                {ownerLoadData.map((person, idx) => (
                  <tr key={idx} className="hover:bg-white/5 transition-colors">
                    <td className="py-3 pl-2">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white text-sm font-bold">
                          {person.name[0]}
                        </div>
                        <span className="text-white font-medium">{person.name}</span>
                      </div>
                    </td>
                    <td className="py-3 text-center text-white font-medium">{person.total}</td>
                    <td className="py-3 text-center text-emerald-400">{person.done}</td>
                    <td className="py-3 text-center text-blue-400">{person.doing}</td>
                    <td className="py-3 text-center text-slate-400">{person.todo}</td>
                    <td className="py-3 text-center">
                      {person.overdue > 0 ? (
                        <span className="text-rose-400 font-bold">{person.overdue}</span>
                      ) : (
                        <span className="text-slate-500">0</span>
                      )}
                    </td>
                    <td className="py-3 text-center">
                      <span className={`font-bold ${person.completionRate >= 80 ? 'text-emerald-400' : person.completionRate >= 50 ? 'text-amber-400' : 'text-rose-400'}`}>
                        {person.completionRate}%
                      </span>
                    </td>
                    <td className="py-3 pr-2">
                      <div className="w-24 h-2 bg-white/10 rounded-full overflow-hidden">
                        <div 
                          className={`h-full rounded-full ${person.completionRate >= 80 ? 'bg-emerald-500' : person.completionRate >= 50 ? 'bg-amber-500' : 'bg-rose-500'}`}
                          style={{ width: `${person.completionRate}%` }}
                        ></div>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div className="text-center text-slate-500 py-8">尚無任務分配數據</div>
        )}
      </div>

      {/* 第三行：逾期任務 & 即將到期 */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* 逾期任務警示 */}
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-rose-500/20">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            <div className="p-2 bg-rose-500/20 rounded-lg"><AlertCircle size={18} className="text-rose-400" /></div>
            逾期任務警示
            {overdueTasks.length > 0 && (
              <span className="ml-2 px-2 py-0.5 bg-rose-500 text-white text-xs rounded-full font-bold animate-pulse">
                {overdueTasks.length}
              </span>
            )}
          </h3>
          {overdueTasks.length > 0 ? (
            <div className="space-y-2 max-h-64 overflow-y-auto pr-2">
              {overdueTasks.map((task, idx) => (
                <div key={idx} className="p-3 bg-rose-500/10 rounded-xl border border-rose-500/20 flex items-center justify-between">
                  <div className="flex-1 min-w-0">
                    <div className="text-white font-medium truncate">{task.title}</div>
                    <div className="text-xs text-slate-400 flex items-center gap-2 mt-1">
                      <span>{task.projectName}</span>
                      <span>•</span>
                      <span>{task.owner}</span>
                    </div>
                  </div>
                  <div className="text-right ml-3">
                    <div className="text-rose-400 font-bold text-lg">+{task.daysOverdue}天</div>
                    <div className="text-xs text-slate-500">截止: {task.endDate}</div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center py-8 text-slate-500">
              <CheckCircle size={32} className="text-emerald-500 mb-2" />
              <span>太棒了！目前沒有逾期任務</span>
            </div>
          )}
        </div>

        {/* 即將到期任務 */}
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-amber-500/20">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            <div className="p-2 bg-amber-500/20 rounded-lg"><Clock size={18} className="text-amber-400" /></div>
            即將到期 (7天內)
            {upcomingTasks.length > 0 && (
              <span className="ml-2 px-2 py-0.5 bg-amber-500 text-white text-xs rounded-full font-bold">
                {upcomingTasks.length}
              </span>
            )}
          </h3>
          {upcomingTasks.length > 0 ? (
            <div className="space-y-2 max-h-64 overflow-y-auto pr-2">
              {upcomingTasks.map((task, idx) => (
                <div key={idx} className="p-3 bg-amber-500/10 rounded-xl border border-amber-500/20 flex items-center justify-between">
                  <div className="flex-1 min-w-0">
                    <div className="text-white font-medium truncate">{task.title}</div>
                    <div className="text-xs text-slate-400 flex items-center gap-2 mt-1">
                      <span>{task.projectName}</span>
                      <span>•</span>
                      <span>{task.owner}</span>
                    </div>
                  </div>
                  <div className="text-right ml-3">
                    <div className={`font-bold text-lg ${task.daysLeft <= 2 ? 'text-rose-400' : 'text-amber-400'}`}>
                      {task.daysLeft === 0 ? '今天' : `${task.daysLeft}天後`}
                    </div>
                    <div className="text-xs text-slate-500">截止: {task.endDate}</div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center py-8 text-slate-500">
              <Calendar size={32} className="text-blue-400 mb-2" />
              <span>近7天內沒有到期的任務</span>
            </div>
          )}
        </div>
      </div>

      {/* 部門與階段分析 */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* 部門專案統計 */}
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            <div className="p-2 bg-cyan-500/20 rounded-lg"><LayoutDashboard size={18} className="text-cyan-400" /></div>
            部門專案統計
          </h3>
          <div className="h-64">
            {deptData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={deptData} layout="vertical">
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" horizontal={false} />
                  <XAxis type="number" stroke="#94a3b8" />
                  <YAxis dataKey="name" type="category" width={80} stroke="#94a3b8" />
                  <RechartsTooltip 
                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                  />
                  <Legend />
                  <Bar dataKey="專案數" fill="#3b82f6" radius={[0, 4, 4, 0]} barSize={20} />
                  <Bar dataKey="平均進度" fill="#10b981" radius={[0, 4, 4, 0]} barSize={20} />
                </BarChart>
              </ResponsiveContainer>
            ) : (
              <div className="flex items-center justify-center h-full text-slate-500">無部門數據</div>
            )}
          </div>
        </div>

        {/* 專案階段分佈 */}
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            <div className="p-2 bg-purple-500/20 rounded-lg"><Activity size={18} className="text-purple-400" /></div>
            專案階段分佈
          </h3>
          <div className="h-64">
            {stageData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={stageData}
                    cx="50%"
                    cy="50%"
                    outerRadius={80}
                    dataKey="value"
                    label={({ name, value }) => `${name}: ${value}`}
                    labelLine={{ stroke: '#64748b' }}
                  >
                    {stageData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={CHART_COLORS[index % CHART_COLORS.length]} />
                    ))}
                  </Pie>
                  <RechartsTooltip 
                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                  />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            ) : (
              <div className="flex items-center justify-center h-full text-slate-500">無階段數據</div>
            )}
          </div>
        </div>
      </div>

      {/* 風險專案清單 */}
      {riskProjects.length > 0 && (
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            <div className="p-2 bg-rose-500/20 rounded-lg"><AlertTriangle size={18} className="text-rose-400" /></div>
            風險/延遲專案追蹤
            <span className="ml-2 px-2 py-0.5 bg-rose-500/20 text-rose-400 text-xs rounded-full font-bold">
              {riskProjects.length} 個專案需要關注
            </span>
          </h3>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="text-left text-slate-400 text-sm border-b border-white/10">
                  <th className="pb-3 pl-2">專案名稱</th>
                  <th className="pb-3">負責人</th>
                  <th className="pb-3">狀態</th>
                  <th className="pb-3 text-center">專案進度</th>
                  <th className="pb-3 text-center">任務進度</th>
                  <th className="pb-3">截止日期</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-white/5">
                {riskProjects.map((project, idx) => (
                  <tr key={idx} className="hover:bg-white/5 transition-colors">
                    <td className="py-3 pl-2 text-white font-medium">{project.name}</td>
                    <td className="py-3 text-slate-300">{project.owner}</td>
                    <td className="py-3">
                      <span className={`px-2 py-1 rounded-lg text-xs font-medium ${
                        project.status === 'delay' 
                          ? 'bg-rose-500/20 text-rose-400' 
                          : 'bg-amber-500/20 text-amber-400'
                      }`}>
                        {project.status === 'delay' ? '延遲' : '風險'}
                      </span>
                    </td>
                    <td className="py-3">
                      <div className="flex items-center justify-center gap-2">
                        <div className="w-20 h-2 bg-white/10 rounded-full overflow-hidden">
                          <div 
                            className={`h-full rounded-full ${project.progress >= 80 ? 'bg-emerald-500' : project.progress >= 50 ? 'bg-amber-500' : 'bg-rose-500'}`}
                            style={{ width: `${project.progress}%` }}
                          ></div>
                        </div>
                        <span className="text-sm text-slate-300">{project.progress}%</span>
                      </div>
                    </td>
                    <td className="py-3 text-center">
                      <span className="text-slate-300">{project.completedTasks}/{project.taskCount}</span>
                      <span className="text-slate-500 text-xs ml-1">({project.taskProgress}%)</span>
                    </td>
                    <td className="py-3 text-slate-400">{project.deadline || '-'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );
};

const EngineerDashboardView = ({ tasks = [], onUpdateTask, user }) => {
    const [editingTask, setEditingTask] = useState(null);
    const [highlightTaskId, setHighlightTaskId] = useState(null);

    // 🔥 檢查是否需要高亮特定任務
    useEffect(() => {
        const taskId = sessionStorage.getItem('highlightTaskId');
        if (taskId) {
            setHighlightTaskId(taskId);
            sessionStorage.removeItem('highlightTaskId');
            // 3秒後取消高亮
            setTimeout(() => setHighlightTaskId(null), 3000);
        }
    }, []);

    // Filter tasks for the current user
    const userName = user?.displayName || '陳建宏';
    const myTasks = tasks.filter(t => t.owner === userName);
    const completedTasks = myTasks.filter(t => t.status === 'Done');
    const todoTasks = myTasks.filter(t => t.status === 'To Do');
    
    const handleSaveTask = (updatedTask) => {
        onUpdateTask(updatedTask);
        setEditingTask(null);
    };

    return (
        <div className="space-y-6 animate-fade-in">
             <div className="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 text-white relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                <div className="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
                <div className="flex justify-between items-center relative z-10">
                    <div>
                        <h2 className="text-2xl font-bold mb-2">早安，{userName} ({user?.department || 'Sr. Software Engineer'})</h2>
                        <p className="opacity-80">這是你本月的績效表現與待辦事項。</p>
                    </div>
                    <div className="text-right">
                        <div className="text-4xl font-bold">
                            {myTasks.length > 0 ? Math.round((completedTasks.length / myTasks.length) * 100) : 0}
                            <span className="text-lg font-normal opacity-70">%</span>
                        </div>
                        <div className="text-xs opacity-80">任務達成率</div>
                    </div>
                </div>
             </div>
             
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-emerald-500/30 transition-all">
                    <h3 className="text-slate-400 text-sm font-medium mb-2">本月完成任務</h3>
                    <div className="text-3xl font-bold text-white">{completedTasks.length}</div>
                </div>
                <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-amber-500/30 transition-all">
                    <h3 className="text-slate-400 text-sm font-medium mb-2">待處理任務</h3>
                    <div className="text-3xl font-bold text-white">{todoTasks.length}</div>
                </div>
                <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-blue-500/30 transition-all">
                    <h3 className="text-slate-400 text-sm font-medium mb-2">總任務數</h3>
                    <div className="text-3xl font-bold text-white">{myTasks.length}</div>
                </div>
             </div>
             
             <div className="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden">
                <div className="p-4 bg-white/5 border-b border-white/10 font-bold text-white">我的任務清單 (To-Do)</div>
                <div className="divide-y divide-white/5">
                    {myTasks.length === 0 ? (
                        <div className="p-8 text-center text-slate-500">目前沒有指派給您的任務</div>
                    ) : (
                        myTasks.map(task => (
                            <div 
                                key={task.id} 
                                className={`p-4 flex items-center justify-between hover:bg-white/5 cursor-pointer transition-all ${
                                    highlightTaskId === task.id ? 'bg-blue-500/20 ring-2 ring-blue-400 animate-pulse' : ''
                                }`}
                                onClick={() => setEditingTask(task)}
                            >
                                <div className="flex items-center gap-3">
                                    <div className={`w-2 h-2 rounded-full ${task.priority === 'P1' ? 'bg-rose-500' : 'bg-blue-500'}`}></div>
                                    <span className="text-white font-medium">{task.title}</span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <span className="text-xs text-slate-500">{task.status}</span>
                                    <button className="text-slate-500 hover:text-cyan-400 transition-colors"><ArrowRight size={18}/></button>
                                </div>
                            </div>
                        ))
                    )}
                </div>
             </div>

             {/* Edit Task Modal */}
             {editingTask && (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in">
                    <div className="bg-slate-800/95 backdrop-blur-xl rounded-2xl w-full max-w-lg mx-4 overflow-hidden shadow-2xl border border-white/10">
                        <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                            <h3 className="font-bold text-white">編輯任務</h3>
                            <button onClick={() => setEditingTask(null)} className="text-slate-500 hover:text-white transition-colors">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-6">
                            <TaskForm 
                                initialData={editingTask} 
                                onSubmit={handleSaveTask} 
                                onCancel={() => setEditingTask(null)} 
                            />
                        </div>
                    </div>
                </div>
             )}
        </div>
    )
}

const HistoryForm = ({ onSubmit, onCancel }) => {
  const [formData, setFormData] = useState({
    version: '',
    date: new Date().toISOString().split('T')[0],
    createdAt: new Date().toISOString(), // 完整時間戳記
    author: '陳建宏', // Default user
    action: '',
    desc: '',
    status: 'Pending',
    attachment: null,
    fileName: ''
  });
  const [fileName, setFileName] = useState('');

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        alert("檔案過大！請上傳 10MB 以下的檔案。");
        e.target.value = null;
        return;
      }
      setFileName(file.name);
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormData(prev => ({ ...prev, attachment: reader.result, fileName: file.name }));
      };
      reader.readAsDataURL(file);
    }
  };

  const handleRemoveFile = () => {
    setFileName('');
    setFormData(prev => ({ ...prev, attachment: null, fileName: '' }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-5">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">版本號 (Version)</label>
          <input
            type="text"
            name="version"
            value={formData.version}
            onChange={handleChange}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all"
            placeholder="e.g. V1.3"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">日期 (Date)</label>
          <input
            type="date"
            name="date"
            value={formData.date}
            onChange={handleChange}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all [color-scheme:dark]"
            required
          />
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">作者 (Author)</label>
          <input
            type="text"
            name="author"
            value={formData.author}
            onChange={handleChange}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">狀態 (Status)</label>
          <select
            name="status"
            value={formData.status}
            onChange={handleChange}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all appearance-none cursor-pointer"
            style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'right 12px center', backgroundSize: '20px' }}
          >
            <option value="Pending" className="bg-slate-800">Pending</option>
            <option value="Approved" className="bg-slate-800">Approved</option>
            <option value="Rejected" className="bg-slate-800">Rejected</option>
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1">動作 (Action)</label>
        <input
          type="text"
          name="action"
          value={formData.action}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all"
          placeholder="e.g. 規格變更"
          required
        />
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1">描述 (Description)</label>
        <textarea
          name="desc"
          value={formData.desc}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all h-24 resize-none"
          placeholder="詳細描述變更內容..."
          required
        ></textarea>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-2">附件 (Attachment)</label>
        <div className="flex items-center space-x-4">
          <label className="flex items-center gap-2 cursor-pointer bg-white/5 hover:bg-white/10 text-slate-300 px-4 py-2.5 rounded-xl transition-all border border-white/10 hover:border-white/20">
            <Upload size={18} />
            <span>選擇檔案</span>
            <input type="file" onChange={handleFileChange} className="hidden" />
          </label>
          {fileName && (
            <div className="flex items-center gap-2 text-sm text-emerald-400 bg-emerald-500/20 px-3 py-1.5 rounded-full border border-emerald-500/30">
              <span>{fileName}</span>
              <button type="button" onClick={handleRemoveFile} className="hover:text-rose-400 transition-colors">
                <X size={14}/>
              </button>
            </div>
          )}
        </div>
        <p className="text-xs text-slate-500 mt-2">支援圖片與文件，最大 10MB</p>
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t border-white/10">
        <button
          type="button"
          onClick={onCancel}
          className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl transition-all"
        >
          取消
        </button>
        <button
          type="submit"
          className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg hover:shadow-blue-500/25 transition-all font-medium"
        >
          新增紀錄
        </button>
      </div>
    </form>
  );
};

// --- 設計會議紀錄表單 ---
const MeetingForm = ({ onSubmit, onCancel, initialData }) => {
  const [formData, setFormData] = useState(initialData || {
    title: '',
    date: new Date().toISOString().split('T')[0],
    time: '09:00',
    location: '',
    attendees: '',
    agenda: '',
    decisions: '',
    actionItems: '',
    notes: '',
    nextMeetingDate: '',
    attachment: null,
    fileName: ''
  });
  const [fileName, setFileName] = useState(initialData?.fileName || '');

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) {
        alert("檔案過大！請上傳 10MB 以下的檔案。");
        e.target.value = null;
        return;
      }
      setFileName(file.name);
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormData(prev => ({ ...prev, attachment: reader.result, fileName: file.name }));
      };
      reader.readAsDataURL(file);
    }
  };

  const handleRemoveFile = () => {
    setFileName('');
    setFormData(prev => ({ ...prev, attachment: null, fileName: '' }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit({
      ...formData,
      createdAt: new Date().toISOString()
    });
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-5 max-h-[70vh] overflow-y-auto pr-2">
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">會議主題 *</label>
        <input
          type="text"
          name="title"
          value={formData.title}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all"
          placeholder="例如：新產品設計評審會議"
          required
        />
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">日期 *</label>
          <input
            type="date"
            name="date"
            value={formData.date}
            onChange={handleChange}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all [color-scheme:dark]"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">時間</label>
          <input
            type="time"
            name="time"
            value={formData.time}
            onChange={handleChange}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all [color-scheme:dark]"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-1.5">地點</label>
          <input
            type="text"
            name="location"
            value={formData.location}
            onChange={handleChange}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all"
            placeholder="會議室/線上"
          />
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">出席人員 *</label>
        <input
          type="text"
          name="attendees"
          value={formData.attendees}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all"
          placeholder="以逗號分隔，例如：張三, 李四, 王五"
          required
        />
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">會議議程</label>
        <textarea
          name="agenda"
          value={formData.agenda}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all h-20 resize-none"
          placeholder="1. 議題一\n2. 議題二\n3. 議題三"
        ></textarea>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">決議事項</label>
        <textarea
          name="decisions"
          value={formData.decisions}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all h-20 resize-none"
          placeholder="列出會議中做出的重要決定..."
        ></textarea>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">待辦事項 (Action Items)</label>
        <textarea
          name="actionItems"
          value={formData.actionItems}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all h-20 resize-none"
          placeholder="1. [負責人] 待辦事項描述 - 截止日期\n2. [負責人] 待辦事項描述 - 截止日期"
        ></textarea>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">會議備註</label>
        <textarea
          name="notes"
          value={formData.notes}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all h-16 resize-none"
          placeholder="其他備註或重要記錄..."
        ></textarea>
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">下次會議日期</label>
        <input
          type="date"
          name="nextMeetingDate"
          value={formData.nextMeetingDate}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all [color-scheme:dark]"
        />
      </div>

      <div>
        <label className="block text-sm font-medium text-slate-300 mb-2">附件 (會議資料)</label>
        <div className="flex items-center space-x-4">
          <label className="flex items-center gap-2 cursor-pointer bg-white/5 hover:bg-white/10 text-slate-300 px-4 py-2.5 rounded-xl transition-all border border-white/10 hover:border-white/20">
            <Upload size={18} />
            <span>選擇檔案</span>
            <input type="file" onChange={handleFileChange} className="hidden" />
          </label>
          {fileName && (
            <div className="flex items-center gap-2 text-sm text-emerald-400 bg-emerald-500/20 px-3 py-1.5 rounded-full border border-emerald-500/30">
              <span>{fileName}</span>
              <button type="button" onClick={handleRemoveFile} className="hover:text-rose-400 transition-colors">
                <X size={14}/>
              </button>
            </div>
          )}
        </div>
        <p className="text-xs text-slate-500 mt-2">支援圖片與文件，最大 10MB</p>
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t border-white/10">
        <button
          type="button"
          onClick={onCancel}
          className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl transition-all"
        >
          取消
        </button>
        <button
          type="submit"
          className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg hover:shadow-blue-500/25 transition-all font-medium"
        >
          {initialData ? '更新紀錄' : '新增紀錄'}
        </button>
      </div>
    </form>
  );
};

// --- 專案通知表單組件 ---
const NotificationForm = ({ onSubmit, onCancel, project, machine, allUsers, currentUser, projectTasks }) => {
  const [formData, setFormData] = useState({
    title: '',
    type: 'general', // general, meeting, urgent
    content: '',
    meetingDate: '',
    meetingTime: '09:00',
    meetingLocation: '',
    recipients: [],
    taskId: '', // 🔥 關聯的任務ID
    taskName: '' // 🔥 關聯的任務名稱
  });
  const [searchTerm, setSearchTerm] = useState('');
  const [showUserDropdown, setShowUserDropdown] = useState(false);

  // 過濾可選擇的用戶
  const availableUsers = allUsers.filter(u => 
    u.displayName && 
    u.displayName.toLowerCase().includes(searchTerm.toLowerCase()) &&
    !formData.recipients.find(r => r.username === u.username)
  );

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleAddRecipient = (user) => {
    setFormData(prev => ({
      ...prev,
      recipients: [...prev.recipients, { username: user.username, displayName: user.displayName }]
    }));
    setSearchTerm('');
    setShowUserDropdown(false);
  };

  const handleRemoveRecipient = (username) => {
    setFormData(prev => ({
      ...prev,
      recipients: prev.recipients.filter(r => r.username !== username)
    }));
  };

  const handleSelectAll = () => {
    const allRecipients = allUsers
      .filter(u => u.displayName && u.username !== currentUser?.username)
      .map(u => ({ username: u.username, displayName: u.displayName }));
    setFormData(prev => ({ ...prev, recipients: allRecipients }));
  };

  const handleClearAll = () => {
    setFormData(prev => ({ ...prev, recipients: [] }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (formData.recipients.length === 0) {
      alert('請選擇至少一位通知對象');
      return;
    }
    onSubmit({
      ...formData,
      projectId: project.id,
      projectName: project.name,
      machineName: machine?.name || '未指定機台', // 🔥 使用machine.name
      sender: currentUser?.displayName || 'System',
      senderUsername: currentUser?.username || 'system',
      createdAt: new Date().toISOString(),
      isRead: {} // 各收件人已讀狀態
    });
  };

  const notificationTypes = [
    { value: 'general', label: '📢 一般通知', color: 'from-blue-500 to-cyan-500' },
    { value: 'meeting', label: '📅 開會通知', color: 'from-purple-500 to-pink-500' },
    { value: 'urgent', label: '🚨 緊急通知', color: 'from-red-500 to-orange-500' }
  ];

  return (
    <form onSubmit={handleSubmit} className="space-y-5 max-h-[70vh] overflow-y-auto pr-2">
      {/* 通知類型 */}
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-2">通知類型</label>
        <div className="grid grid-cols-3 gap-3">
          {notificationTypes.map(type => (
            <button
              key={type.value}
              type="button"
              onClick={() => setFormData(prev => ({ ...prev, type: type.value }))}
              className={`px-4 py-3 rounded-xl text-sm font-medium transition-all border ${
                formData.type === type.value
                  ? `bg-gradient-to-r ${type.color} text-white border-transparent shadow-lg`
                  : 'bg-white/5 text-slate-400 border-white/10 hover:bg-white/10'
              }`}
            >
              {type.label}
            </button>
          ))}
        </div>
      </div>

      {/* 關聯任務（可選）*/}
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">關聯任務（可選）</label>
        <select
          name="taskId"
          value={formData.taskId}
          onChange={(e) => {
            const selectedTask = projectTasks?.find(t => t.id === e.target.value);
            setFormData(prev => ({
              ...prev,
              taskId: e.target.value,
              taskName: selectedTask?.title || ''
            }));
          }}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 outline-none transition-all"
        >
          <option value="" className="bg-slate-800">無關聯任務</option>
          {projectTasks && projectTasks.map(task => (
            <option key={task.id} value={task.id} className="bg-slate-800">
              {task.title} ({task.status})
            </option>
          ))}
        </select>
        {formData.taskId && (
          <p className="text-xs text-slate-400 mt-1.5">✨ 標題將自動顯示為「{project.name} - {formData.taskName}」</p>
        )}
      </div>

      {/* 標題 */}
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">通知標題 *</label>
        <input
          type="text"
          name="title"
          value={formData.title}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all"
          placeholder={formData.taskId ? "可留空，將自動使用任務名稱" : "例如：專案進度更新通知"}
          required={!formData.taskId}
        />
      </div>

      {/* 開會通知時顯示日期時間地點 */}
      {formData.type === 'meeting' && (
        <div className="grid grid-cols-3 gap-4 p-4 bg-purple-500/10 border border-purple-500/20 rounded-xl">
          <div>
            <label className="block text-sm font-medium text-purple-300 mb-1.5">📅 會議日期 *</label>
            <input
              type="date"
              name="meetingDate"
              value={formData.meetingDate}
              onChange={handleChange}
              className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-purple-500/50 outline-none transition-all [color-scheme:dark]"
              required={formData.type === 'meeting'}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-purple-300 mb-1.5">⏰ 會議時間 *</label>
            <input
              type="time"
              name="meetingTime"
              value={formData.meetingTime}
              onChange={handleChange}
              className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-purple-500/50 outline-none transition-all [color-scheme:dark]"
              required={formData.type === 'meeting'}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-purple-300 mb-1.5">📍 會議地點</label>
            <input
              type="text"
              name="meetingLocation"
              value={formData.meetingLocation}
              onChange={handleChange}
              className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all"
              placeholder="會議室/線上連結"
            />
          </div>
        </div>
      )}

      {/* 通知內容 */}
      <div>
        <label className="block text-sm font-medium text-slate-300 mb-1.5">通知內容 *</label>
        <textarea
          name="content"
          value={formData.content}
          onChange={handleChange}
          className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none transition-all h-28 resize-none"
          placeholder={formData.type === 'meeting' 
            ? "請說明會議主題、討論事項等..."
            : "請輸入通知詳細內容..."}
          required
        ></textarea>
      </div>

      {/* 選擇收件人 */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="text-sm font-medium text-slate-300">
            選擇通知對象 * <span className="text-slate-500">（已選 {formData.recipients.length} 人）</span>
          </label>
          <div className="flex gap-2">
            {/* 🔥 專案成員快速選擇 */}
            <button 
              type="button" 
              onClick={() => {
                // 根據專案負責人和任務成員筛選
                const projectMembers = new Set();
                // 添加專案負責人
                if (project.owner) {
                  const owner = allUsers.find(u => u.displayName === project.owner);
                  if (owner) projectMembers.add(owner.username);
                }
                // 添加所有任務的負責人
                if (projectTasks && projectTasks.length > 0) {
                  projectTasks.forEach(task => {
                    if (task.owner) {
                      const taskOwner = allUsers.find(u => u.displayName === task.owner);
                      if (taskOwner) projectMembers.add(taskOwner.username);
                    }
                  });
                }
                // 轉換為 recipients 格式
                const members = allUsers.filter(u => projectMembers.has(u.username))
                  .map(u => ({ username: u.username, displayName: u.displayName }));
                setFormData(prev => ({ ...prev, recipients: members }));
              }}
              className="text-xs px-2.5 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full hover:from-purple-600 hover:to-pink-600 transition-all font-medium flex items-center gap-1"
            >
              <Users size={12} />
              專案成員
            </button>
            <button 
              type="button" 
              onClick={handleSelectAll}
              className="text-xs text-blue-400 hover:text-blue-300 transition-colors"
            >
              全選
            </button>
            <span className="text-slate-600">|</span>
            <button 
              type="button" 
              onClick={handleClearAll}
              className="text-xs text-slate-500 hover:text-slate-300 transition-colors"
            >
              清除
            </button>
          </div>
        </div>
        
        {/* 搜尋用戶 */}
        <div className="relative">
          <input
            type="text"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setShowUserDropdown(true);
            }}
            onFocus={() => setShowUserDropdown(true)}
            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 outline-none transition-all"
            placeholder="搜尋用戶名稱..."
          />
          <Search size={18} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500" />
          
          {/* 用戶下拉選單 */}
          {showUserDropdown && availableUsers.length > 0 && (
            <div className="absolute z-50 w-full mt-2 bg-slate-800 border border-white/10 rounded-xl shadow-xl max-h-48 overflow-y-auto">
              {availableUsers.slice(0, 10).map(user => (
                <button
                  key={user.username}
                  type="button"
                  onClick={() => handleAddRecipient(user)}
                  className="w-full px-4 py-3 text-left hover:bg-white/10 transition-colors flex items-center gap-3 border-b border-white/5 last:border-0"
                >
                  <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                    {user.displayName?.[0] || '?'}
                  </div>
                  <div>
                    <div className="text-white text-sm">{user.displayName}</div>
                    <div className="text-slate-500 text-xs">{user.department || '未設定部門'}</div>
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>

        {/* 已選擇的收件人 */}
        {formData.recipients.length > 0 && (
          <div className="flex flex-wrap gap-2 mt-3">
            {formData.recipients.map(r => (
              <span 
                key={r.username}
                className="inline-flex items-center gap-2 bg-blue-500/20 text-blue-300 px-3 py-1.5 rounded-full text-sm border border-blue-500/30"
              >
                <span className="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs">
                  {r.displayName?.[0] || '?'}
                </span>
                {r.displayName}
                <button 
                  type="button"
                  onClick={() => handleRemoveRecipient(r.username)}
                  className="hover:text-red-400 transition-colors"
                >
                  <X size={14} />
                </button>
              </span>
            ))}
          </div>
        )}
      </div>

      {/* 按鈕 */}
      <div className="flex justify-end gap-3 pt-4 border-t border-white/10">
        <button
          type="button"
          onClick={onCancel}
          className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl transition-all"
        >
          取消
        </button>
        <button
          type="submit"
          className={`px-5 py-2.5 text-white rounded-xl hover:shadow-lg transition-all font-medium flex items-center gap-2 ${
            formData.type === 'urgent' 
              ? 'bg-gradient-to-r from-red-500 to-orange-500 hover:shadow-red-500/25'
              : formData.type === 'meeting'
              ? 'bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-purple-500/25'
              : 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:shadow-blue-500/25'
          }`}
        >
          <Send size={16} />
          發送通知
        </button>
      </div>
    </form>
  );
};

// --- 專案規格討論歷程視圖 ---
const SpecDiscussionView = ({ machine }) => {
  const [urls, setUrls] = useState([]);
  const [isEditing, setIsEditing] = useState(false);
  const [editingUrl, setEditingUrl] = useState(null);
  const [newName, setNewName] = useState('');
  const [newUrl, setNewUrl] = useState('');
  const [newDescription, setNewDescription] = useState('');

  // 從資料庫訂閱資料
  useEffect(() => {
    const unsubscribe = db.subscribe('spec_discussion_urls', (data) => {
      setUrls(data.filter(u => u.machineId === machine.id));
    });
    return () => unsubscribe();
  }, [machine.id]);

  const handleAddUrl = async () => {
    if (!newName.trim() || !newUrl.trim()) {
      alert('請填寫名稱和網址');
      return;
    }
    try {
      const newEntry = {
        id: Date.now(),
        name: newName,
        url: newUrl,
        description: newDescription,
        machineId: machine.id,
        createdAt: new Date().toISOString()
      };
      await db.addDoc('spec_discussion_urls', newEntry);
      setNewName('');
      setNewUrl('');
      setNewDescription('');
      setIsEditing(false);
    } catch (error) {
      console.error('新增連結失敗:', error);
      alert('新增失敗，請稍後再試');
    }
  };

  const handleUpdateUrl = async (id) => {
    if (!newName.trim() || !newUrl.trim()) {
      alert('請填寫名稱和網址');
      return;
    }
    try {
      await db.updateDoc('spec_discussion_urls', id, {
        name: newName,
        url: newUrl,
        description: newDescription
      });
      setEditingUrl(null);
      setNewName('');
      setNewUrl('');
      setNewDescription('');
    } catch (error) {
      console.error('更新連結失敗:', error);
      alert('更新失敗，請稍後再試');
    }
  };

  const handleDeleteUrl = async (id) => {
    if (confirm('確定要刪除此連結嗎?')) {
      try {
        await db.deleteDoc('spec_discussion_urls', id);
      } catch (error) {
        console.error('刪除連結失敗:', error);
        alert('刪除失敗，請稍後再試');
      }
    }
  };

  const handleOpenUrl = (url) => {
    window.open(url, '_blank', 'noopener,noreferrer');
  };

  const startEdit = (urlEntry) => {
    setEditingUrl(urlEntry.id);
    setNewName(urlEntry.name);
    setNewUrl(urlEntry.url);
    setNewDescription(urlEntry.description || '');
    setIsEditing(false);
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-white flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center shadow-lg shadow-violet-500/25">
              <ExternalLink className="w-5 h-5 text-white" />
            </div>
            專案規格討論歷程
          </h1>
          <p className="text-slate-400 mt-2 ml-13">管理與訪問專案規格討論的外部連結</p>
        </div>
        <button
          onClick={() => {
            setIsEditing(!isEditing);
            setEditingUrl(null);
            setNewName('');
            setNewUrl('');
            setNewDescription('');
          }}
          className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg hover:shadow-blue-500/25 transition-all flex items-center gap-2 font-medium"
        >
          <Plus size={20} />
          新增連結
        </button>
      </div>

      {/* 新增/編輯表單 */}
      {(isEditing || editingUrl) && (
        <div className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10">
          <h3 className="text-lg font-bold text-white mb-4">
            {editingUrl ? '編輯連結' : '新增連結'}
          </h3>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-slate-300 mb-2">連結名稱</label>
              <input
                type="text"
                value={newName}
                onChange={(e) => setNewName(e.target.value)}
                placeholder="例如:主要討論區、技術規格文件等"
                className="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-300 mb-2">網址 (URL)</label>
              <input
                type="url"
                value={newUrl}
                onChange={(e) => setNewUrl(e.target.value)}
                placeholder="https://example.com"
                className="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-300 mb-2">敘述說明 (選填)</label>
              <textarea
                value={newDescription}
                onChange={(e) => setNewDescription(e.target.value)}
                placeholder="輸入連結的敘述說明，例如：此連結包含產品規格的主要討論內容..."
                rows={3}
                className="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all resize-none"
              />
            </div>
            <div className="flex gap-3 justify-end">
              <button
                onClick={() => {
                  setIsEditing(false);
                  setEditingUrl(null);
                  setNewName('');
                  setNewUrl('');
                  setNewDescription('');
                }}
                className="px-5 py-2.5 text-slate-400 hover:text-white hover:bg-white/10 rounded-xl transition-all"
              >
                取消
              </button>
              <button
                onClick={() => editingUrl ? handleUpdateUrl(editingUrl) : handleAddUrl()}
                className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg hover:shadow-blue-500/25 transition-all font-medium"
              >
                {editingUrl ? '更新' : '新增'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 連結列表 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {urls.map((urlEntry) => (
          <div
            key={urlEntry.id}
            className="bg-white/5 backdrop-blur-xl p-6 rounded-2xl border border-white/10 hover:border-white/20 hover:bg-white/10 transition-all group"
          >
            <div className="flex items-start justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-blue-500/25">
                  <LinkIcon size={20} className="text-white" />
                </div>
                <div>
                  <h3 className="font-bold text-white">{urlEntry.name}</h3>
                  <p className="text-xs text-slate-500 mt-1">
                    {new Date(urlEntry.createdAt).toLocaleDateString('zh-TW')}
                  </p>
                </div>
              </div>
            </div>
            
            {/* 敘述說明 */}
            {urlEntry.description && (
              <div className="mb-3 p-3 bg-white/5 rounded-xl border border-white/5">
                <p className="text-sm text-slate-400">{urlEntry.description}</p>
              </div>
            )}

            <div className="mb-4">
              <a
                href={urlEntry.url}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sm text-cyan-400 hover:text-cyan-300 break-all transition-colors"
              >
                {urlEntry.url}
              </a>
            </div>

            <div className="flex gap-2">
              <button
                onClick={() => handleOpenUrl(urlEntry.url)}
                className="flex-1 px-3 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg hover:shadow-blue-500/25 transition-all flex items-center justify-center gap-2 text-sm font-medium"
              >
                <ExternalLink size={16} />
                開啟連結
              </button>
              <button
                onClick={() => startEdit(urlEntry)}
                className="px-3 py-2.5 bg-white/5 border border-white/10 text-slate-400 hover:text-white hover:border-white/20 rounded-xl transition-all"
                title="編輯"
              >
                <Edit size={16} />
              </button>
              <button
                onClick={() => handleDeleteUrl(urlEntry.id)}
                className="px-3 py-2.5 bg-rose-500/10 border border-rose-500/30 text-rose-400 hover:bg-rose-500/20 rounded-xl transition-all"
                title="刪除"
              >
                <Trash2 size={16} />
              </button>
            </div>
          </div>
        ))}
      </div>

      {urls.length === 0 && !isEditing && (
        <div className="bg-white/5 backdrop-blur-xl p-12 rounded-2xl border border-white/10 text-center">
          <div className="w-20 h-20 rounded-2xl bg-white/5 flex items-center justify-center mx-auto mb-4">
            <ExternalLink className="w-10 h-10 text-slate-500" />
          </div>
          <h3 className="text-lg font-bold text-slate-400 mb-2">尚無討論連結</h3>
          <p className="text-slate-500 mb-4">點擊上方「新增連結」按鈕來添加第一個討論連結</p>
        </div>
      )}
    </div>
  );
};

// --- Main App (ProjectApp) ---

const ProjectApp = ({ machine, onBackToMachines, user }) => {
  const [currentView, setCurrentView] = useState('dashboard');
  const [selectedProject, setSelectedProject] = useState(null);
  
  // Lifted State - Initialize with filtered data
  const [projects, setProjects] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [changes, setChanges] = useState([]);
  const [history, setHistory] = useState([]);
  const [messages, setMessages] = useState([]);
  const [meetings, setMeetings] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [allUsers, setAllUsers] = useState([]);

  // Sync with DB
  useEffect(() => {
    const unsubProjects = db.subscribe('rd_projects', (data) => setProjects(data.filter(p => p.machineId === machine.id)));
    const unsubTasks = db.subscribe('rd_tasks', (data) => setTasks(data));
    const unsubChanges = db.subscribe('rd_changes', (data) => setChanges(data));
    // 訂閱 history 並按時間排序（越新的越上面）
    const unsubHistory = db.subscribe('rd_history', (data) => {
      const sortedData = [...data].sort((a, b) => {
        // 優先使用 createdAt，其次使用 date
        const timeA = new Date(a.createdAt || a.date || 0).getTime();
        const timeB = new Date(b.createdAt || b.date || 0).getTime();
        return timeB - timeA; // 降序排列（新的在前）
      });
      setHistory(sortedData);
    });
    const unsubMessages = db.subscribe('rd_messages', (data) => setMessages(data));
    // 訂閱會議紀錄
    const unsubMeetings = db.subscribe('rd_meetings', (data) => {
      const sortedData = [...data].sort((a, b) => {
        const timeA = new Date(a.date + ' ' + (a.time || '00:00')).getTime();
        const timeB = new Date(b.date + ' ' + (b.time || '00:00')).getTime();
        return timeB - timeA; // 降序排列（新的在前）
      });
      setMeetings(sortedData);
    });
    // 訂閱通知
    const unsubNotifications = db.subscribe('rd_notifications', (data) => {
      const sortedData = [...data].sort((a, b) => {
        const timeA = new Date(a.createdAt || 0).getTime();
        const timeB = new Date(b.createdAt || 0).getTime();
        return timeB - timeA;
      });
      setNotifications(sortedData);
    });
    // 訂閱用戶列表（用於通知選擇收件人）
    const unsubUsers = db.subscribe('tqm_users', (data) => setAllUsers(data));
    
    return () => {
        unsubProjects();
        unsubTasks();
        unsubChanges();
        unsubHistory();
        unsubMessages();
        unsubMeetings();
        unsubNotifications();
        unsubUsers();
    };
  }, [machine.id]);
  
  // 🔥 檢查是否有從跑馬燈點擊跳轉的專案
  useEffect(() => {
    const openProjectId = sessionStorage.getItem('openProjectId');
    
    console.log('🔍 ProjectApp 檢查 sessionStorage:', { 
      openProjectId, 
      projectsCount: projects.length,
      projectIds: projects.map(p => p.id)
    });
    
    if (openProjectId && projects.length > 0) {
      const targetProject = projects.find(p => p.id === openProjectId);
      if (targetProject) {
        setSelectedProject(targetProject);
        setCurrentView('detail');
        // 清除 sessionStorage
        sessionStorage.removeItem('openProjectId');
        console.log('🎯 自動打開專案:', targetProject.name);
      } else {
        console.warn('⚠️ 找不到專案 ID:', openProjectId);
      }
    }
  }, [projects]);

  const handleViewDetails = (project) => {
    setSelectedProject(project);
    setCurrentView('detail');
  };

  const handleAddProject = async (newProject) => {
    const projectId = await db.addDoc('rd_projects', { ...newProject, machineId: machine.id });
    
    // 🆕 自動記錄專案新增到產品履歷
    const now = new Date();
    const timestamp = now.toISOString().split('T')[0];
    const author = user?.displayName || '系統';
    
    const historyEntry = {
      version: 'Auto',
      date: timestamp,
      createdAt: now.toISOString(), // 完整時間戳記
      action: `新增專案：${newProject.name}`,
      desc: `負責人: ${newProject.owner}；類別: ${newProject.category}；狀態: ${newProject.status}；進度: ${newProject.progress}%`,
      status: 'Pending',
      author: author,
      projectId: projectId,
      autoGenerated: true
    };
    
    await db.addDoc('rd_history', historyEntry);
    console.log('✅ 自動記錄新增專案:', historyEntry);
  };

  const handleUpdateProject = async (updatedProject) => {
    // 先獲取原始專案資料以便比對變更
    const originalProject = projects.find(p => p.id === updatedProject.id);
    
    // 更新專案
    await db.updateDoc('rd_projects', updatedProject.id, updatedProject);
    
    // 🆕 自動記錄專案異動到產品履歷
    if (originalProject) {
      const changes = [];
      const now = new Date();
      const timestamp = now.toISOString().split('T')[0];
      const author = user?.displayName || '系統';
      
      // 檢測狀態變更
      if (originalProject.status !== updatedProject.status) {
        changes.push({
          field: '狀態',
          from: originalProject.status,
          to: updatedProject.status
        });
      }
      
      // 檢測負責人變更
      if (originalProject.owner !== updatedProject.owner) {
        changes.push({
          field: '負責人',
          from: originalProject.owner,
          to: updatedProject.owner
        });
      }
      
      // 檢測進度變更（變化超過5%才記錄）
      if (Math.abs((originalProject.progress || 0) - (updatedProject.progress || 0)) >= 5) {
        changes.push({
          field: '進度',
          from: `${originalProject.progress || 0}%`,
          to: `${updatedProject.progress || 0}%`
        });
      }
      
      // 檢測階段變更
      if (originalProject.stage !== updatedProject.stage) {
        changes.push({
          field: '階段',
          from: originalProject.stage,
          to: updatedProject.stage
        });
      }
      
      // 檢測名稱變更
      if (originalProject.name !== updatedProject.name) {
        changes.push({
          field: '專案名稱',
          from: originalProject.name,
          to: updatedProject.name
        });
      }
      
      // 如果有變更，自動新增履歷記錄
      if (changes.length > 0) {
        const changeDesc = changes.map(c => `${c.field}: ${c.from} → ${c.to}`).join('；');
        
        const historyEntry = {
          version: 'Auto',
          date: timestamp,
          createdAt: now.toISOString(), // 完整時間戳記
          action: `專案更新：${updatedProject.name}`,
          desc: changeDesc,
          status: 'Pending',
          author: author,
          projectId: updatedProject.id,
          autoGenerated: true,
          changes: changes
        };
        
        await db.addDoc('rd_history', historyEntry);
        console.log('✅ 自動記錄專案異動:', historyEntry);
      }
    }
  };

  const handleDeleteProject = async (projectId) => {
    if (confirm('確定要刪除此專案嗎？')) {
      await db.deleteDoc('rd_projects', projectId);
      if (selectedProject?.id === projectId) {
        setSelectedProject(null);
        setCurrentView('list');
      }
    }
  };

  const handleAddTask = async (newTask) => {
    const taskId = await db.addDoc('rd_tasks', newTask);
    
    // 🆕 自動記錄任務新增到產品履歷
    const now = new Date();
    const timestamp = now.toISOString().split('T')[0];
    const author = user?.displayName || '系統';
    
    const historyEntry = {
      version: 'Auto',
      date: timestamp,
      createdAt: now.toISOString(), // 完整時間戳記
      action: `新增任務：${newTask.title}`,
      desc: `負責人: ${newTask.owner}；優先級: ${newTask.priority}；狀態: ${newTask.status}`,
      status: 'Pending',
      author: author,
      projectId: newTask.projectId,
      taskId: taskId,
      autoGenerated: true
    };
    
    await db.addDoc('rd_history', historyEntry);
    console.log('✅ 自動記錄新增任務:', historyEntry);
  };

  const handleUpdateTask = async (updatedTask) => {
    // 先獲取原始任務資料以便比對變更
    const originalTask = tasks.find(t => t.id === updatedTask.id);
    
    // 更新任務
    await db.updateDoc('rd_tasks', updatedTask.id, updatedTask);
    
    // 🆕 自動記錄任務異動到產品履歷
    if (originalTask) {
      const changes = [];
      const now = new Date();
      const timestamp = now.toISOString().split('T')[0];
      const author = user?.displayName || '系統';
      
      // 檢測狀態變更
      if (originalTask.status !== updatedTask.status) {
        changes.push({
          field: '狀態',
          from: originalTask.status,
          to: updatedTask.status
        });
      }
      
      // 檢測負責人變更
      if (originalTask.owner !== updatedTask.owner) {
        changes.push({
          field: '負責人',
          from: originalTask.owner,
          to: updatedTask.owner
        });
      }
      
      // 檢測優先級變更
      if (originalTask.priority !== updatedTask.priority) {
        changes.push({
          field: '優先級',
          from: originalTask.priority,
          to: updatedTask.priority
        });
      }
      
      // 檢測標題變更
      if (originalTask.title !== updatedTask.title) {
        changes.push({
          field: '任務名稱',
          from: originalTask.title,
          to: updatedTask.title
        });
      }
      
      // 如果有變更，自動新增履歷記錄
      if (changes.length > 0) {
        const changeDesc = changes.map(c => `${c.field}: ${c.from} → ${c.to}`).join('；');
        const taskName = updatedTask.title || originalTask.title;
        
        const historyEntry = {
          version: 'Auto',
          date: timestamp,
          createdAt: now.toISOString(), // 完整時間戳記
          action: `任務更新：${taskName}`,
          desc: changeDesc,
          status: 'Pending',
          author: author,
          projectId: updatedTask.projectId,
          taskId: updatedTask.id,
          autoGenerated: true,
          changes: changes
        };
        
        await db.addDoc('rd_history', historyEntry);
        console.log('✅ 自動記錄任務異動:', historyEntry);
      }
    }
  };

  const handleAddChange = async (newChange) => {
    await db.addDoc('rd_changes', newChange);
  };

  const handleAddHistory = async (newHistory) => {
    await db.addDoc('rd_history', newHistory);
  };

  const handleAddMessage = async (newMessage) => {
    try {
      // 檢查訊息中的附件大小
      if (newMessage.fileData && newMessage.fileData.length > 1024 * 1024) {
        alert('附件過大！Firestore 限制單一文件 1MB，請壓縮圖片或使用較小的檔案');
        return;
      }
      await db.addDoc('rd_messages', newMessage);
    } catch (e) {
      console.error("Error adding message: ", e);
      const errMsg = e.toString();
      if (errMsg.includes('exceeds') || errMsg.includes('too large') || errMsg.includes('1048487')) {
        alert('發送失敗: 資料過大！\n\nFirestore 限制單一文件 1MB，請移除附件或使用較小的圖片');
      } else {
        alert('發送失敗: ' + errMsg);
      }
    }
  };

  // 會議紀錄處理函數
  const handleAddMeeting = async (newMeeting) => {
    try {
      await db.addDoc('rd_meetings', newMeeting);
    } catch (e) {
      console.error("Error adding meeting: ", e);
      alert('新增會議紀錄失敗: ' + e.message);
    }
  };

  const handleUpdateMeeting = async (updatedMeeting) => {
    try {
      await db.updateDoc('rd_meetings', updatedMeeting.id, updatedMeeting);
    } catch (e) {
      console.error("Error updating meeting: ", e);
      alert('更新會議紀錄失敗: ' + e.message);
    }
  };

  const handleDeleteMeeting = async (meetingId) => {
    if (confirm('確定要刪除此會議紀錄嗎？')) {
      try {
        await db.deleteDoc('rd_meetings', meetingId);
      } catch (e) {
        console.error("Error deleting meeting: ", e);
        alert('刪除會議紀錄失敗: ' + e.message);
      }
    }
  };

  // 通知處理函數
  const handleAddNotification = async (newNotification) => {
    try {
      await db.addDoc('rd_notifications', newNotification);
      console.log('✅ 通知已發送:', newNotification);
    } catch (e) {
      console.error("Error adding notification: ", e);
      alert('發送通知失敗: ' + e.message);
    }
  };

  const renderContent = () => {
    switch (currentView) {
      case 'dashboard':
        return <DashboardView projects={projects} tasks={tasks} changes={changes} history={history} onViewDetails={handleViewDetails} />;
      case 'list':
        return (
          <ProjectListView 
            projects={projects} 
            onViewDetails={handleViewDetails} 
            onAddProject={handleAddProject}
            onUpdateProject={handleUpdateProject}
            onDeleteProject={handleDeleteProject}
          />
        );
      case 'detail':
        return (
          <ProjectDetailView 
            project={selectedProject} 
            machine={machine}
            onBack={() => setCurrentView('list')} 
            tasks={tasks}
            onAddTask={handleAddTask}
            onUpdateTask={handleUpdateTask}
            changes={changes}
            onAddChange={handleAddChange}
            history={history}
            onAddHistory={handleAddHistory}
            messages={messages}
            onAddMessage={handleAddMessage}
            meetings={meetings}
            onAddMeeting={handleAddMeeting}
            onUpdateMeeting={handleUpdateMeeting}
            onDeleteMeeting={handleDeleteMeeting}
            notifications={notifications}
            onAddNotification={handleAddNotification}
            allUsers={allUsers}
            onUpdateProject={handleUpdateProject}
            onDeleteProject={handleDeleteProject}
            user={user}
          />
        );
      case 'analytics':
        return <AnalyticsView projects={projects} tasks={tasks} changes={changes} />;
      case 'spec-discussion':
        return <SpecDiscussionView machine={machine} />;
      case 'engineer':
        return <EngineerDashboardView tasks={tasks} onUpdateTask={handleUpdateTask} user={user} />;
      default:
        return <DashboardView projects={projects} tasks={tasks} changes={changes} onViewDetails={handleViewDetails} />;
    }
  };

  const NavItem = ({ id, icon: Icon, label }) => {
    const isActive = currentView === id || (currentView === 'detail' && id === 'list');
    return (
      <button
        onClick={() => setCurrentView(id)}
        className={`w-full flex items-center px-4 py-3.5 mb-2 rounded-xl transition-all duration-200 group ${
          isActive
            ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/25' 
            : 'text-slate-400 hover:bg-white/10 hover:text-white'
        }`}
      >
        <div className={`p-2 rounded-lg mr-3 transition-all ${
          isActive ? 'bg-white/20' : 'bg-white/5 group-hover:bg-white/10'
        }`}>
          <Icon size={18} className={isActive ? 'text-white' : 'text-slate-400 group-hover:text-white'} />
        </div>
        <span className="font-medium text-sm">{label}</span>
        {isActive && <ChevronRight size={16} className="ml-auto" />}
      </button>
    );
  };

  return (
    <div className="flex h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-800 font-sans">
      {/* 背景裝飾 */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-0 right-0 w-96 h-96 bg-blue-500/5 rounded-full blur-3xl"></div>
        <div className="absolute bottom-0 left-0 w-96 h-96 bg-purple-500/5 rounded-full blur-3xl"></div>
      </div>

      {/* Sidebar - 深色玻璃效果 */}
      <aside className="w-72 bg-white/5 backdrop-blur-xl border-r border-white/10 hidden md:flex flex-col relative z-10">
        <div className="p-6 border-b border-white/10">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
              <Activity size={24} />
            </div>
            <div>
              <div className="font-bold text-xl text-white">R&D Nexus</div>
              <p className="text-xs text-slate-400">研發進度追蹤系統</p>
            </div>
          </div>
          {machine && (
             <div className="mt-5 p-4 bg-white/5 backdrop-blur rounded-2xl border border-white/10">
                <div className="text-xs text-slate-500 mb-1.5 font-medium uppercase tracking-wider">目前機台</div>
                <div className="font-bold text-white flex items-center gap-2">
                   <div className="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse shadow-lg shadow-emerald-500/50"></div>
                   {machine.name}
                </div>
                <div className="text-xs text-slate-500 mt-1 font-mono">CODE: {machine.code}</div>
             </div>
          )}
        </div>

        <nav className="flex-1 px-3 py-6 overflow-y-auto">
          <div className="mb-8">
            <p className="px-4 text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">管理中心</p>
            <NavItem id="dashboard" icon={LayoutDashboard} label="總覽儀表板" />
            <NavItem id="list" icon={ListTodo} label="專案列表" />
            <NavItem id="analytics" icon={BarChart3} label="分析報告" />
            <NavItem id="spec-discussion" icon={ExternalLink} label="專案規格討論歷程" />
          </div>
          
          <div className="mb-8">
            <p className="px-4 text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">個人專區</p>
            <NavItem id="engineer" icon={UserCircle} label="我的績效與任務" />
          </div>
        </nav>

        <div className="p-4 border-t border-white/10">
          <button className="flex items-center px-4 py-3 text-slate-400 hover:text-white w-full rounded-xl hover:bg-white/10 transition-all group">
            <Settings size={20} className="mr-3 group-hover:rotate-90 transition-transform duration-300" />
            <span className="font-medium text-sm">系統設定</span>
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col h-screen overflow-hidden relative z-10">
        {/* Header (Mobile Only / Utility) */}
        <header className="h-16 bg-white/5 backdrop-blur-xl border-b border-white/10 flex items-center justify-between px-6 md:hidden relative z-30">
          <div className="font-bold text-lg text-white">R&D Nexus</div>
          <button className="p-2 text-slate-400 hover:bg-white/10 rounded-lg"><MoreVertical /></button>
        </header>
        
        <header className="hidden md:flex h-20 bg-white/5 backdrop-blur-xl border-b border-white/10 items-center justify-between px-8 relative z-20">
            <div className="flex items-center gap-4 text-slate-400 text-sm">
                <div className="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-xl border border-white/10">
                  <Clock size={16} />
                  <span>最後更新時間: {new Date().toLocaleString('zh-TW')}</span>
                </div>
                <button className="text-blue-400 hover:text-blue-300 font-medium flex items-center gap-1 px-3 py-2 hover:bg-blue-500/10 rounded-lg transition-colors">
                  <RefreshCw size={14} />
                  重新整理
                </button>
            </div>
            <div className="flex items-center gap-5">
                 <div className="flex items-center gap-3 px-4 py-2 bg-white/5 rounded-xl border border-white/10">
                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold text-sm shadow-lg shadow-indigo-500/30">
                       {user?.displayName?.[0] || 'A'}
                    </div>
                    <div className="text-sm">
                       <p className="font-bold text-white">{user?.displayName || 'Admin User'}</p>
                       <p className="text-xs text-slate-500">{user?.department || '研發部經理'}</p>
                    </div>
                 </div>
                 <button onClick={onBackToMachines} className="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-xl text-sm transition-all backdrop-blur border border-white/10 font-medium">
                    <LogOut size={16} /> 返回機台選擇
                 </button>
            </div>
        </header>

        {/* Scrollable Area */}
        <div className="flex-1 overflow-y-auto p-4 md:p-8">
          <div className="max-w-7xl mx-auto animate-fadeIn">
            {renderContent()}
          </div>
        </div>
      </main>
    </div>
  );
};

// --- KPI Report System (整合專案與KPI報告) ---
const KPIReportSystem = ({ onBackToMenu, user }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [projects, setProjects] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [tqmRecords, setTqmRecords] = useState([]);
  const [kpiData, setKpiData] = useState([]);
  const [selectedMonth, setSelectedMonth] = useState(`${new Date().getMonth() + 1}月`);
  const [selectedDept, setSelectedDept] = useState('研發部');
  const [viewMode, setViewMode] = useState('current'); // current, history, analysis
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [selectedQuarter, setSelectedQuarter] = useState('Q1');
  
  // 歷史評分記錄 (模擬數據,實際應從資料庫讀取)
  const [historyScores, setHistoryScores] = useState([
    { month: '1月', year: 2024, tqm: 85, kpi: 78, project: 82, budget: 90, cost: 88, total: 84.1, grade: 'B' },
    { month: '2月', year: 2024, tqm: 88, kpi: 82, project: 85, budget: 92, cost: 90, total: 86.8, grade: 'B' },
    { month: '3月', year: 2024, tqm: 90, kpi: 85, project: 88, budget: 95, cost: 92, total: 89.2, grade: 'B' },
    { month: '4月', year: 2024, tqm: 82, kpi: 80, project: 78, budget: 88, cost: 85, total: 82.1, grade: 'B' },
    { month: '5月', year: 2024, tqm: 86, kpi: 83, project: 84, budget: 91, cost: 89, total: 85.9, grade: 'B' },
    { month: '6月', year: 2024, tqm: 89, kpi: 86, project: 87, budget: 94, cost: 91, total: 88.5, grade: 'B' },
    { month: '7月', year: 2024, tqm: 75, kpi: 72, project: 70, budget: 85, cost: 80, total: 75.3, grade: 'C' },
    { month: '8月', year: 2024, tqm: 78, kpi: 75, project: 73, budget: 87, cost: 82, total: 77.8, grade: 'C' },
    { month: '9月', year: 2024, tqm: 83, kpi: 79, project: 81, budget: 89, cost: 86, total: 83.2, grade: 'B' },
    { month: '10月', year: 2024, tqm: 87, kpi: 84, project: 86, budget: 93, cost: 90, total: 87.4, grade: 'B' },
    { month: '11月', year: 2024, tqm: 91, kpi: 88, project: 90, budget: 96, cost: 94, total: 91.1, grade: 'A' },
    { month: '12月', year: 2024, tqm: 60, kpi: 0, project: 0, budget: 100, cost: 67, total: 37.0, grade: 'F' },
  ]);
  
  // 新增：每月預算記錄 (存入資料庫)
  const [monthlyBudgets, setMonthlyBudgets] = useState([]);
  
  // 新增：每月成本記錄 (存入資料庫)
  const [monthlyCosts, setMonthlyCosts] = useState([]);
  
  // 預設年度預算 (用於新增月份時的參考值)
  const [defaultYearlyBudget, setDefaultYearlyBudget] = useState(10000000);

  const [showAddBudget, setShowAddBudget] = useState(false);
  const [showAddProduct, setShowAddProduct] = useState(false);
  const [newProduct, setNewProduct] = useState({ productName: '', salesPrice: '', cost: '' });
  const [editingBudget, setEditingBudget] = useState(false);
  const [editingCost, setEditingCost] = useState(false);

  // 訂閱數據
  useEffect(() => {
    const unsubProjects = db.subscribe('rd_projects', (data) => {
      console.log('🔍 KPI Report: 載入 rd_projects 資料', data);
      setProjects(data);
    });
    const unsubTasks = db.subscribe('rd_tasks', setTasks);
    const unsubTqm = db.subscribe('tqm_records', setTqmRecords);
    // 直接從 KPI 績效系統資料庫抓取
    const unsubKpi = db.subscribe('kpi_performance', (data) => {
      // KPI 系統的數據格式: { name, department, month, metrics: [{name, target, actual, status}] }
      console.log('🔍 KPI Report: 載入 kpi_performance 資料', data);
      setKpiData(data || []);
    });
    // 訂閱每月預算記錄
    const unsubBudget = db.subscribe('monthly_budgets', setMonthlyBudgets);
    // 訂閱每月成本記錄
    const unsubCost = db.subscribe('monthly_costs', setMonthlyCosts);
    
    return () => { 
      unsubProjects(); 
      unsubTasks(); 
      unsubTqm(); 
      unsubKpi(); 
      unsubBudget();
      unsubCost();
    };
  }, []);

  // 根據選擇的月份篩選數據
  const filteredTqmRecords = useMemo(() => {
    if (!selectedMonth) return tqmRecords;
    const month = parseInt(selectedMonth.replace('月', ''));
    return tqmRecords.filter(record => {
      if (!record.date) return false;
      const recordDate = new Date(record.date);
      const recordYear = recordDate.getFullYear();
      const recordMonth = recordDate.getMonth() + 1;
      return recordYear === selectedYear && recordMonth === month;
    });
  }, [tqmRecords, selectedMonth, selectedYear]);

  const filteredKpiData = useMemo(() => {
    if (!selectedMonth) return kpiData;
    const month = parseInt(selectedMonth.replace('月', ''));
    
    // Debug: 列印所有 KPI 數據
    console.log('所有 KPI 數據:', kpiData);
    console.log('篩選條件 - 月份:', month, '年份:', selectedYear);
    
    const filtered = kpiData.filter(record => {
      // KPI 系統使用 month 字段 (e.g., "11月")
      if (record.month) {
        const recordMonth = parseInt(record.month.replace('月', ''));
        console.log('KPI 記錄:', record.name, 'Month:', record.month, '解析後:', recordMonth);
        // KPI 系統通常沒有年份欄位,所以只比對月份即可
        return recordMonth === month;
      }
      // 如果有 date 字段則使用 date
      if (record.date) {
        const recordDate = new Date(record.date);
        const recordYear = recordDate.getFullYear();
        const recordMonth = recordDate.getMonth() + 1;
        return recordYear === selectedYear && recordMonth === month;
      }
      return false;
    });
    
    console.log('篩選後的 KPI 數據:', filtered);
    return filtered;
  }, [kpiData, selectedMonth, selectedYear]);

  const filteredProjects = useMemo(() => {
    if (!selectedMonth) return projects;
    const month = parseInt(selectedMonth.replace('月', ''));
    
    console.log('篩選專案 - 月份:', month, '年份:', selectedYear);
    console.log('所有專案:', projects);
    console.log('專案詳細資料:', JSON.stringify(projects, null, 2));
    
    const filtered = projects.filter(project => {
      console.log('檢查專案:', project.name || project.id, {
        confirmDate: project.confirmDate,
        deadline: project.deadline,
        status: project.status
      });
      
      // 優先使用 confirmDate (確認日期)
      if (project.confirmDate) {
        const confirmDate = new Date(project.confirmDate);
        const confirmYear = confirmDate.getFullYear();
        const confirmMonth = confirmDate.getMonth() + 1;
        
        console.log('  → 確認日期檢查:', {
          confirmDate: project.confirmDate,
          confirmMonth,
          selectedMonth: month,
          isMatch: confirmYear === selectedYear && confirmMonth === month
        });
        
        return confirmYear === selectedYear && confirmMonth === month;
      }
      
      // 如果沒有 confirmDate，使用 deadline (截止日期)
      if (project.deadline) {
        const deadlineDate = new Date(project.deadline);
        const deadlineYear = deadlineDate.getFullYear();
        const deadlineMonth = deadlineDate.getMonth() + 1;
        
        console.log('  → 截止日期檢查:', {
          deadline: project.deadline,
          deadlineMonth,
          selectedMonth: month,
          isMatch: deadlineYear === selectedYear && deadlineMonth === month
        });
        
        return deadlineYear === selectedYear && deadlineMonth === month;
      }
      
      // 沒有任何日期資訊的專案不顯示
      console.log('  → 沒有日期資訊，不顯示');
      return false;
    });
    
    console.log('篩選後的專案:', filtered);
    return filtered;
  }, [projects, selectedMonth, selectedYear]);

  // 過濾每月預算數據
  const filteredMonthlyBudgets = useMemo(() => {
    if (!selectedMonth) return monthlyBudgets;
    const month = parseInt(selectedMonth.replace('月', ''));
    return monthlyBudgets.filter(budget => {
      return budget.year === selectedYear && budget.month === month;
    });
  }, [monthlyBudgets, selectedMonth, selectedYear]);

  // 過濾每月成本數據
  const filteredMonthlyCosts = useMemo(() => {
    if (!selectedMonth) return monthlyCosts;
    const month = parseInt(selectedMonth.replace('月', ''));
    return monthlyCosts.filter(cost => {
      return cost.year === selectedYear && cost.month === month;
    });
  }, [monthlyCosts, selectedMonth, selectedYear]);

  // 計算 TQM 品質分數 (20%)
  const calculateTQMScore = useMemo(() => {
    if (filteredTqmRecords.length === 0) return { score: 0, weight: 20, weightedScore: 0, details: { total: 0, improved: 0, improveRate: 0, pending: 0, notStarted: 0, penalty: 0, finalScore: 0 } };
    // 根據改善狀態計分
    const improvedRecords = filteredTqmRecords.filter(r => r.status === '已改善').length;
    const totalRecords = filteredTqmRecords.length;
    const improveRate = (improvedRecords / totalRecords) * 100;
    
    // 分數計算：改善率越高分數越高
    let baseScore = 100;
    if (improveRate < 60) baseScore = 60;
    else if (improveRate < 70) baseScore = 70;
    else if (improveRate < 80) baseScore = 80;
    else if (improveRate < 90) baseScore = 90;
    else baseScore = 100;
    
    // 🆕 異常數量懲罰機制：每月異常數超過6件，每多1件扣2分，最多扣20分
    const abnormalThreshold = 6;
    let penalty = 0;
    if (totalRecords > abnormalThreshold) {
      const excessCount = totalRecords - abnormalThreshold;
      penalty = Math.min(excessCount * 2, 20); // 每件扣2分，最多扣20分
    }
    
    // 最終分數 = 基礎分數 - 異常數量懲罰
    const finalScore = Math.max(baseScore - penalty, 0);
    
    return {
      score: finalScore,
      weight: 20,
      weightedScore: (finalScore * 0.2).toFixed(1),
      details: {
        total: totalRecords,
        improved: improvedRecords,
        improveRate: improveRate.toFixed(1),
        pending: filteredTqmRecords.filter(r => r.status === '處理中').length,
        notStarted: filteredTqmRecords.filter(r => r.status === '未處理').length,
        baseScore: baseScore,
        penalty: penalty,
        finalScore: finalScore
      }
    };
  }, [filteredTqmRecords]);

  // 計算 KPI 績效分數 (20%)
  const calculateKPIScore = useMemo(() => {
    if (filteredKpiData.length === 0) return { score: 0, weight: 20, weightedScore: 0, details: { total: 0, achieved: 0, achieveRate: 0, missed: 0 } };
    
    // 計算所有 KPI 指標達成率
    const allMetrics = filteredKpiData.flatMap(d => d.metrics || []);
    if (allMetrics.length === 0) return { score: 0, weight: 20, weightedScore: 0, details: { total: 0, achieved: 0, achieveRate: 0, missed: 0 } };
    
    const achievedMetrics = allMetrics.filter(m => m.status === 'Achieved').length;
    const achieveRate = (achievedMetrics / allMetrics.length) * 100;
    
    // 分數對應
    let score = Math.round(achieveRate);
    
    return {
      score,
      weight: 20,
      weightedScore: (score * 0.2).toFixed(1),
      details: {
        total: allMetrics.length,
        achieved: achievedMetrics,
        achieveRate: achieveRate.toFixed(1),
        missed: allMetrics.filter(m => m.status === 'Missed').length
      }
    };
  }, [filteredKpiData]);

  // 🔥 新版：計算專案進度KPI分數 (30%)
  // 根據 R&D Nexus 專案資料計算每月預期進度與實際達成率
  const calculateProjectScore = useMemo(() => {
    // 使用所有專案來計算（不只是當月的）
    const activeProjects = projects.filter(p => 
      p.status !== 'Completed' && p.status !== 'Cancelled' && 
      p.startDate && p.deadline
    );
    
    if (activeProjects.length === 0 && projects.length === 0) {
      return { 
        score: 0, 
        weight: 30, 
        weightedScore: 0, 
        details: { 
          total: 0, 
          projectsAnalyzed: 0,
          avgExpectedProgress: 0,
          avgActualProgress: 0,
          avgAchieveRate: 0,
          onTrackCount: 0,
          behindCount: 0,
          aheadCount: 0,
          completedCount: 0,
          projectDetails: []
        } 
      };
    }
    
    const currentMonth = parseInt(selectedMonth.replace('月', ''));
    const currentYear = selectedYear;
    
    // 計算當月月底日期
    const monthEndDate = new Date(currentYear, currentMonth, 0); // 當月最後一天
    const today = new Date();
    const evaluationDate = monthEndDate < today ? monthEndDate : today;
    
    let projectDetails = [];
    let totalExpectedProgress = 0;
    let totalActualProgress = 0;
    let onTrackCount = 0;
    let behindCount = 0;
    let aheadCount = 0;
    let completedCount = 0;
    
    // 分析所有專案
    projects.forEach(project => {
      // 🔥 智能取得開始日期：優先使用 startDate，否則用 createdAt，最後用截止日期往前推30天
      let startDate = null;
      if (project.startDate) {
        startDate = new Date(project.startDate);
      } else if (project.createdAt) {
        startDate = new Date(project.createdAt);
      }
      
      const deadline = project.deadline ? new Date(project.deadline) : null;
      const actualProgress = Math.min(Math.max(parseFloat(project.progress) || 0, 0), 100);
      
      // 已完成的專案
      if (project.status === 'Completed') {
        completedCount++;
        projectDetails.push({
          name: project.name,
          code: project.code || '-',
          status: 'completed',
          expectedProgress: 100,
          actualProgress: 100,
          achieveRate: 100,
          deviation: 0,
          statusText: '✅ 已完成'
        });
        totalExpectedProgress += 100;
        totalActualProgress += 100;
        onTrackCount++;
        return;
      }
      
      // 如果沒有截止日期，跳過計算
      if (!deadline) {
        projectDetails.push({
          name: project.name,
          code: project.code || '-',
          status: 'no-date',
          expectedProgress: '-',
          actualProgress: actualProgress,
          achieveRate: '-',
          deviation: '-',
          statusText: '⚠️ 缺少截止日期'
        });
        return;
      }
      
      // 如果沒有開始日期，使用截止日期往前推60天作為預設開始日期
      if (!startDate) {
        startDate = new Date(deadline);
        startDate.setDate(startDate.getDate() - 60);
      }
      
      // 計算專案總天數
      const totalDays = Math.max(1, (deadline - startDate) / (1000 * 60 * 60 * 24));
      
      // 計算到當月底為止應經過的天數
      let elapsedDays = 0;
      if (evaluationDate >= deadline) {
        // 已過截止日期
        elapsedDays = totalDays;
      } else if (evaluationDate <= startDate) {
        // 尚未開始
        elapsedDays = 0;
      } else {
        elapsedDays = (evaluationDate - startDate) / (1000 * 60 * 60 * 24);
      }
      
      // 計算當月底預期進度百分比
      const expectedProgress = Math.min(100, Math.max(0, (elapsedDays / totalDays) * 100));
      
      // 計算達成率（實際進度 / 預期進度）
      let achieveRate = 0;
      if (expectedProgress > 0) {
        achieveRate = Math.min(150, (actualProgress / expectedProgress) * 100);
      } else if (actualProgress > 0) {
        achieveRate = 150; // 還沒到預期時間但已有進度
      } else {
        achieveRate = 100; // 都是 0
      }
      
      // 進度偏差
      const deviation = actualProgress - expectedProgress;
      
      // 判斷狀態
      let status = 'on-track';
      let statusText = '🟢 進度正常';
      
      if (achieveRate >= 110) {
        status = 'ahead';
        statusText = '🔵 超前進度';
        aheadCount++;
      } else if (achieveRate >= 90) {
        status = 'on-track';
        statusText = '🟢 進度正常';
        onTrackCount++;
      } else if (achieveRate >= 70) {
        status = 'slight-behind';
        statusText = '🟡 稍微落後';
        behindCount++;
      } else {
        status = 'behind';
        statusText = '🔴 進度落後';
        behindCount++;
      }
      
      projectDetails.push({
        name: project.name,
        code: project.code || '-',
        status,
        startDate: project.startDate,
        deadline: project.deadline,
        expectedProgress: expectedProgress.toFixed(1),
        actualProgress: actualProgress.toFixed(1),
        achieveRate: achieveRate.toFixed(1),
        deviation: deviation.toFixed(1),
        statusText
      });
      
      totalExpectedProgress += expectedProgress;
      totalActualProgress += actualProgress;
    });
    
    // 計算有效分析的專案數
    const analyzedProjects = projectDetails.filter(p => p.status !== 'no-date');
    const projectsAnalyzed = analyzedProjects.length;
    
    // 計算平均值
    const avgExpectedProgress = projectsAnalyzed > 0 ? totalExpectedProgress / projectsAnalyzed : 0;
    const avgActualProgress = projectsAnalyzed > 0 ? totalActualProgress / projectsAnalyzed : 0;
    const avgAchieveRate = avgExpectedProgress > 0 
      ? Math.min(150, (avgActualProgress / avgExpectedProgress) * 100) 
      : 100;
    
    // 計算KPI分數 (滿分100分)
    // 評分標準：
    // - 基礎分：平均達成率轉換 (0-80分)
    // - 進度正常/超前獎勵 (0-20分)
    let baseScore = 0;
    if (avgAchieveRate >= 100) {
      baseScore = 80; // 達標得滿分基礎分
    } else if (avgAchieveRate >= 90) {
      baseScore = 70 + (avgAchieveRate - 90);
    } else if (avgAchieveRate >= 70) {
      baseScore = 50 + (avgAchieveRate - 70);
    } else if (avgAchieveRate >= 50) {
      baseScore = 30 + (avgAchieveRate - 50);
    } else {
      baseScore = avgAchieveRate * 0.6;
    }
    
    // 進度狀態獎勵分數
    const onTrackRatio = projectsAnalyzed > 0 ? (onTrackCount + aheadCount) / projectsAnalyzed : 0;
    const bonusScore = onTrackRatio * 20;
    
    const score = Math.min(100, Math.round(baseScore + bonusScore));
    
    return {
      score,
      weight: 30,
      weightedScore: (score * 0.3).toFixed(1),
      details: {
        total: projects.length,
        projectsAnalyzed,
        avgExpectedProgress: avgExpectedProgress.toFixed(1),
        avgActualProgress: avgActualProgress.toFixed(1),
        avgAchieveRate: avgAchieveRate.toFixed(1),
        onTrackCount,
        behindCount,
        aheadCount,
        completedCount,
        projectDetails
      }
    };
  }, [projects, selectedMonth, selectedYear]);

  // 計算預算控制分數 (15%)
  const calculateBudgetScore = useMemo(() => {
    // 使用當月預算記錄或預設值
    const currentBudget = filteredMonthlyBudgets.length > 0 
      ? filteredMonthlyBudgets[0] 
      : { yearlyBudget: defaultYearlyBudget, actualSpending: 0 };
    
    const { yearlyBudget, actualSpending } = currentBudget;
    const usageRate = yearlyBudget > 0 ? (actualSpending / yearlyBudget) * 100 : 0;
    
    // 評分標準：使用率在80-90%為最佳
    let score = 100;
    if (usageRate > 95) score = 70; // 超支風險
    else if (usageRate > 90) score = 85;
    else if (usageRate >= 80 && usageRate <= 90) score = 100; // 最佳範圍
    else if (usageRate >= 70) score = 90;
    else if (usageRate >= 60) score = 80;
    else score = 70; // 使用率太低可能執行不力
    
    return {
      score,
      weight: 15,
      weightedScore: (score * 0.15).toFixed(1),
      details: {
        yearlyBudget: (yearlyBudget / 10000).toFixed(0),
        actualSpending: (actualSpending / 10000).toFixed(0),
        remaining: ((yearlyBudget - actualSpending) / 10000).toFixed(0),
        usageRate: usageRate.toFixed(1),
        hasMonthlyData: filteredMonthlyBudgets.length > 0
      }
    };
  }, [filteredMonthlyBudgets, defaultYearlyBudget]);

  // 計算成本管控分數 (15%)
  const calculateCostScore = useMemo(() => {
    // 使用當月成本數據
    const currentCostData = filteredMonthlyCosts.length > 0 
      ? filteredMonthlyCosts[0].products || []
      : [];
    
    if (currentCostData.length === 0) return { 
      score: 0, 
      weight: 15, 
      weightedScore: 0, 
      details: { 
        total: 0, 
        qualified: 0, 
        qualifyRate: 0, 
        avgCostRate: 0, 
        overBudget: 0,
        hasMonthlyData: false
      } 
    };
    
    // 計算符合標準的產品數（成本率≤65%）
    const qualifiedProducts = currentCostData.filter(p => p.costRate <= 65).length;
    const qualifyRate = (qualifiedProducts / currentCostData.length) * 100;
    
    // 平均成本率
    const avgCostRate = currentCostData.reduce((sum, p) => sum + p.costRate, 0) / currentCostData.length;
    
    // 評分：符合率100%得100分，每少10%扣10分
    let score = Math.round(qualifyRate);
    if (avgCostRate > 65) {
      score = Math.max(60, score - (avgCostRate - 65) * 2); // 超標扣分
    }
    
    return {
      score,
      weight: 15,
      weightedScore: (score * 0.15).toFixed(1),
      details: {
        total: currentCostData.length,
        qualified: qualifiedProducts,
        qualifyRate: qualifyRate.toFixed(1),
        avgCostRate: avgCostRate.toFixed(1),
        overBudget: currentCostData.filter(p => p.costRate > 65).length,
        hasMonthlyData: filteredMonthlyCosts.length > 0
      }
    };
  }, [filteredMonthlyCosts]);

  // 總分計算
  const totalScore = useMemo(() => {
    const weighted = 
      parseFloat(calculateTQMScore.weightedScore) +
      parseFloat(calculateKPIScore.weightedScore) +
      parseFloat(calculateProjectScore.weightedScore) +
      parseFloat(calculateBudgetScore.weightedScore) +
      parseFloat(calculateCostScore.weightedScore);
    
    return {
      total: weighted.toFixed(1),
      grade: weighted >= 90 ? 'A' : weighted >= 80 ? 'B' : weighted >= 70 ? 'C' : weighted >= 60 ? 'D' : 'F',
      level: weighted >= 90 ? '優秀' : weighted >= 80 ? '良好' : weighted >= 70 ? '合格' : weighted >= 60 ? '待改進' : '不合格'
    };
  }, [calculateTQMScore, calculateKPIScore, calculateProjectScore, calculateBudgetScore, calculateCostScore]);

  // 新增產品成本資料
  const handleAddProduct = () => {
    if (!newProduct.productName || !newProduct.salesPrice || !newProduct.cost) {
      alert('請填寫完整資料');
      return;
    }
    const costRate = (parseFloat(newProduct.cost) / parseFloat(newProduct.salesPrice)) * 100;
    setCostControlData([...costControlData, {
      productName: newProduct.productName,
      salesPrice: parseFloat(newProduct.salesPrice),
      cost: parseFloat(newProduct.cost),
      costRate: parseFloat(costRate.toFixed(2))
    }]);
    setNewProduct({ productName: '', salesPrice: '', cost: '' });
    setShowAddProduct(false);
  };

  // 生成綜合報告
  const generateComprehensiveReport = () => {
    const report = `
==================================================
研發部門 KPI 綜合評分報告
==================================================
報告期間：${selectedMonth}
生成時間：${new Date().toLocaleString('zh-TW')}
評分人員：${user.displayName}

【總體評分】
────────────────────────────────────────
總分：${totalScore.total} 分
等級：${totalScore.grade} (${totalScore.level})

【各項目詳細評分】
────────────────────────────────────────

一、TQM 品質管理 (佔比 20%)
   原始分數：${calculateTQMScore.score} 分
   加權分數：${calculateTQMScore.weightedScore} 分
   ├─ 總異常數：${calculateTQMScore.details.total} 件
   ├─ 已改善數：${calculateTQMScore.details.improved} 件
   ├─ 改善率：${calculateTQMScore.details.improveRate}%
   ├─ 處理中：${calculateTQMScore.details.pending} 件
   ├─ 未處理：${calculateTQMScore.details.notStarted} 件
   │
   ├─ 改善率基礎分：${calculateTQMScore.details.baseScore} 分
   ├─ 異常數量懲罰：-${calculateTQMScore.details.penalty} 分 (目標≤6件，超過每件扣2分)
   └─ 最終得分：${calculateTQMScore.details.finalScore} 分
   
   評分標準：
   • 改善率 ≥90%: 100分 | 80-89%: 90分 | 70-79%: 80分 | 60-69%: 70分 | <60%: 60分
   • 異常數量控制：目標每月≤6件，超過每多1件扣2分 (最多扣20分)

二、KPI 績效表現 (佔比 20%)
   原始分數：${calculateKPIScore.score} 分
   加權分數：${calculateKPIScore.weightedScore} 分
   ├─ 總指標數：${calculateKPIScore.details.total}
   ├─ 達成數：${calculateKPIScore.details.achieved}
   ├─ 達成率：${calculateKPIScore.details.achieveRate}%
   └─ 未達成：${calculateKPIScore.details.missed}

三、研發專案進度 (佔比 30%) - R&D Nexus 資料
   原始分數：${calculateProjectScore.score} 分
   加權分數：${calculateProjectScore.weightedScore} 分
   ├─ 總專案數：${calculateProjectScore.details.total}
   ├─ 已分析：${calculateProjectScore.details.projectsAnalyzed}
   ├─ 平均預期進度：${calculateProjectScore.details.avgExpectedProgress}%
   ├─ 平均實際進度：${calculateProjectScore.details.avgActualProgress}%
   ├─ 平均達成率：${calculateProjectScore.details.avgAchieveRate}%
   ├─ 進度正常/超前：${calculateProjectScore.details.onTrackCount + calculateProjectScore.details.aheadCount}
   ├─ 進度落後：${calculateProjectScore.details.behindCount}
   └─ 已完成：${calculateProjectScore.details.completedCount}

【專案進度明細】
────────────────────────────────────────
${calculateProjectScore.details.projectDetails ? 
  calculateProjectScore.details.projectDetails.map((p, i) => 
    `${i+1}. ${p.name} (${p.code})
   預期進度：${p.expectedProgress}%
   實際進度：${p.actualProgress}%
   達成率：${p.achieveRate}% ${p.statusText}`
  ).join('\n')
  : '尚無專案資料'}

四、年度預算控制 (佔比 15%)
   原始分數：${calculateBudgetScore.score} 分
   加權分數：${calculateBudgetScore.weightedScore} 分
   ├─ 年度預算：${calculateBudgetScore.details.yearlyBudget} 萬元
   ├─ 實際支出：${calculateBudgetScore.details.actualSpending} 萬元
   ├─ 剩餘預算：${calculateBudgetScore.details.remaining} 萬元
   └─ 使用率：${calculateBudgetScore.details.usageRate}%

五、新機成本管控 (佔比 15%)
   原始分數：${calculateCostScore.score} 分
   加權分數：${calculateCostScore.weightedScore} 分
   ├─ 總產品數：${calculateCostScore.details.total}
   ├─ 符合標準：${calculateCostScore.details.qualified} (成本率≤65%)
   ├─ 符合率：${calculateCostScore.details.qualifyRate}%
   ├─ 平均成本率：${calculateCostScore.details.avgCostRate}%
   └─ 超標產品：${calculateCostScore.details.overBudget}

【產品成本明細】
────────────────────────────────────────
${filteredMonthlyCosts.length > 0 && filteredMonthlyCosts[0].products ? 
  filteredMonthlyCosts[0].products.map((p, i) => 
    `${i+1}. ${p.productName}
   售價：${p.salesPrice.toLocaleString()} 元
   成本：${p.cost.toLocaleString()} 元
   成本率：${p.costRate}% ${p.costRate <= 65 ? '✓ 合格' : '✗ 超標'}`
  ).join('\n')
  : '本月尚無成本數據'}

【綜合建議】
────────────────────────────────────────
${totalScore.total >= 90 ? '✓ 各項指標表現優異，請繼續保持！' : ''}
${calculateTQMScore.score < 80 ? '• 建議加強 TQM 品質改善，提升異常處理效率' : ''}
${calculateKPIScore.score < 80 ? '• 建議檢討 KPI 執行策略，提升達成率' : ''}
${calculateProjectScore.score < 80 ? '• 建議優化專案管理流程，提升準時完成率' : ''}
${calculateBudgetScore.details.usageRate > 90 ? '• 預算使用率偏高，建議加強成本控管' : ''}
${calculateCostScore.details.overBudget > 0 ? `• 有 ${calculateCostScore.details.overBudget} 項產品成本超標，需立即改善` : ''}

==================================================
`;
    
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `研發部門KPI綜合報告_${selectedMonth}_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
      {/* 導航列 */}
      <nav className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white shadow-lg sticky top-0 z-30">
        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-white/20 rounded-lg backdrop-blur">
              <BarChart3 className="w-6 h-6" />
            </div>
            <div>
              <span className="font-bold text-xl">研發部門 KPI 綜合評分系統</span>
              <p className="text-xs text-blue-100">整合 TQM、績效、專案、預算、成本五大指標</p>
            </div>
          </div>
          <div className="flex space-x-2">
            <button onClick={() => setActiveTab('dashboard')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'dashboard' ? 'bg-white/20 backdrop-blur' : 'hover:bg-white/10'}`}>
              <LayoutDashboard className="w-4 h-4 inline mr-2"/>總覽
            </button>
            <button onClick={() => setActiveTab('history')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'history' ? 'bg-white/20 backdrop-blur' : 'hover:bg-white/10'}`}>
              <Calendar className="w-4 h-4 inline mr-2"/>歷史記錄
            </button>
            <button onClick={() => setActiveTab('analysis')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'analysis' ? 'bg-white/20 backdrop-blur' : 'hover:bg-white/10'}`}>
              <TrendingUp className="w-4 h-4 inline mr-2"/>趨勢分析
            </button>
            <button onClick={() => setActiveTab('details')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'details' ? 'bg-white/20 backdrop-blur' : 'hover:bg-white/10'}`}>
              <ListTodo className="w-4 h-4 inline mr-2"/>詳細分析
            </button>
            <button onClick={() => setActiveTab('settings')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'settings' ? 'bg-white/20 backdrop-blur' : 'hover:bg-white/10'}`}>
              <Settings className="w-4 h-4 inline mr-2"/>數據設定
            </button>
            <button onClick={onBackToMenu} className="ml-4 px-4 py-2 rounded-lg text-sm font-medium bg-red-500 hover:bg-red-600 transition-all flex items-center gap-2">
              <LogOut className="w-4 h-4"/>返回
            </button>
          </div>
        </div>
      </nav>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {/* 總覽儀表板 */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6 animate-fade-in">
            {/* 月份選擇器 */}
            <div className="bg-white rounded-xl shadow-md p-4 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <Calendar className="w-5 h-5 text-blue-600"/>
                <span className="font-medium text-slate-700">選擇月份:</span>
                <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                  {['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'].map(m => <option key={m} value={m}>{m}</option>)}
                </select>
                <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                  <option value={2024}>2024年</option>
                  <option value={2025}>2025年</option>
                </select>
              </div>
              <div className="flex items-center gap-4">
                <div className="text-sm text-slate-500">
                  即時數據更新於 {new Date().toLocaleString('zh-TW')}
                </div>
              </div>
            </div>

            {/* 數據來源說明 */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
              <div className="flex items-start gap-3">
                <div className="p-2 bg-blue-100 rounded-lg">
                  <Activity className="w-5 h-5 text-blue-600"/>
                </div>
                <div className="flex-1">
                  <h3 className="font-bold text-blue-900 mb-2">📊 即時數據整合</h3>
                  <div className="grid grid-cols-1 md:grid-cols-5 gap-3 text-xs">
                    <div className="bg-white p-2 rounded border border-blue-100">
                      <p className="font-medium text-blue-700">TQM 品質</p>
                      <p className="text-slate-600 mt-1">{selectedYear}年{selectedMonth}</p>
                      <p className="text-blue-600 font-bold">{filteredTqmRecords.length} 筆記錄</p>
                    </div>
                    <div className="bg-white p-2 rounded border border-purple-100">
                      <p className="font-medium text-purple-700">KPI 績效</p>
                      <p className="text-slate-600 mt-1">{selectedYear}年{selectedMonth}</p>
                      <p className="text-purple-600 font-bold">{filteredKpiData.length} 筆記錄</p>
                    </div>
                    <div className="bg-white p-2 rounded border border-cyan-100">
                      <p className="font-medium text-cyan-700">專案進度</p>
                      <p className="text-slate-600 mt-1">{selectedYear}年{selectedMonth}</p>
                      <p className="text-cyan-600 font-bold">{calculateProjectScore.details.projectsAnalyzed} 個專案</p>
                    </div>
                    <div className="bg-white p-2 rounded border border-green-100">
                      <p className="font-medium text-green-700">預算控管</p>
                      <p className="text-slate-600 mt-1">每月紀錄</p>
                      <p className="text-green-600 font-bold">{monthlyBudgets.length} 筆預算</p>
                    </div>
                    <div className="bg-white p-2 rounded border border-orange-100">
                      <p className="font-medium text-orange-700">成本管控</p>
                      <p className="text-slate-600 mt-1">每月紀錄</p>
                      <p className="text-orange-600 font-bold">{monthlyCosts.length} 筆成本</p>
                    </div>
                  </div>
                  <p className="text-xs text-blue-700 mt-2">✓ 所有數據來自 Firebase 即時資料庫,依所選月份自動篩選計算</p>
                </div>
              </div>
            </div>

            {/* 總分卡片 */}
            <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl shadow-2xl p-8 text-white">
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-4xl font-bold mb-2">{totalScore.total} <span className="text-2xl">分</span></h2>
                  <p className="text-blue-100 text-lg">研發部門綜合評分</p>
                  <div className="mt-4 flex items-center gap-4">
                    <span className={`px-4 py-2 rounded-full text-2xl font-bold ${
                      totalScore.grade === 'A' ? 'bg-green-500' :
                      totalScore.grade === 'B' ? 'bg-blue-500' :
                      totalScore.grade === 'C' ? 'bg-yellow-500' :
                      'bg-red-500'
                    }`}>{totalScore.grade}</span>
                    <span className="text-xl">{totalScore.level}</span>
                  </div>
                </div>
                <div className="text-right">
                  <button onClick={generateComprehensiveReport} className="px-6 py-3 bg-white text-blue-600 rounded-lg hover:bg-blue-50 font-bold flex items-center gap-2">
                    <Download className="w-5 h-5"/>匯出綜合報告
                  </button>
                  <p className="text-blue-100 text-sm mt-2">{selectedMonth} 評分結果</p>
                </div>
              </div>
            </div>

            {/* 五大評分項目 */}
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
              {/* TQM 品質 */}
              <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div className="flex justify-between items-start mb-4">
                  <div className="p-3 bg-blue-100 rounded-lg">
                    <CheckCircle2 className="w-6 h-6 text-blue-600"/>
                  </div>
                  <span className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded font-bold">20%</span>
                </div>
                <h3 className="text-sm text-slate-500 mb-1">TQM 品質</h3>
                <p className="text-3xl font-bold text-slate-800">{calculateTQMScore.weightedScore}</p>
                <p className="text-xs text-slate-400 mt-1">原始: {calculateTQMScore.score}分</p>
                <div className="mt-3 pt-3 border-t border-slate-100">
                  <p className="text-xs text-slate-600">改善率 {calculateTQMScore.details.improveRate}%</p>
                </div>
              </div>

              {/* KPI 績效 */}
              <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div className="flex justify-between items-start mb-4">
                  <div className="p-3 bg-purple-100 rounded-lg">
                    <Target className="w-6 h-6 text-purple-600"/>
                  </div>
                  <span className="text-xs bg-purple-50 text-purple-600 px-2 py-1 rounded font-bold">20%</span>
                </div>
                <h3 className="text-sm text-slate-500 mb-1">KPI 績效</h3>
                <p className="text-3xl font-bold text-slate-800">{calculateKPIScore.weightedScore}</p>
                <p className="text-xs text-slate-400 mt-1">原始: {calculateKPIScore.score}分</p>
                <div className="mt-3 pt-3 border-t border-slate-100">
                  <p className="text-xs text-slate-600">達成率 {calculateKPIScore.details.achieveRate}%</p>
                </div>
              </div>

              {/* 專案進度 */}
              <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-indigo-500">
                <div className="flex justify-between items-start mb-4">
                  <div className="p-3 bg-indigo-100 rounded-lg">
                    <Activity className="w-6 h-6 text-indigo-600"/>
                  </div>
                  <span className="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold">30%</span>
                </div>
                <h3 className="text-sm text-slate-500 mb-1">專案進度</h3>
                <p className="text-3xl font-bold text-slate-800">{calculateProjectScore.weightedScore}</p>
                <p className="text-xs text-slate-400 mt-1">原始: {calculateProjectScore.score}分</p>
                <div className="mt-3 pt-3 border-t border-slate-100">
                  <p className="text-xs text-slate-600">達標率 {calculateProjectScore.details.avgAchieveRate}%</p>
                </div>
              </div>

              {/* 預算控制 */}
              <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div className="flex justify-between items-start mb-4">
                  <div className="p-3 bg-green-100 rounded-lg">
                    <TrendingUp className="w-6 h-6 text-green-600"/>
                  </div>
                  <span className="text-xs bg-green-50 text-green-600 px-2 py-1 rounded font-bold">15%</span>
                </div>
                <h3 className="text-sm text-slate-500 mb-1">預算控制</h3>
                <p className="text-3xl font-bold text-slate-800">{calculateBudgetScore.weightedScore}</p>
                <p className="text-xs text-slate-400 mt-1">原始: {calculateBudgetScore.score}分</p>
                <div className="mt-3 pt-3 border-t border-slate-100">
                  <p className="text-xs text-slate-600">使用率 {calculateBudgetScore.details.usageRate}%</p>
                </div>
              </div>

              {/* 成本管控 */}
              <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                <div className="flex justify-between items-start mb-4">
                  <div className="p-3 bg-orange-100 rounded-lg">
                    <PieChartIcon className="w-6 h-6 text-orange-600"/>
                  </div>
                  <span className="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded font-bold">15%</span>
                </div>
                <h3 className="text-sm text-slate-500 mb-1">成本管控</h3>
                <p className="text-3xl font-bold text-slate-800">{calculateCostScore.weightedScore}</p>
                <p className="text-xs text-slate-400 mt-1">原始: {calculateCostScore.score}分</p>
                <div className="mt-3 pt-3 border-t border-slate-100">
                  <p className="text-xs text-slate-600">符合率 {calculateCostScore.details.qualifyRate}%</p>
                </div>
              </div>
            </div>

            {/* 評分佔比圓餅圖 */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-lg font-bold text-slate-800 mb-4">評分項目佔比</h3>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={[
                          { name: 'TQM品質', value: 20, fill: '#3b82f6' },
                          { name: 'KPI績效', value: 20, fill: '#a855f7' },
                          { name: '專案進度', value: 30, fill: '#6366f1' },
                          { name: '預算控制', value: 15, fill: '#22c55e' },
                          { name: '成本管控', value: 15, fill: '#f97316' }
                        ]}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, value }) => `${name} ${value}%`}
                        outerRadius={80}
                        dataKey="value"
                      >
                      </Pie>
                      <Tooltip />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-lg font-bold text-slate-800 mb-4">各項目得分對比</h3>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={[
                      { name: 'TQM', score: calculateTQMScore.score, target: 100 },
                      { name: 'KPI', score: calculateKPIScore.score, target: 100 },
                      { name: '專案', score: calculateProjectScore.score, target: 100 },
                      { name: '預算', score: calculateBudgetScore.score, target: 100 },
                      { name: '成本', score: calculateCostScore.score, target: 100 }
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis domain={[0, 100]} />
                      <Tooltip />
                      <Legend />
                      <Bar dataKey="score" fill="#6366f1" name="實際得分" />
                      <Bar dataKey="target" fill="#cbd5e1" name="滿分" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* 詳細分析頁面 */}
        {activeTab === 'details' && (
          <div className="space-y-6 animate-fade-in">
            <h1 className="text-3xl font-bold text-slate-800">詳細分析報告</h1>
            
            {/* 計分說明 */}
            <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl shadow-lg p-6 border border-indigo-200">
              <h3 className="text-xl font-bold text-indigo-900 mb-4 flex items-center gap-2">
                <Activity className="w-6 h-6"/>📘 評分計算說明
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {/* TQM 計分說明 */}
                <div className="bg-white rounded-lg p-4 border border-blue-200">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                      <CheckCircle2 className="w-5 h-5 text-blue-600"/>
                    </div>
                    <h4 className="font-bold text-blue-900">TQM 品質 (20%)</h4>
                  </div>
                  <div className="text-xs space-y-2 text-slate-700">
                    <p className="font-medium text-blue-700">計算公式:</p>
                    <p>改善率 = 已改善數 ÷ 總異常數 × 100%</p>
                    <p className="mt-1">最終分數 = 改善率基礎分 - 異常數量懲罰</p>
                    <div className="bg-blue-50 p-2 rounded mt-2">
                      <p className="font-medium">評分標準 (改善率基礎分):</p>
                      <p>• ≥90%: 100分</p>
                      <p>• 80-89%: 90分</p>
                      <p>• 70-79%: 80分</p>
                      <p>• 60-69%: 70分</p>
                      <p>• &lt;60%: 60分</p>
                    </div>
                    <div className="bg-orange-50 p-2 rounded mt-2 border border-orange-200">
                      <p className="font-medium text-orange-800">異常數量控制:</p>
                      <p>• 目標: 每月 ≤ 6件</p>
                      <p>• 超過6件，每多1件扣2分</p>
                      <p>• 最多扣20分</p>
                      {calculateTQMScore.details.total > 6 && (
                        <p className="text-red-600 font-medium mt-1">
                          ⚠️ 本月異常數 {calculateTQMScore.details.total} 件，扣 {calculateTQMScore.details.penalty} 分
                        </p>
                      )}
                    </div>
                    <p className="text-indigo-600 font-medium mt-2">
                      當月數據: {calculateTQMScore.details.total} 件 | 改善率: {calculateTQMScore.details.improveRate}%
                    </p>
                  </div>
                </div>

                {/* KPI 計分說明 */}
                <div className="bg-white rounded-lg p-4 border border-purple-200">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                      <Target className="w-5 h-5 text-purple-600"/>
                    </div>
                    <h4 className="font-bold text-purple-900">KPI 績效 (20%)</h4>
                  </div>
                  <div className="text-xs space-y-2 text-slate-700">
                    <p className="font-medium text-purple-700">計算公式:</p>
                    <p>達成率 = 達成指標數 ÷ 總指標數 × 100%</p>
                    <div className="bg-purple-50 p-2 rounded mt-2">
                      <p className="font-medium">評分標準:</p>
                      <p>• 直接使用達成率作為分數</p>
                      <p>• 範圍: 0-100分</p>
                      <p>• 每個 KPI 指標狀態:</p>
                      <p className="ml-2">- Achieved = 達成</p>
                      <p className="ml-2">- Missed = 未達成</p>
                    </div>
                    <p className="text-indigo-600 font-medium mt-2">
                      當月數據: {calculateKPIScore.details.total} 個指標
                    </p>
                  </div>
                </div>

                {/* 專案計分說明 - 新版 */}
                <div className="bg-white rounded-lg p-4 border border-cyan-200">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                      <Activity className="w-5 h-5 text-cyan-600"/>
                    </div>
                    <h4 className="font-bold text-cyan-900">專案進度 (30%)</h4>
                  </div>
                  <div className="text-xs space-y-2 text-slate-700">
                    <p className="font-medium text-cyan-700">計算公式 (R&D Nexus 資料):</p>
                    <p>預期進度 = (月底 - 開始日) / (截止日 - 開始日) × 100%</p>
                    <p>達成率 = 實際進度 / 預期進度 × 100%</p>
                    <div className="bg-cyan-50 p-2 rounded mt-2">
                      <p className="font-medium">評分標準:</p>
                      <p>• 達成率 ≥100%: 80分基礎</p>
                      <p>• 達成率 90-99%: 70-79分</p>
                      <p>• 達成率 70-89%: 50-69分</p>
                      <p className="mt-1 text-cyan-700">獎勵分數:</p>
                      <p>正常/超前專案比例 × 20分</p>
                    </div>
                    <p className="text-indigo-600 font-medium mt-2">
                      當月數據: {calculateProjectScore.details.projectsAnalyzed} 個專案 (達成率: {calculateProjectScore.details.avgAchieveRate}%)
                    </p>
                  </div>
                </div>

                {/* 預算計分說明 */}
                <div className="bg-white rounded-lg p-4 border border-green-200">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                      <TrendingUp className="w-5 h-5 text-green-600"/>
                    </div>
                    <h4 className="font-bold text-green-900">預算控管 (15%)</h4>
                  </div>
                  <div className="text-xs space-y-2 text-slate-700">
                    <p className="font-medium text-green-700">計算公式:</p>
                    <p>使用率 = 實際支出 ÷ 年度預算 × 100%</p>
                    <div className="bg-green-50 p-2 rounded mt-2">
                      <p className="font-medium">評分標準:</p>
                      <p>• 80-90%: 100分 (理想區間)</p>
                      <p>• 90-95%: 95分</p>
                      <p>• 70-80%: 90分</p>
                      <p>• 95-100%: 85分</p>
                      <p>• &gt;100% 或 &lt;70%: 70分</p>
                    </div>
                    <p className="text-indigo-600 font-medium mt-2">
                      年度預算制
                    </p>
                  </div>
                </div>

                {/* 成本計分說明 */}
                <div className="bg-white rounded-lg p-4 border border-orange-200">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                      <PieChartIcon className="w-5 h-5 text-orange-600"/>
                    </div>
                    <h4 className="font-bold text-orange-900">成本管控 (15%)</h4>
                  </div>
                  <div className="text-xs space-y-2 text-slate-700">
                    <p className="font-medium text-orange-700">計算公式:</p>
                    <p>平均成本率 = Σ(成本÷售價) ÷ 產品數</p>
                    <div className="bg-orange-50 p-2 rounded mt-2">
                      <p className="font-medium">評分標準:</p>
                      <p>• ≤60%: 100分 (優秀)</p>
                      <p>• 60-65%: 90分 (良好)</p>
                      <p>• 65-70%: 80分 (合格)</p>
                      <p>• 70-75%: 70分 (待改善)</p>
                      <p>• &gt;75%: 60分 (需檢討)</p>
                      <p className="text-orange-700 mt-1">目標: ≤65%</p>
                    </div>
                    <p className="text-indigo-600 font-medium mt-2">
                      本月產品: {calculateCostScore.details.total} 項
                    </p>
                  </div>
                </div>

                {/* 總分計算說明 */}
                <div className="bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg p-4 border-2 border-indigo-300">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                      <BarChart3 className="w-5 h-5 text-white"/>
                    </div>
                    <h4 className="font-bold text-indigo-900">總分計算</h4>
                  </div>
                  <div className="text-xs space-y-2 text-slate-800">
                    <p className="font-bold text-indigo-800">加權總分公式:</p>
                    <div className="bg-white p-2 rounded font-mono text-xs">
                      總分 = TQM×20% + KPI×20% + 專案×30% + 預算×15% + 成本×15%
                    </div>
                    <div className="bg-white p-2 rounded mt-2">
                      <p className="font-medium">等級評定:</p>
                      <p>• A級: ≥90分 (優秀)</p>
                      <p>• B級: 80-89分 (良好)</p>
                      <p>• C級: 70-79分 (合格)</p>
                      <p>• D級: 60-69分 (待改善)</p>
                      <p>• F級: &lt;60分 (不合格)</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* TQM 詳細 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-bold text-blue-600 mb-4 flex items-center gap-2">
                <CheckCircle2 className="w-6 h-6"/>TQM 品質管理詳細
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-slate-600">總異常數</p>
                  <p className="text-2xl font-bold text-slate-800">{calculateTQMScore.details.total}</p>
                </div>
                <div className="p-4 bg-green-50 rounded-lg">
                  <p className="text-sm text-slate-600">已改善</p>
                  <p className="text-2xl font-bold text-green-600">{calculateTQMScore.details.improved}</p>
                </div>
                <div className="p-4 bg-yellow-50 rounded-lg">
                  <p className="text-sm text-slate-600">處理中</p>
                  <p className="text-2xl font-bold text-yellow-600">{calculateTQMScore.details.pending}</p>
                </div>
                <div className="p-4 bg-red-50 rounded-lg">
                  <p className="text-sm text-slate-600">未處理</p>
                  <p className="text-2xl font-bold text-red-600">{calculateTQMScore.details.notStarted}</p>
                </div>
              </div>
            </div>

            {/* KPI 詳細 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-bold text-purple-600 mb-4 flex items-center gap-2">
                <Target className="w-6 h-6"/>KPI 績效詳細
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div className="p-4 bg-purple-50 rounded-lg">
                  <p className="text-sm text-slate-600">總指標數</p>
                  <p className="text-2xl font-bold text-slate-800">{calculateKPIScore.details.total}</p>
                </div>
                <div className="p-4 bg-green-50 rounded-lg">
                  <p className="text-sm text-slate-600">已達成</p>
                  <p className="text-2xl font-bold text-green-600">{calculateKPIScore.details.achieved}</p>
                </div>
                <div className="p-4 bg-red-50 rounded-lg">
                  <p className="text-sm text-slate-600">未達成</p>
                  <p className="text-2xl font-bold text-red-600">{calculateKPIScore.details.missed}</p>
                </div>
              </div>
            </div>

            {/* 專案進度詳細 - 新版 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-bold text-indigo-600 mb-4 flex items-center gap-2">
                <Activity className="w-6 h-6"/>專案進度KPI詳細 (R&D Nexus 資料)
              </h3>
              
              {/* 統計概覽 */}
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div className="p-4 bg-indigo-50 rounded-lg text-center">
                  <p className="text-sm text-slate-600">總專案數</p>
                  <p className="text-2xl font-bold text-slate-800">{calculateProjectScore.details.total}</p>
                </div>
                <div className="p-4 bg-blue-50 rounded-lg text-center">
                  <p className="text-sm text-slate-600">已分析</p>
                  <p className="text-2xl font-bold text-blue-600">{calculateProjectScore.details.projectsAnalyzed}</p>
                </div>
                <div className="p-4 bg-green-50 rounded-lg text-center">
                  <p className="text-sm text-slate-600">進度正常/超前</p>
                  <p className="text-2xl font-bold text-green-600">{calculateProjectScore.details.onTrackCount + calculateProjectScore.details.aheadCount}</p>
                </div>
                <div className="p-4 bg-amber-50 rounded-lg text-center">
                  <p className="text-sm text-slate-600">進度落後</p>
                  <p className="text-2xl font-bold text-amber-600">{calculateProjectScore.details.behindCount}</p>
                </div>
                <div className="p-4 bg-purple-50 rounded-lg text-center">
                  <p className="text-sm text-slate-600">已完成</p>
                  <p className="text-2xl font-bold text-purple-600">{calculateProjectScore.details.completedCount}</p>
                </div>
              </div>
              
              {/* 進度達成率總覽 */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl">
                <div className="text-center">
                  <p className="text-sm text-slate-600">平均預期進度</p>
                  <p className="text-3xl font-bold text-indigo-600">{calculateProjectScore.details.avgExpectedProgress}%</p>
                  <p className="text-xs text-slate-500">當月應達成的進度</p>
                </div>
                <div className="text-center">
                  <p className="text-sm text-slate-600">平均實際進度</p>
                  <p className="text-3xl font-bold text-blue-600">{calculateProjectScore.details.avgActualProgress}%</p>
                  <p className="text-xs text-slate-500">目前實際完成進度</p>
                </div>
                <div className="text-center">
                  <p className="text-sm text-slate-600">平均達成率</p>
                  <p className={`text-3xl font-bold ${parseFloat(calculateProjectScore.details.avgAchieveRate) >= 90 ? 'text-green-600' : parseFloat(calculateProjectScore.details.avgAchieveRate) >= 70 ? 'text-amber-600' : 'text-red-600'}`}>
                    {calculateProjectScore.details.avgAchieveRate}%
                  </p>
                  <p className="text-xs text-slate-500">實際/預期 × 100</p>
                </div>
              </div>
              
              {/* 專案列表明細 */}
              {calculateProjectScore.details.projectDetails && calculateProjectScore.details.projectDetails.length > 0 && (
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-slate-700">專案名稱</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold text-slate-700">代碼</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold text-slate-700">預期進度</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold text-slate-700">實際進度</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold text-slate-700">達成率</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold text-slate-700">偏差</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold text-slate-700">狀態</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {calculateProjectScore.details.projectDetails.map((proj, idx) => (
                        <tr key={idx} className="hover:bg-slate-50">
                          <td className="px-4 py-3 font-medium text-slate-800">{proj.name}</td>
                          <td className="px-4 py-3 text-center text-slate-600 text-sm">{proj.code}</td>
                          <td className="px-4 py-3 text-center">
                            {proj.expectedProgress === '-' ? (
                              <span className="text-slate-400">-</span>
                            ) : (
                              <span className="font-medium text-indigo-600">{proj.expectedProgress}%</span>
                            )}
                          </td>
                          <td className="px-4 py-3 text-center">
                            <span className="font-medium text-blue-600">{proj.actualProgress}%</span>
                          </td>
                          <td className="px-4 py-3 text-center">
                            {proj.achieveRate === '-' ? (
                              <span className="text-slate-400">-</span>
                            ) : (
                              <span className={`font-bold ${parseFloat(proj.achieveRate) >= 90 ? 'text-green-600' : parseFloat(proj.achieveRate) >= 70 ? 'text-amber-600' : 'text-red-600'}`}>
                                {proj.achieveRate}%
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3 text-center">
                            {proj.deviation === '-' ? (
                              <span className="text-slate-400">-</span>
                            ) : (
                              <span className={`font-medium ${parseFloat(proj.deviation) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {parseFloat(proj.deviation) >= 0 ? '+' : ''}{proj.deviation}%
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3 text-center text-sm">{proj.statusText}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
              
              {/* 計算說明 */}
              <div className="mt-4 p-4 bg-slate-50 rounded-lg">
                <h4 className="font-bold text-slate-700 mb-2">📊 KPI 計算說明</h4>
                <div className="text-sm text-slate-600 space-y-1">
                  <p>• <strong>預期進度</strong> = (當月底日期 - 開始日期) / (截止日期 - 開始日期) × 100%</p>
                  <p>• <strong>達成率</strong> = 實際進度 / 預期進度 × 100%</p>
                  <p>• <strong>KPI分數</strong> = 基礎分(達成率對應分數) + 獎勵分(正常/超前專案比例 × 20分)</p>
                  <p>• 達成率 ≥90% 為🟢進度正常，70-90% 為🟡稍微落後，&lt;70% 為🔴進度落後</p>
                </div>
              </div>
            </div>

            {/* 產品成本明細表 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-bold text-orange-600 mb-4 flex items-center gap-2">
                <PieChartIcon className="w-6 h-6"/>產品成本管控明細
              </h3>
              {filteredMonthlyCosts.length > 0 && filteredMonthlyCosts[0].products && filteredMonthlyCosts[0].products.length > 0 ? (
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-slate-700">產品名稱</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold text-slate-700">銷售價格</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold text-slate-700">成本</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold text-slate-700">成本率</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold text-slate-700">狀態</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {filteredMonthlyCosts[0].products.map((product, idx) => (
                        <tr key={idx} className="hover:bg-slate-50">
                          <td className="px-4 py-3 font-medium text-slate-800">{product.productName}</td>
                          <td className="px-4 py-3 text-right text-slate-700">{product.salesPrice.toLocaleString()} 元</td>
                          <td className="px-4 py-3 text-right text-slate-700">{product.cost.toLocaleString()} 元</td>
                          <td className="px-4 py-3 text-right">
                            <span className={`font-bold ${product.costRate <= 65 ? 'text-green-600' : 'text-red-600'}`}>
                              {product.costRate}%
                            </span>
                          </td>
                          <td className="px-4 py-3 text-center">
                            {product.costRate <= 65 ? 
                              <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">✓ 合格</span> :
                              <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold">✗ 超標</span>
                            }
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="text-center py-8 text-slate-500">
                  <p>本月尚無成本數據</p>
                  <p className="text-sm mt-2">請至「數據設定」頁面新增本月成本資料</p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* 數據設定頁面 */}
        {activeTab === 'settings' && (
          <div className="space-y-6 animate-fade-in">
            <h1 className="text-3xl font-bold text-slate-800">數據設定</h1>
            
            {/* 每月預算設定 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-bold text-green-600 mb-4 flex items-center gap-2">
                <TrendingUp className="w-6 h-6"/>每月預算控制
              </h3>
              <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                <p className="text-sm text-slate-600">當前月份: {selectedYear}年 {selectedMonth}</p>
                {filteredMonthlyBudgets.length === 0 && (
                  <p className="text-sm text-orange-600 mt-1">⚠️ 尚未設定本月預算</p>
                )}
              </div>
              
              {!editingBudget ? (
                // 顯示模式
                filteredMonthlyBudgets.length > 0 ? (
                  <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">年度預算（元）</label>
                        <div className="px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                          <span className="text-lg font-bold text-slate-800">
                            {filteredMonthlyBudgets[0].yearlyBudget.toLocaleString()}
                          </span>
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">實際支出（元）</label>
                        <div className="px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                          <span className="text-lg font-bold text-slate-800">
                            {filteredMonthlyBudgets[0].actualSpending.toLocaleString()}
                          </span>
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">使用率</label>
                        <div className="px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                          <span className="text-lg font-bold text-slate-800">
                            {((filteredMonthlyBudgets[0].actualSpending / filteredMonthlyBudgets[0].yearlyBudget) * 100).toFixed(1)}%
                          </span>
                        </div>
                      </div>
                    </div>
                    <button 
                      onClick={() => setEditingBudget(true)} 
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      編輯本月預算
                    </button>
                  </div>
                ) : (
                  <button 
                    onClick={() => setEditingBudget(true)} 
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                  >
                    <Plus className="w-4 h-4"/>新增本月預算
                  </button>
                )
              ) : (
                // 編輯模式
                <div className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-2">年度預算（元）</label>
                      <input 
                        type="number" 
                        defaultValue={filteredMonthlyBudgets.length > 0 ? filteredMonthlyBudgets[0].yearlyBudget : defaultYearlyBudget}
                        id="budget-yearly"
                        className="w-full px-4 py-2 border border-slate-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-2">實際支出（元）</label>
                      <input 
                        type="number" 
                        defaultValue={filteredMonthlyBudgets.length > 0 ? filteredMonthlyBudgets[0].actualSpending : 0}
                        id="budget-spending"
                        className="w-full px-4 py-2 border border-slate-300 rounded-lg"
                      />
                    </div>
                    <div className="flex items-end">
                      <button 
                        onClick={() => {
                          const yearlyBudget = parseInt(document.getElementById('budget-yearly').value);
                          const actualSpending = parseInt(document.getElementById('budget-spending').value);
                          const month = parseInt(selectedMonth.replace('月', ''));
                          
                          if (filteredMonthlyBudgets.length > 0) {
                            // 更新現有記錄
                            db.updateDoc('monthly_budgets', filteredMonthlyBudgets[0].id, {
                              yearlyBudget,
                              actualSpending,
                              updatedAt: new Date().toISOString()
                            });
                          } else {
                            // 新增記錄
                            db.addDoc('monthly_budgets', {
                              year: selectedYear,
                              month: month,
                              yearlyBudget,
                              actualSpending,
                              createdAt: new Date().toISOString()
                            });
                          }
                          setEditingBudget(false);
                        }}
                        className="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                      >
                        儲存
                      </button>
                    </div>
                  </div>
                  <button 
                    onClick={() => setEditingBudget(false)} 
                    className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300"
                  >
                    取消
                  </button>
                </div>
              )}
            </div>

            {/* 每月產品成本設定 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold text-orange-600 flex items-center gap-2">
                  <PieChartIcon className="w-6 h-6"/>每月新機成本管控
                </h3>
              </div>
              
              <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                <p className="text-sm text-slate-600">當前月份: {selectedYear}年 {selectedMonth}</p>
                {filteredMonthlyCosts.length === 0 && (
                  <p className="text-sm text-orange-600 mt-1">⚠️ 尚未設定本月成本</p>
                )}
              </div>

              {!editingCost ? (
                // 顯示模式
                filteredMonthlyCosts.length > 0 ? (
                  <div className="space-y-4">
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-slate-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-slate-700">產品名稱</th>
                            <th className="px-4 py-3 text-right text-sm font-semibold text-slate-700">銷售價格</th>
                            <th className="px-4 py-3 text-right text-sm font-semibold text-slate-700">成本</th>
                            <th className="px-4 py-3 text-right text-sm font-semibold text-slate-700">成本率</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {(filteredMonthlyCosts[0].products || []).map((product, idx) => (
                            <tr key={idx}>
                              <td className="px-4 py-3 font-medium text-slate-800">{product.productName}</td>
                              <td className="px-4 py-3 text-right text-slate-700">{product.salesPrice.toLocaleString()} 元</td>
                              <td className="px-4 py-3 text-right text-slate-700">{product.cost.toLocaleString()} 元</td>
                              <td className="px-4 py-3 text-right">
                                <span className={`font-bold ${product.costRate <= 65 ? 'text-green-600' : 'text-red-600'}`}>
                                  {product.costRate}%
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <button 
                      onClick={() => setEditingCost(true)} 
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      編輯本月成本
                    </button>
                  </div>
                ) : (
                  <button 
                    onClick={() => setEditingCost(true)} 
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                  >
                    <Plus className="w-4 h-4"/>新增本月成本
                  </button>
                )
              ) : (
                // 編輯模式 - 這裡我們使用簡單的JSON編輯器
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-2">
                      產品成本資料 (JSON格式)
                    </label>
                    <textarea 
                      id="cost-products"
                      rows="10"
                      defaultValue={JSON.stringify(
                        filteredMonthlyCosts.length > 0 
                          ? filteredMonthlyCosts[0].products || []
                          : [
                              {productName: "產品A", salesPrice: 100000, cost: 60000, costRate: 60},
                              {productName: "產品B", salesPrice: 150000, cost: 90000, costRate: 60}
                            ],
                        null,
                        2
                      )}
                      className="w-full px-4 py-2 border border-slate-300 rounded-lg font-mono text-sm"
                    />
                    <p className="text-xs text-slate-500 mt-1">
                      格式範例: [{"{"}productName: "產品A", salesPrice: 100000, cost: 60000, costRate: 60{"}"}]
                    </p>
                  </div>
                  <div className="flex gap-3">
                    <button 
                      onClick={() => {
                        try {
                          const products = JSON.parse(document.getElementById('cost-products').value);
                          const month = parseInt(selectedMonth.replace('月', ''));
                          
                          if (filteredMonthlyCosts.length > 0) {
                            // 更新現有記錄
                            db.updateDoc('monthly_costs', filteredMonthlyCosts[0].id, {
                              products,
                              updatedAt: new Date().toISOString()
                            });
                          } else {
                            // 新增記錄
                            db.addDoc('monthly_costs', {
                              year: selectedYear,
                              month: month,
                              products,
                              createdAt: new Date().toISOString()
                            });
                          }
                          setEditingCost(false);
                        } catch (error) {
                          alert('JSON 格式錯誤: ' + error.message);
                        }
                      }}
                      className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    >
                      儲存
                    </button>
                    <button 
                      onClick={() => setEditingCost(false)} 
                      className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300"
                    >
                      取消
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* 歷史記錄頁面 */}
        {activeTab === 'history' && (
          <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center">
              <h1 className="text-3xl font-bold text-slate-800">歷史評分記錄</h1>
              <div className="flex gap-3">
                <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="px-4 py-2 border border-slate-300 rounded-lg bg-white">
                  <option value={2024}>2024年</option>
                  <option value={2025}>2025年</option>
                </select>
              </div>
            </div>

            {/* 歷史記錄表格 */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                    <tr>
                      <th className="px-6 py-4 text-left font-semibold">月份</th>
                      <th className="px-6 py-4 text-center font-semibold">TQM品質<br/>(20%)</th>
                      <th className="px-6 py-4 text-center font-semibold">KPI績效<br/>(20%)</th>
                      <th className="px-6 py-4 text-center font-semibold">專案進度<br/>(30%)</th>
                      <th className="px-6 py-4 text-center font-semibold">預算控管<br/>(15%)</th>
                      <th className="px-6 py-4 text-center font-semibold">成本管控<br/>(15%)</th>
                      <th className="px-6 py-4 text-center font-semibold">總分</th>
                      <th className="px-6 py-4 text-center font-semibold">等級</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-200">
                    {historyScores.filter(h => h.year === selectedYear).map((record, idx) => (
                      <tr key={idx} className="hover:bg-slate-50 transition-colors">
                        <td className="px-6 py-4 font-medium text-slate-800">{record.year}年 {record.month}</td>
                        <td className="px-6 py-4 text-center">
                          <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${record.tqm >= 80 ? 'bg-green-100 text-green-700' : record.tqm >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                            {record.tqm}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${record.kpi >= 80 ? 'bg-green-100 text-green-700' : record.kpi >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                            {record.kpi}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${record.project >= 80 ? 'bg-green-100 text-green-700' : record.project >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                            {record.project}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${record.budget >= 80 ? 'bg-green-100 text-green-700' : record.budget >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                            {record.budget}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${record.cost >= 80 ? 'bg-green-100 text-green-700' : record.cost >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                            {record.cost}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className="text-2xl font-bold text-blue-600">{record.total}</span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className={`inline-block px-4 py-2 rounded-full text-lg font-bold ${
                            record.grade === 'A' ? 'bg-green-500 text-white' :
                            record.grade === 'B' ? 'bg-blue-500 text-white' :
                            record.grade === 'C' ? 'bg-yellow-500 text-white' :
                            record.grade === 'D' ? 'bg-orange-500 text-white' :
                            'bg-red-500 text-white'
                          }`}>{record.grade}</span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* 統計摘要 */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                <h3 className="text-sm font-medium text-green-800 mb-2">年度最高分</h3>
                <p className="text-3xl font-bold text-green-700">
                  {Math.max(...historyScores.filter(h => h.year === selectedYear).map(h => h.total))}
                </p>
                <p className="text-xs text-green-600 mt-1">
                  {historyScores.filter(h => h.year === selectedYear).find(h => h.total === Math.max(...historyScores.filter(h2 => h2.year === selectedYear).map(h2 => h2.total)))?.month}
                </p>
              </div>
              <div className="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl border border-red-200">
                <h3 className="text-sm font-medium text-red-800 mb-2">年度最低分</h3>
                <p className="text-3xl font-bold text-red-700">
                  {Math.min(...historyScores.filter(h => h.year === selectedYear).map(h => h.total))}
                </p>
                <p className="text-xs text-red-600 mt-1">
                  {historyScores.filter(h => h.year === selectedYear).find(h => h.total === Math.min(...historyScores.filter(h2 => h2.year === selectedYear).map(h2 => h2.total)))?.month}
                </p>
              </div>
              <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                <h3 className="text-sm font-medium text-blue-800 mb-2">年度平均分</h3>
                <p className="text-3xl font-bold text-blue-700">
                  {(historyScores.filter(h => h.year === selectedYear).reduce((sum, h) => sum + h.total, 0) / historyScores.filter(h => h.year === selectedYear).length).toFixed(1)}
                </p>
                <p className="text-xs text-blue-600 mt-1">12個月平均</p>
              </div>
              <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                <h3 className="text-sm font-medium text-purple-800 mb-2">優良月份</h3>
                <p className="text-3xl font-bold text-purple-700">
                  {historyScores.filter(h => h.year === selectedYear && h.grade === 'A').length}
                </p>
                <p className="text-xs text-purple-600 mt-1">A級評分月份數</p>
              </div>
            </div>
          </div>
        )}

        {/* 趨勢分析頁面 */}
        {activeTab === 'analysis' && (
          <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center">
              <h1 className="text-3xl font-bold text-slate-800">KPI 趨勢分析</h1>
              <div className="flex gap-3">
                <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="px-4 py-2 border border-slate-300 rounded-lg bg-white">
                  <option value={2024}>2024年</option>
                  <option value={2025}>2025年</option>
                </select>
                <select value={selectedQuarter} onChange={e => setSelectedQuarter(e.target.value)} className="px-4 py-2 border border-slate-300 rounded-lg bg-white">
                  <option value="Q1">第一季 (1-3月)</option>
                  <option value="Q2">第二季 (4-6月)</option>
                  <option value="Q3">第三季 (7-9月)</option>
                  <option value="Q4">第四季 (10-12月)</option>
                </select>
              </div>
            </div>

            {/* 年度趨勢圖 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-bold text-slate-800 mb-6">年度總分趨勢</h2>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={historyScores.filter(h => h.year === selectedYear)}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0"/>
                    <XAxis dataKey="month" stroke="#64748b"/>
                    <YAxis domain={[0, 100]} stroke="#64748b"/>
                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }}/>
                    <Legend />
                    <Line type="monotone" dataKey="total" stroke="#3b82f6" strokeWidth={3} name="總分" dot={{ fill: '#3b82f6', r: 6 }}/>
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* 五大指標趨勢圖 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-bold text-slate-800 mb-6">五大指標趨勢對比</h2>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={historyScores.filter(h => h.year === selectedYear)}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0"/>
                    <XAxis dataKey="month" stroke="#64748b"/>
                    <YAxis domain={[0, 100]} stroke="#64748b"/>
                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }}/>
                    <Legend />
                    <Line type="monotone" dataKey="tqm" stroke="#3b82f6" strokeWidth={2} name="TQM品質" />
                    <Line type="monotone" dataKey="kpi" stroke="#8b5cf6" strokeWidth={2} name="KPI績效" />
                    <Line type="monotone" dataKey="project" stroke="#06b6d4" strokeWidth={2} name="專案進度" />
                    <Line type="monotone" dataKey="budget" stroke="#10b981" strokeWidth={2} name="預算控管" />
                    <Line type="monotone" dataKey="cost" stroke="#f59e0b" strokeWidth={2} name="成本管控" />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* 季度對比分析 */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-bold text-slate-800 mb-6">季度平均分數對比</h2>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={[
                    { 
                      quarter: 'Q1', 
                      average: (historyScores.filter(h => h.year === selectedYear && ['1月','2月','3月'].includes(h.month)).reduce((sum, h) => sum + h.total, 0) / 3).toFixed(1)
                    },
                    { 
                      quarter: 'Q2', 
                      average: (historyScores.filter(h => h.year === selectedYear && ['4月','5月','6月'].includes(h.month)).reduce((sum, h) => sum + h.total, 0) / 3).toFixed(1)
                    },
                    { 
                      quarter: 'Q3', 
                      average: (historyScores.filter(h => h.year === selectedYear && ['7月','8月','9月'].includes(h.month)).reduce((sum, h) => sum + h.total, 0) / 3).toFixed(1)
                    },
                    { 
                      quarter: 'Q4', 
                      average: (historyScores.filter(h => h.year === selectedYear && ['10月','11月','12月'].includes(h.month)).reduce((sum, h) => sum + h.total, 0) / 3).toFixed(1)
                    }
                  ]}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0"/>
                    <XAxis dataKey="quarter" stroke="#64748b"/>
                    <YAxis domain={[0, 100]} stroke="#64748b"/>
                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }}/>
                    <Bar dataKey="average" fill="#8b5cf6" name="季度平均分" radius={[8, 8, 0, 0]}/>
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* 績效分析洞察 */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                <h3 className="text-lg font-bold text-blue-900 mb-4 flex items-center gap-2">
                  <TrendingUp className="w-5 h-5"/>表現最佳指標
                </h3>
                <div className="space-y-3">
                  {(() => {
                    const yearData = historyScores.filter(h => h.year === selectedYear);
                    const avgScores = {
                      TQM: (yearData.reduce((sum, h) => sum + h.tqm, 0) / yearData.length).toFixed(1),
                      KPI: (yearData.reduce((sum, h) => sum + h.kpi, 0) / yearData.length).toFixed(1),
                      專案: (yearData.reduce((sum, h) => sum + h.project, 0) / yearData.length).toFixed(1),
                      預算: (yearData.reduce((sum, h) => sum + h.budget, 0) / yearData.length).toFixed(1),
                      成本: (yearData.reduce((sum, h) => sum + h.cost, 0) / yearData.length).toFixed(1)
                    };
                    const maxMetric = Object.entries(avgScores).sort((a, b) => b[1] - a[1])[0];
                    return (
                      <div className="bg-white p-4 rounded-lg">
                        <p className="text-3xl font-bold text-blue-600">{maxMetric[0]}</p>
                        <p className="text-sm text-slate-600 mt-1">年度平均: {maxMetric[1]} 分</p>
                      </div>
                    );
                  })()}
                </div>
              </div>

              <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-6 border border-orange-200">
                <h3 className="text-lg font-bold text-orange-900 mb-4 flex items-center gap-2">
                  <AlertTriangle className="w-5 h-5"/>需要改善指標
                </h3>
                <div className="space-y-3">
                  {(() => {
                    const yearData = historyScores.filter(h => h.year === selectedYear);
                    const avgScores = {
                      TQM: (yearData.reduce((sum, h) => sum + h.tqm, 0) / yearData.length).toFixed(1),
                      KPI: (yearData.reduce((sum, h) => sum + h.kpi, 0) / yearData.length).toFixed(1),
                      專案: (yearData.reduce((sum, h) => sum + h.project, 0) / yearData.length).toFixed(1),
                      預算: (yearData.reduce((sum, h) => sum + h.budget, 0) / yearData.length).toFixed(1),
                      成本: (yearData.reduce((sum, h) => sum + h.cost, 0) / yearData.length).toFixed(1)
                    };
                    const minMetric = Object.entries(avgScores).sort((a, b) => a[1] - b[1])[0];
                    return (
                      <div className="bg-white p-4 rounded-lg">
                        <p className="text-3xl font-bold text-orange-600">{minMetric[0]}</p>
                        <p className="text-sm text-slate-600 mt-1">年度平均: {minMetric[1]} 分</p>
                        <p className="text-xs text-orange-600 mt-2">建議優先關注此項指標表現</p>
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          </div>
        )}

      </main>
    </div>
  );
};

// --- System Selector Component ---
// --- Product War Room Component ---
const ProductWarRoom = ({ onBackToMenu }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [data, setData] = useState([
    { id: 1, docType: 'D1131231-1', requestType: 'H', partNo: 'H32H00A0023A', name: 'SMART桃紅色6吋彩票圈(WINNER版)-100 (機器人娃娃機 SMART ROBOT)', spec: '燒錄RFID標籤', confirmDate: '2025-01-06', orderType: '組立製令', attr: 'M:自製件' },
    { id: 2, docType: 'D1131231-1', requestType: 'H', partNo: 'H32H00A0024A', name: 'SMART橘色6吋彩票圈(WINNER版)-150 (機器人娃娃機 SMART ROBOT)', spec: '燒錄RFID標籤', confirmDate: '2025-01-06', orderType: '組立製令', attr: 'M:自製件' },
    { id: 3, docType: 'D1131231-1', requestType: 'H', partNo: 'H32H00A0025A', name: 'SMART藍色6吋彩票圈(WINNER版)-200 (機器人娃娃機 SMART ROBOT)', spec: '燒錄RFID標籤', confirmDate: '2025-01-06', orderType: '組立製令', attr: 'M:自製件' },
    { id: 180, docType: '原頡需求新設', requestType: 'F', partNo: 'F30C11SEV03', name: '中型兌幣機', spec: '110V MHP-1100SA退幣器 慧展投幣器 含底座 門框組(SEV版) 儲幣槽右移 前門壓克力(減寬)', confirmDate: '2025-11-10', orderType: '組立製令', attr: 'M:自製件' },
    { id: 181, docType: '企劃書', requestType: 'F', partNo: 'F58B11WYC01', name: '雙享樂娃娃機', spec: '110V 白色 控箱組(加高版)/FEI控箱(搖桿在左) LED燈板 滑道(鐵製)', confirmDate: '2025-11-14', orderType: '組立製令', attr: 'M:自製件' },
    { id: 182, docType: 'D1141211-1', requestType: 'H', partNo: 'H32H00C0015A', name: '控箱總成(禮品版) (機器人娃娃機 SMART ROBOT)', spec: '含軟條燈、線材、基板、鈑金、壓克力', confirmDate: '2025-11-14', orderType: '組立製令', attr: 'M:自製件' },
    { id: 183, docType: '昕霖需求新設', requestType: 'H', partNo: 'H57P00A0023A', name: '4片點陣板模組 (多重組合式娃娃機)', spec: '640*143.3*376.6mm', confirmDate: '2025-11-15', orderType: '組立製令', attr: 'M:自製件' },
    { id: 184, docType: '需求新設', requestType: 'S', partNo: 'S11A00K001', name: '標準螺絲套件包', spec: 'M4*10, M5*12', confirmDate: '2025-11-20', orderType: '組立製令', attr: 'M:自製件' },
    { id: 185, docType: 'D1241105-2', requestType: 'H', partNo: 'H12B00A001', name: '新款馬達固定座', spec: 'SUS304 2.0t', confirmDate: '2025-11-21', orderType: '加工製令', attr: 'M:自製件' },
  ]);
  const [searchTerm, setSearchTerm] = useState('');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isPresentationMode, setIsPresentationMode] = useState(false);
  const fileInputRef = React.useRef(null);
  const [excelLibLoaded, setExcelLibLoaded] = useState(false);
  
  // 新增：整合資料 state
  const [rdTasks, setRdTasks] = useState([]);
  const [rdMachines, setRdMachines] = useState([]);

  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ef4444', '#6366f1'];
  const CAT_COLORS = {
    '機台 (F)': '#2563eb',
    '物料 (H)': '#16a34a',
    '套件 (S)': '#f97316',
    '其他': '#94a3b8'
  };

  // 從資料庫加載資料
  useEffect(() => {
    const loadData = async () => {
      try {
        const dbData = await db.getDocs('rd_projects');
        if (dbData && dbData.length > 0) {
          setData(dbData);
        }
      } catch (error) {
        console.error('從資料庫加載資料時發生錯誤:', error);
      }
    };
    loadData();
    
    // 訂閱整合資料
    const unsubTasks = db.subscribe('rd_tasks', setRdTasks);
    const unsubMachines = db.subscribe('rd_machines', setRdMachines);
    
    return () => {
      unsubTasks && unsubTasks();
      unsubMachines && unsubMachines();
    };
  }, []);

  useEffect(() => {
    if (window.XLSX) {
      setExcelLibLoaded(true);
      return;
    }
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
    script.onload = () => setExcelLibLoaded(true);
    document.body.appendChild(script);
  }, []);

  const [formData, setFormData] = useState({
    docType: '',
    partNo: '',
    name: '',
    spec: '',
    confirmDate: new Date().toISOString().split('T')[0],
    orderType: '組立製令',
    attr: 'M:自製件'
  });

  const parseCSVLine = (text) => {
    const result = [];
    let cell = '';
    let inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(cell.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
        cell = '';
      } else {
        cell += char;
      }
    }
    result.push(cell.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
    return result;
  };

  const extractProductSeries = (name) => {
    if (!name) return '其他';
    const matches = name.match(/\(([^)]+)\)/g);
    if (matches && matches.length > 0) {
      let series = matches[matches.length - 1].replace(/[()]/g, '');
      if (series.includes('機器人')) return '機器人娃娃機';
      if (series.includes('WINNER')) return 'Winner系列';
      return series;
    }
    if (name.includes('兌幣機')) return '兌幣機系列';
    if (name.includes('娃娃機')) return '一般娃娃機';
    return '通用/其他';
  };

  const getPartCategory = (partNo) => {
    if (!partNo) return '其他';
    const prefix = partNo.charAt(0).toUpperCase();
    if (prefix === 'F') return '機台 (F)';
    if (prefix === 'H') return '物料 (H)';
    if (prefix === 'S') return '套件 (S)';
    return '其他';
  };

  const normalizeDocType = (docType) => {
    if (!docType) return '未知';
    const type = docType.toUpperCase();
    if (type.startsWith('D11')) return 'D11 (電子設變)';
    if (type.startsWith('D12')) return 'D12 (機構設變)';
    if (type.startsWith('D13')) return 'D13 (軟體設變)';
    if (type.includes('企劃')) return '新產品企劃';
    if (type.includes('需求') || type.includes('新設')) return '業務/客戶需求';
    return type;
  };

  const stats = useMemo(() => {
    const monthCounts = {};
    const productSeriesCounts = {};
    const partCategoryCounts = { '機台 (F)': 0, '物料 (H)': 0, '套件 (S)': 0, '其他': 0 };
    const docTypeDetailedCounts = {};
    let totalItems = 0;
    
    data.forEach(item => {
      totalItems++;
      if (item.confirmDate) {
        let dateStr = String(item.confirmDate).replace(/\//g, '-');
        const parts = dateStr.split('-');
        if (parts.length === 3) {
          if (parts[1].length === 1) parts[1] = '0' + parts[1];
          if (parts[2].length === 1) parts[2] = '0' + parts[2];
          dateStr = parts.join('-');
        }
        const month = dateStr.substring(0, 7);
        if (month.length === 7) {
           monthCounts[month] = (monthCounts[month] || 0) + 1;
        }
      }
      const series = extractProductSeries(item.name);
      productSeriesCounts[series] = (productSeriesCounts[series] || 0) + 1;
      const category = getPartCategory(item.partNo);
      partCategoryCounts[category] = (partCategoryCounts[category] || 0) + 1;
      const detailedType = normalizeDocType(item.docType);
      docTypeDetailedCounts[detailedType] = (docTypeDetailedCounts[detailedType] || 0) + 1;
    });
    
    const barChartData = Object.keys(monthCounts).sort().map(key => ({
      name: key,
      count: monthCounts[key]
    }));

    const docTypeData = Object.keys(docTypeDetailedCounts)
      .map(key => ({ name: key, count: docTypeDetailedCounts[key] }))
      .sort((a, b) => b.count - a.count);

    const partCategoryData = Object.keys(partCategoryCounts)
      .filter(k => partCategoryCounts[k] > 0)
      .map(k => ({ name: k, value: partCategoryCounts[k] }));

    const productSeriesData = Object.keys(productSeriesCounts)
      .map(key => ({ name: key, count: productSeriesCounts[key] }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5);

    const busyMonth = barChartData.length > 0 ? barChartData.reduce((prev, current) => (prev.count > current.count) ? prev : current).name : '無';
    const topSeries = productSeriesData.length > 0 ? productSeriesData[0].name : '無';
    const topCategory = partCategoryData.length > 0 ? partCategoryData.reduce((prev, current) => (prev.value > current.value) ? prev : current).name : '無';
    const topDocType = docTypeData.length > 0 ? docTypeData[0].name : '無';
    const currentMonth = "2025-11";
    const newThisMonth = data.filter(d => String(d.confirmDate || '').includes(currentMonth)).length;

    return { 
      barChartData, 
      docTypeData, 
      partCategoryData, 
      productSeriesData, 
      totalItems, 
      newThisMonth, 
      busyMonth, 
      topSeries,
      topCategory,
      topDocType
    };
  }, [data]);

  const handlePrint = () => {
    window.print();
  };

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const fileName = file.name.toLowerCase();
    if (fileName.endsWith('.csv')) processCSV(file);
    else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) processExcel(file);
    else alert('不支援的檔案格式，請上傳 .csv 或 .xlsx 檔案');
    event.target.value = ''; 
  };

  const processCSV = (file) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const rows = text.split(/\r\n|\n/);
      const newItems = [];
      let successCount = 0;
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i].trim();
        if (!row) continue;
        const cols = parseCSVLine(row);
        if (cols.length < 3) continue;
        let newItem = mapColumnsToData(cols, i);
        if (newItem) { newItems.push(newItem); successCount++; }
      }
      finalizeImport(newItems, successCount);
    };
    reader.readAsText(file);
  };

  const processExcel = (file) => {
    if (!excelLibLoaded) { alert("Excel 解析元件尚未載入完成，請稍後再試。"); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = window.XLSX.read(data, { type: 'array' });
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      const newItems = [];
      let successCount = 0;
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;
        if (String(row[1]).includes('單據類型') || String(row[0]).includes('單據類型')) continue;
        if (!row[1] && !row[4]) continue;
        let newItem = mapColumnsToData(row, i);
        if (newItem) { newItems.push(newItem); successCount++; }
      }
      finalizeImport(newItems, successCount);
    };
    reader.readAsArrayBuffer(file);
  };

  const mapColumnsToData = (cols, index) => {
    if (cols.length > 8) {
       if (!cols[1] && !cols[4]) return null;
       let dateVal = cols[7];
       if (typeof dateVal === 'number') {
          const date = new Date(Math.round((dateVal - 25569)*86400*1000));
          dateVal = date.toISOString().split('T')[0];
       }
       return {
        id: Date.now() + index,
        docType: String(cols[1] || '').trim(),
        partNo: String(cols[4] || '').trim(),
        name: String(cols[5] || '').trim(),
        spec: String(cols[6] || '').trim(),
        confirmDate: String(dateVal || '').trim(),
        orderType: String(cols[9] || '組立製令').trim(),
        attr: String(cols[10] || 'M:自製件').trim()
      };
    } else if (cols.length >= 5) {
      return {
        id: Date.now() + index,
        docType: String(cols[0] || '').trim(),
        partNo: String(cols[1] || '').trim(),
        name: String(cols[2] || '').trim(),
        spec: String(cols[3] || '').trim(),
        confirmDate: String(cols[4] || '').trim(),
        orderType: String(cols[5] || '').trim(),
        attr: String(cols[6] || '').trim()
      };
    }
    return null;
  };

  const finalizeImport = async (newItems, count) => {
    if (newItems.length > 0) {
      try {
        // 將每一筆資料保存到資料庫
        for (const item of newItems) {
          await db.addDoc('rd_projects', item);
        }
        setData(prev => [...newItems, ...prev]);
        alert(`匯入成功！共新增 ${count} 筆資料，已保存至資料庫。`);
      } catch (error) {
        console.error('匯入資料時發生錯誤:', error);
        alert('匯入失敗：保存至資料庫時發生錯誤。');
      }
    } else { alert('匯入失敗：找不到有效資料，請確認檔案格式。'); }
  };

  const handleExport = () => {
    const BOM = "\uFEFF"; 
    const headers = "單據類型,新設料號,品名,規格,確認日,製令單別,屬性\n";
    const csvContent = data.map(row => {
      const safe = (val) => {
        if (!val) return "";
        const str = String(val);
        return str.includes(',') || str.includes('"') ? `"${str.replace(/"/g, '""')}"` : str;
      };
      return `${safe(row.docType)},${safe(row.partNo)},${safe(row.name)},${safe(row.spec)},${safe(row.confirmDate)},${safe(row.orderType)},${safe(row.attr)}`;
    }).join("\n");
    const blob = new Blob([BOM + headers + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `戰情分析資料_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const newItem = { id: Date.now(), ...formData };
      // 保存到資料庫
      await db.addDoc('rd_projects', newItem);
      setData([newItem, ...data]);
      setIsModalOpen(false);
      setFormData({ docType: '', partNo: '', name: '', spec: '', confirmDate: new Date().toISOString().split('T')[0], orderType: '組立製令', attr: 'M:自製件' });
      alert('資料新增成功！已保存至資料庫。');
    } catch (error) {
      console.error('新增資料時發生錯誤:', error);
      alert('新增失敗：保存至資料庫時發生錯誤。');
    }
  };

  const handleDelete = async (id) => {
    if(window.confirm('確定要刪除這筆資料嗎？')) {
      try {
        // 從資料庫刪除
        await db.deleteDoc('rd_projects', id);
        setData(data.filter(item => item.id !== id));
        alert('刪除成功！');
      } catch (error) {
        console.error('刪除資料時發生錯誤:', error);
        alert('刪除失敗：從資料庫刪除時發生錯誤。');
      }
    }
  };

  const filteredData = data.filter(item => 
    (item.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
    (item.partNo || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
    (item.docType || '').toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className={`min-h-screen font-sans ${isPresentationMode ? 'bg-white text-slate-900' : 'bg-slate-50 text-slate-900'}`}>
      <style>{`
        @media print {
          @page { margin: 1cm; size: A4; }
          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: white !important; }
          .no-print { display: none !important; }
          .print-full-width { width: 100% !important; max-width: none !important; margin: 0 !important; padding: 0 !important; }
          .print-break-inside { break-inside: avoid; }
          .shadow-sm, .shadow-lg { box-shadow: none !important; border: 1px solid #ddd !important; }
        }
      `}</style>

      {!isPresentationMode && (
        <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50 no-print">
          <div className="max-w-7xl mx-auto flex justify-between items-center">
            <div className="flex items-center gap-3">
              <Cpu className="w-8 h-8 text-blue-400" />
              <div>
                <h1 className="text-xl font-bold tracking-wide">2025 產品開發戰情室</h1>
                <p className="text-xs text-slate-400">R&D Management Dashboard</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setIsPresentationMode(true)} className="px-4 py-2 bg-purple-600 text-white rounded-lg flex items-center gap-2 hover:bg-purple-700 transition-all shadow-md border border-purple-500">
                <Presentation size={18} /> 戰情匯報模式
              </button>
              <div className="h-8 w-px bg-slate-700 mx-2"></div>
              <button onClick={() => setActiveTab('dashboard')} className={`px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${activeTab === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
                <LayoutDashboard size={18} /> 戰情總覽
              </button>
              <button onClick={() => setActiveTab('workload')} className={`px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${activeTab === 'workload' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
                <Users size={18} /> 人員負擔
              </button>
              <button onClick={() => setActiveTab('machines')} className={`px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${activeTab === 'machines' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
                <Cpu size={18} /> 機台近況
              </button>
              <button onClick={() => setActiveTab('data')} className={`px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${activeTab === 'data' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
                <TableIcon size={18} /> 資料管理
              </button>
              <button onClick={onBackToMenu} className="px-4 py-2 bg-red-500 text-white rounded-lg flex items-center gap-2 hover:bg-red-600 transition-all">
                <LogOut size={18} /> 返回
              </button>
            </div>
          </div>
        </header>
      )}

      {isPresentationMode && (
        <div className="bg-slate-900 text-white p-4 flex justify-between items-center no-print">
           <h2 className="text-lg font-bold flex items-center gap-2"><Presentation size={20}/> 2025 年度研發專案執行報告</h2>
           <div className="flex gap-3">
             <button onClick={handlePrint} className="px-4 py-1.5 bg-slate-700 rounded hover:bg-slate-600 flex items-center gap-2 text-sm">
               <Printer size={16}/> 列印報告 (Ctrl+P)
             </button>
             <button onClick={() => setIsPresentationMode(false)} className="px-4 py-1.5 bg-red-600 rounded hover:bg-red-700 text-sm">
               <X size={16}/> 退出模式
             </button>
           </div>
        </div>
      )}

      <div className="hidden print:block p-4 border-b-2 border-slate-900 mb-6">
        <h1 className="text-2xl font-bold text-slate-900">2025 年度產品開發戰情分析報告</h1>
        <p className="text-sm text-slate-500">列印日期: {new Date().toLocaleDateString()}</p>
      </div>

      <main className={`max-w-7xl mx-auto p-4 md:p-6 print-full-width ${isPresentationMode ? 'bg-white max-w-5xl' : ''}`}>
        
        {activeTab === 'dashboard' && (
          <div className="space-y-8 animate-fade-in">
            
            <div className={`p-6 rounded-xl border-l-4 print-break-inside ${isPresentationMode ? 'bg-slate-50 border-slate-900 shadow-none' : 'bg-white border-blue-600 shadow-sm'}`}>
              <h3 className="text-lg font-bold mb-3 flex items-center gap-2 text-slate-800">
                <FileText className="text-blue-600" /> 主管分析摘要 (Executive Summary)
              </h3>
              <p className="text-slate-700 leading-relaxed text-base">
                2025年度共執行 <span className="font-bold text-blue-700">{stats.totalItems}</span> 個開發項目。
                開發資源主要集中於 <span className="font-bold text-red-600">{stats.topSeries}</span> 系列，
                並在 <span className="font-bold text-blue-700">{stats.busyMonth}</span> 達到開發高峰。
                <br className="my-2 block" />
                在單據來源分析中，<span className="font-bold text-indigo-600">{stats.topDocType}</span> 為最主要的案源，
                這反映了研發單位目前投入最多心力於此類型的案件處理。
                同時，本年度料號結構偏向 <span className="font-bold text-orange-600">{stats.topCategory}</span> 開發。
              </p>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 print-break-inside">
              <div className={`p-4 rounded-xl border ${isPresentationMode ? 'bg-slate-50 border-slate-200' : 'bg-white shadow-sm border-slate-100'}`}>
                <p className="text-sm text-slate-500 mb-1">年度總案量</p>
                <p className="text-3xl font-bold text-slate-800">{stats.totalItems}</p>
                <div className="h-1 w-full bg-blue-100 mt-2 rounded-full overflow-hidden"><div className="h-full bg-blue-500 w-full"></div></div>
              </div>
              <div className={`p-4 rounded-xl border ${isPresentationMode ? 'bg-slate-50 border-slate-200' : 'bg-white shadow-sm border-slate-100'}`}>
                <p className="text-sm text-slate-500 mb-1">主力單據類型</p>
                <p className="text-lg font-bold text-slate-800 truncate" title={stats.topDocType}>{stats.topDocType}</p>
                 <div className="h-1 w-full bg-indigo-100 mt-2 rounded-full overflow-hidden"><div className="h-full bg-indigo-500 w-[70%]"></div></div>
              </div>
              <div className={`p-4 rounded-xl border ${isPresentationMode ? 'bg-slate-50 border-slate-200' : 'bg-white shadow-sm border-slate-100'}`}>
                 <p className="text-sm text-slate-500 mb-1">開發高峰月份</p>
                <p className="text-3xl font-bold text-slate-800">{stats.busyMonth}</p>
                 <div className="h-1 w-full bg-orange-100 mt-2 rounded-full overflow-hidden"><div className="h-full bg-orange-500 w-[85%]"></div></div>
              </div>
              <div className={`p-4 rounded-xl border ${isPresentationMode ? 'bg-slate-50 border-slate-200' : 'bg-white shadow-sm border-slate-100'}`}>
                <p className="text-sm text-slate-500 mb-1">重點產品線</p>
                <p className="text-lg font-bold text-slate-800 truncate" title={stats.topSeries}>{stats.topSeries}</p>
                <div className="h-1 w-full bg-green-100 mt-2 rounded-full overflow-hidden"><div className="h-full bg-green-500 w-full"></div></div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <div className={`p-6 rounded-xl border print-break-inside ${isPresentationMode ? 'border-slate-300' : 'bg-white shadow-sm border-slate-200'}`}>
                <h3 className="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2">
                  <span className="w-1 h-6 bg-indigo-600 rounded"></span> 
                  <Layers size={20} className="text-indigo-600"/>
                  料號結構總類分析 (F/H/S)
                </h3>
                <div className="h-64 flex items-center">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={stats.partCategoryData}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={90}
                        paddingAngle={5}
                        dataKey="value"
                        labelLine={false}
                        label={({name, percent}) => `${(percent * 100).toFixed(0)}%`}
                      >
                        {stats.partCategoryData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={CAT_COLORS[entry.name] || '#94a3b8'} />
                        ))}
                      </Pie>
                      <Tooltip />
                    </PieChart>
                  </ResponsiveContainer>
                  <div className="w-1/3 text-sm text-slate-600 space-y-3">
                    {stats.partCategoryData.map((entry, index) => (
                      <div key={index} className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full" style={{backgroundColor: CAT_COLORS[entry.name] || '#94a3b8'}}></div>
                        <div className="flex flex-col">
                          <span className="font-medium text-slate-800">{entry.name}</span>
                          <span className="text-xs text-slate-500">{entry.value} 筆</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className={`p-6 rounded-xl border print-break-inside ${isPresentationMode ? 'border-slate-300' : 'bg-white shadow-sm border-slate-200'}`}>
                <h3 className="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                  <span className="w-1 h-6 bg-rose-500 rounded"></span> 
                  <FileBarChart size={20} className="text-rose-500"/>
                  單據字首/來源詳細分析
                </h3>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart layout="vertical" data={stats.docTypeData.slice(0, 6)} margin={{ top: 0, right: 30, left: 60, bottom: 0 }}>
                      <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
                      <XAxis type="number" hide />
                      <YAxis dataKey="name" type="category" width={120} tick={{fontSize: 11}} />
                      <Tooltip cursor={{fill: 'transparent'}} />
                      <Bar dataKey="count" name="案件數" fill="#f43f5e" radius={[0, 4, 4, 0]} barSize={20}>
                         {stats.docTypeData.slice(0, 6).map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={['#f43f5e', '#fb7185', '#fda4af', '#a78bfa', '#818cf8', '#60a5fa'][index % 6]} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <p className="text-xs text-slate-500 mt-2 text-center">* 依據 D11/D12/企劃 等關鍵字分類</p>
              </div>

              <div className={`p-6 rounded-xl border print-break-inside ${isPresentationMode ? 'border-slate-300' : 'bg-white shadow-sm border-slate-200'}`}>
                <h3 className="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                  <span className="w-1 h-6 bg-purple-600 rounded"></span> 
                  產品系列資源投入 (Top 5)
                </h3>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart layout="vertical" data={stats.productSeriesData} margin={{ top: 0, right: 30, left: 40, bottom: 0 }}>
                      <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
                      <XAxis type="number" hide />
                      <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} />
                      <Tooltip cursor={{fill: 'transparent'}} />
                      <Bar dataKey="count" name="案件數" fill="#8884d8" radius={[0, 4, 4, 0]} barSize={24}>
                        {stats.productSeriesData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

               <div className={`p-6 rounded-xl border print-break-inside ${isPresentationMode ? 'border-slate-300' : 'bg-white shadow-sm border-slate-200'}`}>
                <h3 className="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                   <span className="w-1 h-6 bg-blue-600 rounded"></span> 
                   年度開發案件量趨勢
                </h3>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={stats.barChartData}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} />
                      <XAxis dataKey="name" tick={{fontSize: 12}} />
                      <YAxis allowDecimals={false} />
                      <Tooltip />
                      <Legend />
                      <Bar dataKey="count" name="案件總數" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={30} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

            </div>
          </div>
        )}

        {/* 人員工作負擔分析 */}
        {activeTab === 'workload' && !isPresentationMode && (
          <div className="space-y-6 animate-fade-in">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                <Users className="text-blue-600" size={24} />
                人員工作負擔分析
                <span className="text-xs text-slate-400 ml-2">整合自：研發專案管理系統</span>
              </h3>
              
              {(() => {
                // 計算每位人員的任務統計
                const ownerStats = {};
                rdTasks.forEach(task => {
                  const owner = task.owner || '未指派';
                  if (!ownerStats[owner]) {
                    ownerStats[owner] = { total: 0, todo: 0, doing: 0, review: 0, done: 0, p1: 0, risk: 0 };
                  }
                  ownerStats[owner].total++;
                  if (task.status === 'To Do') ownerStats[owner].todo++;
                  if (task.status === 'Doing') ownerStats[owner].doing++;
                  if (task.status === 'Review') ownerStats[owner].review++;
                  if (task.status === 'Done') ownerStats[owner].done++;
                  if (task.priority === 'P1') ownerStats[owner].p1++;
                  if (task.risk) ownerStats[owner].risk++;
                });
                
                const sortedOwners = Object.entries(ownerStats)
                  .map(([name, stats]) => ({ name, ...stats, activeLoad: stats.todo + stats.doing + stats.review }))
                  .sort((a, b) => b.activeLoad - a.activeLoad);
                
                const maxLoad = Math.max(...sortedOwners.map(o => o.activeLoad), 1);
                
                return (
                  <div className="space-y-6">
                    {/* 負載總覽卡片 */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p className="text-xs text-blue-600 font-bold mb-1">總任務數</p>
                        <p className="text-3xl font-black text-blue-700">{rdTasks.length}</p>
                      </div>
                      <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
                        <p className="text-xs text-amber-600 font-bold mb-1">進行中</p>
                        <p className="text-3xl font-black text-amber-700">{rdTasks.filter(t => t.status === 'Doing').length}</p>
                      </div>
                      <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p className="text-xs text-red-600 font-bold mb-1">高風險</p>
                        <p className="text-3xl font-black text-red-700">{rdTasks.filter(t => t.risk).length}</p>
                      </div>
                      <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                        <p className="text-xs text-emerald-600 font-bold mb-1">已完成</p>
                        <p className="text-3xl font-black text-emerald-700">{rdTasks.filter(t => t.status === 'Done').length}</p>
                      </div>
                    </div>
                    
                    {/* 人員負載圖表 */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <div className="bg-slate-50 p-6 rounded-xl">
                        <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                          <BarChart3 size={18} className="text-blue-500" />
                          人員工作量排名
                        </h4>
                        <div className="space-y-3">
                          {sortedOwners.slice(0, 10).map((owner, idx) => (
                            <div key={owner.name} className="flex items-center gap-3">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold ${idx === 0 ? 'bg-red-500' : idx === 1 ? 'bg-orange-500' : idx === 2 ? 'bg-amber-500' : 'bg-slate-400'}`}>
                                {idx + 1}
                              </div>
                              <div className="flex-1">
                                <div className="flex justify-between items-center mb-1">
                                  <span className="font-bold text-slate-700">{owner.name}</span>
                                  <span className="text-xs text-slate-500">
                                    {owner.activeLoad} 進行中 / {owner.total} 總計
                                  </span>
                                </div>
                                <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                                  <div 
                                    className={`h-full rounded-full transition-all ${owner.activeLoad > 5 ? 'bg-red-500' : owner.activeLoad > 3 ? 'bg-amber-500' : 'bg-emerald-500'}`}
                                    style={{ width: `${(owner.activeLoad / maxLoad) * 100}%` }}
                                  ></div>
                                </div>
                              </div>
                              {owner.risk > 0 && (
                                <span className="px-2 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-full">
                                  {owner.risk} 風險
                                </span>
                              )}
                            </div>
                          ))}
                          {sortedOwners.length === 0 && (
                            <p className="text-slate-400 text-center py-8">尚無任務資料</p>
                          )}
                        </div>
                      </div>
                      
                      <div className="bg-slate-50 p-6 rounded-xl">
                        <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                          <Activity size={18} className="text-emerald-500" />
                          任務狀態分佈
                        </h4>
                        <div className="h-64">
                          <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                              <Pie
                                data={[
                                  { name: '待處理', value: rdTasks.filter(t => t.status === 'To Do').length, fill: '#94a3b8' },
                                  { name: '進行中', value: rdTasks.filter(t => t.status === 'Doing').length, fill: '#3b82f6' },
                                  { name: '審核中', value: rdTasks.filter(t => t.status === 'Review').length, fill: '#f59e0b' },
                                  { name: '已完成', value: rdTasks.filter(t => t.status === 'Done').length, fill: '#10b981' },
                                ].filter(d => d.value > 0)}
                                cx="50%"
                                cy="50%"
                                innerRadius={50}
                                outerRadius={80}
                                paddingAngle={3}
                                dataKey="value"
                                label={({name, percent}) => `${name} ${(percent * 100).toFixed(0)}%`}
                              >
                              </Pie>
                              <Tooltip />
                            </PieChart>
                          </ResponsiveContainer>
                        </div>
                      </div>
                    </div>
                    
                    {/* 詳細任務表格 */}
                    <div className="bg-slate-50 p-6 rounded-xl">
                      <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <FileText size={18} className="text-indigo-500" />
                        各人員任務明細
                      </h4>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b border-slate-200">
                              <th className="text-left py-3 px-4 font-bold text-slate-600">負責人</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">待處理</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">進行中</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">審核中</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">已完成</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">P1任務</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">風險任務</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">負載狀態</th>
                            </tr>
                          </thead>
                          <tbody>
                            {sortedOwners.map(owner => (
                              <tr key={owner.name} className="border-b border-slate-100 hover:bg-white">
                                <td className="py-3 px-4 font-bold text-slate-800">{owner.name}</td>
                                <td className="py-3 px-4 text-center text-slate-600">{owner.todo}</td>
                                <td className="py-3 px-4 text-center text-blue-600 font-bold">{owner.doing}</td>
                                <td className="py-3 px-4 text-center text-amber-600">{owner.review}</td>
                                <td className="py-3 px-4 text-center text-emerald-600">{owner.done}</td>
                                <td className="py-3 px-4 text-center">
                                  {owner.p1 > 0 && <span className="px-2 py-1 bg-red-100 text-red-600 rounded-full text-xs font-bold">{owner.p1}</span>}
                                </td>
                                <td className="py-3 px-4 text-center">
                                  {owner.risk > 0 && <span className="px-2 py-1 bg-orange-100 text-orange-600 rounded-full text-xs font-bold">{owner.risk}</span>}
                                </td>
                                <td className="py-3 px-4 text-center">
                                  <span className={`px-3 py-1 rounded-full text-xs font-bold ${owner.activeLoad > 5 ? 'bg-red-100 text-red-600' : owner.activeLoad > 3 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}`}>
                                    {owner.activeLoad > 5 ? '超載' : owner.activeLoad > 3 ? '繁忙' : '正常'}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        )}

        {/* 機台開發近況分析 */}
        {activeTab === 'machines' && !isPresentationMode && (
          <div className="space-y-6 animate-fade-in">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                <Cpu className="text-emerald-600" size={24} />
                機台開發近況分析
                <span className="text-xs text-slate-400 ml-2">整合自：研發專案管理系統</span>
              </h3>
              
              {(() => {
                // 計算每台機台的專案與任務統計
                const machineStats = rdMachines.map(machine => {
                  const machineProjects = data.filter(p => p.machineId === machine.id);
                  const machineTasks = rdTasks.filter(t => {
                    const proj = data.find(p => p.id === t.projectId);
                    return proj && proj.machineId === machine.id;
                  });
                  
                  return {
                    ...machine,
                    projectCount: machineProjects.length,
                    taskCount: machineTasks.length,
                    activeTasks: machineTasks.filter(t => t.status === 'Doing' || t.status === 'Review').length,
                    doneTasks: machineTasks.filter(t => t.status === 'Done').length,
                    riskTasks: machineTasks.filter(t => t.risk).length,
                    progress: machine.progress || 0
                  };
                });
                
                return (
                  <div className="space-y-6">
                    {/* 機台總覽卡片 */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                        <p className="text-xs text-emerald-600 font-bold mb-1">總機台數</p>
                        <p className="text-3xl font-black text-emerald-700">{rdMachines.length}</p>
                      </div>
                      <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p className="text-xs text-blue-600 font-bold mb-1">進行中專案</p>
                        <p className="text-3xl font-black text-blue-700">
                          {machineStats.reduce((sum, m) => sum + m.activeTasks, 0)}
                        </p>
                      </div>
                      <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
                        <p className="text-xs text-amber-600 font-bold mb-1">風險項目</p>
                        <p className="text-3xl font-black text-amber-700">
                          {machineStats.reduce((sum, m) => sum + m.riskTasks, 0)}
                        </p>
                      </div>
                      <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <p className="text-xs text-purple-600 font-bold mb-1">平均進度</p>
                        <p className="text-3xl font-black text-purple-700">
                          {machineStats.length > 0 ? Math.round(machineStats.reduce((sum, m) => sum + m.progress, 0) / machineStats.length) : 0}%
                        </p>
                      </div>
                    </div>
                    
                    {/* 機台卡片列表 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                      {machineStats.map(machine => (
                        <div key={machine.id} className="bg-gradient-to-br from-slate-50 to-white p-6 rounded-2xl border border-slate-200 hover:shadow-xl hover:border-blue-200 transition-all group">
                          <div className="flex items-start gap-4 mb-4">
                            <div className="w-16 h-16 rounded-xl overflow-hidden bg-slate-200 flex-shrink-0">
                              {machine.image ? (
                                <img src={machine.image} alt={machine.name} className="w-full h-full object-cover" />
                              ) : (
                                <div className="w-full h-full flex items-center justify-center text-slate-400">
                                  <Cpu size={32} />
                                </div>
                              )}
                            </div>
                            <div className="flex-1 min-w-0">
                              <h4 className="font-bold text-slate-800 text-lg truncate group-hover:text-blue-600 transition-colors">
                                {machine.name}
                              </h4>
                              <p className="text-xs text-slate-400 font-mono">{machine.code || machine.id}</p>
                              <div className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold mt-1 ${machine.status === 'Active' ? 'bg-emerald-100 text-emerald-600' : machine.status === 'Warning' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-600'}`}>
                                <span className={`w-1.5 h-1.5 rounded-full ${machine.status === 'Active' ? 'bg-emerald-500' : machine.status === 'Warning' ? 'bg-amber-500' : 'bg-slate-400'}`}></span>
                                {machine.status || '進行中'}
                              </div>
                            </div>
                          </div>
                          
                          {/* 進度條 */}
                          <div className="mb-4">
                            <div className="flex justify-between items-center mb-1">
                              <span className="text-xs text-slate-500">整體進度</span>
                              <span className="text-xs font-bold text-slate-700">{machine.progress}%</span>
                            </div>
                            <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                              <div 
                                className={`h-full rounded-full transition-all ${machine.progress >= 80 ? 'bg-emerald-500' : machine.progress >= 50 ? 'bg-blue-500' : 'bg-amber-500'}`}
                                style={{ width: `${machine.progress}%` }}
                              ></div>
                            </div>
                          </div>
                          
                          {/* 統計數據 */}
                          <div className="grid grid-cols-3 gap-2 text-center">
                            <div className="bg-blue-50 p-2 rounded-lg">
                              <p className="text-lg font-black text-blue-600">{machine.activeTasks}</p>
                              <p className="text-[10px] text-blue-500">進行中</p>
                            </div>
                            <div className="bg-emerald-50 p-2 rounded-lg">
                              <p className="text-lg font-black text-emerald-600">{machine.doneTasks}</p>
                              <p className="text-[10px] text-emerald-500">已完成</p>
                            </div>
                            <div className="bg-red-50 p-2 rounded-lg">
                              <p className="text-lg font-black text-red-600">{machine.riskTasks}</p>
                              <p className="text-[10px] text-red-500">風險</p>
                            </div>
                          </div>
                        </div>
                      ))}
                      
                      {rdMachines.length === 0 && (
                        <div className="col-span-full text-center py-12 text-slate-400">
                          <Cpu size={48} className="mx-auto mb-4 opacity-30" />
                          <p>尚無機台資料，請至研發專案管理系統新增</p>
                        </div>
                      )}
                    </div>
                    
                    {/* 機台任務統計表 */}
                    <div className="bg-slate-50 p-6 rounded-xl">
                      <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <TableIcon size={18} className="text-indigo-500" />
                        機台開發數據總表
                      </h4>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b border-slate-200">
                              <th className="text-left py-3 px-4 font-bold text-slate-600">機台名稱</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">狀態</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">進度</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">總任務</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">進行中</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">已完成</th>
                              <th className="text-center py-3 px-4 font-bold text-slate-600">風險項</th>
                            </tr>
                          </thead>
                          <tbody>
                            {machineStats.map(machine => (
                              <tr key={machine.id} className="border-b border-slate-100 hover:bg-white">
                                <td className="py-3 px-4">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-lg overflow-hidden bg-slate-200">
                                      {machine.image ? (
                                        <img src={machine.image} alt="" className="w-full h-full object-cover" />
                                      ) : (
                                        <div className="w-full h-full flex items-center justify-center text-slate-400"><Cpu size={20} /></div>
                                      )}
                                    </div>
                                    <div>
                                      <p className="font-bold text-slate-800">{machine.name}</p>
                                      <p className="text-xs text-slate-400">{machine.code || machine.id}</p>
                                    </div>
                                  </div>
                                </td>
                                <td className="py-3 px-4 text-center">
                                  <span className={`px-2 py-1 rounded-full text-xs font-bold ${machine.status === 'Active' ? 'bg-emerald-100 text-emerald-600' : machine.status === 'Warning' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-600'}`}>
                                    {machine.status || '進行中'}
                                  </span>
                                </td>
                                <td className="py-3 px-4">
                                  <div className="flex items-center gap-2">
                                    <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                      <div className={`h-full ${machine.progress >= 80 ? 'bg-emerald-500' : machine.progress >= 50 ? 'bg-blue-500' : 'bg-amber-500'}`} style={{ width: `${machine.progress}%` }}></div>
                                    </div>
                                    <span className="text-xs font-bold text-slate-600 w-10">{machine.progress}%</span>
                                  </div>
                                </td>
                                <td className="py-3 px-4 text-center font-bold text-slate-700">{machine.taskCount}</td>
                                <td className="py-3 px-4 text-center text-blue-600 font-bold">{machine.activeTasks}</td>
                                <td className="py-3 px-4 text-center text-emerald-600 font-bold">{machine.doneTasks}</td>
                                <td className="py-3 px-4 text-center">
                                  {machine.riskTasks > 0 ? (
                                    <span className="px-2 py-1 bg-red-100 text-red-600 rounded-full text-xs font-bold">{machine.riskTasks}</span>
                                  ) : (
                                    <span className="text-slate-300">-</span>
                                  )}
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        )}

        {activeTab === 'data' && !isPresentationMode && (
          <div className="space-y-4 animate-fade-in no-print">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
              <div className="relative w-full md:w-96">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} />
                <input 
                  type="text" 
                  placeholder="搜尋品名、料號或單據..." 
                  className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>
              
              <div className="flex gap-2 w-full md:w-auto">
                <button 
                  onClick={() => setIsModalOpen(true)}
                  className="flex-1 md:flex-none px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"
                >
                  <Plus size={18} /> 新增
                </button>
                <button 
                  onClick={handleExport}
                  className="flex-1 md:flex-none px-4 py-2 bg-slate-100 text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-200 flex items-center justify-center gap-2"
                >
                  <Download size={18} /> 匯出
                </button>
                <div className="relative">
                  <input 
                    type="file" 
                    accept=".csv, .xlsx, .xls"
                    ref={fileInputRef}
                    onChange={handleFileUpload}
                    className="hidden"
                  />
                  <button 
                    onClick={() => fileInputRef.current.click()}
                    className="w-full md:w-auto px-4 py-2 bg-green-600 text-white border border-green-600 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 shadow-sm"
                  >
                    <FileSpreadsheet size={18} /> 匯入 Excel/CSV
                  </button>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full text-left border-collapse">
                  <thead>
                    <tr className="bg-slate-50 text-slate-600 text-sm border-b border-slate-200">
                      <th className="p-4 font-semibold whitespace-nowrap">單據類型</th>
                      <th className="p-4 font-semibold whitespace-nowrap">料號</th>
                      <th className="p-4 font-semibold">品名</th>
                      <th className="p-4 font-semibold">規格</th>
                      <th className="p-4 font-semibold whitespace-nowrap">確認日</th>
                      <th className="p-4 font-semibold whitespace-nowrap text-center">操作</th>
                    </tr>
                  </thead>
                  <tbody className="text-sm">
                    {filteredData.length > 0 ? (
                      filteredData.map((item) => (
                        <tr key={item.id} className="border-b border-slate-100 hover:bg-blue-50 transition-colors">
                          <td className="p-4 text-slate-500 whitespace-nowrap">{item.docType}</td>
                          <td className="p-4 font-mono font-medium text-blue-700 whitespace-nowrap">{item.partNo}</td>
                          <td className="p-4 font-medium text-slate-800">{item.name}</td>
                          <td className="p-4 text-slate-500 max-w-xs truncate" title={item.spec}>{item.spec}</td>
                          <td className="p-4 text-slate-600 whitespace-nowrap">
                            <span className="bg-slate-100 px-2 py-1 rounded text-xs border border-slate-200">
                              {item.confirmDate}
                            </span>
                          </td>
                          <td className="p-4 text-center">
                            <button 
                              onClick={() => handleDelete(item.id)}
                              className="text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50"
                              title="刪除"
                            >
                              <Trash2 size={16} />
                            </button>
                          </td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="6" className="p-8 text-center text-slate-400">
                          沒有找到相符的資料
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
              <div className="p-3 border-t border-slate-200 bg-slate-50 text-xs text-slate-500 flex justify-between items-center">
                <span>共 {filteredData.length} 筆資料</span>
                <span>系統版本 v1.5 (列印修復+詳細單據分析)</span>
              </div>
            </div>
          </div>
        )}
      </main>

      {isModalOpen && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 no-print">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center p-6 border-b border-slate-100">
              <h2 className="text-xl font-bold flex items-center gap-2">
                <Plus className="text-blue-600" /> 新增產品資料
              </h2>
              <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600">
                <X size={24} />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">單據類型</label>
                  <input required type="text" className="w-full p-2 border border-slate-300 rounded-lg" value={formData.docType} onChange={e => setFormData({...formData, docType: e.target.value})} placeholder="例：D1141211-1" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">新設料號</label>
                  <input required type="text" className="w-full p-2 border border-slate-300 rounded-lg" value={formData.partNo} onChange={e => setFormData({...formData, partNo: e.target.value})} placeholder="F... / H... / S..." />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">品名</label>
                <input required type="text" className="w-full p-2 border border-slate-300 rounded-lg" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">規格</label>
                <textarea className="w-full p-2 border border-slate-300 rounded-lg" rows="3" value={formData.spec} onChange={e => setFormData({...formData, spec: e.target.value})}></textarea>
              </div>
               <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">確認日</label>
                  <input required type="date" className="w-full p-2 border border-slate-300 rounded-lg" value={formData.confirmDate} onChange={e => setFormData({...formData, confirmDate: e.target.value})} />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">製令單別</label>
                  <select className="w-full p-2 border border-slate-300 rounded-lg" value={formData.orderType} onChange={e => setFormData({...formData, orderType: e.target.value})}>
                    <option value="組立製令">組立製令</option>
                    <option value="加工製令">加工製令</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">屬性</label>
                  <select className="w-full p-2 border border-slate-300 rounded-lg" value={formData.attr} onChange={e => setFormData({...formData, attr: e.target.value})}>
                    <option value="M:自製件">M:自製件</option>
                    <option value="P:採購件">P:採購件</option>
                  </select>
                </div>
              </div>
              <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg">取消</button>
                <button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-lg flex items-center gap-2"><Save size={18} /> 儲存資料</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

const SystemSelector = ({ onSelect, onLogout, user, onExportDB }) => {
  const isAdmin = user?.role === 'admin';
  const gridClass = `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6`;
  
  // 🔥 訂閱 R&D Nexus 任務數據
  const [rdTasks, setRdTasks] = useState([]);
  const [rdProjects, setRdProjects] = useState([]); // 訂閱專案數據
  const [rdMachines, setRdMachines] = useState([]); // 訂閱機台數據
  const [marqueeMessages, setMarqueeMessages] = useState([]);
  const [rdNotifications, setRdNotifications] = useState([]); // 訂閱通知數據
  const [showNotificationPanel, setShowNotificationPanel] = useState(false);
  
  useEffect(() => {
    const unsubscribeTasks = db.subscribe('rd_tasks', setRdTasks);
    const unsubscribeProjects = db.subscribe('rd_projects', setRdProjects);
    const unsubscribeMachines = db.subscribe('rd_machines', setRdMachines);
    // 訂閱通知
    const unsubscribeNotifications = db.subscribe('rd_notifications', (data) => {
      const sortedData = [...data].sort((a, b) => {
        const timeA = new Date(a.createdAt || 0).getTime();
        const timeB = new Date(b.createdAt || 0).getTime();
        return timeB - timeA;
      });
      setRdNotifications(sortedData);
    });
    return () => {
      unsubscribeTasks();
      unsubscribeProjects();
      unsubscribeMachines();
      unsubscribeNotifications();
    };
  }, []);
  
  // 🔥 過濾當前用戶的通知
  const myNotifications = rdNotifications.filter(n => 
    n.recipients && n.recipients.some(r => r.username === user?.username)
  );
  
  // 未讀通知數量
  const unreadCount = myNotifications.filter(n => 
    !n.isRead || !n.isRead[user?.username]
  ).length;
  
  // 標記通知為已讀
  const markAsRead = async (notification) => {
    try {
      const updatedIsRead = { ...notification.isRead, [user?.username]: true };
      await db.updateDoc('rd_notifications', notification.id, { isRead: updatedIsRead });
    } catch (e) {
      console.error('標記已讀失敗:', e);
    }
  };
  
  // 刪除通知（僅發送者可刪除）
  const deleteNotification = async (notificationId) => {
    console.log('🗑️ 準備刪除通知:', notificationId, typeof notificationId);
    if (!notificationId) {
      alert('❌ 無法刪除：通知 ID 不存在');
      console.error('通知 ID 為空或未定義');
      return;
    }
    if (confirm('確定要刪除此通知嗎？')) {
      try {
        await db.deleteDoc('rd_notifications', notificationId);
        console.log('✅ 通知已成功刪除:', notificationId);
      } catch (e) {
        console.error('❌ 刪除通知失敗:', e);
        alert('刪除失敗：' + e.message);
      }
    }
  };
  
  // 🔥 強制刪除所有通知
  const deleteAllNotifications = async () => {
    if (myNotifications.length === 0) {
      alert('📭 目前沒有任何通知');
      return;
    }
    
    const confirmMsg = `⚠️ 確定要刪除全部 ${myNotifications.length} 則通知嗎？\n\n此操作無法復原！`;
    if (!confirm(confirmMsg)) return;
    
    try {
      console.log('🗑️ 開始批量刪除通知，共', myNotifications.length, '則');
      
      // 批量刪除所有通知
      const deletePromises = myNotifications.map(notification => 
        db.deleteDoc('rd_notifications', notification.id)
      );
      
      await Promise.all(deletePromises);
      
      console.log('✅ 已成功刪除全部通知');
      alert('✅ 已成功刪除全部 ' + myNotifications.length + ' 則通知');
    } catch (e) {
      console.error('❌ 批量刪除通知失敗:', e);
      alert('❌ 刪除失敗：' + e.message);
    }
  };
  
  // 🔥 生成跑馬燈訊息
  useEffect(() => {
    if (!user || rdTasks.length === 0) return;
    
    const userName = user.displayName;
    const today = new Date();
    const messages = [];
    const processedTaskIds = new Set(); // 避免重複顯示
    
    // 過濾屬於當前用戶的未完成任務
    const userTasks = rdTasks.filter(task => 
      task.owner === userName && task.status !== 'Done'
    );
    
    console.log('🔍 跑馬燈任務數據:', userTasks); // 調試用
    
    // 輔助函數：根據 projectId 獲取專案名稱和機台名稱
    const getProjectInfo = (projectId) => {
      if (!projectId) return { projectName: '未分配專案', machineName: '' };
      const project = rdProjects.find(p => p.id === projectId);
      if (!project) return { projectName: '未知專案', machineName: '' };
      
      // 根據 machineId 獲取機台名稱
      let machineName = '';
      if (project.machineId) {
        const machine = rdMachines.find(m => m.id === project.machineId);
        machineName = machine ? machine.name : '';
      }
      
      return { projectName: project.name, machineName };
    };
    
    // 輔助函數：格式化日期
    const formatDate = (dateStr) => {
      if (!dateStr) return '未設定';
      const date = new Date(dateStr);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${month}/${day}`;
    };
    
    // 1. 優先處理超時任務（最高優先級）
    userTasks.forEach(task => {
      if (task.endDate) {
        const endDate = new Date(task.endDate);
        if (endDate < today) {
          const daysOverdue = Math.floor((today - endDate) / (1000 * 60 * 60 * 24));
          const taskName = task.title || task.name || '未命名任務';
          const { projectName, machineName } = getProjectInfo(task.projectId);
          const deadline = formatDate(task.endDate);
          
          // 格式：表情符號 + 機台名稱 + 專案名稱 - 任務名稱 - 截止日期 + 額外資訊
          const machinePrefix = machineName ? `${machineName} | ` : '';
          const overdueInfo = `逾期${daysOverdue}天`;
          
          messages.push({
            type: 'overdue',
            priority: 1,
            text: `⚠️ ${machinePrefix}${projectName} - ${taskName} - 截止:${deadline} (${overdueInfo})`,
            color: 'text-red-600 font-bold',
            taskId: task.id,
            projectId: task.projectId
          });
          processedTaskIds.add(task.id);
        }
      }
    });
    
    // 2. 新增的任務（最近7天內創建且未超時）
    userTasks.forEach(task => {
      if (processedTaskIds.has(task.id)) return;
      
      if (task.createdAt) {
        const createdDate = new Date(task.createdAt);
        const daysSinceCreated = Math.floor((today - createdDate) / (1000 * 60 * 60 * 24));
        if (daysSinceCreated <= 7) {
          const taskName = task.title || task.name || '未命名任務';
          const { projectName, machineName } = getProjectInfo(task.projectId);
          const deadline = formatDate(task.endDate);
          
          // 格式：表情符號 + 機台名稱 + 專案名稱 - 任務名稱 - 截止日期 + 額外資訊
          const machinePrefix = machineName ? `${machineName} | ` : '';
          const statusInfo = `[${task.status}]`;
          
          messages.push({
            type: 'new',
            priority: 2,
            text: `🆕 ${machinePrefix}${projectName} - ${taskName} - 截止:${deadline} ${statusInfo}`,
            color: 'text-blue-600',
            taskId: task.id,
            projectId: task.projectId
          });
          processedTaskIds.add(task.id);
        }
      }
    });
    
    // 3. 其他未完成的任務
    userTasks.forEach(task => {
      if (processedTaskIds.has(task.id)) return;
      
      const taskName = task.title || task.name || '未命名任務';
      const { projectName, machineName } = getProjectInfo(task.projectId);
      const deadline = formatDate(task.endDate);
      
      // 格式：表情符號 + 機台名稱 + 專案名稱 - 任務名稱 - 截止日期 + 額外資訊
      const machinePrefix = machineName ? `${machineName} | ` : '';
      const statusInfo = `[${task.status}]`;
      
      messages.push({
        type: 'pending',
        priority: 3,
        text: `📋 ${machinePrefix}${projectName} - ${taskName} - 截止:${deadline} ${statusInfo}`,
        color: 'text-orange-600',
        taskId: task.id,
        projectId: task.projectId
      });
      processedTaskIds.add(task.id);
    });
    
    // 按優先級排序
    messages.sort((a, b) => a.priority - b.priority);
    
    console.log('📊 生成的跑馬燈訊息:', messages); // 調試用
    
    setMarqueeMessages(messages);
  }, [rdTasks, rdProjects, rdMachines, user]);
  
  // 🔥 點擊任務跳轉到 R&D Nexus 的任務看板
  const handleTaskClick = (projectId) => {
    if (projectId) {
      // 查找專案對應的機台ID
      const project = rdProjects.find(p => p.id === projectId);
      const machineId = project?.machineId;
      
      // 將 projectId、machineId 和 activeTab 存儲到 sessionStorage
      sessionStorage.setItem('openProjectId', projectId);
      sessionStorage.setItem('openMachineId', machineId || '');
      sessionStorage.setItem('openProjectTab', 'kanban');
      
      console.log('🎯 跳轉到專案:', { projectId, machineId, project: project?.name });
    }
    onSelect('PROJECT');
  };
  
  // 🔥 檢查用戶權限
  const userPermissions = user.permissions || ['TQM', 'KPI_PERSONAL', 'KPI', 'PROJECT', 'KPI_REPORT', 'WAR_ROOM', 'APPRAISAL', 'ELEC_SPEC'];
  const hasPermission = (moduleId) => {
    // 管理員擁有所有權限
    if (user.role === 'admin') return true;
    return userPermissions.includes(moduleId);
  };
  
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-6 relative overflow-hidden">
      {/* 背景動態效果 */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute -top-40 -right-40 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse"></div>
        <div className="absolute -bottom-40 -left-40 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse" style={{animationDelay: '1s'}}></div>
        <div className="absolute top-1/3 right-1/4 w-64 h-64 bg-cyan-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse" style={{animationDelay: '2s'}}></div>
      </div>
      
      <div className="relative max-w-6xl w-full">
        <div className="text-center mb-10">
          <div className="inline-flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full text-blue-300 text-sm mb-4">
            <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
            系統連線正常
          </div>
          <h1 className="text-5xl font-bold text-white mb-3">
            歡迎回來，<span className="bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">{user.displayName}</span>
          </h1>
          <p className="text-slate-400 text-lg">請選擇您要進入的系統模組</p>
        </div>
        
        {/* 🔥 任務跑馬燈 - 美化版 */}
        <div className="mb-10 bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/10 overflow-hidden">
          <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-3 flex items-center justify-between">
            <div className="flex items-center gap-3 text-white font-medium">
              <div className="p-2 bg-white/20 rounded-lg">
                <Activity className="w-5 h-5" />
              </div>
              <span>R&D Nexus 任務提醒</span>
            </div>
            {marqueeMessages.length > 0 ? (
              <div className="flex items-center gap-3 text-white text-sm">
                <span className="bg-white/20 px-3 py-1.5 rounded-full font-medium">
                  共 {marqueeMessages.length} 項待辦
                </span>
                {marqueeMessages.filter(m => m.type === 'overdue').length > 0 && (
                  <span className="bg-red-500 px-3 py-1.5 rounded-full font-bold animate-pulse">
                    ⚠️ {marqueeMessages.filter(m => m.type === 'overdue').length} 逾期
                  </span>
                )}
              </div>
            ) : (
              <div className="text-white text-sm bg-white/20 px-3 py-1.5 rounded-full">
                ✅ 目前無待辦任務
              </div>
            )}
          </div>
          <div className="relative overflow-hidden bg-white/5 py-5">
            {marqueeMessages.length > 0 ? (
              <>
                <style dangerouslySetInnerHTML={{__html: `
                  @keyframes marquee {
                    0% { transform: translateX(0%); }
                    100% { transform: translateX(-100%); }
                  }
                  .marquee-container {
                    display: flex;
                    width: 100%;
                  }
                  .marquee-content {
                    animation: marquee ${Math.max(60, marqueeMessages.length * 10)}s linear infinite;
                    white-space: nowrap;
                    display: inline-flex;
                    align-items: center;
                    gap: 1.5rem;
                    padding-left: 1rem;
                  }
                  .marquee-content:hover {
                    animation-play-state: paused;
                  }
                  .task-item {
                    transition: all 0.3s ease;
                    cursor: pointer;
                    flex-shrink: 0;
                  }
                  .task-item:hover {
                    transform: scale(1.08);
                    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
                    z-index: 10;
                  }
                `}} />
                <div className="marquee-content">
                  {marqueeMessages.map((msg, idx) => (
                    <span 
                      key={idx} 
                      onClick={() => handleTaskClick(msg.projectId)}
                      className={`task-item flex items-center gap-2 px-5 py-3 bg-white rounded-xl shadow-lg border-l-4 ${
                        msg.type === 'overdue' ? 'border-red-500 hover:bg-red-50' :
                        msg.type === 'new' ? 'border-blue-500 hover:bg-blue-50' :
                        'border-orange-500 hover:bg-orange-50'
                      }`}
                      title={`點擊查看專案詳情 - 任務 ID: ${msg.taskId || 'N/A'}`}
                    >
                      <span className={msg.color}>{msg.text}</span>
                    </span>
                  ))}
                  {/* 重複一次以實現無縫循環 */}
                  {marqueeMessages.map((msg, idx) => (
                    <span 
                      key={`dup-${idx}`} 
                      onClick={() => handleTaskClick(msg.projectId)}
                      className={`task-item flex items-center gap-2 px-5 py-3 bg-white rounded-xl shadow-lg border-l-4 ${
                        msg.type === 'overdue' ? 'border-red-500 hover:bg-red-50' :
                        msg.type === 'new' ? 'border-blue-500 hover:bg-blue-50' :
                        'border-orange-500 hover:bg-orange-50'
                      }`}
                      title={`點擊查看專案詳情 - 任務 ID: ${msg.taskId || 'N/A'}`}
                    >
                      <span className={msg.color}>{msg.text}</span>
                    </span>
                  ))}
                </div>
              </>
            ) : (
              <div className="text-center py-3 text-slate-300 text-sm">
                <span className="animate-pulse">🎉 太棒了！目前沒有待處理的任務，保持這個狀態！</span>
              </div>
            )}
          </div>
        </div>
        
        {/* 🔔 專案通知區塊 */}
        {myNotifications.length > 0 && (
          <div className="mb-10 bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/10 overflow-hidden">
            <div className="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3 text-white font-medium">
                <div className="p-2 bg-white/20 rounded-lg relative">
                  <AlertCircle className="w-5 h-5" />
                  {unreadCount > 0 && (
                    <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center font-bold animate-pulse">
                      {unreadCount}
                    </span>
                  )}
                </div>
                <span>📬 R&D Nexus 專案通知</span>
              </div>
              <div className="flex items-center gap-2">
                <button 
                  onClick={deleteAllNotifications}
                  className="text-white text-sm bg-red-500/80 hover:bg-red-600 px-3 py-1.5 rounded-full transition-all flex items-center gap-1.5 shadow-lg hover:scale-105"
                  title="刪除全部通知"
                >
                  <Trash2 size={14} />
                  刪除全部
                </button>
                <button 
                  onClick={() => setShowNotificationPanel(!showNotificationPanel)}
                  className="text-white text-sm bg-white/20 px-4 py-1.5 rounded-full hover:bg-white/30 transition-all flex items-center gap-2"
                >
                  {showNotificationPanel ? '收起通知' : `展開查看 (${myNotifications.length})`}
                  {showNotificationPanel ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                </button>
              </div>
            </div>
            
            {showNotificationPanel && (
              <div className="p-4 max-h-96 overflow-y-auto space-y-3">
                {myNotifications.map((notification, idx) => {
                  const isRead = notification.isRead && notification.isRead[user?.username];
                  const isUrgent = notification.type === 'urgent';
                  const isMeeting = notification.type === 'meeting';
                  
                  // 🔥 處理跳轉到專案任務看板頁面
                  const handleJumpToProject = (e) => {
                    e.stopPropagation();
                    if (notification.projectId) {
                      // 🔥 跳轉到專案詳情的任務看板
                      sessionStorage.setItem('openProjectId', notification.projectId);
                      sessionStorage.setItem('openProjectTab', 'kanban');
                      // 如果有任務ID，也存儲任務ID以便打開任務詳情
                      if (notification.taskId) {
                        sessionStorage.setItem('openTaskId', notification.taskId);
                      }
                      // 跳轉到 R&D Nexus
                      onSelect('PROJECT');
                    }
                  };
                  
                  // 🔥 顯示標題：格式為「機台名稱 - 專案名稱 - 任務名稱」
                  const displayTitle = notification.taskName 
                    ? `${notification.machineName || '未指定機台'} - ${notification.projectName} - ${notification.taskName}`
                    : notification.title || `${notification.machineName || '未指定機台'} - ${notification.projectName}`;
                  
                  return (
                    <div 
                      key={notification.id || idx}
                      onClick={() => !isRead && markAsRead(notification)}
                      className={`p-4 rounded-xl transition-all cursor-pointer border ${
                        isUrgent 
                          ? 'bg-red-500/10 border-red-500/30 hover:bg-red-500/20' 
                          : isMeeting
                          ? 'bg-purple-500/10 border-purple-500/30 hover:bg-purple-500/20'
                          : 'bg-white/5 border-white/10 hover:bg-white/10'
                      } ${!isRead ? 'ring-2 ring-amber-400/50' : ''}`}
                      data-notification-id={notification.id}
                    >
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2 flex-wrap">
                            {/* 通知類型標籤 */}
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              isUrgent 
                                ? 'bg-red-500 text-white' 
                                : isMeeting
                                ? 'bg-purple-500 text-white'
                                : 'bg-blue-500 text-white'
                            }`}>
                              {isUrgent ? '🚨 緊急' : isMeeting ? '📅 開會' : '📢 通知'}
                            </span>
                            {/* 機台名稱 - 更明顯的樣式 */}
                            <span className="text-sm font-bold text-white bg-gradient-to-r from-indigo-500 to-blue-500 px-3 py-1 rounded-full shadow-lg">
                              🔧 {notification.machineName || notification.projectName}
                            </span>
                            {/* 未讀標記 */}
                            {!isRead && (
                              <span className="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></span>
                            )}
                          </div>
                          
                          {/* 標題 - 顯示專案名稱-任務名稱 */}
                          <h4 className={`font-bold mb-1 ${isUrgent ? 'text-red-300' : 'text-white'}`}>
                            {displayTitle}
                          </h4>
                          {notification.title && notification.taskName && (
                            <p className="text-xs text-slate-500 mb-2">📝 {notification.title}</p>
                          )}
                          
                          {/* 開會資訊 */}
                          {isMeeting && notification.meetingDate && (
                            <div className="flex items-center gap-4 mb-2 text-sm text-purple-300">
                              <span className="flex items-center gap-1">
                                <Calendar size={14} /> {notification.meetingDate}
                              </span>
                              <span className="flex items-center gap-1">
                                <Clock size={14} /> {notification.meetingTime}
                              </span>
                              {notification.meetingLocation && (
                                <span className="flex items-center gap-1">
                                  📍 {notification.meetingLocation}
                                </span>
                              )}
                            </div>
                          )}
                          
                          {/* 內容 */}
                          <p className="text-slate-300 text-sm whitespace-pre-line">{notification.content}</p>
                          
                          {/* 發送資訊 */}
                          <div className="flex items-center gap-4 mt-3 text-xs text-slate-500">
                            <span>發送者：{notification.sender}</span>
                            <span>時間：{new Date(notification.createdAt).toLocaleString('zh-TW')}</span>
                            <span>收件人：{notification.recipients?.length || 0} 人</span>
                          </div>
                          
                          {/* 🔥 跳轉到專案任務看板按鈕 */}
                          <div className="mt-3 pt-3 border-t border-white/10">
                            <button
                              onClick={handleJumpToProject}
                              className="px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded-lg text-sm font-medium shadow-lg shadow-blue-500/25 transition-all flex items-center gap-2 hover:scale-105"
                            >
                              <ArrowRight size={16} />
                              {notification.taskId ? '前往查看此任務' : '前往專案任務看板'}
                            </button>
                          </div>
                        </div>
                        
                        {/* 操作按鈕 */}
                        <div className="flex flex-col gap-2">
                          {notification.senderUsername === user?.username && (
                            <button
                              onClick={(e) => { 
                                e.stopPropagation(); 
                                console.log('🔍 通知資料:', notification);
                                console.log('🔍 通知 ID:', notification.id);
                                deleteNotification(notification.id); 
                              }}
                              className="p-2 text-slate-500 hover:text-red-400 hover:bg-red-500/20 rounded-lg transition-all"
                              title="刪除通知"
                            >
                              <Trash2 size={16} />
                            </button>
                          )}
                          {isRead && (
                            <span className="text-xs text-emerald-400 flex items-center gap-1">
                              <CheckCircle size={12} /> 已讀
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}
        
        <div className={gridClass}>
          {hasPermission('TQM') && (
          <button 
            onClick={() => onSelect('TQM')}
            className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-white/10 group text-left hover:bg-white/15"
          >
            <div className="bg-gradient-to-br from-blue-500 to-blue-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform">
              <CheckCircle2 className="w-8 h-8 text-white" />
            </div>
            <h2 className="text-xl font-bold text-white mb-2">TQM 品質管理</h2>
            <p className="text-slate-400 text-sm">管理異常紀錄、追蹤改善進度、統計分析報表。</p>
          </button>
          )}

          {hasPermission('KPI_PERSONAL') && (
          <button 
            onClick={() => onSelect('KPI_PERSONAL')}
            className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-cyan-500/30 group text-left relative overflow-hidden hover:bg-white/15"
          >
            <div className="absolute top-4 right-4 bg-gradient-to-r from-cyan-500 to-blue-500 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-lg">簡化版</div>
            <div className="bg-gradient-to-br from-cyan-500 to-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-cyan-500/30 group-hover:scale-110 transition-transform">
              <User className="w-8 h-8 text-white" />
            </div>
            <h2 className="text-xl font-bold text-white mb-2">KPI 個人填寫</h2>
            <p className="text-slate-400 text-sm">5分鐘快速填寫,只記錄工作內容,不用算分數。</p>
          </button>
          )}

          {hasPermission('KPI') && (
          <button 
            onClick={() => onSelect('KPI')}
            className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-white/10 group text-left hover:bg-white/15"
          >
            <div className="bg-gradient-to-br from-purple-500 to-purple-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-purple-500/30 group-hover:scale-110 transition-transform">
              <Target className="w-8 h-8 text-white" />
            </div>
            <h2 className="text-xl font-bold text-white mb-2">KPI 管理儀表板</h2>
            <p className="text-slate-400 text-sm">主管專用:評核員工表現、年度趨勢分析。</p>
          </button>
          )}

          {hasPermission('PROJECT') && (
          <button 
            onClick={() => onSelect('PROJECT')}
            className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-white/10 group text-left hover:bg-white/15"
          >
            <div className="bg-gradient-to-br from-indigo-500 to-indigo-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-indigo-500/30 group-hover:scale-110 transition-transform">
              <Activity className="w-8 h-8 text-white" />
            </div>
            <h2 className="text-xl font-bold text-white mb-2">R&D Nexus</h2>
            <p className="text-slate-400 text-sm">研發專案進度追蹤、甘特圖管理、資源負載分析。</p>
          </button>
          )}

          {hasPermission('KPI_REPORT') && (
          <button 
            onClick={() => onSelect('KPI_REPORT')}
            className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-white/10 group text-left hover:bg-white/15 relative overflow-hidden"
          >
            <div className="absolute top-3 right-3 bg-gradient-to-r from-emerald-400 to-green-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg animate-pulse">NEW</div>
            <div className="bg-gradient-to-br from-emerald-500 to-green-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform">
              <BarChart3 className="w-8 h-8 text-white" />
            </div>
            <h2 className="text-xl font-bold text-white mb-2">KPI 整合報告</h2>
            <p className="text-slate-400 text-sm">研發部門綜合評分、五大指標整合分析。</p>
          </button>
          )}

          {hasPermission('WAR_ROOM') && (
          <button 
            onClick={() => onSelect('PRODUCT_WAR_ROOM')}
            className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-white/10 group text-left hover:bg-white/15 relative overflow-hidden"
          >
            <div className="absolute top-3 right-3 bg-gradient-to-r from-cyan-400 to-blue-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg">戰情</div>
            <div className="bg-gradient-to-br from-cyan-500 to-blue-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-cyan-500/30 group-hover:scale-110 transition-transform">
              <Cpu className="w-8 h-8 text-white" />
            </div>
            <h2 className="text-xl font-bold text-white mb-2">產品開發戰情室</h2>
            <p className="text-slate-400 text-sm">料號分析、開發趨勢、單據追蹤、戰情匯報。</p>
          </button>
          )}

          {hasPermission('APPRAISAL') && (
            <button 
              onClick={() => onSelect('APPRAISAL')}
              className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-white/10 group text-left hover:bg-white/15 relative overflow-hidden"
            >
              <div className="absolute top-3 right-3 bg-gradient-to-r from-amber-400 to-orange-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg">限定</div>
              <div className="bg-gradient-to-br from-amber-500 to-orange-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-amber-500/30 group-hover:scale-110 transition-transform">
                <Shield className="w-8 h-8 text-white" />
              </div>
              <h2 className="text-xl font-bold text-white mb-2">Appraisal 儀表板</h2>
              <p className="text-slate-400 text-sm">上傳 Excel 考核檔並快速生成分析儀表板。</p>
              <div className="mt-3 inline-flex items-center gap-2 text-xs font-bold text-amber-400 uppercase tracking-wide">
                <Shield className="w-3 h-3"/>管理員限定
              </div>
            </button>
          )}

          {hasPermission('ELEC_SPEC') && (
            <button 
              onClick={() => onSelect('ELEC_SPEC')}
              className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-teal-500/30 group text-left hover:bg-teal-500/10 relative overflow-hidden"
            >
              <div className="absolute top-3 right-3 bg-gradient-to-r from-teal-400 to-cyan-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg">電規</div>
              <div className="bg-gradient-to-br from-teal-500 to-cyan-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-teal-500/30 group-hover:scale-110 transition-transform">
                <Cpu className="w-8 h-8 text-white" />
              </div>
              <h2 className="text-xl font-bold text-white mb-2">電規追蹤系統</h2>
              <p className="text-slate-400 text-sm">機台電規登記、零件序號追溯、履歷管理。</p>
            </button>
          )}
          
          {user.role === 'admin' && (
            <button 
              onClick={() => onSelect('ADMIN')}
              className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-red-500/30 group text-left hover:bg-red-500/10 relative overflow-hidden"
            >
              <div className="absolute top-3 right-3 bg-gradient-to-r from-red-500 to-pink-600 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg animate-pulse">ADMIN</div>
              <div className="bg-gradient-to-br from-red-500 to-pink-700 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-red-500/30 group-hover:scale-110 transition-transform">
                <Shield className="w-8 h-8 text-white" />
              </div>
              <h2 className="text-xl font-bold text-white mb-2">🔑 管理員功能</h2>
              <p className="text-slate-400 text-sm">帳號管理、權限設定、資料庫匯出入。</p>
            </button>
          )}
        </div>

        <div className="mt-16 flex flex-col items-center gap-6">
          <div className="flex items-center gap-4">
            <button 
              onClick={onExportDB}
              className="flex items-center gap-2 px-6 py-3 text-emerald-400 hover:text-white bg-emerald-500/10 hover:bg-gradient-to-r hover:from-emerald-500 hover:to-green-600 rounded-xl transition-all border border-emerald-500/30 hover:border-transparent shadow-lg hover:shadow-emerald-500/25 backdrop-blur-sm"
            >
              <FileJson size={18} /> 匯出資料庫備份
            </button>
            <button 
              onClick={onLogout} 
              className="flex items-center gap-2 px-6 py-3 text-slate-400 hover:text-white bg-slate-500/10 hover:bg-gradient-to-r hover:from-slate-600 hover:to-slate-700 rounded-xl transition-all border border-slate-500/30 hover:border-transparent shadow-lg hover:shadow-slate-500/25 backdrop-blur-sm"
            >
              <LogOut size={18} /> 登出帳號
            </button>
          </div>
          <p className="text-sm text-slate-500 flex items-center gap-2">
            <span className="inline-block w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
            定期備份資料庫以保護您的資料安全
          </p>
        </div>
      </div>
    </div>
  );
};

// --- R&D Nexus System Wrapper - 優化載入 ---
const RDNexusSystem = ({ onBackToMenu, user }) => {
    const [selectedMachine, setSelectedMachine] = useState(null);
    const [machines, setMachines] = useState([]);
    const [projects, setProjects] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        // 設定初始載入超時保護
        const loadingTimeout = setTimeout(() => {
            if (loading) {
                console.warn('載入超時，強制結束載入狀態');
                setLoading(false);
            }
        }, 5000);

        console.log('🚀 RDNexus 初始化，檢查 sessionStorage:', {
            openMachineId: sessionStorage.getItem('openMachineId'),
            openProjectId: sessionStorage.getItem('openProjectId')
        });

        const unsubscribe = db.subscribe('rd_machines', (data) => {
            setMachines(data);
            setLoading(false);
            clearTimeout(loadingTimeout);
            console.log('📦 機台載入完成:', data.length, '台');
        });
        
        // 🔥 訂閱專案資料以便找到專案所屬的機台
        const unsubProjects = db.subscribe('rd_projects', (data) => {
            setProjects(data);
        });
        
        return () => {
            unsubscribe();
            unsubProjects();
            clearTimeout(loadingTimeout);
        };
    }, []);
    
    // 🔥 檢查是否有從跑馬燈或通知跳轉，自動選擇機台
    useEffect(() => {
        const targetMachineId = sessionStorage.getItem('openMachineId');
        const targetProjectId = sessionStorage.getItem('openProjectId');
        
        console.log('🔍 RDNexus 檢查 sessionStorage:', { 
            targetMachineId,
            targetProjectId, 
            machinesCount: machines.length,
            projectsCount: projects.length,
            machineIds: machines.map(m => m.id)
        });
        
        // 🔥 如果有專案ID，先找到專案所屬的機台
        if (targetProjectId && projects.length > 0 && machines.length > 0) {
            const project = projects.find(p => p.id === targetProjectId);
            if (project && project.machineId) {
                const machine = machines.find(m => m.id === project.machineId);
                if (machine) {
                    setSelectedMachine(machine);
                    console.log('🎯 從專案ID自動選擇機台:', machine.name, '專案:', project.name);
                    // 不清除 openProjectId，讓 ProjectApp 處理
                    return;
                } else {
                    console.warn('⚠️ 找不到專案所屬的機台 ID:', project.machineId);
                    sessionStorage.removeItem('openProjectId');
                }
            } else {
                console.warn('⚠️ 找不到專案或專案沒有機台ID:', targetProjectId);
                sessionStorage.removeItem('openProjectId');
            }
        }
        
        // 只有當機台列表已載入且找到目標機台時才處理
        if (targetMachineId && machines.length > 0) {
            const machine = machines.find(m => m.id === targetMachineId);
            if (machine) {
                setSelectedMachine(machine);
                // 成功選擇後才清除 sessionStorage
                sessionStorage.removeItem('openMachineId');
                console.log('🎯 自動選擇機台:', machine.name);
            } else {
                console.warn('⚠️ 找不到機台 ID:', targetMachineId);
                // 找不到機台時也要清除，避免無限等待
                sessionStorage.removeItem('openMachineId');
            }
        }
    }, [machines, projects]);

    const handleAddMachine = async (newMachine) => {
        await db.addDoc('rd_machines', { ...newMachine, id: 'M' + Date.now() });
    };

    const handleUpdateMachine = async (updatedMachine) => {
        await db.updateDoc('rd_machines', updatedMachine.id, updatedMachine);
    };

    // 顯示載入動畫 - 深色專業主題
    if (loading) {
        return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center">
                {/* 背景裝飾 */}
                <div className="fixed inset-0 overflow-hidden pointer-events-none">
                    <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl animate-pulse"></div>
                    <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
                </div>
                
                <div className="text-center relative z-10">
                    <div className="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 backdrop-blur-xl rounded-3xl mb-6 border border-white/10 shadow-2xl shadow-blue-500/20">
                        <LayoutDashboard size={40} className="text-blue-400 animate-pulse" />
                    </div>
                    <h2 className="text-2xl font-bold text-white mb-3">R&D Nexus</h2>
                    <p className="text-slate-400 mb-6">載入機台資料中...</p>
                    <div className="flex items-center gap-3 justify-center">
                        <div className="w-3 h-3 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full animate-bounce shadow-lg shadow-blue-500/50"></div>
                        <div className="w-3 h-3 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full animate-bounce shadow-lg shadow-blue-500/50" style={{animationDelay: '0.15s'}}></div>
                        <div className="w-3 h-3 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full animate-bounce shadow-lg shadow-blue-500/50" style={{animationDelay: '0.3s'}}></div>
                    </div>
                </div>
            </div>
        );
    }

    if (selectedMachine) {
        return <ProjectApp machine={selectedMachine} user={user} onBackToMachines={() => setSelectedMachine(null)} />;
    }

    return (
        <MachineSelectionView 
            machines={machines}
            onSelect={setSelectedMachine} 
            onBack={onBackToMenu} 
            onAddMachine={handleAddMachine}
            onUpdateMachine={handleUpdateMachine}
            user={user}
        />
    );
};

// ============================================================
// 電規追蹤系統 (Electrical Spec Tracking System)
// ============================================================

// --- 動態載入 XLSX 函式庫 ---
const loadXLSXForSpec = () => {
  return new Promise((resolve) => {
    if (window.XLSX) return resolve(window.XLSX);
    const script = document.createElement('script');
    script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
    script.onload = () => resolve(window.XLSX);
    document.head.appendChild(script);
  });
};

// --- 進階資料解析引擎：支援原始格式與匯出格式 ---
const processSpecRawData = (dataMatrix, fileName) => {
  if (!dataMatrix || dataMatrix.length < 1) return [];

  const firstRow = dataMatrix[0].map(c => String(c || '').trim());
  const isExportedSummary = firstRow.includes("機台 ID") && firstRow.includes("遊戲序號");
  const isExportedDetails = firstRow.includes("唯一序號 (S/N)") || firstRow.includes("零件名稱 (中)");

  if (isExportedSummary) {
    return dataMatrix.slice(1).map(row => {
      const obj = {};
      firstRow.forEach((header, idx) => {
        if (header === "機台 ID") obj.id = row[idx];
        if (header === "遊戲序號") obj.gameSerial = row[idx];
        if (header === "訂單編號") obj.orderNo = row[idx];
        if (header === "PO 編號") obj.poNo = row[idx];
        if (header === "出貨日期") obj.shipDate = row[idx];
        if (header === "資料來源") obj.importSource = row[idx];
      });
      return { ...obj, parts: [], timestamp: new Date().getTime() };
    }).filter(m => m.id);
  }

  if (isExportedDetails) {
    const machineMap = {};
    dataMatrix.slice(1).forEach(row => {
      const mid = row[firstRow.indexOf("機台 ID")];
      if (!mid) return;
      if (!machineMap[mid]) {
        machineMap[mid] = {
          id: mid,
          gameSerial: row[firstRow.indexOf("遊戲序號")] || '',
          shipDate: row[firstRow.indexOf("出貨日期")] || '',
          orderNo: '來源自明細匯入',
          parts: [],
          importSource: fileName,
          timestamp: new Date().getTime()
        };
      }
      machineMap[mid].parts.push({
        category: row[firstRow.indexOf("零件區域")] || row[firstRow.indexOf("區域")] || '未分類',
        name: row[firstRow.indexOf("零件名稱 (中)")] || row[firstRow.indexOf("中文名稱")] || '',
        desc: row[firstRow.indexOf("零件名稱 (英)")] || row[firstRow.indexOf("英文名稱")] || '',
        sn: row[firstRow.indexOf("唯一序號 (S/N)")] || ''
      });
    });
    return Object.values(machineMap);
  }

  let orderNo = "未知訂單";
  let poNo = "未知 PO";
  let idRowIdx = -1;
  let gameSerialRowIdx = -1;
  let partsStartRowIdx = -1;

  for (let i = 0; i < Math.min(dataMatrix.length, 30); i++) {
    const row = dataMatrix[i] || [];
    const rowStr = row.join('|');
    if (rowStr.includes('訂單')) {
      const foundOrder = row.find(c => String(c).includes('2210-') || String(c).includes('2230-'));
      if (foundOrder) orderNo = foundOrder;
    }
    if (rowStr.includes('PO#')) poNo = row[0] || "未知 PO";
    if (rowStr.includes('Feiloli機台電規')) idRowIdx = i;
    if (rowStr.includes('Game Serial #')) gameSerialRowIdx = i;
    if (rowStr.includes('Chinese Description') || rowStr.includes('Description')) partsStartRowIdx = i + 1;
  }

  if (idRowIdx === -1) return [];

  const machines = [];
  const headerRow = dataMatrix[idRowIdx];
  const dataRow = dataMatrix[idRowIdx + 1]; 
  const colCount = headerRow.length;
  
  for (let j = 2; j < colCount; j++) {
    const machineId = dataRow?.[j];
    if (!machineId || machineId === "" || machineId === "x") continue;

    const currentShipDate = dataRow?.[1] || "";
    const gameSerial = (gameSerialRowIdx !== -1 && dataMatrix[gameSerialRowIdx + 1]) 
      ? dataMatrix[gameSerialRowIdx + 1][j] 
      : "";

    const machineData = {
      id: machineId,
      importSource: fileName,
      orderNo: orderNo,
      poNo: poNo,
      shipDate: currentShipDate,
      gameSerial: String(gameSerial || "").trim(),
      parts: [],
      timestamp: new Date().getTime()
    };

    if (partsStartRowIdx !== -1) {
      let currentCategory = "一般零件";
      for (let i = partsStartRowIdx; i < dataMatrix.length; i++) {
        const row = dataMatrix[i];
        const chineseName = row?.[0];
        const englishName = row?.[1];
        const serial = row?.[j];

        if (!chineseName && !englishName) continue;
        if (String(serial).trim() === "Serial#") {
          currentCategory = chineseName;
          continue;
        }
        if (!serial || serial === "" || String(serial).toLowerCase() === "x") continue;
        
        machineData.parts.push({
          category: currentCategory,
          name: chineseName,
          desc: englishName,
          sn: String(serial).trim()
        });
      }
    }
    machines.push(machineData);
  }
  return machines;
};

// --- 匯出中心彈窗組件 ---
const SpecExportCenterModal = ({ isOpen, onClose, machines, onExport }) => {
  const [selectedIds, setSelectedIds] = useState([]);
  const [includeParts, setIncludeParts] = useState(true);
  const [fields, setFields] = useState({
    id: true, gameSerial: true, orderNo: true, poNo: true, shipDate: true, partsCount: true, source: false
  });

  useEffect(() => { if (isOpen) setSelectedIds(machines.map(m => m.id)); }, [isOpen, machines]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-xl">
      <div className="bg-white w-full max-w-5xl max-h-[90vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-white/20">
        {/* 頂部標題區 - 升級版 */}
        <div className="relative p-8 border-b border-slate-100 flex justify-between items-center bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900 text-white overflow-hidden">
          <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full -mr-32 -mt-32 opacity-20 blur-[80px]"></div>
          <div className="absolute bottom-0 left-1/3 w-48 h-48 bg-emerald-500 rounded-full opacity-10 blur-[60px]"></div>
          <div className="relative z-10">
            <div className="flex items-center space-x-4">
              <div className="w-14 h-14 bg-gradient-to-br from-emerald-400 to-emerald-500 rounded-2xl flex items-center justify-center shadow-xl shadow-emerald-500/30">
                <Settings2 size={26} className="text-white" />
              </div>
              <div>
                <h2 className="text-2xl font-black text-white tracking-tight">自訂匯出設定</h2>
                <p className="text-sm text-blue-300/80 font-medium mt-1 uppercase tracking-widest">Custom Export Configuration</p>
              </div>
            </div>
          </div>
          <button onClick={onClose} className="relative z-10 p-3 hover:bg-white/10 rounded-xl transition-all text-white/60 hover:text-white border border-white/10 hover:border-white/20">
            <X size={22} />
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-8 grid grid-cols-1 lg:grid-cols-5 gap-8 bg-gradient-to-b from-slate-50 to-white">
          {/* 左側：機台選擇 */}
          <div className="lg:col-span-2 space-y-4">
            <div className="flex justify-between items-center">
              <div className="font-bold text-slate-800 text-sm flex items-center">
                <div className="w-7 h-7 bg-blue-100 rounded-lg flex items-center justify-center mr-2">
                  <span className="text-blue-600 font-black text-xs">1</span>
                </div>
                選取機台範圍
                <span className="ml-2 px-2 py-0.5 bg-blue-600 text-white text-xs font-bold rounded-full">{selectedIds.length}</span>
              </div>
              <div className="flex space-x-3">
                <button onClick={() => setSelectedIds(machines.map(m => m.id))} className="text-xs font-bold text-blue-600 hover:text-blue-800 transition-colors px-3 py-1 rounded-lg hover:bg-blue-50">全選</button>
                <button onClick={() => setSelectedIds([])} className="text-xs font-bold text-slate-400 hover:text-rose-500 transition-colors px-3 py-1 rounded-lg hover:bg-rose-50">清除</button>
              </div>
            </div>
            <div className="border-2 border-slate-100 rounded-2xl overflow-hidden bg-white p-3 max-h-[350px] overflow-y-auto shadow-inner">
              {machines.map(m => (
                <label key={m.id} className={`flex items-center px-4 py-3.5 rounded-xl mb-2 last:mb-0 cursor-pointer transition-all duration-300 ${selectedIds.includes(m.id) ? 'bg-gradient-to-r from-blue-50 to-indigo-50 shadow-md border border-blue-200' : 'hover:bg-slate-50 opacity-60 border border-transparent'}`}>
                  <div className={`w-6 h-6 rounded-lg border-2 mr-4 flex items-center justify-center transition-all duration-300 ${selectedIds.includes(m.id) ? 'bg-gradient-to-br from-blue-500 to-blue-600 border-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-white border-slate-300'}`}>
                    {selectedIds.includes(m.id) && <Check size={14} strokeWidth={4} />}
                  </div>
                  <input type="checkbox" className="hidden" checked={selectedIds.includes(m.id)} onChange={() => setSelectedIds(prev => prev.includes(m.id) ? prev.filter(i => i !== m.id) : [...prev, m.id])} />
                  <div className="flex flex-col">
                    <span className="text-sm font-bold text-slate-800">{m.id}</span>
                    <span className="text-xs text-slate-400 font-mono">{m.gameSerial || 'NO SN'}</span>
                  </div>
                </label>
              ))}
            </div>
          </div>

          {/* 右側：欄位選擇 */}
          <div className="lg:col-span-3 space-y-8">
            <div>
              <div className="font-bold text-slate-800 text-sm flex items-center mb-5">
                <div className="w-7 h-7 bg-emerald-100 rounded-lg flex items-center justify-center mr-2">
                  <span className="text-emerald-600 font-black text-xs">2</span>
                </div>
                選取導出欄位
              </div>
              <div className="grid grid-cols-2 gap-4">
                {[
                  { id: 'id', label: 'Feiloli ID', icon: QrCode },
                  { id: 'gameSerial', label: '遊戲序號 (SN)', icon: Hash },
                  { id: 'orderNo', label: '訂單編號', icon: FileText },
                  { id: 'poNo', label: 'PO 號碼', icon: FileText },
                  { id: 'shipDate', label: '出貨日期', icon: Calendar },
                  { id: 'partsCount', label: '零件總數', icon: Package }
                ].map(f => (
                  <label key={f.id} className={`flex items-center p-4 rounded-xl border-2 transition-all duration-300 cursor-pointer ${fields[f.id] ? 'bg-gradient-to-r from-emerald-50 to-white border-emerald-400 shadow-lg shadow-emerald-500/10' : 'bg-slate-50/50 border-slate-100 text-slate-400 hover:border-slate-200 hover:bg-white'}`}>
                    <div className={`w-5 h-5 rounded-lg flex items-center justify-center mr-3 transition-all duration-300 ${fields[f.id] ? 'bg-gradient-to-br from-emerald-400 to-emerald-500 text-white shadow-md' : 'bg-slate-200 text-transparent'}`}>
                      <Check size={12} strokeWidth={4} />
                    </div>
                    <input type="checkbox" className="hidden" checked={fields[f.id]} onChange={() => setFields({...fields, [f.id]: !fields[f.id]})} />
                    <span className="text-sm font-bold">{f.label}</span>
                  </label>
                ))}
              </div>
            </div>

            <div className="relative p-6 bg-gradient-to-br from-indigo-600 via-blue-600 to-blue-700 rounded-2xl text-white shadow-2xl shadow-blue-500/20 overflow-hidden">
              <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
              <div className="relative z-10">
                <div className="flex items-center mb-4">
                  <div className="w-7 h-7 bg-white/20 rounded-lg flex items-center justify-center mr-2">
                    <span className="text-white font-black text-xs">3</span>
                  </div>
                  <h3 className="font-bold uppercase text-sm tracking-widest">數據明細模式</h3>
                </div>
                <label className="flex items-center cursor-pointer group">
                  <div className={`w-7 h-7 rounded-xl border-2 border-white/40 mr-4 flex items-center justify-center transition-all duration-300 ${includeParts ? 'bg-white text-blue-600 scale-110 shadow-xl border-white' : 'bg-transparent text-transparent'}`}>
                     <Check size={16} strokeWidth={4} />
                  </div>
                  <input type="checkbox" className="hidden" checked={includeParts} onChange={() => setIncludeParts(!includeParts)} />
                  <div className="flex flex-col">
                    <span className="text-base font-bold">包含「零件全明細分頁」</span>
                    <p className="text-sm opacity-70 mt-1">建立零件 ID 關聯表，供庫存追蹤與故障盤點</p>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        {/* 底部操作區 */}
        <div className="p-8 border-t border-slate-100 flex items-center justify-between bg-white">
          <div className="bg-gradient-to-r from-slate-100 to-slate-50 px-5 py-3 rounded-xl border border-slate-200 shadow-inner">
            <span className="text-xs font-bold text-slate-400 uppercase">已選取: </span>
            <span className="text-lg font-black text-blue-600">{selectedIds.length}</span>
            <span className="text-sm font-bold text-slate-400 ml-1">台機台</span>
          </div>
          <div className="flex space-x-4">
            <button onClick={onClose} className="px-6 py-3.5 font-bold text-sm text-slate-500 hover:text-slate-900 transition-colors rounded-xl hover:bg-slate-100">取消</button>
            <button 
              onClick={() => { const s = machines.filter(m => selectedIds.includes(m.id)); onExport(s, fields, includeParts); onClose(); }}
              disabled={selectedIds.length === 0}
              className="group px-8 py-3.5 bg-gradient-to-r from-slate-800 to-slate-900 text-white rounded-xl font-bold text-sm hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-xl hover:shadow-blue-500/25 hover:-translate-y-0.5 disabled:opacity-30 disabled:translate-y-0 disabled:hover:from-slate-800 disabled:hover:to-slate-900 flex items-center"
            >
              <Download size={18} className="mr-2 group-hover:animate-bounce" /> 生成報表
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- 儀表板視圖 ---
const SpecDashboardView = ({ stats, onUpload, onNavigate, onOpenExport }) => (
  <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
    {/* 統計卡片區 */}
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
      {/* 機台總數卡片 */}
      <div className="relative bg-gradient-to-br from-white to-slate-50 p-8 rounded-3xl shadow-lg border border-slate-100/80 overflow-hidden group hover:shadow-xl transition-all duration-500">
        <div className="absolute -right-8 -top-8 w-32 h-32 bg-gradient-to-br from-blue-500/20 to-indigo-500/10 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-700"></div>
        <div className="absolute right-4 bottom-4 opacity-5 group-hover:opacity-10 transition-opacity">
          <Activity size={100} />
        </div>
        <div className="relative z-10">
          <div className="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center justify-center mb-5 shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform">
            <Activity size={28} />
          </div>
          <p className="text-slate-400 text-[11px] font-bold uppercase tracking-[0.2em] mb-2">Total Machines</p>
          <p className="text-5xl font-black text-slate-900 tracking-tight">{stats.total}</p>
          <div className="mt-5 flex items-center text-emerald-600 text-xs font-bold bg-emerald-50 w-fit px-3 py-1.5 rounded-full border border-emerald-100">
            <CheckCircle2 size={14} className="mr-1.5" /> 系統運行正常
          </div>
        </div>
      </div>
      
      {/* 型號分佈卡片 */}
      <div className="relative bg-gradient-to-br from-white to-slate-50 p-8 rounded-3xl shadow-lg border border-slate-100/80 overflow-hidden group hover:shadow-xl transition-all duration-500">
        <div className="absolute -left-8 -bottom-8 w-32 h-32 bg-gradient-to-br from-emerald-500/20 to-teal-500/10 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-700"></div>
        <div className="relative z-10">
          <div className="w-14 h-14 bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-2xl flex items-center justify-center mb-5 shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform">
            <Layers size={28} />
          </div>
          <p className="text-slate-400 text-[11px] font-bold uppercase tracking-[0.2em] mb-4">Model Distribution</p>
          <div className="flex flex-wrap gap-2 max-h-[100px] overflow-y-auto custom-scrollbar">
            {Object.entries(stats.models).map(([model, count]) => (
              <div key={model} className="bg-white hover:bg-emerald-50 px-3 py-2 rounded-xl border border-slate-100 hover:border-emerald-200 transition-all flex items-center shadow-sm cursor-default">
                <span className="w-2 h-2 rounded-full bg-gradient-to-r from-emerald-400 to-teal-400 mr-2 shadow-sm"></span>
                <span className="text-xs font-bold text-slate-700">{model}</span>
                <span className="ml-2 text-xs font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded">{count}</span>
              </div>
            ))}
            {stats.total === 0 && <p className="text-slate-300 italic text-sm py-4">等待資料匯入...</p>}
          </div>
        </div>
      </div>

      {/* 匯出中心卡片 */}
      <div className="relative bg-gradient-to-br from-slate-900 via-slate-800 to-indigo-900 p-8 rounded-3xl shadow-2xl overflow-hidden group hover:shadow-indigo-500/20 transition-all duration-500">
        <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIwLjUiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=')] opacity-10"></div>
        <div className="absolute right-0 bottom-0 opacity-10 group-hover:opacity-20 group-hover:scale-125 transition-all duration-700">
           <FileSpreadsheet size={140} />
        </div>
        <div className="absolute top-0 right-0 w-40 h-40 bg-blue-500 rounded-full -mr-20 -mt-20 opacity-20 blur-3xl"></div>
        <div className="relative z-10 flex flex-col h-full justify-between">
          <div>
            <div className="inline-flex items-center px-3 py-1 bg-white/10 backdrop-blur-sm rounded-full text-xs font-bold text-blue-300 uppercase tracking-widest mb-4 border border-white/10">
              <Settings2 size={12} className="mr-1.5" /> Export Center
            </div>
            <h4 className="text-xl font-black text-white mb-2">資料匯出報表</h4>
            <p className="text-sm text-slate-400 leading-relaxed">支援自訂機台、欄位選擇與零件明細匯出至 Excel。</p>
          </div>
          <button onClick={onOpenExport} className="mt-6 bg-white/10 hover:bg-white text-white hover:text-slate-900 px-5 py-3.5 rounded-2xl font-bold text-sm transition-all flex items-center justify-center border border-white/20 backdrop-blur-sm shadow-lg hover:shadow-xl group-hover:scale-[1.02]">
            <Download size={18} className="mr-2" /> 前往匯出中心
          </button>
        </div>
      </div>
    </div>

    {/* 下方區塊 */}
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* 上傳區塊 */}
      <div className="relative bg-gradient-to-br from-white to-blue-50/30 p-10 rounded-3xl shadow-lg border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all duration-500 group overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        <div className="relative z-10 flex flex-col items-center justify-center text-center">
          <div className="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-50 text-slate-300 rounded-3xl flex items-center justify-center mb-6 group-hover:bg-gradient-to-br group-hover:from-blue-100 group-hover:to-indigo-100 group-hover:text-blue-500 transition-all duration-500 shadow-inner group-hover:shadow-lg group-hover:scale-110">
            <Upload size={44} strokeWidth={1.5} />
          </div>
          <h3 className="text-2xl font-black text-slate-800 mb-3 tracking-tight">匯入電規檔案</h3>
          <p className="text-slate-400 text-sm mb-8 max-w-sm leading-relaxed">支援原始工廠 CSV/XLSX 檔案或本系統匯出之報表檔案，系統將自動解析合併數據。</p>
          <label className="relative bg-gradient-to-r from-slate-900 to-slate-800 hover:from-blue-600 hover:to-indigo-600 text-white px-10 py-4 rounded-2xl font-bold cursor-pointer transition-all shadow-xl hover:shadow-2xl hover:-translate-y-1 text-sm uppercase tracking-widest group/btn">
            <span className="flex items-center">
              <Upload size={18} className="mr-2 group-hover/btn:animate-bounce" /> 選取檔案開始
            </span>
            <input type="file" multiple accept=".xlsx,.xls,.csv" className="hidden" onChange={onUpload} />
          </label>
        </div>
      </div>

      {/* 最近紀錄 */}
      <div className="bg-white p-8 rounded-3xl shadow-lg border border-slate-100/80 overflow-hidden">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center">
             <div className="w-10 h-10 bg-gradient-to-br from-amber-100 to-orange-100 text-amber-600 rounded-xl flex items-center justify-center mr-3 shadow-sm"><History size={20} /></div>
             <div>
               <h3 className="text-lg font-black text-slate-800">最近更新紀錄</h3>
               <p className="text-xs text-slate-400">Recent Activities</p>
             </div>
          </div>
          <div className="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-500">{stats.recent.length} 筆</div>
        </div>
        <div className="space-y-3 max-h-[320px] overflow-y-auto custom-scrollbar pr-2">
          {stats.recent.map((m, idx) => (
            <div key={m.id} className="p-4 bg-gradient-to-r from-slate-50 to-white hover:from-blue-50 hover:to-white rounded-2xl flex items-center justify-between group cursor-pointer border border-transparent hover:border-blue-100 hover:shadow-lg transition-all duration-300" onClick={() => onNavigate(m)}>
              <div className="flex items-center space-x-4">
                <div className="relative">
                  <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg shadow-blue-500/20 group-hover:scale-110 transition-transform">
                    {m.id.charAt(0)}
                  </div>
                  <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center text-white text-xs font-bold border-2 border-white shadow">{idx + 1}</div>
                </div>
                <div>
                  <p className="font-black text-slate-800 group-hover:text-blue-600 transition-colors">{m.id}</p>
                  <div className="flex items-center space-x-2 mt-1">
                     <span className="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded uppercase">{m.orderNo}</span>
                     <span className="text-[10px] font-bold text-blue-500 font-mono bg-blue-50 px-2 py-0.5 rounded">SN: {m.gameSerial || '---'}</span>
                  </div>
                </div>
              </div>
              <div className="p-2.5 bg-white rounded-xl text-slate-300 group-hover:text-white group-hover:bg-blue-500 group-hover:shadow-lg transition-all">
                <ChevronRight size={18} />
              </div>
            </div>
          ))}
          {stats.recent.length === 0 && (
            <div className="flex flex-col items-center justify-center py-16 text-center">
              <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-300 mb-4">
                <FileText size={32} />
              </div>
              <p className="text-slate-400 font-bold">尚未匯入任何資料</p>
              <p className="text-slate-300 text-sm mt-1">開始匯入您的第一筆電規資料</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
);

// --- 機台列表視圖 ---
const SpecMachineListView = ({ machines, searchTerm, setSearchTerm, onSelect, onClear, onOpenExport }) => (
  <div className="bg-white rounded-3xl shadow-xl border border-slate-100/80 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
    {/* 搜尋工具列 */}
    <div className="p-6 border-b border-slate-100 flex flex-col xl:flex-row xl:items-center justify-between gap-4 bg-gradient-to-r from-slate-50/80 to-white">
      <div className="relative flex-1 max-w-2xl group">
        <div className="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-slate-100 group-focus-within:bg-blue-100 rounded-xl flex items-center justify-center transition-colors">
          <Search className="text-slate-400 group-focus-within:text-blue-500 transition-colors" size={20} />
        </div>
        <input 
          type="text" 
          placeholder="搜尋機台 ID、序號、訂單編號或特定零件 S/N..." 
          className="w-full pl-16 pr-6 py-4 bg-white border-2 border-slate-100 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-400 transition-all font-medium text-slate-700 shadow-sm placeholder:text-slate-300"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
        />
        {searchTerm && (
          <button onClick={() => setSearchTerm('')} className="absolute right-4 top-1/2 -translate-y-1/2 p-1.5 bg-slate-100 hover:bg-rose-100 rounded-lg text-slate-400 hover:text-rose-500 transition-all">
            <X size={16} />
          </button>
        )}
      </div>
      <div className="flex space-x-3">
        <button onClick={onOpenExport} className="px-6 py-3.5 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white rounded-2xl font-bold text-xs transition-all flex items-center shadow-lg shadow-emerald-500/20 hover:shadow-xl hover:-translate-y-0.5 uppercase tracking-widest">
          <Download size={16} className="mr-2" /> 匯出報表
        </button>
        <button onClick={onClear} className="p-3.5 text-rose-500 bg-rose-50 border border-rose-100 hover:bg-rose-500 hover:text-white hover:border-rose-500 rounded-2xl transition-all shadow-sm hover:shadow-lg">
          <Trash2 size={20} />
        </button>
      </div>
    </div>
    
    {/* 表格 */}
    <div className="overflow-x-auto">
      <table className="w-full text-left border-collapse">
        <thead>
          <tr className="bg-gradient-to-r from-slate-50 to-slate-100/50">
            <th className="px-8 py-5 text-[11px] font-black text-slate-400 uppercase tracking-[0.15em]">機台 ID 編號</th>
            <th className="px-6 py-5 text-[11px] font-black text-slate-400 uppercase tracking-[0.15em]">遊戲機 SN</th>
            <th className="px-6 py-5 text-[11px] font-black text-slate-400 uppercase tracking-[0.15em]">訂單資訊</th>
            <th className="px-6 py-5 text-[11px] font-black text-slate-400 uppercase tracking-[0.15em] text-center">電規項數</th>
            <th className="px-6 py-5"></th>
          </tr>
        </thead>
        <tbody className="divide-y divide-slate-50">
          {machines.map((m, idx) => (
            <tr key={m.id} className="hover:bg-gradient-to-r hover:from-blue-50/50 hover:to-transparent transition-all group cursor-pointer" onClick={() => onSelect(m)}>
              <td className="px-8 py-5">
                <div className="flex items-center space-x-4">
                  <div className="w-11 h-11 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg shadow-blue-500/20 group-hover:scale-110 transition-transform">
                    {m.id.charAt(0)}
                  </div>
                  <div>
                    <span className="font-black text-slate-900 text-base group-hover:text-blue-600 transition-colors block">{m.id}</span>
                    <p className="text-[11px] text-slate-400 mt-0.5 font-medium">{m.shipDate || '未註記日期'}</p>
                  </div>
                </div>
              </td>
              <td className="px-6 py-5">
                <div className="flex items-center space-x-2">
                   <div className="p-2 bg-gradient-to-br from-slate-100 to-slate-50 rounded-lg text-slate-400 shadow-inner"><QrCode size={16} /></div>
                   <span className="font-mono text-sm font-bold text-slate-600 bg-slate-50 px-2 py-1 rounded">{m.gameSerial || '------'}</span>
                </div>
              </td>
              <td className="px-6 py-5">
                <p className="text-sm font-bold text-slate-700">{m.orderNo}</p>
                <p className="text-[11px] text-slate-400 truncate max-w-[200px] mt-0.5 font-medium">{m.importSource}</p>
              </td>
              <td className="px-6 py-5 text-center">
                <span className="inline-flex items-center bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 text-blue-700 px-4 py-1.5 rounded-full text-xs font-black shadow-sm group-hover:from-blue-100 group-hover:to-indigo-100 transition-all">
                  <Package size={12} className="mr-1.5" /> {m.parts.length} 項
                </span>
              </td>
              <td className="px-6 py-5 text-right">
                <button className="p-3 bg-gradient-to-r from-slate-900 to-slate-800 hover:from-blue-600 hover:to-indigo-600 text-white rounded-xl transition-all shadow-lg hover:shadow-xl hover:-translate-x-0.5 group-hover:scale-105">
                  <ChevronRight size={18} />
                </button>
              </td>
            </tr>
          ))}
          {machines.length === 0 && (
            <tr>
              <td colSpan="5" className="py-24">
                <div className="flex flex-col items-center justify-center text-center">
                  <div className="w-20 h-20 bg-slate-100 rounded-3xl flex items-center justify-center text-slate-300 mb-4">
                    <Search size={40} strokeWidth={1.5} />
                  </div>
                  <p className="text-slate-400 font-bold text-lg">找不到符合的資料</p>
                  <p className="text-slate-300 text-sm mt-1">嘗試調整搜尋條件或匯入新資料</p>
                </div>
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
    
    {/* 底部統計 */}
    {machines.length > 0 && (
      <div className="px-8 py-4 bg-gradient-to-r from-slate-50 to-white border-t border-slate-100 flex items-center justify-between">
        <p className="text-sm text-slate-400">
          共 <span className="font-black text-slate-700">{machines.length}</span> 台機台
        </p>
        <div className="flex items-center space-x-2 text-xs text-slate-400">
          <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
          <span>即時同步</span>
        </div>
      </div>
    )}
  </div>
);

// --- 表單視圖 ---
const SpecEntryFormView = ({ initialData, onSave, mode = 'create', suggestions = {} }) => {
  const [formData, setFormData] = useState({
    id: '', orderNo: '', poNo: '', 
    shipDate: new Date().toISOString().slice(0, 10).replace(/-/g, '.'),
    gameSerial: '', 
    parts: [{ category: '控箱區域', name: '', desc: '', sn: '' }],
    ...initialData
  });

  const handlePartChange = (index, field, value) => {
    const newParts = [...formData.parts]; newParts[index][field] = value; setFormData(prev => ({ ...prev, parts: newParts }));
  };

  return (
    <div className="space-y-8">
      {/* 頂部漸層標題區 */}
      <div className="relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900 p-8 rounded-3xl shadow-2xl">
        <div className="absolute top-0 right-0 w-80 h-80 bg-blue-500 rounded-full -mr-40 -mt-40 opacity-20 blur-[100px]"></div>
        <div className="absolute bottom-0 left-0 w-60 h-60 bg-emerald-500 rounded-full -ml-30 -mb-30 opacity-10 blur-[80px]"></div>
        <div className="relative z-10 flex items-center justify-between">
          <div className="flex items-center space-x-5">
            <div className={`w-16 h-16 ${mode === 'edit' ? 'bg-gradient-to-br from-amber-400 to-orange-500' : 'bg-gradient-to-br from-blue-400 to-blue-600'} rounded-2xl flex items-center justify-center shadow-2xl`}>
              {mode === 'edit' ? <Edit3 size={28} className="text-white" /> : <PlusCircle size={28} className="text-white" />}
            </div>
            <div>
              <h1 className="text-3xl font-black text-white tracking-tight">{mode === 'edit' ? `修改機台履歷` : '登記新機台電規'}</h1>
              <p className="text-blue-300/70 text-sm font-medium mt-1 uppercase tracking-widest">Electrical Specification Registry</p>
              {mode === 'edit' && <p className="text-emerald-400 font-mono font-bold mt-1 text-lg">{formData.id}</p>}
            </div>
          </div>
        </div>
      </div>
      
      {/* 表單主體 */}
      <div className="bg-white/80 backdrop-blur-xl p-8 rounded-3xl shadow-xl border border-white/50">
        <form onSubmit={(e) => { e.preventDefault(); onSave({...formData, timestamp: new Date().getTime()}); }} className="space-y-10">
          
          {/* 基本資訊區塊 */}
          <div className="space-y-6">
            <div className="flex items-center space-x-3 mb-6">
              <div className="w-1.5 h-8 bg-gradient-to-b from-blue-500 to-blue-600 rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800">基本資訊</h2>
              <span className="text-xs font-medium text-slate-400 uppercase tracking-widest">Basic Information</span>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div className="group">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 ml-1 group-focus-within:text-blue-600 transition-colors">
                  <span className="flex items-center"><QrCode size={12} className="mr-1.5" />機台編號 (Feiloli ID) *</span>
                </label>
                <input name="id" value={formData.id} onChange={(e) => setFormData({...formData, id: e.target.value})} required disabled={mode === 'edit'} className={`w-full px-5 py-4 border-2 rounded-2xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none font-bold text-lg transition-all duration-300 ${mode === 'edit' ? 'bg-slate-100 text-slate-400 border-slate-200' : 'bg-white text-blue-600 border-slate-200 hover:border-blue-300'}`} placeholder="例: F32H-0070" />
              </div>
              <div className="group">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 ml-1 group-focus-within:text-blue-600 transition-colors">
                  <span className="flex items-center"><Cpu size={12} className="mr-1.5" />遊戲機序號 (SN) *</span>
                </label>
                <input name="gameSerial" value={formData.gameSerial} onChange={(e) => setFormData({...formData, gameSerial: e.target.value})} required className="w-full px-5 py-4 bg-white border-2 border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none font-bold text-lg text-slate-700 font-mono transition-all duration-300 hover:border-blue-300" placeholder="例: L-29XXX" />
              </div>
              <div className="group">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 ml-1 group-focus-within:text-blue-600 transition-colors">
                  <span className="flex items-center"><Calendar size={12} className="mr-1.5" />出貨日期記錄</span>
                </label>
                <input name="shipDate" value={formData.shipDate} onChange={(e) => setFormData({...formData, shipDate: e.target.value})} className="w-full px-5 py-4 bg-white border-2 border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none font-bold text-lg font-mono transition-all duration-300 hover:border-blue-300" placeholder="YYYY.MM.DD" />
              </div>
            </div>
          </div>

          {/* 零件資訊區塊 */}
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="w-1.5 h-8 bg-gradient-to-b from-emerald-500 to-emerald-600 rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800">電器零件詳情</h2>
                <span className="text-xs font-medium text-slate-400 uppercase tracking-widest">Parts Details</span>
                <span className="ml-2 px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-bold">{formData.parts.length} 項</span>
              </div>
              <button type="button" onClick={() => setFormData(p => ({ ...p, parts: [...p.parts, { category: p.parts[p.parts.length-1]?.category || '一般區域', name: '', desc: '', sn: '' }] }))} className="flex items-center px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-bold text-sm hover:from-emerald-600 hover:to-emerald-700 transition-all shadow-lg hover:shadow-emerald-500/25 active:scale-95">
                <Plus size={16} className="mr-2" /> 新增零件
              </button>
            </div>

            <datalist id="spec-cat-list">{suggestions.categories?.map(c => <option key={c} value={c} />)}</datalist>
            <datalist id="spec-name-list">{suggestions.names?.map(c => <option key={c} value={c} />)}</datalist>
            <datalist id="spec-desc-list">{suggestions.descs?.map(c => <option key={c} value={c} />)}</datalist>

            <div className="space-y-4">
              {formData.parts.map((part, index) => (
                <div key={index} className="relative flex flex-col xl:flex-row gap-4 bg-gradient-to-br from-slate-50 to-white p-6 rounded-2xl border-2 border-slate-100 group transition-all duration-300 hover:border-blue-200 hover:shadow-xl hover:shadow-blue-500/5">
                  {/* 序號標籤 */}
                  <div className="absolute -top-3 -left-2 w-8 h-8 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center text-white text-xs font-bold shadow-lg">
                    {index + 1}
                  </div>
                  
                  <div className="w-full xl:w-44 space-y-2">
                    <label className="text-xs font-bold text-slate-400 uppercase flex items-center"><Tag size={11} className="mr-1.5 text-slate-300" /> 區域分類</label>
                    <input list="spec-cat-list" value={part.category} onChange={(e) => handlePartChange(index, 'category', e.target.value)} className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm font-bold focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all duration-300 hover:border-blue-300" />
                  </div>
                  <div className="flex-1 space-y-2">
                    <label className="text-xs font-bold text-slate-400 uppercase flex items-center"><Type size={11} className="mr-1.5 text-slate-300" /> 中文品名</label>
                    <input list="spec-name-list" value={part.name} onChange={(e) => handlePartChange(index, 'name', e.target.value)} className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm font-bold focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all duration-300 hover:border-blue-300" />
                  </div>
                  <div className="flex-1 space-y-2">
                    <label className="text-xs font-bold text-slate-400 uppercase flex items-center"><Globe size={11} className="mr-1.5 text-slate-300" /> 英文描述</label>
                    <input list="spec-desc-list" value={part.desc} onChange={(e) => handlePartChange(index, 'desc', e.target.value)} className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm text-slate-600 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all duration-300 hover:border-blue-300" />
                  </div>
                  <div className="w-full xl:w-64 space-y-2">
                    <label className="text-xs font-bold text-slate-400 uppercase flex items-center"><Hash size={11} className="mr-1.5 text-slate-300" /> 唯一序號 S/N</label>
                    <input value={part.sn} onChange={(e) => handlePartChange(index, 'sn', e.target.value)} className="w-full px-4 py-3 bg-gradient-to-r from-blue-50 to-white border-2 border-blue-200 rounded-xl text-sm font-bold text-blue-600 font-mono focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all duration-300 hover:border-blue-400" placeholder="輸入唯一識別碼" />
                  </div>
                  <button type="button" onClick={() => setFormData(p => ({ ...p, parts: p.parts.filter((_, i) => i !== index) }))} className="xl:self-center p-3 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-xl transition-all duration-300 hover:scale-110 active:scale-95"><X size={22} /></button>
                </div>
              ))}
            </div>
          </div>
          
          {/* 提交按鈕 */}
          <button type="submit" className="w-full py-5 bg-gradient-to-r from-slate-800 via-slate-900 to-slate-800 text-white rounded-2xl font-bold text-base hover:from-blue-600 hover:via-blue-700 hover:to-blue-600 transition-all duration-500 shadow-2xl hover:shadow-blue-500/25 hover:-translate-y-1 active:translate-y-0 flex items-center justify-center uppercase tracking-widest group">
            <Save size={22} className="mr-3 group-hover:scale-110 transition-transform" />
            {mode === 'edit' ? '儲存修改' : '完成登記'}
          </button>
        </form>
      </div>
    </div>
  );
};

// --- 追溯詳情視圖 ---
const SpecTraceabilityDetailView = ({ machine, onClose, onEdit }) => {
  if (!machine) return null;
  const grouped = machine.parts.reduce((acc, part) => { if (!acc[part.category]) acc[part.category] = []; acc[part.category].push(part); return acc; }, {});
  
  return (
    <div className="space-y-8">
      {/* 頂部英雄區 - 機台護照 */}
      <div className="relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900 p-10 rounded-3xl shadow-2xl">
        {/* 裝飾性背景元素 */}
        <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-500 rounded-full -mr-64 -mt-64 opacity-20 blur-[120px]"></div>
        <div className="absolute left-0 bottom-0 w-72 h-72 bg-emerald-500 rounded-full -ml-36 -mb-36 opacity-15 blur-[80px]"></div>
        <div className="absolute right-20 bottom-10 w-32 h-32 bg-amber-400 rounded-full opacity-10 blur-[60px]"></div>
        
        {/* 網格背景 */}
        <div className="absolute inset-0 opacity-5" style={{backgroundImage: 'radial-gradient(circle at 1px 1px, white 1px, transparent 0)', backgroundSize: '40px 40px'}}></div>
        
        <div className="relative z-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8">
          <div className="space-y-6">
            {/* 標籤區 */}
            <div className="flex flex-wrap items-center gap-3">
              <div className="px-4 py-1.5 bg-gradient-to-r from-blue-600/30 to-blue-500/20 backdrop-blur-xl border border-blue-400/20 rounded-full text-xs font-bold uppercase tracking-widest text-blue-300 flex items-center">
                <Cpu size={12} className="mr-2 animate-pulse" />Digital Passport
              </div>
              <span className="text-slate-600">•</span>
              <span className="text-slate-400 text-sm font-medium flex items-center">
                <Calendar size={12} className="mr-1.5" />{machine.shipDate} 出貨
              </span>
            </div>
            
            {/* 機台編號大標題 */}
            <div>
              <h2 className="text-6xl font-black tracking-tighter text-white leading-none mb-2 bg-gradient-to-r from-white via-blue-100 to-white bg-clip-text">{machine.id}</h2>
              <div className="h-1.5 w-32 bg-gradient-to-r from-blue-500 via-emerald-400 to-transparent rounded-full"></div>
            </div>
            
            {/* 資訊卡片 */}
            <div className="flex flex-wrap gap-4 items-stretch">
              <div className="bg-white/10 backdrop-blur-xl px-6 py-5 rounded-2xl border border-white/10 flex flex-col min-w-[180px] hover:bg-white/15 transition-all duration-300 hover:scale-[1.02]">
                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center"><QrCode size={11} className="mr-1.5" />遊戲機序號</span>
                <span className="font-bold text-2xl font-mono text-emerald-400">{machine.gameSerial || 'N/A'}</span>
              </div>
              <div className="bg-white/5 backdrop-blur-xl px-6 py-5 rounded-2xl border border-white/5 flex flex-col min-w-[140px] hover:bg-white/10 transition-all duration-300">
                <span className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center"><FileText size={11} className="mr-1.5" />訂單資訊</span>
                <span className="font-bold text-xl text-white">{machine.orderNo || '—'}</span>
              </div>
              <div className="bg-white/5 backdrop-blur-xl px-6 py-5 rounded-2xl border border-white/5 flex flex-col min-w-[120px] hover:bg-white/10 transition-all duration-300">
                <span className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center"><Package size={11} className="mr-1.5" />零件總數</span>
                <span className="font-bold text-xl text-amber-400">{machine.parts.length} 項</span>
              </div>
            </div>
          </div>
          
          {/* 操作按鈕區 */}
          <div className="flex flex-wrap gap-3">
            <button onClick={() => onEdit(machine)} className="group bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white px-7 py-4 rounded-2xl font-bold text-sm flex items-center transition-all duration-300 shadow-xl shadow-blue-500/20 hover:shadow-blue-500/40 hover:-translate-y-0.5">
              <Edit3 size={18} className="mr-2 group-hover:rotate-12 transition-transform" /> 修改履歷
            </button>
            <button onClick={() => window.print()} className="bg-white/10 hover:bg-white/20 text-white p-4 rounded-2xl transition-all duration-300 border border-white/10 backdrop-blur-md hover:scale-105">
              <Printer size={20} />
            </button>
            <button onClick={onClose} className="bg-white text-slate-900 px-7 py-4 rounded-2xl font-bold text-sm hover:bg-blue-50 transition-all duration-300 shadow-xl hover:-translate-y-0.5">
              返回列表
            </button>
          </div>
        </div>
      </div>

      {/* 零件清單區 */}
      <div className="space-y-12 pb-16">
        {Object.entries(grouped).map(([category, parts], catIndex) => (
          <div key={category} className="space-y-6">
            {/* 分類標題 */}
            <div className="flex items-center space-x-4 sticky top-0 bg-gradient-to-r from-slate-50 to-transparent py-4 z-10">
              <div className={`w-2 h-10 rounded-full shadow-lg ${catIndex % 3 === 0 ? 'bg-gradient-to-b from-blue-500 to-blue-600' : catIndex % 3 === 1 ? 'bg-gradient-to-b from-emerald-500 to-emerald-600' : 'bg-gradient-to-b from-amber-500 to-amber-600'}`}></div>
              <h3 className="text-2xl font-bold text-slate-800">{category}</h3>
              <span className="bg-slate-900 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg">{parts.length} 項零件</span>
            </div>
            
            {/* 零件卡片網格 */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
              {parts.map((p, i) => (
                <div key={i} className="group bg-white p-6 rounded-2xl border-2 border-slate-100 shadow-sm hover:shadow-2xl hover:shadow-blue-500/10 hover:border-blue-200 transition-all duration-500 flex flex-col justify-between hover:-translate-y-1">
                  <div>
                    {/* 卡片頭部 */}
                    <div className="flex items-center justify-between mb-3">
                      <span className="text-xs text-slate-400 font-bold uppercase tracking-wide truncate max-w-[140px]" title={p.desc}>{p.desc || 'Electronic Part'}</span>
                      <div className="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                        <Cpu size={14} className="text-slate-400 group-hover:text-blue-500 transition-colors" />
                      </div>
                    </div>
                    {/* 品名 */}
                    <p className="font-bold text-slate-800 text-lg mb-5 leading-tight min-h-[3rem]">{p.name}</p>
                  </div>
                  
                  {/* 序號區塊 */}
                  <div className="bg-gradient-to-br from-slate-50 to-blue-50/50 px-5 py-4 rounded-xl border border-slate-100 group-hover:from-blue-50 group-hover:to-blue-100/50 group-hover:border-blue-200 transition-all duration-300">
                    <div className="flex items-center justify-between">
                      <div>
                        <span className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center mb-1"><Hash size={10} className="mr-1" />Serial Number</span>
                        <span className="font-mono text-base font-bold text-blue-600">{p.sn}</span>
                      </div>
                      <div className="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-inner group-hover:shadow-blue-100 transition-all">
                        <Check size={16} className="text-emerald-500" />
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- 電規追蹤系統主組件 ---
const ElecSpecTrackingApp = ({ onBackToMenu, user }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [machines, setMachines] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedMachine, setSelectedMachine] = useState(null);
  const [editingMachine, setEditingMachine] = useState(null);
  const [isExportOpen, setIsExportOpen] = useState(false);
  const [notification, setNotification] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  // 從 Firebase 載入資料
  useEffect(() => {
    loadXLSXForSpec();
    
    // 訂閱 Firebase 資料
    const unsubscribe = db.subscribe('elec_spec_machines', (data) => {
      if (data && data.length > 0) {
        setMachines(data);
      } else {
        // 如果 Firebase 沒有資料，嘗試從 localStorage 遷移
        const saved = localStorage.getItem('feiloli_machine_db_v3');
        if (saved) {
          const localData = JSON.parse(saved);
          if (localData.length > 0) {
            // 遷移本地資料到 Firebase
            localData.forEach(machine => {
              db.addDoc('elec_spec_machines', { ...machine, id: machine.id });
            });
            setMachines(localData);
            console.log('📦 已將本地電規資料遷移至 Firebase');
          }
        }
      }
      setIsLoading(false);
    });
    
    return () => unsubscribe && unsubscribe();
  }, []);

  // 同步儲存到 Firebase（當 machines 更新時）
  const saveMachineToFirebase = async (machine) => {
    try {
      // 使用 addDoc（如果有 id 會自動 setDoc）
      await db.addDoc('elec_spec_machines', { ...machine, id: machine.id });
      // 同時備份到 localStorage
      const allMachines = [...machines.filter(m => m.id !== machine.id), machine];
      localStorage.setItem('feiloli_machine_db_v3', JSON.stringify(allMachines));
    } catch (error) {
      console.error('儲存到 Firebase 失敗:', error);
      // 回退到 localStorage
      localStorage.setItem('feiloli_machine_db_v3', JSON.stringify(machines));
    }
  };

  // 批量儲存到 Firebase
  const saveMachinesToFirebase = async (newMachines) => {
    try {
      for (const machine of newMachines) {
        await db.addDoc('elec_spec_machines', { ...machine, id: machine.id });
      }
      // 同時備份到 localStorage
      localStorage.setItem('feiloli_machine_db_v3', JSON.stringify(newMachines));
    } catch (error) {
      console.error('批量儲存到 Firebase 失敗:', error);
      localStorage.setItem('feiloli_machine_db_v3', JSON.stringify(newMachines));
    }
  };

  // 刪除所有資料
  const clearAllMachines = async () => {
    try {
      for (const machine of machines) {
        await db.deleteDoc('elec_spec_machines', machine.id);
      }
      localStorage.removeItem('feiloli_machine_db_v3');
      setMachines([]);
    } catch (error) {
      console.error('清空資料失敗:', error);
    }
  };

  const suggestions = useMemo(() => {
    const allParts = machines.flatMap(m => m.parts);
    return {
      categories: Array.from(new Set(allParts.map(p => p.category))).filter(Boolean).sort(),
      names: Array.from(new Set(allParts.map(p => p.name))).filter(Boolean).sort(),
      descs: Array.from(new Set(allParts.map(p => p.desc))).filter(Boolean).sort(),
    };
  }, [machines]);

  const showNotification = (msg, type = 'success') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };

  const handleFileUpload = async (e) => {
    const files = e.target.files; if (!files.length) return;
    const XLSX = await loadXLSXForSpec();
    let totalParsed = [];
    let processedCount = 0;
    for (let file of Array.from(files)) {
      const reader = new FileReader();
      const isXlsx = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
      reader.onload = (event) => {
        try {
          if (isXlsx) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            workbook.SheetNames.forEach(name => {
              const matrix = XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1 });
              totalParsed = [...totalParsed, ...processSpecRawData(matrix, file.name)];
            });
          } else {
            const matrix = event.target.result.split(/\r?\n/).map(line => line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c?.replace(/"/g, '').trim()));
            totalParsed = [...totalParsed, ...processSpecRawData(matrix, file.name)];
          }
          processedCount++;
          if (processedCount === files.length) {
            const machineMap = {};
            [...machines, ...totalParsed].forEach(m => {
              if (!machineMap[m.id]) { machineMap[m.id] = m; } else {
                const existingParts = new Set(machineMap[m.id].parts.map(p => `${p.name}-${p.sn}`));
                m.parts.forEach(p => { if (!existingParts.has(`${p.name}-${p.sn}`)) machineMap[m.id].parts.push(p); });
              }
            });
            const mergedMachines = Object.values(machineMap).sort((a, b) => b.timestamp - a.timestamp);
            setMachines(mergedMachines);
            // 同步到 Firebase
            saveMachinesToFirebase(mergedMachines);
            showNotification(`已解析並分析 ${totalParsed.length} 台機台/明細數據，已同步至雲端。`);
          }
        } catch (err) { showNotification(`解析失敗`, 'error'); }
      };
      if (isXlsx) reader.readAsArrayBuffer(file); else reader.readAsText(file);
    }
  };

  const handleCustomExport = async (selectedMachines, fields, includeParts) => {
    const XLSX = await loadXLSXForSpec(); const wb = XLSX.utils.book_new();
    const mainSheetData = selectedMachines.map(m => {
      const row = {}; if (fields.id) row["機台 ID"] = m.id; if (fields.gameSerial) row["遊戲序號"] = m.gameSerial; if (fields.orderNo) row["訂單編號"] = m.orderNo; if (fields.poNo) row["PO 編號"] = m.poNo; if (fields.shipDate) row["出貨日期"] = m.shipDate; if (fields.partsCount) row["零件總項數"] = m.parts.length; if (fields.source) row["資料來源"] = m.importSource; return row;
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mainSheetData), "機台總表");
    if (includeParts) {
      const partsSheetData = []; selectedMachines.forEach(m => { m.parts.forEach(p => { partsSheetData.push({ "機台 ID": m.id, "遊戲序號": m.gameSerial, "區域": p.category, "中文名稱": p.name, "英文名稱": p.desc, "唯一序號 (S/N)": p.sn, "出貨日期": m.shipDate }); }); });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(partsSheetData), "零件明細");
    }
    XLSX.writeFile(wb, `機台自訂報表_${new Date().toISOString().slice(0,10)}.xlsx`); showNotification('匯出成功');
  };

  const filteredMachines = useMemo(() => {
    if (!searchTerm) return machines; const s = searchTerm.toLowerCase();
    return machines.filter(m => m.id.toLowerCase().includes(s) || (m.gameSerial && m.gameSerial.toLowerCase().includes(s)) || (m.orderNo && m.orderNo.toLowerCase().includes(s)) || m.parts.some(p => p.sn.toLowerCase().includes(s)));
  }, [machines, searchTerm]);

  const stats = useMemo(() => {
    const total = machines.length; const models = {}; machines.forEach(m => { const p = m.id.split('-')[0]; models[p] = (models[p] || 0) + 1; });
    const recent = [...machines].sort((a, b) => b.timestamp - a.timestamp).slice(0, 5); return { total, models, recent };
  }, [machines]);

  const navItems = [
    { id: 'dashboard', icon: LayoutDashboard, label: '概覽儀表板' },
    { id: 'list', icon: FileText, label: '機台紀錄表' },
    { id: 'traceability', icon: Package, label: '履歷分析' },
    { id: 'manual', icon: PlusCircle, label: '手動新增' }
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-100 via-slate-50 to-blue-50/30 text-slate-900 font-sans">
      <SpecExportCenterModal isOpen={isExportOpen} onClose={() => setIsExportOpen(false)} machines={machines} onExport={handleCustomExport} />
      
      {/* 載入中顯示 */}
      {isLoading && (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center">
          <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
            <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p className="text-slate-700 font-bold">正在從雲端載入資料...</p>
            <p className="text-slate-400 text-sm mt-1">Firebase Firestore</p>
          </div>
        </div>
      )}
      
      {/* Header - 升級版 */}
      <header className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-40 shadow-2xl border-b border-white/5">
        {/* 裝飾性漸層 */}
        <div className="absolute inset-0 overflow-hidden pointer-events-none">
          <div className="absolute -top-24 -right-24 w-48 h-48 bg-blue-500 rounded-full opacity-10 blur-[60px]"></div>
          <div className="absolute -bottom-12 left-1/3 w-32 h-32 bg-emerald-400 rounded-full opacity-5 blur-[40px]"></div>
        </div>
        
        <div className="relative flex items-center space-x-5">
          <div className="relative">
            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center shadow-xl shadow-blue-500/20">
              <Cpu size={24} className="text-white" />
            </div>
            <div className="absolute -top-1 -right-1 w-4 h-4 bg-emerald-400 rounded-full border-2 border-slate-900 animate-pulse"></div>
          </div>
          <div>
            <span className="font-black text-xl block leading-tight tracking-tight">電規追蹤系統</span>
            <span className="text-xs text-blue-400/80 uppercase tracking-[0.2em] font-medium">Track Master Pro</span>
          </div>
        </div>
        
        <div className="relative flex items-center space-x-4">
          <div className="hidden md:flex items-center bg-white/5 backdrop-blur-xl px-5 py-2.5 rounded-xl text-sm border border-white/10">
            <div className="w-8 h-8 bg-gradient-to-br from-emerald-400 to-emerald-500 rounded-lg flex items-center justify-center mr-3 shadow-lg shadow-emerald-500/20">
              <User size={14} className="text-white" />
            </div>
            <div className="text-left">
              <span className="text-slate-100 font-bold block text-sm">{user?.displayName || 'Admin'}</span>
              <span className="text-slate-400 text-xs">已登入</span>
            </div>
          </div>
          <button onClick={onBackToMenu} className="px-5 py-2.5 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-bold transition-all duration-300 flex items-center border border-white/10 hover:border-white/20 hover:scale-105 active:scale-95">
            <ArrowLeft size={16} className="mr-2" /> 返回選單
          </button>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar Nav - 升級版 */}
        <nav className="w-72 bg-white/80 backdrop-blur-xl border-r border-slate-200/50 min-h-[calc(100vh-68px)] p-5 hidden lg:block sticky top-[68px] shadow-xl">
          <div className="space-y-2">
            {navItems.map((item, index) => (
              <button key={item.id} onClick={() => { setActiveTab(item.id); setEditingMachine(null); }} className={`w-full flex items-center p-4 rounded-2xl transition-all duration-300 group relative overflow-hidden ${activeTab === item.id ? 'bg-gradient-to-r from-slate-800 to-slate-900 text-white shadow-xl shadow-slate-900/20' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-100/80'}`}>
                {activeTab === item.id && <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-blue-400 to-emerald-400 rounded-r-full"></div>}
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center mr-4 transition-all duration-300 ${activeTab === item.id ? 'bg-white/10' : 'bg-slate-100 group-hover:bg-slate-200 group-hover:scale-110'}`}>
                  <item.icon size={20} className={activeTab === item.id ? 'text-blue-400' : 'text-slate-400 group-hover:text-slate-600'} />
                </div>
                <div className="text-left">
                  <span className="font-bold text-sm block">{item.label}</span>
                  <span className={`text-xs ${activeTab === item.id ? 'text-slate-400' : 'text-slate-400'}`}>
                    {index === 0 ? '總覽統計' : index === 1 ? '所有記錄' : index === 2 ? '詳細資訊' : '新增資料'}
                  </span>
                </div>
              </button>
            ))}
          </div>
          
          {/* 側邊欄統計卡片 */}
          <div className="mt-8 p-5 bg-gradient-to-br from-slate-50 to-blue-50/50 rounded-2xl border border-slate-200/50">
            <div className="flex items-center space-x-2 mb-4">
              <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
              <span className="text-xs text-slate-500 font-bold uppercase tracking-widest">系統狀態</span>
            </div>
            <div className="space-y-3">
              <div className="flex justify-between items-center">
                <span className="text-xs text-slate-400">已登錄機台</span>
                <span className="font-bold text-slate-700">{stats.total} 台</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-xs text-slate-400">版本</span>
                <span className="font-mono text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded">v2.5</span>
              </div>
            </div>
          </div>
        </nav>

        {/* Mobile Nav - 升級版 */}
        <div className="lg:hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-200 flex justify-around py-3 px-2 z-40 shadow-2xl">
          {navItems.map((item) => (
            <button key={item.id} onClick={() => { setActiveTab(item.id); setEditingMachine(null); }} className={`flex flex-col items-center p-3 rounded-xl transition-all duration-300 ${activeTab === item.id ? 'text-blue-600 bg-blue-50' : 'text-slate-400 hover:text-slate-600'}`}>
              <item.icon size={22} className={activeTab === item.id ? 'mb-1' : 'mb-1'} />
              <span className="text-xs font-bold">{item.label.slice(0, 4)}</span>
            </button>
          ))}
        </div>

        {/* Main Content - 升級版 */}
        <main className="flex-1 p-6 lg:p-10 pb-24 lg:pb-10">
          <div className="max-w-6xl mx-auto">
            {/* 頁面標題區 */}
            <div className="mb-10">
              <div className="flex items-center space-x-2 mb-2">
                <div className="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-xs font-bold uppercase tracking-widest">
                  {editingMachine ? 'Edit Mode' : activeTab === 'dashboard' ? 'Overview' : activeTab === 'list' ? 'Database' : activeTab === 'traceability' ? 'Details' : 'Create'}
                </div>
              </div>
              <h1 className="text-4xl font-black text-slate-900 tracking-tight">
                {editingMachine ? '編輯履歷' : activeTab === 'dashboard' ? '數據儀表板' : activeTab === 'list' ? '全機台清單' : activeTab === 'traceability' ? '機台身份證' : '新增數據'}
              </h1>
              <p className="text-slate-500 mt-2">
                {activeTab === 'dashboard' ? '查看系統概覽與最新動態' : activeTab === 'list' ? '瀏覽與搜尋所有已登錄機台' : activeTab === 'traceability' ? '查看機台詳細履歷資訊' : '手動新增機台電規資料'}
              </p>
            </div>

            <div>
              {editingMachine ? <SpecEntryFormView initialData={editingMachine} mode="edit" onSave={(m) => { 
                saveMachineToFirebase(m);
                setMachines(prev => { const idx = prev.findIndex(x => x.id === m.id); const updated = [...prev]; updated[idx] = m; return updated; }); 
                setEditingMachine(null); 
                setSelectedMachine(m); 
                setActiveTab('traceability'); 
                showNotification('更新成功'); 
              }} suggestions={suggestions} /> : (
                <>
                  {activeTab === 'dashboard' && <SpecDashboardView stats={stats} onUpload={handleFileUpload} onNavigate={(m) => { setSelectedMachine(m); setActiveTab('traceability'); }} onOpenExport={() => setIsExportOpen(true)} />}
                  {activeTab === 'list' && <SpecMachineListView machines={filteredMachines} searchTerm={searchTerm} setSearchTerm={setSearchTerm} onSelect={(m) => { setSelectedMachine(m); setActiveTab('traceability'); }} onClear={() => {if(window.confirm('確定清空所有資料？此操作無法復原！')) clearAllMachines();}} onOpenExport={() => setIsExportOpen(true)} />}
                  {activeTab === 'traceability' && <SpecTraceabilityDetailView machine={selectedMachine} onEdit={(m) => setEditingMachine(m)} onClose={() => setActiveTab('list')} />}
                  {activeTab === 'manual' && <SpecEntryFormView onSave={(m) => { 
                    saveMachineToFirebase(m);
                    setMachines(prev => [m, ...prev]); 
                    setActiveTab('list'); 
                    showNotification('登記成功，已同步至雲端'); 
                  }} mode="create" suggestions={suggestions} />}
                </>
              )}
            </div>
          </div>
        </main>
      </div>

      {/* Toast Notification - 升級版 */}
      {notification && (
        <div className={`fixed bottom-24 lg:bottom-8 right-8 px-8 py-5 rounded-2xl shadow-2xl z-[100] flex items-center space-x-4 border backdrop-blur-xl transition-all duration-500 animate-in slide-in-from-right ${notification.type === 'success' ? 'bg-slate-900/95 text-white border-white/10' : 'bg-gradient-to-r from-rose-600 to-rose-500 text-white border-rose-400/20'}`}>
          <div className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-lg ${notification.type === 'success' ? 'bg-emerald-500' : 'bg-white/20'}`}>
            {notification.type === 'success' ? <CheckCircle2 size={20} /> : <AlertCircle size={20} />}
          </div>
          <div>
            <p className="text-xs opacity-60 uppercase tracking-widest mb-1">{notification.type === 'success' ? 'Success' : 'Error'}</p>
            <p className="font-bold text-base">{notification.msg}</p>
          </div>
        </div>
      )}
    </div>
  );
};

const AppraisalWithDashboard = ({ onBackToMenu, user }) => {
  const [step, setStep] = useState(0);
  const [fileName, setFileName] = useState('');
  const [workbook, setWorkbook] = useState(null);
  const [sheetNames, setSheetNames] = useState([]);
  const [currentSheetName, setCurrentSheetName] = useState('');
  const [currentSheetData, setCurrentSheetData] = useState([]);
  const [employees, setEmployees] = useState([]);
  const [currentEmployeeIndex, setCurrentEmployeeIndex] = useState(0);
  const [errorMsg, setErrorMsg] = useState('');
  const [analysisData, setAnalysisData] = useState([]);
  const ANCHOR_TEXT = '評核判定基準';
  const MAIN_ITEM_REGEX = /^[一二三四五六七八九十]/;
  const SUB_ITEM_REGEX = /^[\(（]\d+[\)）]/;

  useEffect(() => {
    if (window.XLSX) {
      setStep(1);
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    script.async = true;
    script.onload = () => setStep(1);
    document.body.appendChild(script);
  }, []);

  useEffect(() => {
    if (workbook && currentSheetName && window.XLSX) {
      const worksheet = workbook.Sheets[currentSheetName];
      const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
      setCurrentSheetData(jsonData);
      analyzeFileStructure(jsonData);
      setCurrentEmployeeIndex(0);
    }
  }, [currentSheetName, workbook]);

  const handleFileUpload = (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    setFileName(file.name);
    setErrorMsg('');
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = e.target && e.target.result;
      if (data && window.XLSX) {
        try {
          const wb = window.XLSX.read(data, { type: 'array' });
          setWorkbook(wb);
          setSheetNames(wb.SheetNames);
          const firstValidSheet = wb.SheetNames.find((name) => !name.includes('相容性')) || wb.SheetNames[0];
          setCurrentSheetName(firstValidSheet);
          setStep(2);
        } catch (err) {
          setErrorMsg('無法讀取 Excel 檔案，請確認格式是否正確。');
        }
      }
    };
    reader.readAsArrayBuffer(file);
  };

  const analyzeFileStructure = (data) => {
    let anchorRowIndex = -1;
    const foundEmployees = [];
    for (let r = 0; r < Math.min(data.length, 30); r++) {
      if (data[r] && data[r].some((cell) => cell && String(cell).includes(ANCHOR_TEXT))) {
        anchorRowIndex = r;
        break;
      }
    }
    if (anchorRowIndex === -1) {
      setEmployees([]);
      return;
    }
    const nameRowIndex = anchorRowIndex - 1;
    if (nameRowIndex < 0) return;
    const nameRow = data[nameRowIndex];
    for (let c = 9; c < nameRow.length; c++) {
      const cell = nameRow[c] ? String(nameRow[c]).trim() : '';
      if (cell && cell.length > 0 && cell.length < 10 && !cell.includes('評核')) {
        foundEmployees.push({
          name: cell,
          colIndex: c,
          scoreCol: c,
          factCol: c + 1
        });
      }
    }
    setEmployees(foundEmployees);
  };

  const recalculateSheet = (data, scoreCol) => {
    const newData = [...data];
    let currentMainRowIndex = -1;
    let subItemsSum = 0;
    let hasSubItems = false;
    for (let i = 0; i < newData.length; i++) {
      const row = newData[i] || [];
      const title = row[0] ? String(row[0]).trim() : '';
      if (MAIN_ITEM_REGEX.test(title)) {
        if (currentMainRowIndex !== -1 && hasSubItems) {
          newData[currentMainRowIndex][scoreCol] = subItemsSum;
        }
        currentMainRowIndex = i;
        subItemsSum = 0;
        hasSubItems = false;
      } else if (SUB_ITEM_REGEX.test(title)) {
        if (currentMainRowIndex !== -1) {
          hasSubItems = true;
          const val = parseFloat(row[scoreCol]);
          if (!isNaN(val)) subItemsSum += val;
        }
      }
    }
    if (currentMainRowIndex !== -1 && hasSubItems) {
      newData[currentMainRowIndex][scoreCol] = subItemsSum;
    }
    return newData;
  };

  const handleScoreChange = (rowIndex, colIndex, value) => {
    const newData = [...currentSheetData];
    newData[rowIndex] = [...(newData[rowIndex] || [])];
    newData[rowIndex][colIndex] = value;
    const currentEmp = employees[currentEmployeeIndex];
    let updatedData = newData;
    if (currentEmp && colIndex === currentEmp.scoreCol) {
      updatedData = recalculateSheet(updatedData, colIndex);
    }
    setCurrentSheetData(updatedData);
    if (workbook && window.XLSX) {
      const newSheet = window.XLSX.utils.aoa_to_sheet(updatedData);
      workbook.Sheets[currentSheetName] = newSheet;
    }
  };

  const calculateTotalScore = (data, colIndex) => {
    let total = 0;
    data.forEach((row) => {
      const firstCell = row && row[0] ? String(row[0]).trim() : '';
      if (MAIN_ITEM_REGEX.test(firstCell)) {
        const val = parseFloat(row[colIndex]);
        if (!isNaN(val)) total += val;
      }
    });
    return total;
  };

  const performAnalysis = () => {
    if (!workbook || !window.XLSX) return;
    const results = [];
    workbook.SheetNames.forEach((sheetName) => {
      if (sheetName.includes('相容性')) return;
      const worksheet = workbook.Sheets[sheetName];
      const data = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
      let anchorRowIndex = -1;
      for (let r = 0; r < Math.min(data.length, 30); r++) {
        if (data[r] && data[r].some((cell) => cell && String(cell).includes(ANCHOR_TEXT))) {
          anchorRowIndex = r;
          break;
        }
      }
      if (anchorRowIndex === -1) return;
      const nameRow = data[anchorRowIndex - 1];
      if (!nameRow) return;
      for (let c = 9; c < nameRow.length; c++) {
        const name = nameRow[c] ? String(nameRow[c]).trim() : '';
        if (name && name.length > 0 && name.length < 10 && !name.includes('評核')) {
          const score = calculateTotalScore(data, c);
          results.push({
            name,
            department: sheetName,
            score
          });
        }
      }
    });
    results.sort((a, b) => b.score - a.score);
    setAnalysisData(results);
    setStep(3);
  };

  const handleDownloadXLSX = () => {
    if (!workbook || !window.XLSX) return;
    window.XLSX.writeFile(workbook, `已考核_${fileName}`);
  };

  const isCalculatedRow = (rowIndex) => {
    const nextRow = currentSheetData[rowIndex + 1];
    if (!nextRow) return false;
    const nextTitle = nextRow[0] ? String(nextRow[0]).trim() : '';
    return SUB_ITEM_REGEX.test(nextTitle);
  };

  const renderDashboard = () => {
    if (analysisData.length === 0) {
      return <div className="p-10 text-center text-slate-500">目前尚未產出分析結果。</div>;
    }
    const avgScore = (analysisData.reduce((acc, curr) => acc + curr.score, 0) / analysisData.length).toFixed(1);
    const highest = analysisData[0];
    const lowest = analysisData[analysisData.length - 1];
    const scoreGap = (highest.score - lowest.score).toFixed(1);
    const topFive = analysisData.slice(0, 5);
    const bottomFive = analysisData.slice(-5);
    return (
      <div className="bg-gray-50 h-full overflow-y-auto p-6">
        <div className="max-w-6xl mx-auto space-y-6">
          <div className="flex items-center justify-between flex-wrap gap-3">
            <div>
              <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <PieChartIcon className="text-blue-600" />
                績效戰情儀表板
              </h2>
              <p className="text-sm text-gray-500">依據 Excel 考核表自動計算排名與動態等級。</p>
            </div>
            <div className="flex flex-wrap items-center gap-2">
              <button onClick={() => setStep(2)} className="flex items-center text-gray-600 hover:text-blue-600 font-medium px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-200">
                <ArrowLeft className="w-4 h-4 mr-2" /> 返回考核表
              </button>
              <button onClick={onBackToMenu} className="flex items-center gap-2 px-4 py-2 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors shadow-sm">
                <LogOut size={16} /> 返回
              </button>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-blue-100 rounded-lg text-blue-600"><Users size={20} /></div>
                <span className="text-gray-500 font-medium">考核總人數</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{analysisData.length} <span className="text-sm font-normal text-gray-400">人</span></div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-green-100 rounded-lg text-green-600"><TrendingUp size={20} /></div>
                <span className="text-gray-500 font-medium">公司平均分</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{avgScore} <span className="text-sm font-normal text-gray-400">分</span></div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600"><PieChartIcon size={20} /></div>
                <span className="text-gray-500 font-medium">最高分</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{highest.score.toFixed(1)} <span className="text-sm font-normal text-gray-400">{highest.name}</span></div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-amber-100 rounded-lg text-amber-600"><LineChartIcon size={20} /></div>
                <span className="text-gray-500 font-medium">區間差距</span>
              </div>
              <div className="text-3xl font-black text-gray-800">{scoreGap} <span className="text-sm font-normal text-gray-400">最高與最低</span></div>
            </div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div className="bg-white rounded-2xl border border-gray-100 shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-400 uppercase tracking-wide">Top 5 表現</p>
                  <p className="text-lg font-semibold text-gray-800">本輪表現亮眼</p>
                </div>
                <span className="text-sm text-gray-500">{topFive.length} 筆</span>
              </div>
              <div className="divide-y divide-gray-100 max-h-72 overflow-y-auto">
                {topFive.map((item, idx) => (
                  <div key={`top-${item.name}-${idx}`} className="px-6 py-4 flex items-center justify-between">
                    <div>
                      <p className="font-semibold text-gray-800">{idx + 1}. {item.name}</p>
                      <p className="text-xs text-gray-400">{item.department}</p>
                    </div>
                    <p className="font-bold text-lg text-green-600">{item.score.toFixed(1)}</p>
                  </div>
                ))}
              </div>
            </div>
            <div className="bg-white rounded-2xl border border-gray-100 shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-400 uppercase tracking-wide">待加強名單</p>
                  <p className="text-lg font-semibold text-gray-800">低於平均</p>
                </div>
                <span className="text-sm text-gray-500">{bottomFive.length} 筆</span>
              </div>
              <div className="divide-y divide-gray-100 max-h-72 overflow-y-auto">
                {bottomFive.map((item, idx) => {
                  const rank = analysisData.length - bottomFive.length + idx + 1;
                  return (
                    <div key={`low-${item.name}-${idx}`} className="px-6 py-4 flex items-center justify-between">
                      <div>
                        <p className="font-semibold text-gray-800">{rank}. {item.name}</p>
                        <p className="text-xs text-gray-400">{item.department}</p>
                      </div>
                      <p className="font-bold text-lg text-red-500">{item.score.toFixed(1)}</p>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          <div className="bg-white rounded-2xl border border-gray-100 shadow-sm">
            <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
              <p className="text-xs text-gray-400 uppercase tracking-wide">完整排名</p>
              <span className="text-sm text-gray-500">{analysisData.length} 筆</span>
            </div>
            <div className="divide-y divide-gray-100 max-h-96 overflow-y-auto">
              {analysisData.map((item, idx) => (
                <div key={`list-${idx}`} className="px-6 py-4 flex items-center justify-between">
                  <div>
                    <p className="text-sm font-semibold text-gray-800">{idx + 1}. {item.name}</p>
                    <p className="text-xs text-gray-400">{item.department}</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xs text-gray-400">score</p>
                    <p className="text-lg font-bold text-gray-800">{item.score.toFixed(1)}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderUploadStep = () => (
    <div className="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <p className="text-xs uppercase tracking-wider text-slate-400">步驟 1 / 3</p>
          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <Upload className="text-blue-600" /> Excel 上傳與解析
          </h2>
          <p className="text-sm text-slate-500">上傳考核表後即可在畫面中調整分數與事實欄位。</p>
        </div>
        <button onClick={onBackToMenu} className="flex items-center gap-2 text-sm bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors shadow-sm">
          <LogOut size={16} /> 返回
        </button>
      </div>
      <div className="rounded-2xl border border-dashed border-slate-300 p-8 text-center space-y-4">
        <Upload size={36} className="mx-auto text-blue-600" />
        <p className="text-sm text-slate-500">請上傳包含「評核判定基準」標頭的 Excel (.xlsx)</p>
        <label htmlFor="appraisal-upload" className="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-700 cursor-pointer">
          <Upload size={16} /> 點我選擇檔案
        </label>
        <input id="appraisal-upload" type="file" accept=".xlsx,.xls" className="hidden" onChange={handleFileUpload} />
        {fileName && <p className="text-xs text-slate-500">目前選擇：{fileName}</p>}
      </div>
      {errorMsg && <p className="text-sm text-red-600">{errorMsg}</p>}
      <div className="text-xs text-slate-400 space-y-1">
        <p>• 本系統會自動偵測包含「評核判定基準」的區段，並推敲所屬員工欄位。</p>
        <p>• 可直接在畫面上修正單項分數，系統會自動重新計算合計。</p>
      </div>
    </div>
  );

  const renderSheetEditor = () => {
    const selectedEmployee = employees[currentEmployeeIndex];
    const scoreCol = selectedEmployee?.scoreCol;
    const factCol = selectedEmployee?.factCol ?? (scoreCol !== undefined ? scoreCol + 1 : undefined);
    const rowsToDisplay = currentSheetData.slice(0, Math.min(currentSheetData.length, 80));

    return (
      <div className="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 space-y-6">
          <div className="flex flex-wrap items-start justify-between gap-3">
          <div>
            <p className="text-xs uppercase tracking-wider text-slate-400">步驟 2 / 3</p>
            <h2 className="text-2xl font-bold text-slate-800">調整考核表與欄位定位</h2>
            <p className="text-sm text-slate-500">確認每位員工的欄位與分數後，按下「生成儀表板」即可進入分析。</p>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <button onClick={handleDownloadXLSX} disabled={!workbook} className="flex items-center gap-2 px-4 py-2 text-sm border border-slate-200 rounded-lg hover:border-slate-400 disabled:opacity-50">
              <Download size={16} /> 下載調整後 Excel
            </button>
            <button onClick={() => setStep(1)} className="flex items-center gap-2 px-4 py-2 text-sm border border-slate-200 rounded-lg hover:border-slate-400">
              <X size={16} /> 重新上傳
            </button>
            <button onClick={performAnalysis} disabled={employees.length === 0} className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
              <PieChartIcon size={16} /> 生成儀表板
            </button>
              <button onClick={onBackToMenu} className="flex items-center gap-2 px-4 py-2 text-sm border border-slate-200 rounded-lg hover:border-slate-400 text-slate-600">
                <LogOut size={16} /> 離開模組
              </button>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="text-xs uppercase text-slate-400 tracking-wide">工作表</label>
            <select
              value={currentSheetName || ''}
              onChange={(event) => setCurrentSheetName(event.target.value)}
              className="mt-2 w-full border border-slate-200 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
            >
              {sheetNames.length === 0 ? (
                <option value="">尚無工作表可選</option>
              ) : (
                sheetNames.map((sheet) => (
                  <option key={sheet} value={sheet}>{sheet}</option>
                ))
              )}
            </select>
          </div>
          <div>
            <label className="text-xs uppercase text-slate-400 tracking-wide">選擇員工</label>
            <select
              value={employees.length ? currentEmployeeIndex : ''}
              onChange={(event) => {
                const parsed = Number(event.target.value);
                if (!Number.isNaN(parsed)) {
                  setCurrentEmployeeIndex(parsed);
                }
              }}
              className="mt-2 w-full border border-slate-200 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
            >
              {employees.length === 0 ? (
                <option value="">-----</option>
              ) : (
                employees.map((employee, idx) => (
                  <option key={`${employee.name}-${idx}`} value={idx}>{employee.name}</option>
                ))
              )}
            </select>
            {!employees.length && <p className="text-xs text-red-500 mt-2">尚未偵測到任何員工欄位，請確認 Excel 是否包含關鍵標題。</p>}
          </div>
        </div>

        {selectedEmployee ? (
          <div className="space-y-3">
            <div className="rounded-2xl border border-slate-200 overflow-hidden">
              <div className="flex flex-wrap items-center justify-between px-6 py-4 bg-slate-50">
                <div>
                  <p className="text-xs uppercase tracking-wide text-slate-500">目前檢視</p>
                  <p className="text-lg font-semibold text-slate-900">{selectedEmployee.name}</p>
                </div>
                <p className="text-sm text-slate-500">總分欄位：{scoreCol !== undefined ? scoreCol + 1 : '未偵測'}；事實欄位：{factCol !== undefined ? factCol + 1 : '未偵測'}</p>
              </div>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm text-left">
                  <thead className="text-xs uppercase tracking-wide text-slate-400 bg-white">
                    <tr>
                      <th className="px-4 py-3">項目</th>
                      <th className="px-4 py-3">得分</th>
                      <th className="px-4 py-3">事實描述</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rowsToDisplay.map((row, rowIndex) => {
                      const rowData = row || [];
                      const rowTitle = rowData[0] ? String(rowData[0]).trim() : '—';
                      const scoreValue = scoreCol !== undefined ? (rowData[scoreCol] !== undefined ? rowData[scoreCol] : '') : '';
                      const factValue = factCol !== undefined ? (rowData[factCol] !== undefined ? rowData[factCol] : '') : '';
                      const rowClass = isCalculatedRow(rowIndex) ? 'bg-amber-50' : rowIndex % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                      return (
                        <tr key={rowIndex} className={rowClass}>
                          <td className="border-t border-slate-100 px-4 py-3 text-slate-600">{rowTitle}</td>
                          <td className="border-t border-slate-100 px-4 py-3">
                            <input
                              type="text"
                              value={scoreValue}
                              onChange={(event) => scoreCol !== undefined && handleScoreChange(rowIndex, scoreCol, event.target.value)}
                              className="w-full bg-transparent text-slate-900 border-b border-slate-200 focus:border-blue-500 focus:outline-none"
                            />
                          </td>
                          <td className="border-t border-slate-100 px-4 py-3">
                            <input
                              type="text"
                              value={factValue}
                              onChange={(event) => factCol !== undefined && handleScoreChange(rowIndex, factCol, event.target.value)}
                              className="w-full bg-transparent text-slate-900 border-b border-slate-200 focus:border-blue-500 focus:outline-none"
                            />
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
            <p className="text-xs text-slate-400">若某筆項目是合計列 (以括弧開頭的子項)，系統會自動重新計算合計。</p>
          </div>
        ) : (
          <div className="rounded-2xl border border-amber-200 bg-amber-50 px-6 py-5 text-sm text-amber-900">
            尚未偵測到可用的員工欄位，請重新檢查 Excel 是否包含標頭「評核判定基準」或增加人員名稱。
          </div>
        )}
      </div>
    );
  };

  const renderStepContent = () => {
    if (step === 0) {
      return (
        <div className="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 text-center space-y-3">
          <div className="flex items-center justify-center text-blue-600">
            <RefreshCw size={24} />
          </div>
          <p className="text-lg font-semibold text-slate-800">正在載入 Excel 函式庫</p>
          <p className="text-sm text-slate-500">首次使用時將自動下載 xlsx.full.min.js，請稍候。</p>
        </div>
      );
    }
    if (step === 1) return renderUploadStep();
    if (step === 2) return renderSheetEditor();
    if (step === 3) return renderDashboard();
    return null;
  };

  return (
    <div className="min-h-screen bg-slate-100 py-10 px-4">
      <div className="max-w-6xl mx-auto">
        {renderStepContent()}
      </div>
    </div>
  );
};

// --- Root App Component ---
// 主題切換按鈕組件
const ThemeToggle = ({ theme, toggleTheme }) => {
  return (
    <button
      onClick={toggleTheme}
      className={`theme-toggle ${theme}`}
      title={theme === 'dark' ? '切換至明亮模式' : '切換至深色模式'}
    >
      {theme === 'dark' ? (
        <>
          <Sun />
          <span>明亮</span>
        </>
      ) : (
        <>
          <Moon />
          <span>深色</span>
        </>
      )}
    </button>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [system, setSystem] = useState(null); // 'TQM', 'KPI', 'PROJECT'
  const [loading, setLoading] = useState(true);
  
  // 主題狀態管理
  const [theme, setTheme] = useState(() => {
    const savedTheme = localStorage.getItem('tqm_theme');
    return savedTheme || 'dark';
  });
  
  // 切換主題
  const toggleTheme = () => {
    const newTheme = theme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
    localStorage.setItem('tqm_theme', newTheme);
    document.documentElement.setAttribute('data-theme', newTheme);
  };
  
  // 初始化主題
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
  }, []);

  useEffect(() => {
    const savedUser = sessionStorage.getItem('tqm_user');
    if (savedUser) setUser(JSON.parse(savedUser));
    setLoading(false);
  }, []);

  const handleLogin = async (username, password, setError) => {
    try {
      const users = await db.getDocs('tqm_users', u => u.username === username);
      if (users.length === 0) { setError('帳號不存在'); return; }
      const userData = users[0];
      if (userData.password === password) {
        setUser(userData);
        sessionStorage.setItem('tqm_user', JSON.stringify(userData));
      } else { setError('密碼錯誤'); }
    } catch (err) { console.error(err); setError('登入系統發生錯誤'); }
  };

  const handleLogout = () => {
    setUser(null);
    setSystem(null);
    sessionStorage.removeItem('tqm_user');
  };

  // New DB Import/Export Handlers for Login Screen
  const handleImportDB = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (!data.users || !data.records) throw new Error('格式錯誤');
        db.importData(data);
        alert('資料庫載入成功！');
        window.location.reload(); 
      } catch (err) { alert('載入失敗：' + err.message); }
    };
    reader.readAsText(file);
  };

  const handleExportDB = () => {
    try {
      const data = db.exportData();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const timestamp = new Date().toISOString().split('T')[0];
      a.download = `TQM_Database_Backup_${timestamp}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('資料庫匯出成功！');
    } catch (err) {
      console.error('匯出失敗:', err);
      alert('匯出失敗：' + err.message);
    }
  };

  if (loading) return (
    <>
      <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
      <div className="h-screen flex items-center justify-center text-slate-500">系統載入中...</div>
    </>
  );

  if (!user) {
    return (
      <>
        <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
        <LoginScreen onLogin={handleLogin} loading={false} onImportDB={handleImportDB} onExportDB={handleExportDB} />
      </>
    );
  }

  if (!system) {
    return (
      <>
        <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
        <SystemSelector onSelect={setSystem} onLogout={handleLogout} user={user} onExportDB={handleExportDB} />
      </>
    );
  }

  // 包裝系統組件以加入主題切換按鈕
  const renderWithThemeToggle = (component) => (
    <>
      <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
      {component}
    </>
  );

  if (system === 'TQM') {
    return renderWithThemeToggle(<TQMApp appUser={user} onLogout={handleLogout} onBackToMenu={() => setSystem(null)} />);
  }

  if (system === 'KPI_PERSONAL') {
    return renderWithThemeToggle(<KPIPersonalEntryApp user={user} onBackToMenu={() => setSystem(null)} />);
  }

  if (system === 'KPI') {
    return renderWithThemeToggle(<KPIApp onBackToMenu={() => setSystem(null)} />);
  }

  if (system === 'PROJECT') {
    return renderWithThemeToggle(<RDNexusSystem key="rdnexus" user={user} onBackToMenu={() => setSystem(null)} />);
  }

  if (system === 'KPI_REPORT') {
    return renderWithThemeToggle(<KPIReportSystem user={user} onBackToMenu={() => setSystem(null)} />);
  }

  if (system === 'APPRAISAL') {
    return renderWithThemeToggle(<AppraisalWithDashboard user={user} onBackToMenu={() => setSystem(null)} />);
  }

  if (system === 'ELEC_SPEC') {
    return renderWithThemeToggle(<ElecSpecTrackingApp user={user} onBackToMenu={() => setSystem(null)} />);
  }

  if (system === 'PRODUCT_WAR_ROOM') {
    return renderWithThemeToggle(<ProductWarRoom onBackToMenu={() => setSystem(null)} />);
  }
  
  if (system === 'ADMIN') {
    return renderWithThemeToggle(<UserManagement currentUser={user} onBackToMenu={() => setSystem(null)} />);
  }

  return null;
}

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
